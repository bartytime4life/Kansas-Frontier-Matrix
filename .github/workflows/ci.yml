# .github/workflows/ci.yml
name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      strict:
        description: "Fail if expected CI gates are not configured"
        required: false
        default: "true"
      python_version:
        description: "Python version for CI runner"
        required: false
        default: "3.11"
      node_version:
        description: "Node.js version for CI runner"
        required: false
        default: "20"

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  validate:
    name: Validate (contracts + schemas + tests)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      KFM_CI_STRICT: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.strict || 'true' }}
      KFM_PYTHON_VERSION: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.python_version || '3.11' }}
      KFM_NODE_VERSION: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.node_version || '20' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.KFM_PYTHON_VERSION }}

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.KFM_NODE_VERSION }}

      - name: Show tool versions
        run: |
          python --version
          pip --version
          node --version
          npm --version

      - name: KFM CI gates (best-effort, strict by default)
        shell: bash
        run: |
          set -euo pipefail

          strict="${KFM_CI_STRICT}"
          echo "KFM_CI_STRICT=${strict}"

          python -m pip install --upgrade pip

          make_has_target () {
            [[ -f Makefile ]] || return 1
            make -n "$1" >/dev/null 2>&1
          }

          run_make () {
            local target="$1"
            echo "::group::make ${target}"
            make --no-print-directory "${target}"
            echo "::endgroup::"
          }

          note_missing () {
            local gate="$1"
            missing+=("${gate}")
            echo "::warning title=CI gate not configured::${gate}"
          }

          missing=()

          # Gate 1: Markdown protocol / docs validation (required)
          if make_has_target "docs-lint"; then
            run_make "docs-lint"
          elif [[ -f .pre-commit-config.yaml ]]; then
            echo "::group::pre-commit (docs/protocol)"
            python -m pip install pre-commit
            pre-commit run --all-files --show-diff-on-failure
            echo "::endgroup::"
          else
            # Generic Markdown lint fallback (does not replace KFM-MDP checks)
            if git ls-files '*.md' | grep -q .; then
              echo "::group::markdownlint-cli2"
              npx --yes markdownlint-cli2 "**/*.md"
              echo "::endgroup::"
            else
              echo "No Markdown files detected; skipping markdown lint."
            fi
          fi

          # Gate 2: JSON syntax sanity check (helps catch broken catalogs/config)
          echo "::group::JSON syntax check (data/, schemas/, docs/telemetry/, mcp/)"
          python - <<'PY'
          import json, pathlib, sys

          roots = [pathlib.Path(p) for p in ("data", "schemas", "docs/telemetry", "mcp") if pathlib.Path(p).exists()]
          paths = []
          for root in roots:
            paths.extend(root.rglob("*.json"))

          bad = []
          for p in paths:
            try:
              json.loads(p.read_text(encoding="utf-8"))
            except Exception as e:
              bad.append((str(p), str(e)))

          if bad:
            print("Invalid JSON files detected:")
            for p, e in bad:
              print(f" - {p}: {e}")
            sys.exit(1)

          print(f"JSON syntax OK ({len(paths)} files).")
          PY
          echo "::endgroup::"

          # Gate 3: JSON schema validation (STAC/DCAT/telemetry) (required where applicable)
          if make_has_target "schema-validate"; then
            run_make "schema-validate"
          else
            # STAC fallback validation if the STAC catalog tree exists
            if [[ -d "data/stac" ]]; then
              echo "::group::STAC validation (pystac)"
              python -m pip install "pystac[validation]"
              pystac validate "data/stac" --recursive
              echo "::endgroup::"
            else
              note_missing "schema-validate (STAC/DCAT/telemetry) â€” add Makefile target or CI script"
            fi
          fi

          # Gate 4: Graph integrity tests (required where applicable)
          if [[ -d "src/graph" || -d "docs/graph" ]]; then
            if make_has_target "graph-test"; then
              run_make "graph-test"
            elif make_has_target "graph-validate"; then
              run_make "graph-validate"
            else
              note_missing "graph integrity tests (graph-test / graph-validate)"
            fi
          else
            echo "No src/graph or docs/graph detected; skipping graph gate."
          fi

          # Gate 5: API contract tests (required where applicable)
          if [[ -d "src/server" || -d "docs/api" || -f "openapi.yaml" || -f "openapi.yml" || -f "openapi.json" ]]; then
            if make_has_target "api-contract-test"; then
              run_make "api-contract-test"
            elif make_has_target "openapi-validate"; then
              run_make "openapi-validate"
            elif make_has_target "graphql-validate"; then
              run_make "graphql-validate"
            else
              note_missing "API contract tests (api-contract-test / openapi-validate / graphql-validate)"
            fi
          else
            echo "No API surface detected (src/server, docs/api, or openapi.*); skipping API gate."
          fi

          # Gate 6: UI layer registry schema checks (required where applicable)
          if [[ -d "web" ]]; then
            if make_has_target "ui-validate"; then
              run_make "ui-validate"
            elif make_has_target "ui-a11y"; then
              run_make "ui-a11y"
            else
              note_missing "UI registry/a11y checks (ui-validate / ui-a11y)"
            fi
          else
            echo "No web/ directory detected; skipping UI gate."
          fi

          # Gate 7: Security + sovereignty scanning (required where applicable)
          # Baseline secret/dependency scanning runs in the separate `security` job.
          # Repo-specific scanning (sovereignty, redaction lint, SBOM, SLSA) should be wired via Makefile.
          if make_has_target "security-scan"; then
            run_make "security-scan"
          else
            echo "No make security-scan configured; baseline scans run in the security job."
          fi

          # Strict mode: fail if required/applicable gates were not configured
          if [[ "${#missing[@]}" -gt 0 ]]; then
            echo ""
            echo "Missing CI gates:"
            printf ' - %s\n' "${missing[@]}"
            echo ""

            if [[ "${strict}" == "true" ]]; then
              echo "Strict mode is enabled; failing CI because required gates are missing."
              exit 1
            else
              echo "Strict mode is disabled; continuing even though some gates are missing."
            fi
          fi

  security:
    name: Security (secrets + dependency review)
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Dependency review (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/dependency-review-action@v4

      - name: Secret scan (gitleaks)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
