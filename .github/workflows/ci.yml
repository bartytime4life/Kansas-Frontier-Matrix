# .github/workflows/ci.yml
# ðŸ§ª Kansas Frontier Matrix â€” Core CI (Lint, Tests, Type-Checks, Base Schemas)
# v11.2.6 â€” Governed / LTS
#
# Purpose:
#   Fast, deterministic feedback on code + core configs for the KFM monorepo.
#   This workflow focuses on:
#     - Linting & unit/integration tests (Python, Node/Web if present)
#     - Lightweight config/schema sanity checks (non-STAC/DCAT/JSON-LD)
#     - Optional CodeQL scanning (guarded for forks/permissions)
#
# Governance Context:
#   - Docs/Markdown rules: docs_validate.yml (KFM-MDP v11.2.6)
#   - Pipeline contracts: data_pipeline.yml (KFM-PDC v11)
#   - FAIR+CARE & sovereignty: faircare_validate.yml + h3_generalization.yml
#   - STAC/DCAT/JSON-LD: stac_validate.yml + dcat_validate.yml + jsonld_validate.yml
#
# Notes:
#   - Keep permissions minimal by default; escalate only per job where required.
#   - Prefer repo-defined toolchains (requirements-dev.txt, package.json scripts).
#   - Avoid hard-failing when a component is not present (e.g., no web/ directory).

name: ðŸ§ª ci

on:
  pull_request:
    branches:
      - main
      - "release/**"
  push:
    branches:
      - main
      - "release/**"
  workflow_dispatch: {}

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

defaults:
  run:
    shell: bash

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"
  KFM_PY_ROOT: "src"
  KFM_WEB_ROOT: "web"

jobs:
  ###########################################################################
  # 1. Python: lint + tests + basic type check (if configured)
  ###########################################################################
  python-ci:
    name: "ðŸ Python Lint & Tests"
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements*.txt
            pyproject.toml
            setup.cfg

      - name: ðŸ“¦ Install Python Dependencies (prefer locked/dev requirements)
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip

          if [[ -f requirements-dev.txt ]]; then
            pip install -r requirements-dev.txt
          elif [[ -f requirements.txt ]]; then
            pip install -r requirements.txt
          elif [[ -f pyproject.toml ]]; then
            # Best-effort for projects that use pyproject without exported requirements
            pip install .
          else
            echo "No Python dependency manifest found (requirements*.txt/pyproject.toml); skipping install."
          fi

          # Optional sanity check: report broken requirements (best-effort)
          python -m pip check || true

      - name: ðŸ§¹ Lint Python (ruff/flake8/black if present)
        run: |
          set -euo pipefail

          if python -m ruff --version >/dev/null 2>&1; then
            python -m ruff check "${KFM_PY_ROOT}"
            # Only run ruff-format check if supported by the installed ruff
            python -m ruff format --check "${KFM_PY_ROOT}" >/dev/null 2>&1 || true
          elif python -m pip show flake8 >/dev/null 2>&1; then
            flake8 "${KFM_PY_ROOT}"
          else
            echo "No Python linter detected (ruff/flake8)."
            echo "Recommendation: add ruff to requirements-dev.txt for governed CI."
          fi

          # Optional formatter check if black is present and ruff didn't already format-check
          if python -m pip show black >/dev/null 2>&1 && ! python -m ruff --version >/dev/null 2>&1; then
            black --check "${KFM_PY_ROOT}"
          fi

      - name: âœ… Run Python Tests (pytest/tox if configured)
        run: |
          set -euo pipefail

          if [[ -f tox.ini ]] && python -m pip show tox >/dev/null 2>&1; then
            tox
          elif python -m pip show pytest >/dev/null 2>&1; then
            pytest
          else
            echo "No tox/pytest detected; skipping Python tests."
            echo "Recommendation: add pytest to requirements-dev.txt for governed CI."
          fi

      - name: ðŸ” Optional Python Type Checking (mypy/pyright)
        continue-on-error: true
        run: |
          set -euo pipefail
          if python -m pip show mypy >/dev/null 2>&1; then
            mypy "${KFM_PY_ROOT}"
          elif [[ -f "${KFM_WEB_ROOT}/package.json" ]] && command -v node >/dev/null 2>&1; then
            # If a JS toolchain exists, try pyright via npx (best-effort)
            npx --yes pyright "${KFM_PY_ROOT}" || true
          else
            echo "No static type checker (mypy/pyright) detected; skipping."
          fi

  ###########################################################################
  # 2. Node/Web: lint + tests + build (only if web project exists)
  ###########################################################################
  node-ci:
    name: "ðŸ•¸ Web / Node Lint & Tests"
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: ðŸ”Ž Detect web root
        id: detect_web
        run: |
          set -euo pipefail
          if [[ -d "${KFM_WEB_ROOT}" && -f "${KFM_WEB_ROOT}/package.json" ]]; then
            echo "has_web=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_web=false" >> "$GITHUB_OUTPUT"
          fi

      - name: â­ Skip Node/Web CI if no web project
        if: steps.detect_web.outputs.has_web == 'false'
        run: |
          echo "No ${KFM_WEB_ROOT}/package.json; skipping Node/Web CI."

      - name: âš™ï¸ Setup Node ${{ env.NODE_VERSION }}
        if: steps.detect_web.outputs.has_web == 'true'
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: |
            ${{ env.KFM_WEB_ROOT }}/package-lock.json
            ${{ env.KFM_WEB_ROOT }}/npm-shrinkwrap.json

      - name: ðŸ“¦ Install Web Dependencies (npm ci if lock present)
        if: steps.detect_web.outputs.has_web == 'true'
        working-directory: ${{ env.KFM_WEB_ROOT }}
        run: |
          set -euo pipefail
          if [[ -f package-lock.json || -f npm-shrinkwrap.json ]]; then
            npm ci --ignore-scripts
          else
            npm install --ignore-scripts
          fi

      - name: ðŸ§¹ Lint Web (npm run lint --if-present)
        if: steps.detect_web.outputs.has_web == 'true'
        working-directory: ${{ env.KFM_WEB_ROOT }}
        run: |
          set -euo pipefail
          npm run lint --if-present

      - name: âœ… Run Web Tests (npm test --if-present)
        if: steps.detect_web.outputs.has_web == 'true'
        working-directory: ${{ env.KFM_WEB_ROOT }}
        run: |
          set -euo pipefail
          npm test --if-present

      - name: ðŸ— Web Build (npm run build --if-present)
        if: steps.detect_web.outputs.has_web == 'true'
        working-directory: ${{ env.KFM_WEB_ROOT }}
        run: |
          set -euo pipefail
          npm run build --if-present

  ###########################################################################
  # 3. Config & Base Schema Sanity (YAML/JSON/etc.)
  ###########################################################################
  config-schemas:
    name: "ðŸ§¾ Config & Base Schema Checks"
    runs-on: ubuntu-22.04
    timeout-minutes: 20

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: ðŸ§¬ Validate Core Config Schemas (if configured)
        run: |
          set -euo pipefail
          if [[ -d .github/actions/schema-validate ]]; then
            if [[ -d schemas/config && -d config ]]; then
              bash .github/actions/schema-validate/entrypoint.sh schemas/config config
            else
              echo "No schemas/config or config directory; skipping base config schema checks."
            fi
          else
            echo ".github/actions/schema-validate not found; skipping schema validation."
          fi

  ###########################################################################
  # 4. Optional: CodeQL Code Scanning (if enabled)
  #
  # Notes:
  #  - Upgraded to CodeQL Action v4 (current). v3 deprecation announced.
  #  - Avoid running on forked PRs where security-events permissions are not granted.
  ###########################################################################
  codeql:
    name: "ðŸ” CodeQL Static Analysis (Optional)"
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    needs:
      - python-ci
      - node-ci

    if: |
      github.event_name != 'pull_request' ||
      github.event.pull_request.head.repo.full_name == github.repository

    permissions:
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ "python", "javascript" ]

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: ðŸ§© Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}

      - name: ðŸ§ª Autobuild (best-effort)
        uses: github/codeql-action/autobuild@v4

      - name: ðŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{ matrix.language }}"

  ###########################################################################
  # 5. Summary for CI (helps downstream telemetry_export.yml)
  ###########################################################################
  ci-summary:
    name: "ðŸ§¾ CI Summary"
    runs-on: ubuntu-22.04
    needs:
      - python-ci
      - node-ci
      - config-schemas
    if: always()

    steps:
      - name: âœï¸ Emit CI Summary
        run: |
          set -euo pipefail
          {
            echo "## ðŸ§ª KFM Core CI Summary"
            echo ""
            echo "- Python job: ${{ needs.python-ci.result }}"
            echo "- Node/Web job: ${{ needs.node-ci.result }}"
            echo "- Config/Base Schemas job: ${{ needs.config-schemas.result }}"
            echo ""
            echo "Notes:"
            echo "- CodeQL runs only on non-fork contexts (or on push) to ensure security-events permissions."
          } >> "${GITHUB_STEP_SUMMARY}"
