# .github/workflows/h3_generalization.yml
# ðŸ§Š Kansas Frontier Matrix â€” H3 Spatial Generalization & Sensitive Coordinate Enforcement
# v11.2.6 â€” Diamondâ¹ Î© / CrownâˆžÎ© Ultimate Certified
#
# Purpose:
#   Enforce spatial masking and aggregation for sensitive locations using H3,
#   ensuring that archaeological sites, Indigenous lands, sacred locations,
#   and other highâ€‘risk geographies are never exposed at disallowed precision.
#
# Governance Context:
#   - FAIR+CARE (CARE + FAIR metadata from faircare_validate.yml)
#   - Indigenous Data Protection & sovereignty policies
#   - H3 policy config (config-driven; deterministic): config/h3_policy.yml
#   - STAC/DCAT/JSON-LD semantics validated in dedicated workflows
#
# This workflow focuses on:
#   - Detecting raw/sensitive coordinates in governed layers
#   - Verifying high-sensitivity features are represented via H3 cells (not raw points)
#   - Enforcing minimum allowed H3 resolution thresholds per policy
#   - Emitting optional metrics for telemetry_export.yml

name: ðŸ§Š h3-generalization

on:
  pull_request:
    paths:
      - "data/**"
      - "docs/data/**"
      - "config/h3_policy.yml"
      - "config/h3_policy.yaml"
      - "config/h3_*.yml"
      - "config/h3_*.yaml"
      - "scripts/*h3*"
      - ".github/workflows/h3_generalization.yml"
  push:
    branches:
      - main
      - "release/**"
    paths:
      - "data/**"
      - "docs/data/**"
      - "config/h3_policy.yml"
      - "config/h3_policy.yaml"
      - "config/h3_*.yml"
      - "config/h3_*.yaml"
      - "scripts/*h3*"
      - ".github/workflows/h3_generalization.yml"
  workflow_dispatch: {}

concurrency:
  group: h3-generalization-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read

defaults:
  run:
    shell: bash

env:
  PYTHON_VERSION: "3.11"
  H3_DATA_ROOT: "data"
  H3_DOCS_ROOT: "docs/data"
  H3_POLICY_CONFIG: "config/h3_policy.yml"
  H3_METRICS_OUT: "h3-generalization-metrics.json"

jobs:
  h3-generalization:
    name: "ðŸ§Š H3 Spatial Generalization & Sensitive Coordinate Enforcement"
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ”Ž Detect Spatial/H3-Relevant Content
        id: detect_h3
        run: |
          set -euo pipefail
          has_any="false"

          if [[ -d "${H3_DATA_ROOT}" ]]; then
            echo "Found data root: ${H3_DATA_ROOT}"
            has_any="true"
          fi

          if [[ -d "${H3_DOCS_ROOT}" ]]; then
            echo "Found docs data root: ${H3_DOCS_ROOT}"
            has_any="true"
          fi

          echo "has_h3_targets=${has_any}" >> "$GITHUB_OUTPUT"

          if [[ "${has_any}" == "false" ]]; then
            echo "::notice title=H3 generalization::No data/docs roots present; skipping validation."
          fi

      - name: â­ Skip H3 validation (no data/docs roots)
        if: steps.detect_h3.outputs.has_h3_targets == 'false'
        run: |
          echo "No spatial/H3-relevant content detected; nothing to validate for this run."

      - name: ðŸ§¾ Require H3 Policy Config (Config-Driven Determinism)
        if: steps.detect_h3.outputs.has_h3_targets == 'true'
        run: |
          set -euo pipefail
          if [[ ! -f "${H3_POLICY_CONFIG}" ]]; then
            echo "::error title=Missing H3 policy config::${H3_POLICY_CONFIG} not found."
            echo "KFM requires config-driven, deterministic masking rules. Add the policy file (or update workflow env)."
            exit 1
          fi

      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        if: steps.detect_h3.outputs.has_h3_targets == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            scripts/requirements-h3.txt

      - name: ðŸ“¦ Install H3 & Geo Tooling
        if: steps.detect_h3.outputs.has_h3_targets == 'true'
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [[ -f scripts/requirements-h3.txt ]]; then
            pip install --no-cache-dir -r scripts/requirements-h3.txt
          else
            # Minimal defaults if a dedicated requirements file is not present
            pip install --no-cache-dir "h3" "shapely" "pyproj" || echo "Optional geo deps failed; continuing if not strictly required by scripts."
          fi

      - name: ðŸ§Š Enforce H3 Generalization Policy (Hard Gate)
        if: steps.detect_h3.outputs.has_h3_targets == 'true'
        run: |
          set -euo pipefail

          if [[ ! -f scripts/h3_masking_check.py ]]; then
            echo "::error title=Missing H3 enforcement script::scripts/h3_masking_check.py not found."
            echo "This script is required to enforce H3 generalization & masking policies."
            exit 1
          fi

          python scripts/h3_masking_check.py \
            --data-root "${H3_DATA_ROOT}" \
            --docs-root "${H3_DOCS_ROOT}" \
            --policy "${H3_POLICY_CONFIG}" \
            --mode ci

      - name: ðŸ“ Optional H3 Coverage & Consistency Audit
        if: steps.detect_h3.outputs.has_h3_targets == 'true'
        continue-on-error: true
        run: |
          set -euo pipefail
          if [[ -f scripts/h3_coverage_audit.py ]]; then
            python scripts/h3_coverage_audit.py \
              --data-root "${H3_DATA_ROOT}" \
              --docs-root "${H3_DOCS_ROOT}" \
              --policy "${H3_POLICY_CONFIG}"
          else
            echo "scripts/h3_coverage_audit.py not present; skipping advanced H3 coverage audit."
          fi

      - name: ðŸ“Š Optional H3 Metrics Collection
        if: steps.detect_h3.outputs.has_h3_targets == 'true'
        continue-on-error: true
        run: |
          set -euo pipefail
          if [[ -f scripts/collect_h3_metrics.py ]]; then
            python scripts/collect_h3_metrics.py \
              --data-root "${H3_DATA_ROOT}" \
              --docs-root "${H3_DOCS_ROOT}" \
              --policy "${H3_POLICY_CONFIG}" \
              --out "${H3_METRICS_OUT}"
          else
            echo "scripts/collect_h3_metrics.py not found; skipping H3 metrics export."
          fi

      - name: ðŸ“¤ Upload H3 Metrics Artifact (Optional)
        if: success() || failure()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: h3-generalization-metrics
          path: ${{ env.H3_METRICS_OUT }}
          if-no-files-found: ignore

      - name: ðŸ§¾ Emit H3 Generalization Summary
        if: always()
        run: |
          set -euo pipefail
          {
            echo "## ðŸ§Š H3 Spatial Generalization & Sensitive Coordinate Enforcement Summary"
            echo ""
            echo "- Data root: \`${H3_DATA_ROOT}\`"
            echo "- Docs data root: \`${H3_DOCS_ROOT}\`"
            echo "- H3 policy config: \`${H3_POLICY_CONFIG}\`"
            echo "- H3 targets present: \`${{ steps.detect_h3.outputs.has_h3_targets }}\`"
            echo ""
            echo "Hard gate:"
            echo "- \`scripts/h3_masking_check.py\` enforces masking/generalization rules per policy config."
            echo ""
            echo "Optional signals:"
            echo "- \`scripts/h3_coverage_audit.py\` (coverage)"
            echo "- \`scripts/collect_h3_metrics.py\` (metrics â†’ telemetry_export.yml)"
          } >> "${GITHUB_STEP_SUMMARY}"
