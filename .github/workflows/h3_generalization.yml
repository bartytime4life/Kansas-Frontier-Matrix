# .github/workflows/jsonld_validate.yml
# ðŸ§¬ Kansas Frontier Matrix â€” JSON-LD & Ontology Validation
# v11.2.6 â€” Diamondâ¹ Î© / CrownâˆžÎ© Ultimate Certified
#
# Purpose:
#   Validate JSON-LD graphs and ontology-aligned exports across the KFM monorepo, including:
#     - CIDOC-CRM aligned heritage/history graphs
#     - OWL-Time temporal entities
#     - GeoSPARQL geometries & relationships
#     - PROV-O lineage / OpenLineage-compatible event projections
#
# Governance Context:
#   - KFM-OP v11 ontology profile
#   - KFM-STAC v11, KFM-DCAT v11 JSON-LD projections (where applicable)
#   - PROV-O + OpenLineage event modeling
#   - FAIR+CARE & sovereignty signals (enforced downstream; not duplicated here)
#
# Notes:
#   - This workflow focuses on JSON-LD structural + semantic integrity.
#   - STAC/DCAT semantics are validated in stac_validate.yml / dcat_validate.yml.
#   - We only run when JSON-LD candidate files exist (not merely when directories exist).

name: ðŸ§¬ jsonld-validate

on:
  pull_request:
    paths:
      - "data/jsonld/**"
      - "data/graph/**"
      - "data/stac/**"
      - "data/catalog/**"
      - "docs/data/**"
      - "schemas/jsonld/**"
      - ".github/actions/schema-validate/**"
      - ".github/workflows/jsonld_validate.yml"
  push:
    branches:
      - main
      - "release/**"
    paths:
      - "data/jsonld/**"
      - "data/graph/**"
      - "data/stac/**"
      - "data/catalog/**"
      - "docs/data/**"
      - "schemas/jsonld/**"
      - ".github/actions/schema-validate/**"
      - ".github/workflows/jsonld_validate.yml"
  workflow_dispatch: {}

concurrency:
  group: jsonld-validate-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read

defaults:
  run:
    shell: bash

env:
  PYTHON_VERSION: "3.11"

  JSONLD_SCHEMA_DIR: "schemas/jsonld"
  JSONLD_ROOT_DOCS: "docs/data"
  JSONLD_ROOT_DATA: "data/jsonld"
  JSONLD_ROOT_GRAPH: "data/graph"
  JSONLD_ROOT_CATALOG: "data/catalog"
  RELEASES_ROOT: "releases"

jobs:
  jsonld-validate:
    name: "ðŸ§¬ JSON-LD & Ontology Validation (CIDOC / OWL-Time / GeoSPARQL / PROV-O)"
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ”Ž Detect JSON-LD Roots + Candidate Files
        id: detect_jsonld
        run: |
          set -euo pipefail

          roots=()
          [[ -d "${JSONLD_ROOT_DOCS}" ]] && roots+=("${JSONLD_ROOT_DOCS}")
          [[ -d "${JSONLD_ROOT_DATA}" ]] && roots+=("${JSONLD_ROOT_DATA}")
          [[ -d "${JSONLD_ROOT_GRAPH}" ]] && roots+=("${JSONLD_ROOT_GRAPH}")
          [[ -d "${JSONLD_ROOT_CATALOG}" ]] && roots+=("${JSONLD_ROOT_CATALOG}")

          if [[ ${#roots[@]} -eq 0 ]]; then
            echo "has_jsonld=false" >> "$GITHUB_OUTPUT"
            echo "roots=" >> "$GITHUB_OUTPUT"
            echo "::notice title=JSON-LD validation::No JSON-LD roots present; skipping."
            exit 0
          fi

          has_files="false"

          # Fast checks:
          #  1) any *.jsonld
          #  2) any *.json containing "@context" (common JSON-LD-in-.json pattern)
          for r in "${roots[@]}"; do
            if find "$r" -type f -name "*.jsonld" -print -quit | grep -q .; then
              has_files="true"
              break
            fi
            if grep -RIl --include="*.json" '"@context"' "$r" | head -n 1 | grep -q .; then
              has_files="true"
              break
            fi
          done

          echo "has_jsonld=${has_files}" >> "$GITHUB_OUTPUT"
          echo "roots=${roots[*]}" >> "$GITHUB_OUTPUT"

          if [[ "${has_files}" != "true" ]]; then
            echo "::notice title=JSON-LD validation::Roots exist, but no JSON-LD candidate files found; skipping."
          fi

      - name: â­ Skip JSON-LD validation (no JSON-LD candidate files)
        if: steps.detect_jsonld.outputs.has_jsonld != 'true'
        run: |
          echo "No JSON-LD candidate files detected; nothing to validate for this run."

      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        if: steps.detect_jsonld.outputs.has_jsonld == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            pyproject.toml
            scripts/requirements-jsonld.txt

      - name: ðŸ“¦ Install JSON-LD Validation Tooling
        if: steps.detect_jsonld.outputs.has_jsonld == 'true'
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [[ -f scripts/requirements-jsonld.txt ]]; then
            pip install --no-cache-dir -r scripts/requirements-jsonld.txt
          elif [[ -f requirements.txt ]]; then
            pip install --no-cache-dir -r requirements.txt
          else
            # Minimal baseline: enough for typical JSON-LD/SHACL tools used by custom scripts
            pip install --no-cache-dir "jsonschema>=4" "PyLD>=2" "rdflib>=7"
          fi

      - name: ðŸ§¬ Run JSON-LD Schema Validation (Composite Action)
        if: steps.detect_jsonld.outputs.has_jsonld == 'true'
        run: |
          set -euo pipefail

          if [[ ! -d ".github/actions/schema-validate" ]]; then
            echo "::error title=Missing composite action::Expected .github/actions/schema-validate for JSON-LD validation."
            exit 1
          fi

          # Rehydrate roots array from step output
          read -r -a roots <<< "${{ steps.detect_jsonld.outputs.roots }}"

          echo "Validating JSON-LD roots: ${roots[*]}"
          # Expected signature: entrypoint.sh <schema_dir> <root...>
          bash .github/actions/schema-validate/entrypoint.sh "${JSONLD_SCHEMA_DIR}" "${roots[@]}"

      - name: ðŸ“ Optional SHACL / Ontology Shape Validation
        if: steps.detect_jsonld.outputs.has_jsonld == 'true'
        continue-on-error: true
        run: |
          set -euo pipefail
          if [[ -f scripts/validate_jsonld_shacl.py ]]; then
            python -m pip install --upgrade pip
            pip install --no-cache-dir "pyshacl" "rdflib" "PyLD" || echo "Optional SHACL deps install failed; continuing."
            python scripts/validate_jsonld_shacl.py \
              --schema-dir "${JSONLD_SCHEMA_DIR}" \
              --docs-root "${JSONLD_ROOT_DOCS}" \
              --data-root "${JSONLD_ROOT_DATA}" \
              --graph-root "${JSONLD_ROOT_GRAPH}" \
              --catalog-root "${JSONLD_ROOT_CATALOG}"
          else
            echo "No scripts/validate_jsonld_shacl.py found; skipping ontology-level shape validation."
          fi

      - name: ðŸ“¡ Optional PROV-O / OpenLineage Consistency Checks
        if: steps.detect_jsonld.outputs.has_jsonld == 'true'
        continue-on-error: true
        run: |
          set -euo pipefail
          if [[ -f scripts/validate_prov_openlineage.py ]]; then
            python -m pip install --upgrade pip
            pip install --no-cache-dir "rdflib" "PyLD" || echo "Optional PROV/OpenLineage deps install failed; continuing."
            python scripts/validate_prov_openlineage.py \
              --graph-root "${JSONLD_ROOT_GRAPH}" \
              --releases-root "${RELEASES_ROOT}"
          else
            echo "No scripts/validate_prov_openlineage.py found; skipping PROV-O/OpenLineage checks."
          fi

      - name: ðŸ§¾ Emit JSON-LD Validation Summary
        if: always()
        run: |
          set -euo pipefail
          {
            echo "## ðŸ§¬ JSON-LD & Ontology Validation Summary"
            echo ""
            echo "- JSON-LD candidate files present: \`${{ steps.detect_jsonld.outputs.has_jsonld }}\`"
            echo "- JSON-LD schema dir: \`${JSONLD_SCHEMA_DIR}\`"
            echo "- Roots (existence-checked):"
            echo "  - \`${JSONLD_ROOT_DOCS}\`"
            echo "  - \`${JSONLD_ROOT_DATA}\`"
            echo "  - \`${JSONLD_ROOT_GRAPH}\`"
            echo "  - \`${JSONLD_ROOT_CATALOG}\`"
            echo "- Releases root (for PROV/OpenLineage checks): \`${RELEASES_ROOT}\`"
            echo ""
            echo "This run validates ontology-aligned assets under KFM-OP v11."
            echo "STAC/DCAT-specific validation remains in their dedicated workflows."
          } >> "${GITHUB_STEP_SUMMARY}"
