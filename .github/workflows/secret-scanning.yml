name: "Security â€” Secret Scanning (Gitleaks)"

on:
  push:
    branches: [ "main", "release/*" ]
  pull_request:
    branches: [ "main", "release/*" ]
  schedule:
    - cron: "0 8 * * 1" # Mondays at 08:00 UTC
  workflow_dispatch:

permissions:
  contents: read
  security-events: write  # needed to upload SARIF
  actions: read

jobs:
  gitleaks:
    name: Gitleaks scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history for baseline scans)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Restore Gitleaks cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/gitleaks
          key: gitleaks-${{ runner.os }}-${{ github.ref }}
          restore-keys: |
            gitleaks-${{ runner.os }}-

      # Install Gitleaks (pinned)
      - name: Install Gitleaks
        run: |
          GITLEAKS_VERSION="8.18.4"
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz \
            | tar xz gitleaks
          sudo mv gitleaks /usr/local/bin/gitleaks
          gitleaks version

      # Decide diff range for PRs to reduce noise/time; fallback to full repo on push/schedule
      - name: Determine scan target
        id: target
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "mode=diff" >> $GITHUB_OUTPUT
            echo "base=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
            echo "head=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          else
            echo "mode=repo" >> $GITHUB_OUTPUT
          fi

      # Run Gitleaks; respect local config if present (.gitleaks.toml or .gitleaksignore)
      - name: Run Gitleaks (PR diff)
        if: ${{ steps.target.outputs.mode == 'diff' }}
        run: |
          # Prefer local config; otherwise use builtin rules
          CONFIG_ARG=""
          if [[ -f ".gitleaks.toml" ]]; then
            CONFIG_ARG="--config .gitleaks.toml"
          fi
          IGNORE_ARG=""
          if [[ -f ".gitleaksignore" ]]; then
            IGNORE_ARG="--exclude-from .gitleaksignore"
          fi
          gitleaks detect \
            --no-git \
            --verbose \
            --report-format sarif \
            --report-path gitleaks.sarif \
            --redact \
            $CONFIG_ARG $IGNORE_ARG \
            --source . \
            --log-opts "${{ steps.target.outputs.base }}..${{ steps.target.outputs.head }}"
        continue-on-error: true

      - name: Run Gitleaks (full repo)
        if: ${{ steps.target.outputs.mode != 'diff' }}
        run: |
          CONFIG_ARG=""
          if [[ -f ".gitleaks.toml" ]]; then
            CONFIG_ARG="--config .gitleaks.toml"
          fi
          IGNORE_ARG=""
          if [[ -f ".gitleaksignore" ]]; then
            IGNORE_ARG="--exclude-from .gitleaksignore"
          fi
          gitleaks detect \
            --verbose \
            --report-format sarif \
            --report-path gitleaks.sarif \
            --redact \
            $CONFIG_ARG $IGNORE_ARG \
            --source .
        continue-on-error: true

      # Upload SARIF to Code Scanning so alerts appear under Security tab
      - name: Upload SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks.sarif

      # Keep SARIF as an artifact for audit/compliance
      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-${{ github.sha }}
          path: gitleaks.sarif
          retention-days: 14

      # Fail the job if findings exist (based on SARIF presence & count)
      - name: Fail on findings
        if: always()
        run: |
          if [[ ! -s "gitleaks.sarif" ]]; then
            echo "No SARIF produced; assuming no findings."
            exit 0
          fi
          # Count results in SARIF
          COUNT=$(jq '[.runs[].results[]] | length' gitleaks.sarif 2>/dev/null || echo 0)
          echo "Gitleaks findings: $COUNT"
          if [[ "$COUNT" -gt 0 ]]; then
            echo "::error::Secrets detected by Gitleaks. See Security > Code scanning alerts."
            exit 1
          fi
