# .github/workflows/telemetry_export.yml
# üìä Kansas Frontier Matrix ‚Äî CI/CD & AI Telemetry Export
# v11.2.6 ‚Äî Diamond‚Åπ Œ© / Crown‚àûŒ© Ultimate Certified
#
# Purpose:
#   Aggregate CI/CD, governance, security, and AI/Focus Mode metrics into a
#   governed telemetry document (github-infra-telemetry.json), validate it
#   against telemetry schemas, and expose it as an artifact for releases.
#
# Governance Context:
#   - Telemetry schemas (github-workflows-v4, security-policy, energy, carbon)
#   - PROV-O/OpenLineage event modeling
#   - FAIR+CARE-aligned observability & sustainability reporting
#
# NOTE:
#   This workflow relies on repo-local scripts for the heavy lifting:
#     - scripts/aggregate_telemetry.py
#     - scripts/validate_telemetry.py   (optional)
#     - scripts/print_version.py        (optional, for version scoping)

name: üìä telemetry-export

on:
  # Run after key governed workflows complete
  workflow_run:
    workflows:
      - "üß™ ci"
      - "üìö docs-validate"
      - "üõ∞ stac-validate"
      - "üóÇ dcat-validate"
      - "üß¨ jsonld-validate"
      - "‚öñ faircare-validate"
      - "üßä h3-generalization"
      - "üîê security-audit"
      - "üì¶ sbom-verify"
      - "üîÅ data-pipeline"
      - "ü§ñ ai-behavior-check"
      - "üéØ focusmode-mlops"
      - "üåê site"
    types:
      - completed

  # Manual trigger for backfills / debugging
  workflow_dispatch: {}

# Avoid overlapping telemetry exports on the same commit
concurrency:
  group: telemetry-export-${{ github.event.workflow_run.head_sha || github.sha }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read

defaults:
  run:
    shell: bash

env:
  PYTHON_VERSION: "3.11"
  TELEMETRY_OUT: "github-infra-telemetry.json"
  TELEMETRY_SCHEMA_DIR: "schemas/telemetry"
  # Optional specialized schemas (if used by scripts)
  TELEMETRY_SCHEMA_MAIN: "schemas/telemetry/github-workflows-v4.json"
  TELEMETRY_SCHEMA_SECURITY: "schemas/telemetry/security-policy-v1.json"
  TELEMETRY_SCHEMA_ENERGY: "schemas/telemetry/energy-v2.json"
  TELEMETRY_SCHEMA_CARBON: "schemas/telemetry/carbon-v2.json"
  RELEASES_ROOT: "releases"

jobs:
  telemetry-export:
    name: "üìä Aggregate & Validate Telemetry"
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
      - name: üì• Checkout repository (same commit as triggering workflow)
        uses: actions/checkout@v4
        with:
          # Important for workflow_run: ensure we check out the workflow_run's commit
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}
          fetch-depth: 0

      - name: üêç Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            scripts/requirements-telemetry.txt

      - name: üì¶ Install Telemetry Tooling
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [[ -f scripts/requirements-telemetry.txt ]]; then
            pip install --no-cache-dir -r scripts/requirements-telemetry.txt
          elif [[ -f requirements.txt ]]; then
            pip install --no-cache-dir -r requirements.txt
          fi

      # --------------------------------------------------------------------
      # 1. Determine version scope (optional but recommended)
      # --------------------------------------------------------------------
      - name: üîñ Resolve Version (for releases/<version>/ wiring)
        id: version
        run: |
          set -euo pipefail
          ver="dev"
          if [[ -f scripts/print_version.py ]]; then
            if v=$(python scripts/print_version.py 2>/dev/null); then
              ver="${v}"
            fi
          fi
          echo "version=${ver}" >> "$GITHUB_OUTPUT"
          echo "Resolved telemetry version scope: ${ver}"

      # --------------------------------------------------------------------
      # 2. Aggregate telemetry
      # --------------------------------------------------------------------
      - name: üìä Aggregate Telemetry
        run: |
          set -euo pipefail
          if [[ ! -f scripts/aggregate_telemetry.py ]]; then
            echo "::error title=Missing telemetry aggregator::scripts/aggregate_telemetry.py not found."
            echo "This script is required to aggregate telemetry into ${TELEMETRY_OUT}."
            exit 1
          fi

          python scripts/aggregate_telemetry.py \
            --event-path "${GITHUB_EVENT_PATH}" \
            --schema-dir "${TELEMETRY_SCHEMA_DIR}" \
            --out "${TELEMETRY_OUT}" \
            --version "${{ steps.version.outputs.version }}" \
            --ref "${GITHUB_REF}" \
            --sha "${GITHUB_SHA}"

      # --------------------------------------------------------------------
      # 3. Validate telemetry JSON against schemas (optional hard gate)
      #    - If validation tools exist, they run as gates.
      #    - Artifact upload still happens via `if: always()`.
      # --------------------------------------------------------------------
      - name: ‚úÖ Validate Telemetry JSON (Preferred: Custom Script)
        if: always()
        run: |
          set -euo pipefail
          if [[ -f scripts/validate_telemetry.py ]]; then
            python scripts/validate_telemetry.py \
              --telemetry "${TELEMETRY_OUT}" \
              --schema "${TELEMETRY_SCHEMA_MAIN}" \
              --energy-schema "${TELEMETRY_SCHEMA_ENERGY}" \
              --carbon-schema "${TELEMETRY_SCHEMA_CARBON}" \
              --security-schema "${TELEMETRY_SCHEMA_SECURITY}"
          else
            echo "scripts/validate_telemetry.py not found; skipping custom validation."
          fi

      - name: ‚úÖ Validate Telemetry JSON (Fallback: schema-validate)
        if: always()
        run: |
          set -euo pipefail
          if [[ -d ".github/actions/schema-validate" ]]; then
            bash .github/actions/schema-validate/entrypoint.sh \
              "${TELEMETRY_SCHEMA_DIR}" \
              "${TELEMETRY_OUT}"
          else
            echo ".github/actions/schema-validate not found; skipping fallback telemetry schema validation."
          fi

      # --------------------------------------------------------------------
      # 4. Stage releases/<version>/github-infra-telemetry.json (workspace only)
      # --------------------------------------------------------------------
      - name: üìÅ Stage Version-Scoped Telemetry (Non-Commital)
        if: always()
        run: |
          set -euo pipefail
          ver="${{ steps.version.outputs.version }}"
          mkdir -p "${RELEASES_ROOT}/${ver}"
          cp "${TELEMETRY_OUT}" "${RELEASES_ROOT}/${ver}/github-infra-telemetry.json"
          echo "Staged telemetry at ${RELEASES_ROOT}/${ver}/github-infra-telemetry.json (workspace only)."

      # --------------------------------------------------------------------
      # 5. Upload telemetry artifacts (always)
      # --------------------------------------------------------------------
      - name: üì§ Upload Telemetry Artifact (Root)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: github-infra-telemetry
          path: ${{ env.TELEMETRY_OUT }}
          if-no-files-found: error

      - name: üì§ Upload Telemetry Artifact (Version-Scoped)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: github-infra-telemetry-${{ steps.version.outputs.version }}
          path: ${{ env.RELEASES_ROOT }}/${{ steps.version.outputs.version }}/github-infra-telemetry.json
          if-no-files-found: error

      # --------------------------------------------------------------------
      # 6. Telemetry Export Summary (for GitHub UI)
      # --------------------------------------------------------------------
      - name: üßæ Emit Telemetry Export Summary
        if: always()
        run: |
          set -euo pipefail
          {
            echo "## üìä Telemetry Export Summary"
            echo ""
            echo "- Triggered by workflow: \`${{ github.event.workflow_run.name || github.workflow }}\`"
            echo "- Trigger head branch: \`${{ github.event.workflow_run.head_branch || 'n/a' }}\`"
            echo "- Trigger head SHA: \`${{ github.event.workflow_run.head_sha || github.sha }}\`"
            echo "- Trigger conclusion: \`${{ github.event.workflow_run.conclusion || 'n/a' }}\`"
            echo "- Telemetry output: \`${TELEMETRY_OUT}\`"
            echo "- Version scope: \`${{ steps.version.outputs.version }}\`"
            echo "- Version-scoped path (workspace): \`${RELEASES_ROOT}/${{ steps.version.outputs.version }}/github-infra-telemetry.json\`"
            echo ""
            echo "This workflow aggregates governed CI/CD, governance, security, AI, and Focus Mode"
            echo "signals into a single telemetry document suitable for release packaging and"
            echo "observability dashboards."
          } >> "${GITHUB_STEP_SUMMARY}"
