# .github/workflows/telemetry_export.yml
# üìä Kansas Frontier Matrix ‚Äî CI/CD & AI Telemetry Export
# v11.2.6 ‚Äî Diamond‚Åπ Œ© / Crown‚àûŒ© Ultimate Certified
#
# Purpose:
#   Aggregate CI/CD, governance, security, and AI/Focus Mode metrics into a
#   governed telemetry document (github-infra-telemetry.json), validate it
#   against telemetry schemas, and expose it as an artifact for releases.
#
# Governance Context:
#   - Telemetry schemas (github-workflows-v4, security-policy, energy, carbon)
#   - PROV-O/OpenLineage event modeling
#   - FAIR+CARE-aligned observability & sustainability reporting
#
# NOTE:
#   This workflow relies on repo-local scripts for the heavy lifting:
#     - scripts/aggregate_telemetry.py
#     - scripts/validate_telemetry.py   (optional; fallback validator included)
#     - scripts/print_version.py        (optional, for version scoping)

name: üìä telemetry-export

on:
  # Run after key governed workflows complete
  workflow_run:
    workflows:
      - "üß™ ci"
      - "üìö docs-validate"
      - "üõ∞ stac-validate"
      - "üóÇ dcat-validate"
      - "üß¨ jsonld-validate"
      - "‚öñ faircare-validate"
      - "üßä h3-generalization"
      - "üîê security-audit"
      - "üì¶ sbom-verify"
      - "üîÅ data-pipeline"
      - "ü§ñ ai-behavior-check"
      - "üéØ focusmode-mlops"
    types:
      - completed

  # Manual trigger for backfills / debugging
  workflow_dispatch:
    inputs:
      source_sha:
        description: "Optional: commit SHA to export telemetry for (backfill/debug)."
        required: false
        type: string
      source_run_id:
        description: "Optional: upstream workflow_run id to download artifacts from (backfill/debug)."
        required: false
        type: string

# Avoid overlapping telemetry exports on the same source revision
concurrency:
  group: telemetry-export-${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.event_name == 'workflow_dispatch' && github.event.inputs.source_sha || github.sha }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read

defaults:
  run:
    shell: bash

env:
  PYTHON_VERSION: "3.11"
  TELEMETRY_OUT: "github-infra-telemetry.json"
  TELEMETRY_SCHEMA_DIR: "schemas/telemetry"

  # Optional specialized schemas (if used by scripts / fallback validator)
  TELEMETRY_SCHEMA_MAIN: "schemas/telemetry/github-workflows-v4.json"
  TELEMETRY_SCHEMA_SECURITY: "schemas/telemetry/security-policy-v1.json"
  TELEMETRY_SCHEMA_ENERGY: "schemas/telemetry/energy-v2.json"
  TELEMETRY_SCHEMA_CARBON: "schemas/telemetry/carbon-v2.json"

  RELEASES_ROOT: "releases"
  UPSTREAM_ARTIFACTS_DIR: ".telemetry_upstream_artifacts"

jobs:
  telemetry-export:
    name: "üìä Aggregate & Validate Telemetry"
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
      - name: üß≠ Resolve Trigger Context (sha/ref/run_id)
        id: ctx
        run: |
          set -euo pipefail

          sha="${GITHUB_SHA}"
          ref="${GITHUB_REF}"
          run_id=""
          trigger_workflow="${GITHUB_WORKFLOW}"
          trigger_conclusion=""
          trigger_html_url=""

          if [[ "${GITHUB_EVENT_NAME}" == "workflow_run" ]]; then
            sha="$(jq -r '.workflow_run.head_sha' "${GITHUB_EVENT_PATH}")"
            branch="$(jq -r '.workflow_run.head_branch' "${GITHUB_EVENT_PATH}")"
            ref="refs/heads/${branch}"
            run_id="$(jq -r '.workflow_run.id' "${GITHUB_EVENT_PATH}")"
            trigger_workflow="$(jq -r '.workflow_run.name' "${GITHUB_EVENT_PATH}")"
            trigger_conclusion="$(jq -r '.workflow_run.conclusion' "${GITHUB_EVENT_PATH}")"
            trigger_html_url="$(jq -r '.workflow_run.html_url' "${GITHUB_EVENT_PATH}")"
          fi

          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            in_sha="$(jq -r '.inputs.source_sha // empty' "${GITHUB_EVENT_PATH}")"
            in_run_id="$(jq -r '.inputs.source_run_id // empty' "${GITHUB_EVENT_PATH}")"
            if [[ -n "${in_sha}" ]]; then
              sha="${in_sha}"
            fi
            if [[ -n "${in_run_id}" ]]; then
              run_id="${in_run_id}"
            fi
          fi

          echo "sha=${sha}" >> "${GITHUB_OUTPUT}"
          echo "ref=${ref}" >> "${GITHUB_OUTPUT}"
          echo "run_id=${run_id}" >> "${GITHUB_OUTPUT}"
          echo "trigger_workflow=${trigger_workflow}" >> "${GITHUB_OUTPUT}"
          echo "trigger_conclusion=${trigger_conclusion}" >> "${GITHUB_OUTPUT}"
          echo "trigger_html_url=${trigger_html_url}" >> "${GITHUB_OUTPUT}"

          echo "Resolved context:"
          echo "- sha: ${sha}"
          echo "- ref: ${ref}"
          echo "- upstream run_id: ${run_id:-<none>}"
          echo "- trigger workflow: ${trigger_workflow}"
          if [[ -n "${trigger_conclusion}" ]]; then
            echo "- trigger conclusion: ${trigger_conclusion}"
          fi

      - name: üì• Checkout repository (exact revision)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.ctx.outputs.sha }}

      - name: üêç Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            scripts/requirements-telemetry.txt

      - name: üì¶ Install Telemetry Tooling
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [[ -f scripts/requirements-telemetry.txt ]]; then
            pip install --no-cache-dir -r scripts/requirements-telemetry.txt
          elif [[ -f requirements.txt ]]; then
            pip install --no-cache-dir -r requirements.txt
          fi
          # Fallback validator dependency (safe even if already installed)
          pip install --no-cache-dir jsonschema

      # --------------------------------------------------------------------
      # 1. Determine version scope (optional but recommended)
      #    - Uses scripts/print_version.py if available; falls back to "dev".
      # --------------------------------------------------------------------
      - name: üîñ Resolve Version (for releases/<version>/ wiring)
        id: version
        run: |
          set -euo pipefail
          ver="dev"
          if [[ -f scripts/print_version.py ]]; then
            if v=$(python scripts/print_version.py 2>/dev/null); then
              ver="${v}"
            fi
          fi
          echo "version=${ver}" >> "${GITHUB_OUTPUT}"
          echo "Resolved telemetry version scope: ${ver}"

      # --------------------------------------------------------------------
      # 2. (Optional) Pull upstream artifacts from the triggering workflow_run
      # --------------------------------------------------------------------
      - name: ‚¨áÔ∏è Download Upstream Artifacts (workflow_run only)
        if: ${{ steps.ctx.outputs.run_id != '' }}
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          run_id="${{ steps.ctx.outputs.run_id }}"

          mkdir -p "${UPSTREAM_ARTIFACTS_DIR}"
          echo "Fetching artifacts for upstream run_id=${run_id} into ${UPSTREAM_ARTIFACTS_DIR}"

          gh api "/repos/${GH_REPO}/actions/runs/${run_id}/artifacts?per_page=100" --paginate \
            | jq -s '{artifacts: (map(.artifacts) | add)}' \
            > "${UPSTREAM_ARTIFACTS_DIR}/artifacts.json"

          total="$(jq -r '.artifacts | length' "${UPSTREAM_ARTIFACTS_DIR}/artifacts.json")"
          echo "Found ${total} upstream artifacts."
          if [[ "${total}" == "0" ]]; then
            exit 0
          fi

          jq -r '.artifacts[]
            | select(.expired == false)
            | "\(.id)\t\(.name)"' \
            "${UPSTREAM_ARTIFACTS_DIR}/artifacts.json" \
            | while IFS=$'\t' read -r artifact_id artifact_name; do
                zip_path="${UPSTREAM_ARTIFACTS_DIR}/${artifact_name}.zip"
                out_dir="${UPSTREAM_ARTIFACTS_DIR}/${artifact_name}"

                echo "Downloading artifact: ${artifact_name} (${artifact_id})"
                gh api "/repos/${GH_REPO}/actions/artifacts/${artifact_id}/zip" > "${zip_path}"

                mkdir -p "${out_dir}"
                unzip -q "${zip_path}" -d "${out_dir}"
              done

          echo "KFM_UPSTREAM_ARTIFACTS_DIR=${UPSTREAM_ARTIFACTS_DIR}" >> "${GITHUB_ENV}"

      # --------------------------------------------------------------------
      # 3. Aggregate telemetry
      # --------------------------------------------------------------------
      - name: üìä Aggregate Telemetry
        env:
          KFM_TRIGGER_WORKFLOW: ${{ steps.ctx.outputs.trigger_workflow }}
          KFM_TRIGGER_CONCLUSION: ${{ steps.ctx.outputs.trigger_conclusion }}
          KFM_TRIGGER_RUN_URL: ${{ steps.ctx.outputs.trigger_html_url }}
          KFM_TRIGGER_RUN_ID: ${{ steps.ctx.outputs.run_id }}
          KFM_VERSION_SCOPE: ${{ steps.version.outputs.version }}
        run: |
          set -euo pipefail

          if [[ ! -f scripts/aggregate_telemetry.py ]]; then
            echo "::error title=Missing telemetry aggregator::scripts/aggregate_telemetry.py not found."
            echo "This script is required to aggregate telemetry into ${TELEMETRY_OUT}."
            exit 1
          fi

          python scripts/aggregate_telemetry.py \
            --event-path "${GITHUB_EVENT_PATH}" \
            --schema-dir "${TELEMETRY_SCHEMA_DIR}" \
            --out "${TELEMETRY_OUT}" \
            --version "${{ steps.version.outputs.version }}" \
            --ref "${{ steps.ctx.outputs.ref }}" \
            --sha "${{ steps.ctx.outputs.sha }}"

          test -s "${TELEMETRY_OUT}"

      # --------------------------------------------------------------------
      # 4. Validate telemetry JSON against schemas (hard gate)
      # --------------------------------------------------------------------
      - name: ‚úÖ Validate Telemetry JSON
        run: |
          set -euo pipefail

          if [[ -f scripts/validate_telemetry.py ]]; then
            python scripts/validate_telemetry.py \
              --telemetry "${TELEMETRY_OUT}" \
              --schema "${TELEMETRY_SCHEMA_MAIN}" \
              --energy-schema "${TELEMETRY_SCHEMA_ENERGY}" \
              --carbon-schema "${TELEMETRY_SCHEMA_CARBON}"
            exit 0
          fi

          if [[ ! -f "${TELEMETRY_SCHEMA_MAIN}" ]]; then
            echo "::error title=Missing telemetry schema::${TELEMETRY_SCHEMA_MAIN} not found."
            exit 1
          fi

          python - "${TELEMETRY_SCHEMA_MAIN}" "${TELEMETRY_OUT}" <<'PY'
          import json
          import sys
          from pathlib import Path

          import jsonschema

          schema_path = Path(sys.argv[1])
          doc_path = Path(sys.argv[2])

          schema = json.loads(schema_path.read_text(encoding="utf-8"))
          doc = json.loads(doc_path.read_text(encoding="utf-8"))

          jsonschema.validate(instance=doc, schema=schema)
          print(f"OK: {doc_path} validates against {schema_path}")
          PY

      # --------------------------------------------------------------------
      # 5. Stage releases/<version>/github-infra-telemetry.json (workspace only)
      # --------------------------------------------------------------------
      - name: üìÅ Stage Version-Scoped Telemetry (Workspace Only)
        run: |
          set -euo pipefail
          ver="${{ steps.version.outputs.version }}"
          mkdir -p "${RELEASES_ROOT}/${ver}"
          cp "${TELEMETRY_OUT}" "${RELEASES_ROOT}/${ver}/github-infra-telemetry.json"
          echo "Staged telemetry at ${RELEASES_ROOT}/${ver}/github-infra-telemetry.json (workspace only)."

      # --------------------------------------------------------------------
      # 6. Upload telemetry artifacts
      # --------------------------------------------------------------------
      - name: üì§ Upload Telemetry Artifact (Root)
        uses: actions/upload-artifact@v4
        with:
          name: github-infra-telemetry
          path: ${{ env.TELEMETRY_OUT }}
          if-no-files-found: error

      - name: üì§ Upload Telemetry Artifact (Version-Scoped)
        uses: actions/upload-artifact@v4
        with:
          name: github-infra-telemetry-${{ steps.version.outputs.version }}
          path: ${{ env.RELEASES_ROOT }}/${{ steps.version.outputs.version }}/github-infra-telemetry.json
          if-no-files-found: error

      - name: üì§ Upload Upstream Artifact Index (Optional)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: telemetry-upstream-artifacts-index
          path: ${{ env.UPSTREAM_ARTIFACTS_DIR }}/artifacts.json
          if-no-files-found: ignore

      # --------------------------------------------------------------------
      # 7. Telemetry Export Summary (for GitHub UI)
      # --------------------------------------------------------------------
      - name: üßæ Emit Telemetry Export Summary
        if: always()
        run: |
          set -euo pipefail

          {
            echo "## üìä Telemetry Export Summary"
            echo ""
            echo "- Event: \`${GITHUB_EVENT_NAME}\`"
            echo "- Trigger workflow: \`${{ steps.ctx.outputs.trigger_workflow }}\`"
            if [[ -n "${{ steps.ctx.outputs.trigger_conclusion }}" ]]; then
              echo "- Trigger conclusion: \`${{ steps.ctx.outputs.trigger_conclusion }}\`"
            fi
            if [[ -n "${{ steps.ctx.outputs.trigger_html_url }}" ]]; then
              echo "- Trigger run: ${{ steps.ctx.outputs.trigger_html_url }}"
            fi
            echo "- Telemetry output: \`${TELEMETRY_OUT}\`"
            echo "- Version scope: \`${{ steps.version.outputs.version }}\`"
            echo "- Version-scoped path (workspace): \`${RELEASES_ROOT}/${{ steps.version.outputs.version }}/github-infra-telemetry.json\`"
            if [[ -n "${{ steps.ctx.outputs.run_id }}" ]]; then
              echo "- Upstream run_id (artifact pull): \`${{ steps.ctx.outputs.run_id }}\`"
              echo "- Upstream artifacts dir (workspace): \`${UPSTREAM_ARTIFACTS_DIR}\`"
            fi
            echo ""
            echo "This workflow aggregates governed CI/CD, governance, security, AI, and Focus Mode signals"
            echo "into a single telemetry document suitable for release packaging and observability dashboards."
          } >> "${GITHUB_STEP_SUMMARY}"
