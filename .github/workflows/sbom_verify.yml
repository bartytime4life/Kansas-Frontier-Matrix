# .github/workflows/sbom_verify.yml
# ðŸ“¦ Kansas Frontier Matrix â€” SBOM, Manifest & SLSA Attestation Verification
# v11.2.6 â€” Diamondâ¹ Î© / CrownâˆžÎ© Ultimate Certified
#
# Purpose:
#   Verify that each governed release has:
#     - A valid SPDX SBOM (sbom*.spdx.json)
#     - A matching release manifest (manifest.zip or manifest.json)
#     - Valid signatures and/or attestations (signature.sig, slsa-attestation.json)
#   and that these artifacts are internally consistent and policy-compliant.
#
# Governance Context:
#   - SECURITY.md (supply-chain & SBOM policy)
#   - KFM-STAC / KFM-DCAT for cataloging release artifacts
#   - SLSA provenance guidance (OpenLineage + PROV-O integration)
#
# Core enforcement is delegated to local scripts:
#   - scripts/verify_supply_chain.py        (hard gate)
#   - scripts/verify_sbom_spdx.py          (optional SPDX structural checks)
#   - scripts/collect_sbom_metrics.py      (optional metrics for telemetry)

name: ðŸ“¦ sbom-verify

on:
  pull_request:
    paths:
      - "releases/**"
      - "docs/security/**"
      - "docs/data/**"
      - "schemas/sbom/**"
      - "scripts/verify_supply_chain.py"
      - "scripts/verify_sbom_*"
      - ".github/workflows/sbom_verify.yml"
  push:
    branches:
      - main
      - "release/**"
    paths:
      - "releases/**"
      - "docs/security/**"
      - "docs/data/**"
      - "schemas/sbom/**"
      - "scripts/verify_supply_chain.py"
      - "scripts/verify_sbom_*"
      - ".github/workflows/sbom_verify.yml"
  schedule:
    # Weekly verification of latest releases on default branch
    - cron: "30 1 * * 0"
  workflow_dispatch: {}

# Avoid overlapping SBOM verification runs on the same ref
concurrency:
  group: sbom-verify-${{ github.ref }}
  cancel-in-progress: true

# Least privilege: this workflow reads repo content and uploads artifacts only.
permissions:
  contents: read
  actions: read

defaults:
  run:
    shell: bash

env:
  PYTHON_VERSION: "3.11"
  RELEASES_ROOT: "releases"
  SBOM_SCHEMA_DIR: "schemas/sbom"

  # Discovery + outputs
  SBOM_GLOB: "sbom*.spdx.json"
  SBOM_METRICS_OUT: "sbom-verify-metrics.json"

  # Optional report hooks (only uploaded if created by scripts)
  SUPPLY_CHAIN_REPORT_OUT: "supply-chain-verify-report.json"
  SPDX_REPORT_OUT: "spdx-verify-report.json"

jobs:
  sbom-verify:
    name: "ðŸ“¦ SBOM / Manifest / SLSA Verification"
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # --------------------------------------------------------------------
      # 0. Detect whether there is anything to verify
      # --------------------------------------------------------------------
      - name: ðŸ”Ž Detect Release Artifacts
        id: detect_releases
        run: |
          set -euo pipefail

          if [[ ! -d "${RELEASES_ROOT}" ]]; then
            echo "has_releases=false" >> "$GITHUB_OUTPUT"
            echo "sbom_count=0" >> "$GITHUB_OUTPUT"
            echo "::notice title=SBOM verify::No ${RELEASES_ROOT} directory found; skipping."
            exit 0
          fi

          # Count matching SBOMs to make decision deterministic & visible
          sbom_count="$(find "${RELEASES_ROOT}" -type f -name "${SBOM_GLOB}" | wc -l | tr -d ' ')"
          echo "sbom_count=${sbom_count}" >> "$GITHUB_OUTPUT"

          if [[ "${sbom_count}" -gt 0 ]]; then
            echo "has_releases=true" >> "$GITHUB_OUTPUT"
            echo "Found ${sbom_count} SBOM file(s) matching ${SBOM_GLOB} under ${RELEASES_ROOT}."
          else
            echo "has_releases=false" >> "$GITHUB_OUTPUT"
            echo "::notice title=SBOM verify::No ${SBOM_GLOB} files found under ${RELEASES_ROOT}; skipping."
          fi

      - name: â­ Skip SBOM verification (no releases with SBOM)
        if: steps.detect_releases.outputs.has_releases == 'false'
        run: |
          echo "No releases with SBOMs detected; nothing to verify for this run."

      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        if: steps.detect_releases.outputs.has_releases == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            scripts/requirements-sbom.txt

      - name: ðŸ“¦ Install SBOM Verification Tooling
        if: steps.detect_releases.outputs.has_releases == 'true'
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [[ -f scripts/requirements-sbom.txt ]]; then
            pip install --no-cache-dir -r scripts/requirements-sbom.txt
          else
            # Minimal default helpers if a dedicated requirements file is not present
            pip install --no-cache-dir "jsonschema" "python-dateutil" || echo "Optional SBOM deps failed; continuing if not strictly required by scripts."
          fi

      # --------------------------------------------------------------------
      # 1. Optional schema validation for SBOM JSON (best-effort)
      # --------------------------------------------------------------------
      - name: ðŸ§¾ Validate SPDX SBOM Files Against Schema (Best-Effort)
        if: steps.detect_releases.outputs.has_releases == 'true'
        continue-on-error: true
        run: |
          set -euo pipefail

          if [[ -d ".github/actions/schema-validate" && -d "${SBOM_SCHEMA_DIR}" ]]; then
            echo "Running schema validation for SBOMs under ${RELEASES_ROOT} using ${SBOM_SCHEMA_DIR}."
            bash .github/actions/schema-validate/entrypoint.sh "${SBOM_SCHEMA_DIR}" "${RELEASES_ROOT}"
          else
            echo "Schema validation skipped (schema-validate action or ${SBOM_SCHEMA_DIR} missing)."
          fi

      # --------------------------------------------------------------------
      # 2. Hard Gate: Supply-Chain / SBOM Consistency Check
      # --------------------------------------------------------------------
      - name: ðŸ›¡ Verify Supply Chain Artifacts (Hard Gate)
        if: steps.detect_releases.outputs.has_releases == 'true'
        run: |
          set -euo pipefail

          if [[ ! -f scripts/verify_supply_chain.py ]]; then
            echo "::error title=Missing verifier::scripts/verify_supply_chain.py not found."
            echo "This script is required to enforce SBOM/manifest/attestation policy."
            exit 1
          fi

          python scripts/verify_supply_chain.py \
            --releases-root "${RELEASES_ROOT}"

      - name: ðŸ“¤ Upload Supply-Chain Verification Report (Optional)
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: supply-chain-verify-report
          path: ${{ env.SUPPLY_CHAIN_REPORT_OUT }}
          if-no-files-found: ignore

      # --------------------------------------------------------------------
      # 3. Optional: Fine-grained SPDX / SBOM Content Checks
      # --------------------------------------------------------------------
      - name: ðŸ“ Optional SPDX / SBOM Content Checks
        if: steps.detect_releases.outputs.has_releases == 'true'
        continue-on-error: true
        run: |
          set -euo pipefail

          if [[ -f scripts/verify_sbom_spdx.py ]]; then
            python scripts/verify_sbom_spdx.py \
              --releases-root "${RELEASES_ROOT}"
          else
            echo "scripts/verify_sbom_spdx.py not found; skipping fine-grained SPDX checks."
          fi

      - name: ðŸ“¤ Upload SPDX Verification Report (Optional)
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: spdx-verify-report
          path: ${{ env.SPDX_REPORT_OUT }}
          if-no-files-found: ignore

      # --------------------------------------------------------------------
      # 4. Optional: SBOM/Supply-Chain Metrics for Telemetry
      # --------------------------------------------------------------------
      - name: ðŸ“Š Optional SBOM Metrics Collection
        if: steps.detect_releases.outputs.has_releases == 'true'
        continue-on-error: true
        run: |
          set -euo pipefail

          if [[ -f scripts/collect_sbom_metrics.py ]]; then
            python scripts/collect_sbom_metrics.py \
              --releases-root "${RELEASES_ROOT}" \
              --out "${SBOM_METRICS_OUT}"
          else
            echo "scripts/collect_sbom_metrics.py not found; skipping SBOM metrics export."
          fi

      - name: ðŸ“¤ Upload SBOM Metrics Artifact (Optional)
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: sbom-verify-metrics
          path: ${{ env.SBOM_METRICS_OUT }}
          if-no-files-found: ignore

      # --------------------------------------------------------------------
      # 5. SBOM Verification Summary (for GitHub UI & telemetry_export.yml)
      # --------------------------------------------------------------------
      - name: ðŸ§¾ Emit SBOM Verification Summary
        if: always()
        run: |
          set -euo pipefail
          {
            echo "## ðŸ“¦ SBOM / Manifest / SLSA Verification Summary"
            echo ""
            echo "- Releases root: \`${RELEASES_ROOT}\`"
            echo "- SBOM glob: \`${SBOM_GLOB}\`"
            echo "- SBOM count: \`${{ steps.detect_releases.outputs.sbom_count }}\`"
            echo "- Releases with SBOM present: \`${{ steps.detect_releases.outputs.has_releases }}\`"
            echo "- SBOM schema dir: \`${SBOM_SCHEMA_DIR}\`"
            echo ""
            echo "Hard gate:"
            echo "- \`scripts/verify_supply_chain.py\` (required) enforces SBOM/manifest/attestation policy."
            echo ""
            echo "Optional checks:"
            echo "- \`scripts/verify_sbom_spdx.py\` (fine-grained SPDX checks)"
            echo "- \`scripts/collect_sbom_metrics.py\` (metrics for telemetry_export.yml)"
            echo ""
            echo "Optional artifacts (only if produced by scripts):"
            echo "- \`${SUPPLY_CHAIN_REPORT_OUT}\`"
            echo "- \`${SPDX_REPORT_OUT}\`"
            echo "- \`${SBOM_METRICS_OUT}\`"
          } >> "${GITHUB_STEP_SUMMARY}"
