# .github/workflows/data_pipeline.yml
# ðŸ” Kansas Frontier Matrix â€” Data Pipeline Contracts & Lineage Governance
# v11.2.6 â€” Stable / Governed (KFM-PDC v11)
#
# Purpose:
#   Enforce governed, deterministic ETL / data pipeline behavior across KFM by:
#     - Validating pipeline configs against KFM-PDC v11 contracts
#     - Executing CI-safe dry-runs (stage/test mode; no prod side effects)
#     - Validating lineage / OpenLineage outputs and PROV-O consistency
#     - Emitting optional metrics for downstream telemetry_export.yml
#
# Governance Context:
#   - KFM-PDC v11 (data pipeline & contract spec)
#   - KFM-STAC v11 / KFM-DCAT v11 (catalogued outputs; validated separately)
#   - PROV-O + OpenLineage event modeling (validated/used in jsonld_validate.yml)
#   - FAIR+CARE & sovereignty (faircare_validate.yml, h3_generalization.yml)

name: ðŸ” data-pipeline

on:
  pull_request:
    branches:
      - main
      - "release/**"
    paths:
      - "src/pipelines/**"
      - "src/etl/**"
      - "config/pipelines/**"
      - "config/etl/**"
      - "schemas/pipelines/**"
      - "data/raw/**"
      - "data/work/**"
      - "data/processed/**"
      - "scripts/validate_pipelines.py"
      - "scripts/run_etl_dryrun.py"
      - "scripts/validate_lineage.py"
      - "scripts/collect_pipeline_metrics.py"
      - ".github/actions/schema-validate/**"
      - ".github/workflows/data_pipeline.yml"
  push:
    branches:
      - main
      - "release/**"
    paths:
      - "src/pipelines/**"
      - "src/etl/**"
      - "config/pipelines/**"
      - "config/etl/**"
      - "schemas/pipelines/**"
      - "data/raw/**"
      - "data/work/**"
      - "data/processed/**"
      - "scripts/validate_pipelines.py"
      - "scripts/run_etl_dryrun.py"
      - "scripts/validate_lineage.py"
      - "scripts/collect_pipeline_metrics.py"
      - ".github/actions/schema-validate/**"
      - ".github/workflows/data_pipeline.yml"
  schedule:
    # Nightly contract & dry-run validation on default branch
    - cron: "15 3 * * *"
  workflow_dispatch: {}

# Avoid overlapping pipeline governance runs on the same ref
concurrency:
  group: data-pipeline-${{ github.ref }}
  cancel-in-progress: true

# Minimal permissions (no write required for this workflow)
permissions:
  contents: read

defaults:
  run:
    shell: bash

env:
  PYTHON_VERSION: "3.11"

  # Determinism / reproducibility knobs (scripts may optionally read these)
  TZ: "UTC"
  PYTHONHASHSEED: "0"
  KFM_RUN_MODE: "ci"
  KFM_ENV: "stage"

  # Tunable paths; align with repo layout
  KFM_PIPELINE_CONFIG_ROOT: "config/pipelines"
  KFM_PIPELINE_SCHEMA_DIR: "schemas/pipelines"
  KFM_PIPELINE_SRC_ROOT: "src/pipelines"
  KFM_ETL_SRC_ROOT: "src/etl"

  KFM_DATA_RAW_ROOT: "data/raw"
  KFM_DATA_WORK_ROOT: "data/work"
  KFM_DATA_PROCESSED_ROOT: "data/processed"

  # Optional metrics file picked up by telemetry_export.yml
  KFM_PIPELINE_METRICS_OUT: "data-pipeline-metrics.json"

jobs:
  ###########################################################################
  # 1. Pipeline Config & Contract Validation (KFM-PDC v11)
  ###########################################################################
  pipeline-contracts:
    name: "ðŸ§¾ Pipeline Contract Validation (KFM-PDC v11)"
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    outputs:
      has_configs: ${{ steps.detect.outputs.has_configs }}
      has_schemas: ${{ steps.detect.outputs.has_schemas }}
      has_sources: ${{ steps.detect.outputs.has_sources }}

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ”Ž Detect pipeline inputs (configs / schemas / sources)
        id: detect
        run: |
          set -euo pipefail

          has_configs="false"
          if [[ -d "${KFM_PIPELINE_CONFIG_ROOT}" ]]; then
            if find "${KFM_PIPELINE_CONFIG_ROOT}" -type f \( -name "*.yml" -o -name "*.yaml" -o -name "*.json" \) | grep -q .; then
              has_configs="true"
            fi
          fi

          has_schemas="false"
          if [[ -d "${KFM_PIPELINE_SCHEMA_DIR}" ]]; then
            if find "${KFM_PIPELINE_SCHEMA_DIR}" -type f -name "*.json" | grep -q .; then
              has_schemas="true"
            fi
          fi

          has_sources="false"
          if [[ -d "${KFM_PIPELINE_SRC_ROOT}" || -d "${KFM_ETL_SRC_ROOT}" ]]; then
            has_sources="true"
          fi

          echo "has_configs=${has_configs}" >> "$GITHUB_OUTPUT"
          echo "has_schemas=${has_schemas}" >> "$GITHUB_OUTPUT"
          echo "has_sources=${has_sources}" >> "$GITHUB_OUTPUT"

          echo "Detected:"
          echo "  - configs: ${has_configs} (${KFM_PIPELINE_CONFIG_ROOT})"
          echo "  - schemas: ${has_schemas} (${KFM_PIPELINE_SCHEMA_DIR})"
          echo "  - sources: ${has_sources} (${KFM_PIPELINE_SRC_ROOT} / ${KFM_ETL_SRC_ROOT})"

      - name: â­ Skip contracts (no pipeline configs present)
        if: steps.detect.outputs.has_configs == 'false'
        run: |
          echo "No pipeline configs found under ${KFM_PIPELINE_CONFIG_ROOT}; contract validation is a no-op."

      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        if: steps.detect.outputs.has_configs == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            scripts/requirements-pipelines.txt

      - name: ðŸ“¦ Install Pipeline Tooling
        if: steps.detect.outputs.has_configs == 'true'
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [[ -f scripts/requirements-pipelines.txt ]]; then
            pip install --no-cache-dir -r scripts/requirements-pipelines.txt
          elif [[ -f requirements.txt ]]; then
            pip install --no-cache-dir -r requirements.txt
          else
            echo "::warning::No requirements file found; assuming pipeline validators are self-contained."
          fi

      - name: ðŸ§¬ Validate Pipeline Config Schemas (KFM-PDC v11)
        if: steps.detect.outputs.has_configs == 'true'
        run: |
          set -euo pipefail

          if [[ ! -d ".github/actions/schema-validate" ]]; then
            echo "::error title=Missing schema validator::.github/actions/schema-validate not found."
            exit 1
          fi

          if [[ "${{ steps.detect.outputs.has_schemas }}" != "true" ]]; then
            echo "::error title=Missing pipeline schemas::${KFM_PIPELINE_SCHEMA_DIR} has no JSON schemas."
            echo "KFM-PDC contract validation requires governed schemas under ${KFM_PIPELINE_SCHEMA_DIR}."
            exit 1
          fi

          bash .github/actions/schema-validate/entrypoint.sh \
            "${KFM_PIPELINE_SCHEMA_DIR}" \
            "${KFM_PIPELINE_CONFIG_ROOT}"

      - name: âœ… Validate Pipeline Contract Semantics (Required)
        if: steps.detect.outputs.has_configs == 'true'
        run: |
          set -euo pipefail
          if [[ ! -f scripts/validate_pipelines.py ]]; then
            echo "::error title=Missing contract validator::scripts/validate_pipelines.py not found."
            echo "Governed pipelines require semantic contract validation."
            exit 1
          fi

          python scripts/validate_pipelines.py \
            --config-root "${KFM_PIPELINE_CONFIG_ROOT}" \
            --src-root "${KFM_PIPELINE_SRC_ROOT}"

  ###########################################################################
  # 2. Pipeline Dry-Run / Tests (Stage)
  ###########################################################################
  pipeline-dryrun:
    name: "ðŸ§ª Pipeline Dry-Run & Tests (Stage)"
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    needs:
      - pipeline-contracts

    if: needs.pipeline-contracts.outputs.has_configs == 'true' && needs.pipeline-contracts.outputs.has_sources == 'true'

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            scripts/requirements-pipelines.txt

      - name: ðŸ“¦ Install Pipeline Runtime Dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [[ -f scripts/requirements-pipelines.txt ]]; then
            pip install --no-cache-dir -r scripts/requirements-pipelines.txt
          elif [[ -f requirements.txt ]]; then
            pip install --no-cache-dir -r requirements.txt
          else
            echo "::warning::No requirements file found; dry-run may fail if dependencies are missing."
          fi

      - name: ðŸ§ª Run Pipeline Dry-Run (CI Stage Mode)
        run: |
          set -euo pipefail
          if [[ ! -f scripts/run_etl_dryrun.py ]]; then
            echo "::error title=Missing dry-run runner::scripts/run_etl_dryrun.py not found."
            echo "Governed pipelines require a CI-safe dry-run entrypoint."
            exit 1
          fi

          python scripts/run_etl_dryrun.py \
            --config-root "${KFM_PIPELINE_CONFIG_ROOT}" \
            --src-root "${KFM_PIPELINE_SRC_ROOT}" \
            --raw-root "${KFM_DATA_RAW_ROOT}" \
            --work-root "${KFM_DATA_WORK_ROOT}" \
            --processed-root "${KFM_DATA_PROCESSED_ROOT}" \
            --mode "ci-stage"

  ###########################################################################
  # 3. Lineage / OpenLineage / PROV-O Validation
  ###########################################################################
  pipeline-lineage:
    name: "ðŸ“¡ Lineage & OpenLineage / PROV-O Validation"
    runs-on: ubuntu-22.04
    timeout-minutes: 40
    needs:
      - pipeline-contracts
      - pipeline-dryrun

    # Run whenever dryrun was attempted (even if it failed), but skip if dryrun was skipped
    if: always() && needs.pipeline-dryrun.result != 'skipped'

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            scripts/requirements-pipelines.txt

      - name: ðŸ“¦ Install Lineage Tooling
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [[ -f scripts/requirements-pipelines.txt ]]; then
            pip install --no-cache-dir -r scripts/requirements-pipelines.txt
          elif [[ -f requirements.txt ]]; then
            pip install --no-cache-dir -r requirements.txt
          else
            echo "::warning::No requirements file found; lineage validation may fail if deps are missing."
          fi

      - name: ðŸ“¡ Validate Lineage & OpenLineage Events (Required)
        run: |
          set -euo pipefail
          if [[ ! -f scripts/validate_lineage.py ]]; then
            echo "::error title=Missing lineage validator::scripts/validate_lineage.py not found."
            echo "Governed pipelines require lineage validation (OpenLineage / PROV-O alignment)."
            exit 1
          fi

          python scripts/validate_lineage.py \
            --config-root "${KFM_PIPELINE_CONFIG_ROOT}" \
            --src-root "${KFM_PIPELINE_SRC_ROOT}" \
            --data-root "${KFM_DATA_PROCESSED_ROOT}"

      - name: ðŸ“Š Optional Pipeline Metrics Collection
        continue-on-error: true
        run: |
          set -euo pipefail
          if [[ -f scripts/collect_pipeline_metrics.py ]]; then
            python scripts/collect_pipeline_metrics.py \
              --config-root "${KFM_PIPELINE_CONFIG_ROOT}" \
              --data-root "${KFM_DATA_PROCESSED_ROOT}" \
              --out "${KFM_PIPELINE_METRICS_OUT}"
          else
            echo "scripts/collect_pipeline_metrics.py not found; skipping pipeline metrics export."
          fi

      - name: ðŸ“¤ Upload Pipeline Metrics Artifact (Optional)
        if: success() || failure()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: data-pipeline-metrics
          path: ${{ env.KFM_PIPELINE_METRICS_OUT }}
          if-no-files-found: ignore

  ###########################################################################
  # 4. Summary (for GitHub UI & telemetry_export.yml)
  ###########################################################################
  pipeline-summary:
    name: "ðŸ§¾ Data Pipeline Governance Summary"
    runs-on: ubuntu-22.04
    needs:
      - pipeline-contracts
      - pipeline-dryrun
      - pipeline-lineage
    if: always()

    steps:
      - name: ðŸ§¾ Emit Data Pipeline Summary
        run: |
          set -euo pipefail
          {
            echo "## ðŸ” Data Pipeline Governance Summary"
            echo ""
            echo "- Contract validation: ${{ needs.pipeline-contracts.result }}"
            echo "- Dry-run: ${{ needs.pipeline-dryrun.result }}"
            echo "- Lineage validation: ${{ needs.pipeline-lineage.result }}"
            echo ""
            echo "Detected inputs:"
            echo "- Pipeline configs present: \`${{ needs.pipeline-contracts.outputs.has_configs }}\`"
            echo "- Pipeline schemas present: \`${{ needs.pipeline-contracts.outputs.has_schemas }}\`"
            echo "- Pipeline sources present: \`${{ needs.pipeline-contracts.outputs.has_sources }}\`"
            echo ""
            echo "This workflow enforces KFM-PDC v11 data contracts, runs CI-safe pipeline dry-runs,"
            echo "and validates lineage (OpenLineage / PROV-O alignment) as part of the governed CI/CD plan."
          } >> "${GITHUB_STEP_SUMMARY}"
