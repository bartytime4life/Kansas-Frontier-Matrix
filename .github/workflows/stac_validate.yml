# .github/workflows/stac_validate.yml
# ðŸ›° Kansas Frontier Matrix â€” STAC Collections & Items Validation
# v11.2.6 â€” Diamondâ¹ Î© / CrownâˆžÎ© Ultimate Certified
#
# Purpose:
#   Validate all STAC Collections/Items under data/stac/** against:
#     - Official STAC 1.x JSON Schemas (KFM-STAC v11 profile)
#     - Local STAC extensions & schema-map overrides (if configured)
#     - Basic geometry & bbox consistency checks (optional)
#
# Governance Context:
#   - KFM-STAC v11 profile (Collections, Items, Catalogs)
#   - KFM-MDP v11.2.6 (docs for STAC metadata live under docs/data/**)
#   - FAIR+CARE & sovereignty rules (enforced more deeply in faircare_validate.yml + h3-generalization.yml)
#   - PROV-O / OpenLineage: this workflow emits structured metrics for telemetry_export.yml

name: ðŸ›° stac-validate

on:
  pull_request:
    paths:
      - "data/stac/**"
      - "schemas/stac/**"
      - ".github/actions/stac-validate/**"
      - ".github/workflows/stac_validate.yml"
  push:
    branches:
      - main
      - "release/**"
    paths:
      - "data/stac/**"
      - "schemas/stac/**"
      - ".github/actions/stac-validate/**"
      - ".github/workflows/stac_validate.yml"
  workflow_dispatch: {}

# Ensure we don't have overlapping STAC validation runs per ref
concurrency:
  group: stac-validate-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read

defaults:
  run:
    shell: bash

env:
  STAC_ROOT: "data/stac"
  STAC_SCHEMA_DIR: "schemas/stac"
  PYTHON_VERSION: "3.11"
  STAC_VALIDATE_METRICS_OUT: "stac-validate-metrics.json"

jobs:
  stac-validate:
    name: "ðŸ›° STAC 1.x Validation (KFM-STAC v11)"
    runs-on: ubuntu-22.04
    timeout-minutes: 40

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # Optional: short-circuit if STAC_ROOT does not exist (e.g., early repo state)
      - name: ðŸ”Ž Check for STAC directory
        id: detect_stac
        run: |
          set -euo pipefail
          if [[ -d "${STAC_ROOT}" ]]; then
            echo "has_stac=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_stac=false" >> "$GITHUB_OUTPUT"
            echo "::notice title=STAC validation::No ${STAC_ROOT} directory present; skipping."
          fi

      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            scripts/requirements-stac.txt

      - name: ðŸ“¦ Install STAC Validation Tooling (Optional)
        if: steps.detect_stac.outputs.has_stac == 'true'
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          # Keep installs lightweight; prefer an optional dedicated requirements file.
          if [[ -f scripts/requirements-stac.txt ]]; then
            pip install --no-cache-dir -r scripts/requirements-stac.txt
          fi

      # --------------------------------------------------------------------
      # 1. STAC structural & schema validation via repo-local composite entrypoint
      #
      # Design:
      #   - Capture exit code deterministically
      #   - Always continue to emit metrics + upload artifacts
      #   - Fail the job in a dedicated final "gate" step
      # --------------------------------------------------------------------
      - name: ðŸ›° Run STAC Validator (Repo-Local Composite Entrypoint)
        id: stac_validator
        if: steps.detect_stac.outputs.has_stac == 'true'
        run: |
          set -euo pipefail

          exit_code=0
          entry=".github/actions/stac-validate/entrypoint.sh"

          if [[ ! -f "${entry}" ]]; then
            echo "::error title=Missing stac-validate action::Expected ${entry} to exist."
            exit_code=1
          else
            set +e
            bash "${entry}" "${STAC_ROOT}" "${STAC_SCHEMA_DIR}"
            exit_code=$?
            set -e
          fi

          echo "exit_code=${exit_code}" >> "$GITHUB_OUTPUT"

          if [[ "${exit_code}" -eq 0 ]]; then
            echo "STAC validation: PASS"
          else
            echo "STAC validation: FAIL (exit ${exit_code})"
          fi

          # Always succeed here so we can emit metrics + upload artifacts.
          exit 0

      # --------------------------------------------------------------------
      # 2. Optional: Geometry & bbox best-practices checks (advanced)
      #    Not a hard gate by default; emits exit codes into metrics.
      # --------------------------------------------------------------------
      - name: ðŸ“ Optional STAC Geometry & BBox Checks
        id: geom
        if: steps.detect_stac.outputs.has_stac == 'true'
        run: |
          set -euo pipefail
          exit_code=0

          if [[ -f scripts/validate_stac_geometry.py ]]; then
            python -m pip install --upgrade pip
            pip install --no-cache-dir "stac-check" || true

            set +e
            python scripts/validate_stac_geometry.py --root "${STAC_ROOT}"
            exit_code=$?
            set -e
          else
            echo "No scripts/validate_stac_geometry.py found; skipping geometry/bbox detail checks."
          fi

          echo "exit_code=${exit_code}" >> "$GITHUB_OUTPUT"
          exit 0

      # --------------------------------------------------------------------
      # 3. Optional: STAC API validation (if STAC API config present)
      #    This is for validating a running STAC API, not local JSON only.
      # --------------------------------------------------------------------
      - name: ðŸŒ Optional STAC API Validation
        id: api
        if: steps.detect_stac.outputs.has_stac == 'true'
        run: |
          set -euo pipefail
          exit_code=0

          if [[ -f scripts/validate_stac_api.py ]]; then
            python -m pip install --upgrade pip
            pip install --no-cache-dir "stac-api-validator" || true

            set +e
            python scripts/validate_stac_api.py
            exit_code=$?
            set -e
          else
            echo "No scripts/validate_stac_api.py found; skipping STAC API validation."
          fi

          echo "exit_code=${exit_code}" >> "$GITHUB_OUTPUT"
          exit 0

      # --------------------------------------------------------------------
      # 4. Emit structured metrics for telemetry_export.yml (always)
      # --------------------------------------------------------------------
      - name: ðŸ“ˆ Write STAC Validation Metrics (for telemetry)
        if: always()
        run: |
          set -euo pipefail

          has_stac="${{ steps.detect_stac.outputs.has_stac }}"
          validator_exit="${{ steps.stac_validator.outputs.exit_code || '0' }}"
          geom_exit="${{ steps.geom.outputs.exit_code || '0' }}"
          api_exit="${{ steps.api.outputs.exit_code || '0' }}"

          json_count=0
          if [[ "${has_stac}" == "true" ]]; then
            json_count="$(find "${STAC_ROOT}" -type f -name '*.json' | wc -l | tr -d ' ')"
          fi

          now="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          status="pass"
          if [[ "${has_stac}" == "true" && "${validator_exit}" != "0" ]]; then
            status="fail"
          fi

          cat > "${STAC_VALIDATE_METRICS_OUT}" <<JSON
          {
            "schema": "kfm.telemetry.stac_validate.v1",
            "generated_at_utc": "${now}",
            "repo": "${GITHUB_REPOSITORY}",
            "ref": "${GITHUB_REF}",
            "sha": "${GITHUB_SHA}",
            "run_id": "${GITHUB_RUN_ID}",
            "run_attempt": "${GITHUB_RUN_ATTEMPT}",
            "workflow": "${GITHUB_WORKFLOW}",
            "job": "${GITHUB_JOB}",
            "stac": {
              "root": "${STAC_ROOT}",
              "schema_dir": "${STAC_SCHEMA_DIR}",
              "has_stac": ${has_stac},
              "json_file_count": ${json_count}
            },
            "results": {
              "validator_exit_code": ${validator_exit},
              "geometry_exit_code": ${geom_exit},
              "api_exit_code": ${api_exit},
              "status": "${status}"
            }
          }
          JSON

          echo "Wrote ${STAC_VALIDATE_METRICS_OUT}"

      - name: ðŸ“¤ Upload STAC Validation Metrics Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: stac-validate-metrics
          path: ${{ env.STAC_VALIDATE_METRICS_OUT }}
          if-no-files-found: error

      # --------------------------------------------------------------------
      # 5. STAC Validation Summary (for GitHub UI)
      # --------------------------------------------------------------------
      - name: ðŸ§¾ Emit STAC Validation Summary
        if: always()
        run: |
          set -euo pipefail
          {
            echo "## ðŸ›° STAC Validation Summary"
            echo ""
            echo "- STAC root: \`${STAC_ROOT}\`"
            echo "- STAC schema dir: \`${STAC_SCHEMA_DIR}\`"
            echo "- STAC directory present: \`${{ steps.detect_stac.outputs.has_stac }}\`"
            echo "- Validator exit code: \`${{ steps.stac_validator.outputs.exit_code || '0' }}\`"
            echo "- Geometry check exit code (optional): \`${{ steps.geom.outputs.exit_code || '0' }}\`"
            echo "- STAC API check exit code (optional): \`${{ steps.api.outputs.exit_code || '0' }}\`"
            echo "- Metrics artifact: \`${STAC_VALIDATE_METRICS_OUT}\` (uploaded as \`stac-validate-metrics\`)"
            echo ""
            echo "This run is part of the governed CI/CD plan for STAC assets (KFM-STAC v11)."
          } >> "${GITHUB_STEP_SUMMARY}"

      # --------------------------------------------------------------------
      # 6. Hard gate (only if STAC exists): fail if validator failed
      # --------------------------------------------------------------------
      - name: ðŸš¦ Gate: Fail if STAC Validator Failed
        if: steps.detect_stac.outputs.has_stac == 'true'
        run: |
          set -euo pipefail
          code="${{ steps.stac_validator.outputs.exit_code }}"
          if [[ "${code}" != "0" ]]; then
            echo "::error title=STAC validation failed::Validator exited with ${code}."
            exit "${code}"
          fi
