# .github/workflows/security_audit.yml
# üîê Kansas Frontier Matrix ‚Äî Security Audit (Dependencies, Secrets, Workflow Hardening)
# v11.2.6 ‚Äî Diamond‚Åπ Œ© / Crown‚àûŒ© Ultimate Certified
#
# Purpose:
#   Run governed security checks over the KFM monorepo, focusing on:
#     - Dependency vulnerability scanning (Python, Node, etc.)
#     - Secret/credential leakage scanning
#     - Basic workflow security hardening checks
#   Emit a small machine-readable metrics artifact consumed by telemetry_export.yml.
#
# Governance Context:
#   - Implements the SECURITY.md policy for:
#       * CVE scanning and patch SLAs
#       * Secret hygiene (no secrets in repo)
#       * Supply-chain hygiene (in tandem with sbom_verify.yml)
#   - Complements:
#       * ci.yml           ‚Üí core tests & linting
#       * sbom_verify.yml  ‚Üí SBOM + attestations + manifest checks
#       * faircare_validate.yml / h3_generalization.yml ‚Üí FAIR+CARE & sovereignty
#   - Telemetry:
#       * Emits security-audit-metrics.json as a workflow artifact (for telemetry_export.yml)

name: üîê security-audit

on:
  pull_request:
    branches:
      - main
      - "release/**"
  push:
    branches:
      - main
      - "release/**"
  schedule:
    # Weekly deep audit on default branch
    - cron: "0 2 * * 0"
  workflow_dispatch: {}

# Avoid overlapping security audits on the same ref
concurrency:
  group: security-audit-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read
  security-events: write     # allow SARIF uploads if scanners emit them
  pull-requests: read        # for dependency review on PRs (optional)

defaults:
  run:
    shell: bash

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"
  KFM_WEB_ROOT: "web"

  # Telemetry / metrics artifact for telemetry_export.yml aggregation
  SECURITY_METRICS_OUT: "security-audit-metrics.json"

jobs:
  security-audit:
    name: "üîê Security Audit (Deps, Secrets, Workflow Hardening)"
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0            # full history helps secret scanners
          persist-credentials: false

      # --------------------------------------------------------------------
      # 0. Detect optional projects / manifests (avoid unnecessary setup)
      # --------------------------------------------------------------------
      - name: üîé Detect web project
        id: detect_web
        run: |
          set -euo pipefail
          if [[ -d "${KFM_WEB_ROOT}" && -f "${KFM_WEB_ROOT}/package.json" ]]; then
            echo "has_web=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_web=false" >> "$GITHUB_OUTPUT"
          fi

      # --------------------------------------------------------------------
      # 1. Language runtimes for CLI-based scanners
      # --------------------------------------------------------------------
      - name: üêç Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements*.txt
            scripts/requirements-security.txt
            pyproject.toml

      - name: üì¶ Install Security Tooling (Python)
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [[ -f scripts/requirements-security.txt ]]; then
            pip install --no-cache-dir -r scripts/requirements-security.txt
          else
            # Minimal defaults; extend via scripts/requirements-security.txt as needed
            pip install --no-cache-dir "pip-audit" || echo "pip-audit install failed; continuing (composite security-scan may provide alternatives)."
          fi

      - name: üü¶ Setup Node ${{ env.NODE_VERSION }}
        if: steps.detect_web.outputs.has_web == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: |
            ${{ env.KFM_WEB_ROOT }}/package-lock.json
            ${{ env.KFM_WEB_ROOT }}/npm-shrinkwrap.json

      # --------------------------------------------------------------------
      # 2. Optional PR Dependency Review (fast PR-only supply-chain signal)
      #    (Does not replace the governed composite scan)
      # --------------------------------------------------------------------
      - name: üßæ Dependency Review (PR only)
        id: dependency_review
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/dependency-review-action@v4

      # --------------------------------------------------------------------
      # 3. Composite Security Scan (dependencies + secrets)
      #
      # Expected behavior of .github/actions/security-scan:
      #   - Run dependency vulnerability scanning for supported ecosystems
      #   - Run secret/credential leakage scanning on repo contents
      #   - Exit non-zero if critical/high issues are found
      #
      # This is the primary, governed security gate.
      # --------------------------------------------------------------------
      - name: üîê Consolidated Security Scan (Composite Action)
        id: composite_scan
        run: |
          set -euo pipefail
          if [[ ! -d ".github/actions/security-scan" ]]; then
            echo "::error title=Missing composite action::.github/actions/security-scan not found."
            echo "This composite action is required for governed security audits."
            exit 1
          fi

          # Entry-point is expected to orchestrate:
          #   - dependency scanners (pip-audit / osv-scanner / npm audit / etc.)
          #   - secret scanning (e.g., trufflehog/gitleaks) according to repo policy
          bash .github/actions/security-scan/entrypoint.sh .

      # --------------------------------------------------------------------
      # 4. Python Dependency Vulnerability Audit (pip-audit) ‚Äî explicit, fast
      #    Supplementary visibility (composite scan remains authoritative).
      # --------------------------------------------------------------------
      - name: üß™ Python Dependency Audit (pip-audit)
        id: pip_audit
        if: always()
        continue-on-error: true
        run: |
          set -euo pipefail
          if python -m pip show pip-audit >/dev/null 2>&1; then
            if [[ -f requirements.txt || -f requirements-dev.txt || -f pyproject.toml ]]; then
              echo "Running pip-audit against environment..."
              pip-audit || echo "pip-audit found issues (see log); primary gating is via composite security-scan."
            else
              echo "No Python dependency manifests found; skipping pip-audit."
            fi
          else
            echo "pip-audit not installed; skip explicit Python audit (composite may still have scanned)."
          fi

      # --------------------------------------------------------------------
      # 5. Node / Web Dependency Audit (npm audit) ‚Äî if web project present
      # --------------------------------------------------------------------
      - name: üß™ Node Dependency Audit (npm audit)
        id: npm_audit
        if: always() && steps.detect_web.outputs.has_web == 'true'
        working-directory: ${{ env.KFM_WEB_ROOT }}
        continue-on-error: true
        run: |
          set -euo pipefail

          if [[ -f package-lock.json || -f npm-shrinkwrap.json ]]; then
            npm ci --ignore-scripts
          else
            npm install --ignore-scripts
          fi

          if npm audit --audit-level=high; then
            echo "npm audit completed with no high/critical vulnerabilities."
          else
            echo "npm audit reported high/critical vulnerabilities."
            echo "Composite security-scan is authoritative for gating; use these logs for remediation guidance."
          fi

      # --------------------------------------------------------------------
      # 6. Secret Scanning (gitleaks) ‚Äî explicit, in addition to composite
      # --------------------------------------------------------------------
      - name: üïµÔ∏è Secret Scan (gitleaks)
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          args: "detect --no-color --redact --source=."

      # --------------------------------------------------------------------
      # 7. Workflow Security / Hardening Checks (optional script)
      #
      # Example checks (implemented in your script):
      #   - Minimal permissions in workflow `permissions:` blocks
      #   - No use of unpinned third-party actions (floating tags)
      #   - No use of `pull_request_target` in unsafe ways
      # --------------------------------------------------------------------
      - name: üõ° Workflow Security Hardening Check (Optional)
        id: workflow_hardening
        if: always()
        continue-on-error: true
        run: |
          set -euo pipefail
          if [[ -f scripts/validate_workflow_security.py ]]; then
            python scripts/validate_workflow_security.py \
              --workflows ".github/workflows"
          else
            echo "scripts/validate_workflow_security.py not found; skipping workflow hardening lint."
          fi

      # --------------------------------------------------------------------
      # 8. Emit machine-readable metrics for telemetry_export.yml
      # --------------------------------------------------------------------
      - name: üìà Write Security Audit Metrics (Artifact)
        id: emit_metrics
        if: always()
        env:
          HAS_WEB: ${{ steps.detect_web.outputs.has_web }}
          COMPOSITE_OUTCOME: ${{ steps.composite_scan.outcome }}
          PIP_AUDIT_OUTCOME: ${{ steps.pip_audit.outcome }}
          NPM_AUDIT_OUTCOME: ${{ steps.npm_audit.outcome }}
          GITLEAKS_OUTCOME: ${{ steps.gitleaks.outcome }}
          WORKFLOW_HARDENING_OUTCOME: ${{ steps.workflow_hardening.outcome }}
        run: |
          set -euo pipefail
          python - <<'PY'
          import json
          import os
          from datetime import datetime, timezone

          def env(name: str, default: str = "") -> str:
              return os.environ.get(name, default)

          metrics = {
              "schema": "kfm-security-audit-metrics-v1",
              "generated_at_utc": datetime.now(timezone.utc).replace(microsecond=0).isoformat().replace("+00:00", "Z"),
              "github": {
                  "workflow": env("GITHUB_WORKFLOW"),
                  "run_id": env("GITHUB_RUN_ID"),
                  "run_attempt": env("GITHUB_RUN_ATTEMPT"),
                  "event_name": env("GITHUB_EVENT_NAME"),
                  "ref": env("GITHUB_REF"),
                  "sha": env("GITHUB_SHA"),
                  "repository": env("GITHUB_REPOSITORY"),
              },
              "signals": {
                  "has_web_project": env("HAS_WEB"),
                  "composite_security_scan_outcome": env("COMPOSITE_OUTCOME"),
                  "pip_audit_outcome": env("PIP_AUDIT_OUTCOME"),
                  "npm_audit_outcome": env("NPM_AUDIT_OUTCOME"),
                  "gitleaks_outcome": env("GITLEAKS_OUTCOME"),
                  "workflow_hardening_outcome": env("WORKFLOW_HARDENING_OUTCOME"),
              },
          }

          out_path = env("SECURITY_METRICS_OUT", "security-audit-metrics.json")
          with open(out_path, "w", encoding="utf-8") as f:
              json.dump(metrics, f, indent=2, sort_keys=True)

          print(f"Wrote {out_path}")
          PY

      - name: üì§ Upload Security Audit Metrics Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-metrics
          path: ${{ env.SECURITY_METRICS_OUT }}
          if-no-files-found: error

      # --------------------------------------------------------------------
      # 9. Security Audit Summary (for GitHub UI & telemetry_export.yml)
      # --------------------------------------------------------------------
      - name: üßæ Emit Security Audit Summary
        if: always()
        run: |
          set -euo pipefail
          {
            echo "## üîê Security Audit Summary"
            echo ""
            echo "- Composite security-scan: executed via .github/actions/security-scan"
            echo "- Python dependency audit: pip-audit (best-effort) if installed"
            echo "- Node dependency audit: npm audit (if web project present)"
            echo "- Secret scanning: gitleaks"
            echo "- Workflow hardening: scripts/validate_workflow_security.py (optional)"
            echo "- Metrics artifact: \`${SECURITY_METRICS_OUT}\` (uploaded as \`security-audit-metrics\`)"
            echo ""
            echo "This workflow enforces the SECURITY.md policy for dependency and secret hygiene,"
            echo "and emits governed security signals for telemetry_export.yml and dashboards."
          } >> "${GITHUB_STEP_SUMMARY}"
