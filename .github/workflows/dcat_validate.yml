# .github/workflows/dcat_validate.yml
# ðŸ—‚ Kansas Frontier Matrix â€” DCAT Dataset & Distribution Validation
# v11.2.6 â€” Diamondâ¹ Î© / CrownâˆžÎ© Ultimate Certified
#
# Purpose:
#   Validate DCAT 3.0 / KFM-DCAT v11 datasets and distributions across the repo:
#     - docs/data/**          (dataset documentation + governed metadata)
#     - data/catalog/**       (canonical DCAT exports / projections)
#     - releases/**           (release packets referenced by catalogs)
#     - data/releases/**      (legacy/transition root; scanned if present)
#
# Governance Context:
#   - KFM-DCAT v11 profile (DCAT 3.0 aligned)
#   - KFM-MDP v11.2.6 (governed docs + metadata practices)
#   - FAIR+CARE & sovereignty rules (enforced deeper in faircare_validate.yml + h3_generalization.yml)
#   - PROV-O / OpenLineage linkage (validated deeper in jsonld_validate.yml; surfaced to telemetry_export.yml)
#
# Supply-chain note:
#   - Prefer pinning GitHub Actions to patch versions or commit SHAs where feasible.
#   - Keep GITHUB_TOKEN permissions least-privilege (read-only unless write is required).

name: ðŸ—‚ dcat-validate

on:
  pull_request:
    paths:
      - "docs/data/**"
      - "data/catalog/**"
      - "releases/**"
      - "data/releases/**"
      - "schemas/dcat/**"
      - ".github/actions/dcat-validate/**"
      - ".github/actions/schema-validate/**"
      - ".github/workflows/dcat_validate.yml"
  push:
    branches:
      - main
      - "release/**"
    paths:
      - "docs/data/**"
      - "data/catalog/**"
      - "releases/**"
      - "data/releases/**"
      - "schemas/dcat/**"
      - ".github/actions/dcat-validate/**"
      - ".github/actions/schema-validate/**"
      - ".github/workflows/dcat_validate.yml"
  workflow_dispatch: {}

concurrency:
  group: dcat-validate-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read

defaults:
  run:
    shell: bash

env:
  PYTHON_VERSION: "3.11"

  # Canonical roots
  DCAT_ROOT_DOCS: "docs/data"
  DCAT_ROOT_CATALOG: "data/catalog"
  DCAT_ROOT_RELEASES: "releases"

  # Legacy/transition root (scan if present; do not require)
  DCAT_ROOT_RELEASES_LEGACY: "data/releases"

  DCAT_SCHEMA_DIR: "schemas/dcat"

  # Optional metrics output for telemetry_export.yml (if a script emits it)
  DCAT_METRICS_OUT: "dcat-validate-metrics.json"

jobs:
  dcat-validate:
    name: "ðŸ—‚ DCAT 3.0 Validation (KFM-DCAT v11)"
    runs-on: ubuntu-22.04
    timeout-minutes: 40

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ”Ž Detect DCAT Roots
        id: detect_dcat
        run: |
          set -euo pipefail
          has_any="false"

          for path in "${DCAT_ROOT_DOCS}" "${DCAT_ROOT_CATALOG}" "${DCAT_ROOT_RELEASES}" "${DCAT_ROOT_RELEASES_LEGACY}"; do
            if [[ -d "${path}" ]]; then
              echo "Found DCAT root: ${path}"
              has_any="true"
            fi
          done

          echo "has_dcat=${has_any}" >> "$GITHUB_OUTPUT"

          if [[ "${has_any}" == "false" ]]; then
            echo "::notice title=DCAT validation::No DCAT roots present; skipping validation."
          fi

      - name: â­ Skip DCAT validation (no DCAT roots)
        if: steps.detect_dcat.outputs.has_dcat == 'false'
        run: |
          echo "No DCAT roots detected; nothing to validate for this run."

      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        if: steps.detect_dcat.outputs.has_dcat == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            scripts/requirements-dcat.txt

      - name: ðŸ“¦ Install DCAT Validation Tooling (best-effort)
        if: steps.detect_dcat.outputs.has_dcat == 'true'
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [[ -f scripts/requirements-dcat.txt ]]; then
            pip install --no-cache-dir -r scripts/requirements-dcat.txt
          else
            # Keep lightweight defaults; composite action remains authoritative.
            pip install --no-cache-dir "rdflib" "pyld" "jsonschema" || true
          fi

      # --------------------------------------------------------------------
      # 1. Hard gate: DCAT structural/profile validation via composite action
      # --------------------------------------------------------------------
      - name: ðŸ—‚ Run DCAT Validator (Composite Action) â€” Hard Gate
        if: steps.detect_dcat.outputs.has_dcat == 'true'
        run: |
          set -euo pipefail

          if [[ ! -d ".github/actions/dcat-validate" ]]; then
            echo "::error title=Missing composite action::.github/actions/dcat-validate not found."
            echo "This composite action is required for governed DCAT validation."
            exit 1
          fi

          roots=()
          [[ -d "${DCAT_ROOT_DOCS}" ]] && roots+=("${DCAT_ROOT_DOCS}")
          [[ -d "${DCAT_ROOT_CATALOG}" ]] && roots+=("${DCAT_ROOT_CATALOG}")
          [[ -d "${DCAT_ROOT_RELEASES}" ]] && roots+=("${DCAT_ROOT_RELEASES}")
          [[ -d "${DCAT_ROOT_RELEASES_LEGACY}" ]] && roots+=("${DCAT_ROOT_RELEASES_LEGACY}")

          if [[ ${#roots[@]} -eq 0 ]]; then
            echo "No DCAT roots exist at runtime; nothing to validate."
            exit 0
          fi

          echo "Validating DCAT roots: ${roots[*]}"
          bash .github/actions/dcat-validate/entrypoint.sh "${DCAT_SCHEMA_DIR}" "${roots[@]}"

      # --------------------------------------------------------------------
      # 2. Optional: DCAT linkage & completeness checks (non-gating diagnostics)
      # --------------------------------------------------------------------
      - name: ðŸ”— Optional DCAT Linkage & Completeness Checks
        if: steps.detect_dcat.outputs.has_dcat == 'true'
        continue-on-error: true
        run: |
          set -euo pipefail
          if [[ -f scripts/validate_dcat_links.py ]]; then
            python scripts/validate_dcat_links.py \
              --docs-root "${DCAT_ROOT_DOCS}" \
              --catalog-root "${DCAT_ROOT_CATALOG}" \
              --releases-root "${DCAT_ROOT_RELEASES}" \
              --releases-root-legacy "${DCAT_ROOT_RELEASES_LEGACY}"
          else
            echo "scripts/validate_dcat_links.py not found; skipping optional linkage checks."
          fi

      # --------------------------------------------------------------------
      # 3. Optional: FAIR+CARE field presence pre-check (non-gating)
      # --------------------------------------------------------------------
      - name: âš– Optional FAIR+CARE Metadata Pre-Check (DCAT)
        if: steps.detect_dcat.outputs.has_dcat == 'true'
        continue-on-error: true
        run: |
          set -euo pipefail
          if [[ -f scripts/validate_dcat_faircare_metadata.py ]]; then
            python scripts/validate_dcat_faircare_metadata.py \
              --docs-root "${DCAT_ROOT_DOCS}" \
              --catalog-root "${DCAT_ROOT_CATALOG}" \
              --releases-root "${DCAT_ROOT_RELEASES}" \
              --releases-root-legacy "${DCAT_ROOT_RELEASES_LEGACY}"
          else
            echo "scripts/validate_dcat_faircare_metadata.py not found; skipping FAIR+CARE DCAT pre-check."
          fi

      # --------------------------------------------------------------------
      # 4. Optional: Metrics emission for telemetry_export.yml
      # --------------------------------------------------------------------
      - name: ðŸ“Š Optional DCAT Metrics Collection
        if: steps.detect_dcat.outputs.has_dcat == 'true'
        continue-on-error: true
        run: |
          set -euo pipefail
          if [[ -f scripts/collect_dcat_metrics.py ]]; then
            python scripts/collect_dcat_metrics.py \
              --docs-root "${DCAT_ROOT_DOCS}" \
              --catalog-root "${DCAT_ROOT_CATALOG}" \
              --releases-root "${DCAT_ROOT_RELEASES}" \
              --releases-root-legacy "${DCAT_ROOT_RELEASES_LEGACY}" \
              --out "${DCAT_METRICS_OUT}"
          else
            echo "scripts/collect_dcat_metrics.py not found; skipping metrics export."
          fi

      - name: ðŸ“¤ Upload DCAT Metrics Artifact (Optional)
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: dcat-validate-metrics
          path: ${{ env.DCAT_METRICS_OUT }}
          if-no-files-found: ignore

      # --------------------------------------------------------------------
      # 5. Summary (for GitHub UI & telemetry_export.yml)
      # --------------------------------------------------------------------
      - name: ðŸ§¾ Emit DCAT Validation Summary
        if: always()
        run: |
          set -euo pipefail
          {
            echo "## ðŸ—‚ DCAT Validation Summary"
            echo ""
            echo "- DCAT roots (checked for existence):"
            echo "  - \`${DCAT_ROOT_DOCS}\`"
            echo "  - \`${DCAT_ROOT_CATALOG}\`"
            echo "  - \`${DCAT_ROOT_RELEASES}\`"
            echo "  - \`${DCAT_ROOT_RELEASES_LEGACY}\` (legacy/transition; scanned if present)"
            echo "- DCAT schema dir: \`${DCAT_SCHEMA_DIR}\`"
            echo "- DCAT content present: \`${{ steps.detect_dcat.outputs.has_dcat }}\`"
            echo ""
            echo "Hard gate:"
            echo "- .github/actions/dcat-validate (composite) enforces KFM-DCAT v11 / DCAT 3.0 profile."
            echo ""
            echo "Optional diagnostics:"
            echo "- scripts/validate_dcat_links.py"
            echo "- scripts/validate_dcat_faircare_metadata.py"
            echo "- scripts/collect_dcat_metrics.py â†’ \`${DCAT_METRICS_OUT}\`"
          } >> "${GITHUB_STEP_SUMMARY}"
