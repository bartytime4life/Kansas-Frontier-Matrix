# .github/workflows/docs_validate.yml
# üìö Kansas Frontier Matrix ‚Äî Documentation & Metadata Validation
# v11.2.6 ‚Äî Diamond‚Åπ Œ© / Crown‚àûŒ© Ultimate Certified
#
# Purpose:
#   Enforce KFM-MDP v11.2.6 markdown rules, YAML front-matter governance,
#   and required documentation governance sections for governed markdown.
#
# Governance Layers Applied (minimum):
#   - markdown-lint
#   - schema-lint
#   - metadata-check / footer-check / provenance-check (repo script)
#   - FAIR+CARE doc metadata pre-check (soft here; authoritative in faircare_validate.yml)
#
# Notes:
#   - Heavy lifting MUST be repo-local (scripts/ and/or .github/actions/).
#   - STAC/DCAT/JSON-LD semantics are validated in their dedicated workflows.
#
# Runtime Note:
#   GitHub Actions is migrating JavaScript actions to Node 24; use current majors
#   (e.g., checkout@v6, setup-python@v6) and ensure self-hosted runners meet
#   minimum compatible runner requirements where applicable.

name: üìö docs-validate

on:
  pull_request:
    paths:
      - "**/*.md"
      - "**/*.markdown"
      - "**/*.mdx"
      - "docs/**"
      - ".github/*.md"
      - "README.md"
      - "ARCHITECTURE.md"
      - "schemas/markdown/**"
      - "schemas/json/**"
      - ".github/actions/markdown-lint/**"
      - ".github/actions/schema-validate/**"
      - "scripts/requirements-docs.txt"
      - "scripts/validate_doc_governance.py"
      - "scripts/validate_faircare_doc_metadata.py"
      - "scripts/check_links.py"
      - ".github/workflows/docs_validate.yml"

  push:
    branches:
      - main
      - "release/**"
    paths:
      - "**/*.md"
      - "**/*.markdown"
      - "**/*.mdx"
      - "docs/**"
      - ".github/*.md"
      - "README.md"
      - "ARCHITECTURE.md"
      - "schemas/markdown/**"
      - "schemas/json/**"
      - ".github/actions/markdown-lint/**"
      - ".github/actions/schema-validate/**"
      - "scripts/requirements-docs.txt"
      - "scripts/validate_doc_governance.py"
      - "scripts/validate_faircare_doc_metadata.py"
      - "scripts/check_links.py"
      - ".github/workflows/docs_validate.yml"

  workflow_dispatch: {}

concurrency:
  group: docs-validate-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

defaults:
  run:
    shell: bash

env:
  KFM_MDP_VERSION: "v11.2.6"
  PYTHON_VERSION: "3.11"

  # Validation roots (avoid fragile quoted glob expansion in bash).
  DOCS_ROOT: "docs"
  GITHUB_MD_ROOT: ".github"
  ROOT_FILES: "README.md ARCHITECTURE.md"

  # Preferred schema locations (repo may choose either layout).
  # The resolver step below will pick the first that exists.
  FRONTMATTER_SCHEMA_CANDIDATES: |
    schemas/markdown/kfm-frontmatter-v11.2.6.schema.json
    schemas/markdown/kfm-frontmatter-v11.schema.json
    schemas/json/kfm-frontmatter-v11.2.6.schema.json
    schemas/json/kfm-frontmatter-v11.schema.json

  MDP_SCHEMA_CANDIDATES: |
    schemas/markdown/kfm-mdp-v11.2.6.schema.json
    schemas/markdown/kfm-mdp-v11.schema.json
    schemas/json/kfm-markdown-protocol-v11.2.6.schema.json

jobs:
  docs-validate:
    name: "üìö KFM-MDP Docs & Metadata Validation"
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: üß≠ Resolve documentation schema paths (front-matter + MDP)
        id: schemas
        run: |
          set -euo pipefail

          pick_first_existing() {
            while IFS= read -r candidate; do
              candidate="$(echo "$candidate" | xargs)"
              [[ -z "$candidate" ]] && continue
              if [[ -f "$candidate" ]]; then
                echo "$candidate"
                return 0
              fi
            done
            return 1
          }

          frontmatter_schema="$(pick_first_existing <<< "${FRONTMATTER_SCHEMA_CANDIDATES}")" || true
          mdp_schema="$(pick_first_existing <<< "${MDP_SCHEMA_CANDIDATES}")" || true

          if [[ -z "${frontmatter_schema:-}" ]]; then
            echo "::error title=Front-matter schema missing::No front-matter schema found in candidates."
            echo "Candidates were:"
            echo "${FRONTMATTER_SCHEMA_CANDIDATES}"
            exit 1
          fi

          if [[ -z "${mdp_schema:-}" ]]; then
            echo "::error title=KFM-MDP schema missing::No MDP schema found in candidates."
            echo "Candidates were:"
            echo "${MDP_SCHEMA_CANDIDATES}"
            exit 1
          fi

          echo "KFM_FRONTMATTER_SCHEMA=${frontmatter_schema}" >> "$GITHUB_ENV"
          echo "KFM_MDP_SCHEMA=${mdp_schema}" >> "$GITHUB_ENV"

          echo "frontmatter_schema=${frontmatter_schema}" >> "$GITHUB_OUTPUT"
          echo "mdp_schema=${mdp_schema}" >> "$GITHUB_OUTPUT"

      - name: üêç Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            scripts/requirements-docs.txt

      - name: üì¶ Install Documentation Tooling
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [[ -f scripts/requirements-docs.txt ]]; then
            pip install --no-cache-dir -r scripts/requirements-docs.txt
          else
            # Minimal baseline; prefer pinned deps via scripts/requirements-docs.txt.
            pip install --no-cache-dir "pyyaml" "jsonschema" || true
          fi

      # --------------------------------------------------------------------
      # 1) Markdown lint (KFM-MDP)
      # --------------------------------------------------------------------
      - name: üìö Enforce KFM-MDP Markdown Rules (markdown-lint)
        run: |
          set -euo pipefail
          if [[ ! -d ".github/actions/markdown-lint" ]]; then
            echo "::error title=Missing action::.github/actions/markdown-lint not found."
            exit 1
          fi
          bash .github/actions/markdown-lint/entrypoint.sh

      # --------------------------------------------------------------------
      # 2) Front-matter schema validation (governed)
      #    schema-validate is responsible for file discovery + parsing.
      # --------------------------------------------------------------------
      - name: üßæ Validate YAML Front-Matter (Governed Schema)
        run: |
          set -euo pipefail
          if [[ ! -d ".github/actions/schema-validate" ]]; then
            echo "::error title=Missing action::.github/actions/schema-validate not found."
            exit 1
          fi

          bash .github/actions/schema-validate/entrypoint.sh \
            "${KFM_FRONTMATTER_SCHEMA}" \
            "${DOCS_ROOT}" \
            "${GITHUB_MD_ROOT}" \
            ${ROOT_FILES}

      # --------------------------------------------------------------------
      # 3) MDP structural metadata validation (protocol schema)
      # --------------------------------------------------------------------
      - name: üß¨ Validate KFM-MDP Structural Metadata (Protocol Schema)
        run: |
          set -euo pipefail
          bash .github/actions/schema-validate/entrypoint.sh \
            "${KFM_MDP_SCHEMA}" \
            "${DOCS_ROOT}" \
            "${GITHUB_MD_ROOT}" \
            ${ROOT_FILES}

      # --------------------------------------------------------------------
      # 4) Required doc governance sections (Version History, Footer, Nav)
      #    Make this a hard requirement (aligned with governed docs).
      # --------------------------------------------------------------------
      - name: üìú Enforce Doc Governance Sections (Required)
        run: |
          set -euo pipefail
          if [[ ! -f scripts/validate_doc_governance.py ]]; then
            echo "::error title=Missing validator::scripts/validate_doc_governance.py not found."
            echo "KFM governed docs require governance footer + version history enforcement."
            exit 1
          fi

          python scripts/validate_doc_governance.py \
            --roots "${DOCS_ROOT}" "${GITHUB_MD_ROOT}" \
            --include ${ROOT_FILES}

      # --------------------------------------------------------------------
      # 5) FAIR+CARE doc metadata pre-check (soft here)
      #    Authoritative enforcement is in faircare_validate.yml.
      # --------------------------------------------------------------------
      - name: ‚öñ FAIR+CARE Metadata Presence Check (Docs)
        continue-on-error: true
        run: |
          set -euo pipefail
          if [[ -f scripts/validate_faircare_doc_metadata.py ]]; then
            python scripts/validate_faircare_doc_metadata.py \
              --root "${DOCS_ROOT}" \
              --include-github-md "${GITHUB_MD_ROOT}/*.md"
          else
            echo "::notice title=FAIR+CARE pre-check skipped::scripts/validate_faircare_doc_metadata.py not found."
          fi

      # --------------------------------------------------------------------
      # 6) Optional link checking
      # --------------------------------------------------------------------
      - name: üîó Optional Link & Anchor Check
        continue-on-error: true
        run: |
          set -euo pipefail
          if [[ -f scripts/check_links.py ]]; then
            python scripts/check_links.py \
              --roots "${DOCS_ROOT}" "${GITHUB_MD_ROOT}" \
              --include ${ROOT_FILES}
          else
            echo "::notice title=Link check skipped::scripts/check_links.py not found."
          fi

      # --------------------------------------------------------------------
      # 7) Summary (feeds telemetry_export.yml post-processing)
      # --------------------------------------------------------------------
      - name: üßæ Emit Docs Validation Summary
        if: always()
        run: |
          set -euo pipefail
          {
            echo "## üìö Docs Validation Summary"
            echo ""
            echo "- KFM-MDP: \`${KFM_MDP_VERSION}\`"
            echo "- Front-matter schema: \`${KFM_FRONTMATTER_SCHEMA}\`"
            echo "- MDP schema: \`${KFM_MDP_SCHEMA}\`"
            echo "- Roots:"
            echo "  - \`${DOCS_ROOT}\`"
            echo "  - \`${GITHUB_MD_ROOT}\`"
            echo "  - \`${ROOT_FILES}\`"
            echo ""
            echo "Checks executed (minimum governed set):"
            echo "- markdown-lint"
            echo "- schema/front-matter validation"
            echo "- governance sections validation"
          } >> "${GITHUB_STEP_SUMMARY}"
