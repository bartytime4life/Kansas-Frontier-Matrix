# .github/workflows/faircare_validate.yml
# âš– Kansas Frontier Matrix â€” FAIR+CARE & Sovereignty Governance Validation
# v11.2.6 â€” Diamondâ¹ Î© / CrownâˆžÎ© Ultimate Certified
#
# Purpose:
#   Enforce FAIR+CARE-aligned governance across KFM assets by validating:
#     - FAIR metadata (Findable, Accessible, Interoperable, Reusable)
#     - CARE metadata (Collective Benefit, Authority to Control, Responsibility, Ethics)
#     - Sovereignty flags & policy references
#     - High-sensitivity classifications (heritage, Indigenous, ecology, etc.)
#
# Governance Context:
#   - FAIR Principles (F1-A1-I1-R1)
#   - CARE Principles for Indigenous Data Governance
#   - KFM FAIR+CARE Guide (docs/standards/faircare/FAIRCARE-GUIDE.md)
#   - Indigenous Data Protection policy
#   - STAC/DCAT/JSON-LD validation occurs in dedicated workflows (stac/dcat/jsonld)
#
# Note:
#   Heavy spatial masking & H3 enforcement is handled in h3_generalization.yml.

name: âš– faircare-validate

on:
  pull_request:
    paths:
      - "data/**"
      - "docs/**"
      - ".github/**/*.md"
      - "schemas/faircare/**"
      - "scripts/*faircare*"
      - "scripts/*sensitivity*"
      - ".github/workflows/faircare_validate.yml"
  push:
    branches:
      - main
      - "release/**"
    paths:
      - "data/**"
      - "docs/**"
      - ".github/**/*.md"
      - "schemas/faircare/**"
      - "scripts/*faircare*"
      - "scripts/*sensitivity*"
      - ".github/workflows/faircare_validate.yml"
  workflow_dispatch: {}

concurrency:
  group: faircare-validate-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read

defaults:
  run:
    shell: bash

env:
  PYTHON_VERSION: "3.11"
  FAIRCARE_DOCS_ROOT: "docs"
  FAIRCARE_DATA_ROOT: "data"
  FAIRCARE_SCHEMA_DIR: "schemas/faircare"
  FAIRCARE_METRICS_OUT: "faircare-metrics.json"

jobs:
  faircare-validate:
    name: "âš– FAIR+CARE & Sovereignty Governance Validation"
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ”Ž Detect FAIR+CARE Targets
        id: detect_fc
        run: |
          set -euo pipefail
          has_docs="false"
          has_data="false"

          [[ -d "${FAIRCARE_DOCS_ROOT}" ]] && has_docs="true"
          [[ -d "${FAIRCARE_DATA_ROOT}" ]] && has_data="true"

          echo "has_docs=${has_docs}" >> "$GITHUB_OUTPUT"
          echo "has_data=${has_data}" >> "$GITHUB_OUTPUT"

          if [[ "${has_docs}" == "false" && "${has_data}" == "false" ]]; then
            echo "::notice title=FAIR+CARE validate::No docs/ or data/ roots present; skipping."
          fi

      - name: â­ Skip FAIR+CARE validation (no docs/data)
        if: steps.detect_fc.outputs.has_docs == 'false' && steps.detect_fc.outputs.has_data == 'false'
        run: |
          echo "No FAIR+CARE targets detected; nothing to validate for this run."

      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        if: steps.detect_fc.outputs.has_docs == 'true' || steps.detect_fc.outputs.has_data == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            scripts/requirements-faircare.txt

      - name: ðŸ“¦ Install FAIR+CARE Tooling
        if: steps.detect_fc.outputs.has_docs == 'true' || steps.detect_fc.outputs.has_data == 'true'
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [[ -f scripts/requirements-faircare.txt ]]; then
            pip install --no-cache-dir -r scripts/requirements-faircare.txt
          else
            # Minimal defaults (scripts should vendor/declare anything stricter)
            pip install --no-cache-dir "pyyaml" "jsonschema" || true
          fi

      - name: ðŸ“š Validate FAIR+CARE Doc Metadata (Hard Gate)
        if: steps.detect_fc.outputs.has_docs == 'true'
        run: |
          set -euo pipefail
          if [[ -f scripts/validate_faircare_doc_metadata.py ]]; then
            python scripts/validate_faircare_doc_metadata.py \
              --root "${FAIRCARE_DOCS_ROOT}" \
              --include-pattern "*.md" \
              --include-github-md ".github/**/*.md"
          else
            echo "::error title=Missing validator::scripts/validate_faircare_doc_metadata.py not found."
            echo "This script is required to enforce FAIR+CARE doc metadata governance."
            exit 1
          fi

      - name: ðŸ—‚ Validate FAIR+CARE for Datasets & Distributions (Hard Gate)
        if: steps.detect_fc.outputs.has_data == 'true'
        run: |
          set -euo pipefail
          if [[ -f scripts/validate_faircare_datasets.py ]]; then
            python scripts/validate_faircare_datasets.py \
              --data-root "${FAIRCARE_DATA_ROOT}" \
              --docs-root "${FAIRCARE_DOCS_ROOT}" \
              --schema-dir "${FAIRCARE_SCHEMA_DIR}"
          else
            echo "::error title=Missing validator::scripts/validate_faircare_datasets.py not found."
            echo "This script is required to enforce FAIR+CARE dataset-level governance."
            exit 1
          fi

      - name: ðŸ§­ High-Sensitivity & Sovereignty Classification Checks (Soft Gate)
        if: steps.detect_fc.outputs.has_data == 'true'
        continue-on-error: true
        run: |
          set -euo pipefail
          if [[ -f scripts/validate_sensitivity_flags.py ]]; then
            python scripts/validate_sensitivity_flags.py \
              --data-root "${FAIRCARE_DATA_ROOT}" \
              --docs-root "${FAIRCARE_DOCS_ROOT}"
          else
            echo "::notice title=Sensitivity validator missing::scripts/validate_sensitivity_flags.py not present; skipping."
          fi

      - name: ðŸ“Š Optional FAIR+CARE Metrics Collection
        if: steps.detect_fc.outputs.has_data == 'true' || steps.detect_fc.outputs.has_docs == 'true'
        continue-on-error: true
        run: |
          set -euo pipefail
          if [[ -f scripts/collect_faircare_metrics.py ]]; then
            python scripts/collect_faircare_metrics.py \
              --data-root "${FAIRCARE_DATA_ROOT}" \
              --docs-root "${FAIRCARE_DOCS_ROOT}" \
              --out "${FAIRCARE_METRICS_OUT}"
          else
            echo "scripts/collect_faircare_metrics.py not found; skipping FAIR+CARE metrics export."
          fi

      - name: ðŸ“¤ Upload FAIR+CARE Metrics Artifact (Optional)
        if: success() || failure()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: faircare-metrics
          path: ${{ env.FAIRCARE_METRICS_OUT }}
          if-no-files-found: ignore

      - name: ðŸ§¾ Emit FAIR+CARE Validation Summary
        if: always()
        run: |
          set -euo pipefail
          {
            echo "## âš– FAIR+CARE & Sovereignty Validation Summary"
            echo ""
            echo "- Docs root: \`${FAIRCARE_DOCS_ROOT}\` (present: \`${{ steps.detect_fc.outputs.has_docs }}\`)"
            echo "- Data root: \`${FAIRCARE_DATA_ROOT}\` (present: \`${{ steps.detect_fc.outputs.has_data }}\`)"
            echo "- FAIR+CARE schema dir: \`${FAIRCARE_SCHEMA_DIR}\`"
            echo ""
            echo "Hard gates:"
            echo "- \`scripts/validate_faircare_doc_metadata.py\`"
            echo "- \`scripts/validate_faircare_datasets.py\`"
            echo ""
            echo "Related governance checks:"
            echo "- Spatial masking validated separately in \`h3_generalization.yml\`"
          } >> "${GITHUB_STEP_SUMMARY}"
