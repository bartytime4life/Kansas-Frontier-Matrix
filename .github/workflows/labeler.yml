# .github/workflows/labeler.yml
# ðŸ· Kansas Frontier Matrix â€” PR Auto-Labeling by Component / Domain
# v11.2.3 â€” Diamondâ¹ Î© / CrownâˆžÎ© Ultimate Certified
#
# Purpose:
#   - Automatically apply and sync labels on pull requests based on:
#       * Changed paths (code, data, docs, infra, AI, Focus Mode, etc.)
#       * Patterns defined in .github/labeler.yml
#   - Support governance routing, CODEOWNERS, and dashboard filtering.
#
# Notes:
#   - Uses actions/labeler with configuration from .github/labeler.yml.
#   - Runs on pull_request_target so labels are applied even for forks,
#     but with minimal permissions for safety.

name: ðŸ· labeler

on:
  pull_request_target:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
      - edited

concurrency:
  group: labeler-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read           # Read repo to evaluate .github/labeler.yml and paths
  pull-requests: write     # Apply / remove labels on PRs
  issues: write            # Some labeler features also touch issues (safe, scoped)

jobs:
  apply-labels:
    name: "ðŸ· Apply Path-Based Labels"
    runs-on: ubuntu-22.04
    timeout-minutes: 10

    steps:
      # NOTE: actions/labeler does not strictly require checkout, but we do a shallow
      # fetch=0 so it can inspect paths & config safely for this ref.
      - name: ðŸ“¥ Checkout repository (read-only)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ· Run Labeler (from .github/labeler.yml)
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: ".github/labeler.yml"
          sync-labels: true   # Remove labels if they no longer match paths

      - name: ðŸ§¾ Emit Labeler Summary
        if: always()
        run: |
          {
            echo "## ðŸ· PR Auto-Labeling Summary"
            echo ""
            echo "- Workflow: \`${GITHUB_WORKFLOW}\`"
            echo "- Ref: \`${GITHUB_REF}\`"
            echo "- PR: #${{ github.event.pull_request.number }}"
            echo ""
            echo "Labels are applied based on rules defined in:"
            echo "- \`.github/labeler.yml\`"
            echo ""
            echo "This job keeps PR labels in sync with the current file changes,"
            echo "supporting governance routing, dashboards, and CODEOWNERS review flows."
          } >> "${GITHUB_STEP_SUMMARY}"