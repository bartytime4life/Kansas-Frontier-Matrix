# .github/workflows/jsonld_validate.yml
# ðŸ§¬ Kansas Frontier Matrix â€” JSON-LD & Ontology Validation
# v11.2.6 â€” Diamondâ¹ Î© / CrownâˆžÎ© Ultimate Certified
#
# Purpose:
#   Validate JSON-LD graphs and ontology-aligned exports across the KFM monorepo, including:
#     - CIDOC-CRM aligned heritage/history graphs
#     - OWL-Time temporal entities
#     - GeoSPARQL geometries & relationships
#     - PROV-O lineage / OpenLineage-compatible exports
#
# Governance Context:
#   - KFM-OP v11 ontology profile
#   - KFM-STAC v11, KFM-DCAT v11 JSON-LD projections (if present)
#   - PROV-O + OpenLineage event modeling
#   - FAIR+CARE & sovereignty signals (enforced downstream in faircare_validate.yml + h3_generalization.yml)
#
# Notes:
#   - Hard gate: structural/schema validation via .github/actions/schema-validate
#   - Optional: SHACL/ontology and PROV/OpenLineage consistency scripts (if present)
#   - Emits a machine-readable metrics artifact for telemetry_export.yml

name: ðŸ§¬ jsonld-validate

on:
  pull_request:
    paths:
      - "data/jsonld/**"
      - "data/graph/**"
      - "data/stac/**"
      - "data/catalog/**"
      - "docs/data/**"
      - "releases/**"
      - "schemas/jsonld/**"
      - "scripts/validate_jsonld_shacl.py"
      - "scripts/validate_prov_openlineage.py"
      - "scripts/requirements-jsonld.txt"
      - ".github/actions/schema-validate/**"
      - ".github/workflows/jsonld_validate.yml"
  push:
    branches:
      - main
      - "release/**"
    paths:
      - "data/jsonld/**"
      - "data/graph/**"
      - "data/stac/**"
      - "data/catalog/**"
      - "docs/data/**"
      - "releases/**"
      - "schemas/jsonld/**"
      - "scripts/validate_jsonld_shacl.py"
      - "scripts/validate_prov_openlineage.py"
      - "scripts/requirements-jsonld.txt"
      - ".github/actions/schema-validate/**"
      - ".github/workflows/jsonld_validate.yml"
  workflow_dispatch: {}

concurrency:
  group: jsonld-validate-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read

defaults:
  run:
    shell: bash

env:
  PYTHON_VERSION: "3.11"

  JSONLD_SCHEMA_DIR: "schemas/jsonld"

  JSONLD_ROOT_DOCS: "docs/data"
  JSONLD_ROOT_DATA: "data/jsonld"
  JSONLD_ROOT_GRAPH: "data/graph"
  JSONLD_ROOT_CATALOG: "data/catalog"

  RELEASES_ROOT: "releases"

  METRICS_OUT: "jsonld-validate-metrics.json"

  # Optional strictness toggles (default: best-effort for extra checks)
  STRICT_SHACL: "false"
  STRICT_PROV: "false"

jobs:
  jsonld-validate:
    name: "ðŸ§¬ JSON-LD & Ontology Validation (KFM-OP v11)"
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ”Ž Detect JSON-LD content
        id: detect_jsonld
        run: |
          set -euo pipefail

          total=0
          roots=("${JSONLD_ROOT_DOCS}" "${JSONLD_ROOT_DATA}" "${JSONLD_ROOT_GRAPH}" "${JSONLD_ROOT_CATALOG}")

          for root in "${roots[@]}"; do
            if [[ -d "${root}" ]]; then
              n=$(find "${root}" -type f -name "*.jsonld" 2>/dev/null | wc -l | tr -d ' ')
              total=$((total + n))
            fi
          done

          if [[ "${total}" -gt 0 ]]; then
            echo "has_jsonld=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_jsonld=false" >> "$GITHUB_OUTPUT"
            echo "::notice title=JSON-LD validation::No *.jsonld files found under configured roots; skipping."
          fi

          echo "jsonld_file_count=${total}" >> "$GITHUB_OUTPUT"

      - name: â­ Skip JSON-LD validation (no JSON-LD content)
        if: steps.detect_jsonld.outputs.has_jsonld == 'false'
        run: |
          echo "No JSON-LD content detected; job is a no-op."

      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        if: steps.detect_jsonld.outputs.has_jsonld == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            scripts/requirements-jsonld.txt
            scripts/requirements-ontology.txt
            scripts/requirements-graph.txt

      - name: ðŸ“¦ Install JSON-LD validation tooling (deterministic)
        if: steps.detect_jsonld.outputs.has_jsonld == 'true'
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip

          if [[ -f scripts/requirements-jsonld.txt ]]; then
            pip install --no-cache-dir -r scripts/requirements-jsonld.txt
          elif [[ -f requirements.txt ]]; then
            echo "::notice title=JSON-LD tooling::scripts/requirements-jsonld.txt not found; falling back to requirements.txt."
            pip install --no-cache-dir -r requirements.txt
          else
            echo "::notice title=JSON-LD tooling::No requirements file found; assuming validator scripts/actions are self-contained."
          fi

      - name: ðŸ§¬ Run JSON-LD schema validation (composite entrypoint)
        id: schema_validate
        if: steps.detect_jsonld.outputs.has_jsonld == 'true'
        run: |
          set -euo pipefail

          if [[ ! -d "${JSONLD_SCHEMA_DIR}" ]]; then
            echo "::error title=Missing JSON-LD schemas::Expected ${JSONLD_SCHEMA_DIR}."
            exit 1
          fi

          if [[ ! -d ".github/actions/schema-validate" ]]; then
            echo "::error title=Missing composite action::Expected .github/actions/schema-validate."
            exit 1
          fi

          roots=()
          [[ -d "${JSONLD_ROOT_DOCS}" ]] && roots+=("${JSONLD_ROOT_DOCS}")
          [[ -d "${JSONLD_ROOT_DATA}" ]] && roots+=("${JSONLD_ROOT_DATA}")
          [[ -d "${JSONLD_ROOT_GRAPH}" ]] && roots+=("${JSONLD_ROOT_GRAPH}")
          [[ -d "${JSONLD_ROOT_CATALOG}" ]] && roots+=("${JSONLD_ROOT_CATALOG}")

          echo "Validating JSON-LD roots: ${roots[*]}"
          bash .github/actions/schema-validate/entrypoint.sh "${JSONLD_SCHEMA_DIR}" "${roots[@]}"

      - name: ðŸ“ SHACL / ontology shape validation (optional)
        id: shacl_validate
        if: steps.detect_jsonld.outputs.has_jsonld == 'true'
        continue-on-error: ${{ env.STRICT_SHACL != 'true' }}
        run: |
          set -euo pipefail

          if [[ ! -f scripts/validate_jsonld_shacl.py ]]; then
            echo "scripts/validate_jsonld_shacl.py not found; skipping SHACL/ontology checks."
            exit 0
          fi

          # Avoid non-deterministic 'pip install latest' here. Ensure deps are pinned in requirements.
          python -c "import rdflib" >/dev/null 2>&1 || {
            echo "::notice title=SHACL validation skipped::rdflib not installed. Add it to scripts/requirements-jsonld.txt."
            exit 0
          }

          if ! python -c "import pyshacl" >/dev/null 2>&1; then
            echo "::notice title=SHACL validation skipped::pyshacl not installed. Add it to scripts/requirements-jsonld.txt."
            exit 0
          fi

          python scripts/validate_jsonld_shacl.py \
            --schema-dir "${JSONLD_SCHEMA_DIR}" \
            --docs-root "${JSONLD_ROOT_DOCS}" \
            --data-root "${JSONLD_ROOT_DATA}" \
            --graph-root "${JSONLD_ROOT_GRAPH}" \
            --catalog-root "${JSONLD_ROOT_CATALOG}"

      - name: ðŸ“¡ PROV-O / OpenLineage consistency checks (optional)
        id: prov_validate
        if: steps.detect_jsonld.outputs.has_jsonld == 'true'
        continue-on-error: ${{ env.STRICT_PROV != 'true' }}
        run: |
          set -euo pipefail

          if [[ ! -f scripts/validate_prov_openlineage.py ]]; then
            echo "scripts/validate_prov_openlineage.py not found; skipping PROV/OpenLineage checks."
            exit 0
          fi

          python -c "import rdflib" >/dev/null 2>&1 || {
            echo "::notice title=PROV/OpenLineage validation skipped::rdflib not installed. Add it to scripts/requirements-jsonld.txt."
            exit 0
          }

          python scripts/validate_prov_openlineage.py \
            --graph-root "${JSONLD_ROOT_GRAPH}" \
            --releases-root "${RELEASES_ROOT}"

      - name: ðŸ“Š Write metrics artifact (for telemetry_export.yml)
        if: always()
        run: |
          set -euo pipefail

          has_jsonld="${{ steps.detect_jsonld.outputs.has_jsonld || 'false' }}"
          file_count="${{ steps.detect_jsonld.outputs.jsonld_file_count || '0' }}"

          schema_outcome="${{ steps.schema_validate.outcome || 'skipped' }}"
          shacl_outcome="${{ steps.shacl_validate.outcome || 'skipped' }}"
          prov_outcome="${{ steps.prov_validate.outcome || 'skipped' }}"

          cat > "${METRICS_OUT}" <<EOF
          {
            "kfm_workflow": "jsonld-validate",
            "kfm_version": "v11.2.6",
            "run": {
              "run_id": "${GITHUB_RUN_ID}",
              "run_attempt": "${GITHUB_RUN_ATTEMPT}",
              "repository": "${GITHUB_REPOSITORY}",
              "ref": "${GITHUB_REF}",
              "sha": "${GITHUB_SHA}"
            },
            "inputs": {
              "schema_dir": "${JSONLD_SCHEMA_DIR}",
              "roots": {
                "docs": "${JSONLD_ROOT_DOCS}",
                "data": "${JSONLD_ROOT_DATA}",
                "graph": "${JSONLD_ROOT_GRAPH}",
                "catalog": "${JSONLD_ROOT_CATALOG}"
              },
              "jsonld_detected": ${has_jsonld},
              "jsonld_file_count": ${file_count}
            },
            "results": {
              "schema_validation": "${schema_outcome}",
              "shacl_validation": "${shacl_outcome}",
              "prov_openlineage_validation": "${prov_outcome}"
            }
          }
          EOF

          echo "Wrote ${METRICS_OUT}"

      - name: ðŸ“¤ Upload JSON-LD validation metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jsonld-validate-metrics
          path: ${{ env.METRICS_OUT }}
          if-no-files-found: error

      - name: ðŸ§¾ Emit JSON-LD validation summary
        if: always()
        run: |
          set -euo pipefail
          {
            echo "## ðŸ§¬ JSON-LD & Ontology Validation Summary"
            echo ""
            echo "- JSON-LD files detected: \`${{ steps.detect_jsonld.outputs.has_jsonld || 'false' }}\`"
            echo "- JSON-LD file count: \`${{ steps.detect_jsonld.outputs.jsonld_file_count || '0' }}\`"
            echo "- Schema dir: \`${JSONLD_SCHEMA_DIR}\`"
            echo ""
            echo "Step outcomes:"
            echo "- Schema validation: \`${{ steps.schema_validate.outcome || 'skipped' }}\`"
            echo "- SHACL / ontology checks: \`${{ steps.shacl_validate.outcome || 'skipped' }}\`"
            echo "- PROV/OpenLineage checks: \`${{ steps.prov_validate.outcome || 'skipped' }}\`"
            echo ""
            echo "Metrics artifact:"
            echo "- \`${METRICS_OUT}\` (uploaded as \`jsonld-validate-metrics\`)"
          } >> "${GITHUB_STEP_SUMMARY}"
