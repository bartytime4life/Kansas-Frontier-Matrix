# .github/workflows/docs.yml
name: Docs

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - "docs/**"
      - "**/*.md"
      - ".github/workflows/docs.yml"
      - "mkdocs.yml"
      - "docs/conf.py"
      - "docusaurus.config.*"
      - "web/docusaurus.config.*"
      - ".pre-commit-config.yaml"
      - "Makefile"
      - "pyproject.toml"
      - "requirements*.txt"
      - "docs/requirements*.txt"
      - "package.json"
      - "package-lock.json"
      - "web/package.json"
      - "web/package-lock.json"
  push:
    branches: [main, master]
    paths:
      - "docs/**"
      - "**/*.md"
      - ".github/workflows/docs.yml"
      - "mkdocs.yml"
      - "docs/conf.py"
      - "docusaurus.config.*"
      - "web/docusaurus.config.*"
      - ".pre-commit-config.yaml"
      - "Makefile"
      - "pyproject.toml"
      - "requirements*.txt"
      - "docs/requirements*.txt"
      - "package.json"
      - "package-lock.json"
      - "web/package.json"
      - "web/package-lock.json"
  workflow_dispatch:
    inputs:
      deploy:
        description: "Deploy built docs to GitHub Pages (only if a build is detected)"
        required: false
        default: "false"
      strict:
        description: "Fail when a docs build configuration is not detected (push defaults to true, PR defaults to false)"
        required: false
        default: "true"
      python_version:
        description: "Python version for docs tooling (MkDocs/Sphinx/pre-commit)"
        required: false
        default: "3.11"
      node_version:
        description: "Node.js version for docs tooling (markdownlint/Docusaurus)"
        required: false
        default: "20"

concurrency:
  group: docs-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  docs_lint:
    name: Docs lint (protocol + markdown)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      KFM_PYTHON_VERSION: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.python_version || '3.11' }}
      KFM_NODE_VERSION: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.node_version || '20' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.KFM_PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: |
            requirements*.txt
            docs/requirements*.txt
            pyproject.toml

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.KFM_NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: |
            package-lock.json
            web/package-lock.json

      - name: Show tool versions
        run: |
          python --version
          pip --version
          node --version
          npm --version

      - name: Run docs lint (best-effort)
        shell: bash
        run: |
          set -euo pipefail

          python -m pip install --upgrade pip

          make_has_target () {
            [[ -f Makefile ]] || return 1
            make -n "$1" >/dev/null 2>&1
          }

          run_make () {
            local target="$1"
            echo "::group::make ${target}"
            make --no-print-directory "${target}"
            echo "::endgroup::"
          }

          if make_has_target "docs-lint"; then
            run_make "docs-lint"
            exit 0
          fi

          if [[ -f .pre-commit-config.yaml ]]; then
            echo "::group::pre-commit (docs/protocol)"
            python -m pip install pre-commit
            pre-commit run --all-files --show-diff-on-failure
            echo "::endgroup::"
            exit 0
          fi

          echo "::group::markdownlint-cli2"
          npx --yes markdownlint-cli2 "**/*.md"
          echo "::endgroup::"

  docs_build:
    name: Docs build (detect + build)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [docs_lint]
    outputs:
      built: ${{ steps.build.outputs.built }}
      output_dir: ${{ steps.build.outputs.output_dir }}
    env:
      # PRs default to non-strict so docs build config can be added incrementally.
      # Pushes default to strict to protect the default branch.
      KFM_DOCS_STRICT: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.strict || (github.event_name == 'pull_request' && 'false' || 'true') }}
      KFM_PYTHON_VERSION: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.python_version || '3.11' }}
      KFM_NODE_VERSION: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.node_version || '20' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.KFM_PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: |
            requirements*.txt
            docs/requirements*.txt
            pyproject.toml

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.KFM_NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: |
            package-lock.json
            web/package-lock.json

      - id: build
        name: Detect and build docs
        shell: bash
        run: |
          set -euo pipefail

          strict="${KFM_DOCS_STRICT}"
          echo "KFM_DOCS_STRICT=${strict}"

          built="false"
          output_dir=""

          python -m pip install --upgrade pip

          make_has_target () {
            [[ -f Makefile ]] || return 1
            make -n "$1" >/dev/null 2>&1
          }

          run_make () {
            local target="$1"
            echo "::group::make ${target}"
            make --no-print-directory "${target}"
            echo "::endgroup::"
          }

          # 1) Prefer repo-governed build target when available
          if make_has_target "docs-build"; then
            run_make "docs-build"

            # Try common output directories
            for cand in site docs/_build/html build public; do
              if [[ -d "${cand}" ]]; then
                output_dir="${cand}"
                break
              fi
            done

            if [[ -n "${output_dir}" ]]; then
              built="true"
            else
              msg="docs-build ran but no output directory was detected (expected one of: site, docs/_build/html, build, public)."
              if [[ "${strict}" == "true" ]]; then
                echo "::error::${msg}"
                exit 1
              else
                echo "::warning::${msg}"
              fi
            fi

          # 2) MkDocs (mkdocs.yml)
          elif [[ -f "mkdocs.yml" ]]; then
            echo "::group::MkDocs build"
            if [[ -f "docs/requirements.txt" ]]; then
              pip install -r docs/requirements.txt
            elif [[ -f "requirements.txt" ]]; then
              pip install -r requirements.txt
            else
              pip install mkdocs mkdocs-material
            fi
            mkdocs build --strict --site-dir site
            echo "::endgroup::"
            built="true"
            output_dir="site"

          # 3) Sphinx (docs/conf.py)
          elif [[ -f "docs/conf.py" ]]; then
            echo "::group::Sphinx build"
            if [[ -f "docs/requirements.txt" ]]; then
              pip install -r docs/requirements.txt
            elif [[ -f "requirements.txt" ]]; then
              pip install -r requirements.txt
            else
              pip install sphinx
            fi
            sphinx-build -b html docs docs/_build/html
            echo "::endgroup::"
            built="true"
            output_dir="docs/_build/html"

          # 4) Docusaurus (docusaurus.config.*)
          elif [[ -f "docusaurus.config.js" || -f "docusaurus.config.ts" || -f "web/docusaurus.config.js" || -f "web/docusaurus.config.ts" ]]; then
            node_root="."
            if [[ -f "web/docusaurus.config.js" || -f "web/docusaurus.config.ts" ]]; then
              node_root="web"
            fi

            if [[ ! -f "${node_root}/package.json" ]]; then
              echo "::error::Docusaurus config detected but ${node_root}/package.json not found."
              exit 1
            fi

            echo "::group::Docusaurus build (${node_root})"
            pushd "${node_root}" >/dev/null
            npm ci
            npm run build --if-present
            popd >/dev/null
            echo "::endgroup::"

            # Docusaurus default output dir
            if [[ "${node_root}" == "web" ]]; then
              output_dir="web/build"
            else
              output_dir="build"
            fi

            if [[ -d "${output_dir}" ]]; then
              built="true"
            else
              msg="Docusaurus build completed but output directory not found at ${output_dir}."
              if [[ "${strict}" == "true" ]]; then
                echo "::error::${msg}"
                exit 1
              else
                echo "::warning::${msg}"
              fi
            fi

          else
            msg="No docs build configuration detected (expected Makefile:docs-build, mkdocs.yml, docs/conf.py, or Docusaurus config)."
            if [[ "${strict}" == "true" ]]; then
              echo "::error::${msg}"
              exit 1
            else
              echo "::warning::${msg}"
            fi
          fi

          echo "built=${built}" >> "${GITHUB_OUTPUT}"
          echo "output_dir=${output_dir}" >> "${GITHUB_OUTPUT}"

      - name: Upload Pages artifact
        if: steps.build.outputs.built == 'true' && steps.build.outputs.output_dir != ''
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ steps.build.outputs.output_dir }}

  deploy_pages:
    name: Deploy Docs (GitHub Pages)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [docs_build]
    if: >
      needs.docs_build.outputs.built == 'true' &&
      needs.docs_build.outputs.output_dir != '' &&
      (
        (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true') ||
        (
          github.event_name == 'push' &&
          (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') &&
          vars.KFM_DOCS_AUTO_DEPLOY == 'true'
        )
      )

    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages

    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

