# .github/workflows/reusable/attest_reusable.yml
name: reusable_attest
on:
  workflow_call:
    inputs:
      artifact_name: {type: string, required: true}
jobs:
  attest:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/download-artifact@v4
        with: {name: "${{ inputs.artifact_name }}-bundle", path: dist}
      - name: Install cosign & slsa
        uses: sigstore/cosign-installer@v3
      - name: SLSA provenance (in-toto)
        uses: slsa-framework/slsa-github-generator/.github/actions/generator@v2
        with:
          builder-id: "https://github.com/slsa-framework/slsa-github-generator/go/builder"
          outputs: "dist/${{ inputs.artifact_name }}.intoto.jsonl"
      - name: Keyless sign artifact + sbom + provenance
        env: {COSIGN_EXPERIMENTAL: "true"}
        run: |
          cosign sign-blob --yes dist/${{ inputs.artifact_name }}.tgz            > dist/${{ inputs.artifact_name }}.tgz.sig
          cosign sign-blob --yes dist/${{ inputs.artifact_name }}.sbom.spdx.json > dist/${{ inputs.artifact_name }}.sbom.sig
          cosign sign-blob --yes dist/${{ inputs.artifact_name }}.intoto.jsonl   > dist/${{ inputs.artifact_name }}.intoto.sig
      - uses: actions/upload-artifact@v4
        with: {name: "${{ inputs.artifact_name }}-attest", path: dist}
