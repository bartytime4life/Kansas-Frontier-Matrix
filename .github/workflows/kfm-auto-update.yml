# .github/workflows/kfm-auto-update.yml
# ğŸ”„ Kansas Frontier Matrix â€” Auto-Update & Governed Promotion
# v11.2.2 â€” Diamondâ¹ Î© / CrownâˆÎ© Ultimate Certified
#
# Purpose:
#   Perform scheduled or manual auto-refresh of data/models,
#   validate via FAIR+CARE, sovereignty (H3), metadata contracts,
#   and promote artifacts from stage â†’ prod only after full governance approval.
#
# Governance Layers Applied:
#   - KFM-MDP v11.2.2 (docs + metadata)
#   - FAIR+CARE enforcement (faircare_validate)
#   - Indigenous sovereignty (H3 generalization)
#   - STAC/DCAT/JSON-LD + Ontology validation
#   - OpenLineage v2.5 emission
#   - SBOM/SLSA checks (sbom_verify downstream)
#   - Telemetry â†’ releases/github-infra-telemetry.json

name: ğŸ”„ kfm-auto-update

on:
  schedule:
    - cron: "0 3 * * *" # Daily auto-refresh at 03:00 UTC
  workflow_dispatch:
    inputs:
      reason:
        description: "Why are you running this manually? (optional)"
        required: false
        type: string

# Prevent overlapping auto-update runs
concurrency:
  group: kfm-auto-update
  cancel-in-progress: false

# Required permissions for governed promotion
permissions:
  contents: write       # Needed for tagging + pushing tags
  id-token: write       # Needed for OIDC auth to clouds if used
  actions: read
  packages: read

defaults:
  run:
    shell: bash

env:
  PYTHON_VERSION: "3.11"
  KFM_ENV: "stage"      # default stage env
  KFM_TELEMETRY_OUT: "github-infra-telemetry.json"

jobs:

  ###########################################################################
  # 1. INGEST + VALIDATE (Stage)
  ###########################################################################
  ingest:
    name: "ğŸ§ª Ingest & Validate (Stage)"
    runs-on: ubuntu-latest
    environment: stage
    timeout-minutes: 150

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Dependencies (Locked)
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt

      - name: ğŸ”„ Run Ingest Agent (Stage)
        run: |
          python run_agent.py --mode ingest --stage stage

      # -------------------
      # Metadata validation
      # -------------------
      - name: ğŸ“š Validate Docs & Front-Matter (KFM-MDP v11.2.2)
        run: |
          bash .github/actions/markdown-lint/entrypoint.sh

      - name: ğŸ›° Validate STAC 1.x
        run: |
          bash .github/actions/stac-validate/entrypoint.sh data/stac

      - name: ğŸ—‚ Validate DCAT 3.0
        run: |
          bash .github/actions/dcat-validate/entrypoint.sh

      - name: ğŸ§¬ JSON-LD & Ontology Validation
        run: |
          bash .github/actions/schema-validate/entrypoint.sh schemas/jsonld

      # -------------------
      # FAIR+CARE & Sovereignty gates
      # -------------------
      - name: âš– FAIR+CARE Governance Check
        run: |
          python scripts/run_faircare_checks.py

      - name: ğŸ§Š H3 Generalization / Sensitive Coordinate Enforcement
        run: |
          python scripts/h3_masking_check.py --stage stage

      # -------------------
      # Data contracts & lineage
      # -------------------
      - name: ğŸ” Validate Data Pipelines (KFM-PDC v11)
        run: |
          python scripts/validate_pipelines.py

      - name: ğŸ“¡ Emit OpenLineage Events (Stage)
        run: |
          python scripts/emit_lineage.py --env stage --mode ingest

      # -------------------
      # Domain-specific validation hooks (optional)
      # -------------------
      - name: ğŸŒ¿ Climate/Hydro Model Checks (if present)
        continue-on-error: true
        run: |
          [[ -f scripts/validate_climate.py ]] && python scripts/validate_climate.py

      # -------------------
      # Telemetry snapshot
      # -------------------
      - name: ğŸ“Š Export Stage Telemetry
        run: |
          python scripts/telemetry_collect.py --env stage --out ${{ env.KFM_TELEMETRY_OUT }}

      - name: ğŸ“¤ Upload Stage Telemetry Artifact
        uses: actions/upload-artifact@v5
        with:
          name: telemetry-stage
          path: ${{ env.KFM_TELEMETRY_OUT }}


  ###########################################################################
  # 2. PROMOTE TO PRODUCTION (Governed)
  ###########################################################################
  promote:
    name: "ğŸš€ Promote to Production (Governed)"
    needs: ingest
    runs-on: ubuntu-latest

    # Gated environment: reviewers + waiting period
    environment:
      name: prod
      url: https://kfm.example.org

    timeout-minutes: 90

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # -------------------
      # Final governance gates
      # -------------------
      - name: âš– Final FAIR+CARE Gate
        run: |
          python scripts/run_faircare_checks.py --env prod

      - name: ğŸ§Š Final H3 Generalization Check
        run: |
          python scripts/h3_masking_check.py --stage prod

      - name: ğŸ›¡ Supply-Chain (SBOM + SLSA) Check
        run: |
          python scripts/verify_supply_chain.py

      - name: ğŸ” Promote Artifacts Stage â†’ Prod
        run: |
          python promote.py --from stage --to prod

      # -------------------
      # Version tagging
      # -------------------
      - name: ğŸ· Tag Release
        if: ${{ success() }}
        run: |
          ver=$(python scripts/print_version.py)
          git config user.name "kfm-auto-update-bot"
          git config user.email "auto@kfm.example.org"
          git tag -a "kfm-${ver}" -m "Automated promotion"
          git push --tags

      # -------------------
      # Telemetry for promotion run
      # -------------------
      - name: ğŸ“Š Export Prod Telemetry
        run: |
          python scripts/telemetry_collect.py --env prod --out ${{ env.KFM_TELEMETRY_OUT }}

      - name: ğŸ“¤ Upload Prod Telemetry Artifact
        uses: actions/upload-artifact@v5
        with:
          name: telemetry-prod
          path: ${{ env.KFM_TELEMETRY_OUT }}
