# .github/workflows/kfm-auto-update.yml
# ğŸ”„ Kansas Frontier Matrix â€” Auto-Update & Governed Promotion
# v11.2.6 â€” Diamondâ¹ Î© / CrownâˆÎ© Ultimate Certified
#
# Purpose:
#   Perform scheduled or manual auto-refresh of data/models,
#   validate via FAIR+CARE, sovereignty (H3), metadata contracts,
#   and promote artifacts from stage â†’ prod only after full governance approval.
#
# Governance Layers Applied:
#   - KFM-MDP v11.2.6 (docs + metadata)
#   - FAIR+CARE enforcement (faircare_validate)
#   - Indigenous sovereignty (H3 generalization)
#   - STAC/DCAT/JSON-LD + Ontology validation
#   - OpenLineage emission (scripted)
#   - SBOM/SLSA checks (sbom_verify downstream)
#   - Telemetry snapshots (release packaging / dashboards)

name: ğŸ”„ kfm-auto-update

on:
  schedule:
    - cron: "0 3 * * *" # Daily auto-refresh at 03:00 UTC on default branch
  workflow_dispatch:
    inputs:
      reason:
        description: "Why are you running this manually? (optional)"
        required: false
        type: string

concurrency:
  group: kfm-auto-update
  cancel-in-progress: false

permissions:
  contents: write
  id-token: write
  actions: read
  packages: read

defaults:
  run:
    shell: bash

env:
  PYTHON_VERSION: "3.11"
  KFM_ENV: "stage"
  KFM_TELEMETRY_OUT: "github-infra-telemetry.json"
  STAC_ROOT: "data/stac"
  STAC_SCHEMA_DIR: "schemas/stac"

jobs:
  ingest:
    name: "ğŸ§ª Ingest & Validate (Stage)"
    runs-on: ubuntu-22.04
    environment: stage
    timeout-minutes: 150

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }} with cache
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements.txt

      - name: ğŸ“¦ Install Dependencies (Locked)
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt

      - name: ğŸ”„ Run Ingest Agent (Stage)
        run: |
          set -euo pipefail
          python run_agent.py --mode ingest --stage stage

      - name: ğŸ“š Validate Docs & Front-Matter (KFM-MDP v11.2.6)
        run: |
          set -euo pipefail
          bash .github/actions/markdown-lint/entrypoint.sh

      - name: ğŸ›° Validate STAC 1.x (KFM-STAC v11)
        run: |
          set -euo pipefail
          bash .github/actions/stac-validate/entrypoint.sh "${STAC_ROOT}" "${STAC_SCHEMA_DIR}"

      - name: ğŸ—‚ Validate DCAT 3.0 (KFM-DCAT v11)
        run: |
          set -euo pipefail
          bash .github/actions/dcat-validate/entrypoint.sh

      - name: ğŸ§¬ JSON-LD & Ontology Validation (KFM-OP v11)
        run: |
          set -euo pipefail
          # Validate known JSON-LD roots if present; schema-validate should tolerate missing roots gracefully.
          bash .github/actions/schema-validate/entrypoint.sh "schemas/jsonld" "docs/data" "data/jsonld" "data/graph" "data/catalog"

      - name: âš– FAIR+CARE Governance Check (Stage)
        run: |
          set -euo pipefail
          python scripts/run_faircare_checks.py --env stage

      - name: ğŸ§Š H3 Generalization / Sensitive Coordinate Enforcement (Stage)
        run: |
          set -euo pipefail
          python scripts/h3_masking_check.py --stage stage

      - name: ğŸ” Validate Data Pipelines (KFM-PDC v11)
        run: |
          set -euo pipefail
          python scripts/validate_pipelines.py

      - name: ğŸ“¡ Emit OpenLineage Events (Stage)
        run: |
          set -euo pipefail
          python scripts/emit_lineage.py --env stage --mode ingest

      - name: ğŸŒ¿ Climate/Hydro Model Checks (if present)
        continue-on-error: true
        run: |
          set -euo pipefail
          [[ -f scripts/validate_climate.py ]] && python scripts/validate_climate.py

      - name: ğŸ“Š Export Stage Telemetry
        run: |
          set -euo pipefail
          python scripts/telemetry_collect.py --env stage --out "${KFM_TELEMETRY_OUT}"

      - name: ğŸ“¤ Upload Stage Telemetry Artifact
        uses: actions/upload-artifact@v4
        with:
          name: telemetry-stage
          path: ${{ env.KFM_TELEMETRY_OUT }}

  promote:
    name: "ğŸš€ Promote to Production (Governed)"
    needs: ingest
    runs-on: ubuntu-22.04
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 90

    environment:
      name: prod
      url: https://kfm.example.org

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # tagging + provenance tools are safer with full history

      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }} with cache
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements.txt

      - name: ğŸ“¦ Install Dependencies (Locked)
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt

      - name: âš– Final FAIR+CARE Gate (Prod)
        run: |
          set -euo pipefail
          python scripts/run_faircare_checks.py --env prod

      - name: ğŸ§Š Final H3 Generalization Check (Prod)
        run: |
          set -euo pipefail
          python scripts/h3_masking_check.py --stage prod

      - name: ğŸ›¡ Supply-Chain (SBOM + SLSA) Check
        run: |
          set -euo pipefail
          python scripts/verify_supply_chain.py

      - name: ğŸ” Promote Artifacts Stage â†’ Prod
        run: |
          set -euo pipefail
          python promote.py --from stage --to prod

      - name: ğŸ“¡ Emit OpenLineage Events (Prod)
        run: |
          set -euo pipefail
          python scripts/emit_lineage.py --env prod --mode promote

      - name: ğŸ· Tag Release (Governed)
        if: success()
        run: |
          set -euo pipefail
          ver="$(python scripts/print_version.py)"
          tag="kfm-${ver}"
          git config user.name "kfm-auto-update-bot"
          git config user.email "auto@kfm.example.org"
          git tag -a "${tag}" -m "Automated promotion"
          git push origin "${tag}"

      - name: ğŸ“Š Export Prod Telemetry
        run: |
          set -euo pipefail
          python scripts/telemetry_collect.py --env prod --out "${KFM_TELEMETRY_OUT}"

      - name: ğŸ“¤ Upload Prod Telemetry Artifact
        uses: actions/upload-artifact@v4
        with:
          name: telemetry-prod
          path: ${{ env.KFM_TELEMETRY_OUT }}
