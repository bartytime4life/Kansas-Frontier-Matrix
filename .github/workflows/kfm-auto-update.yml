# .github/workflows/kfm-auto-update.yml
# ðŸ”„ Kansas Frontier Matrix â€” Auto-Update & Governed Promotion
# v11.2.6 â€” Diamondâ¹ Î© / CrownâˆžÎ© Ultimate Certified
#
# Purpose:
#   Perform scheduled or manual auto-refresh of data/models,
#   validate via FAIR+CARE, sovereignty (H3), metadata contracts,
#   and promote artifacts from stage â†’ prod only after full governance approval.
#
# Governance Layers Applied:
#   - KFM-MDP v11.2.6 (docs + metadata)
#   - FAIR+CARE enforcement (faircare_validate)
#   - Indigenous sovereignty (H3 generalization)
#   - STAC/DCAT/JSON-LD + Ontology validation
#   - OpenLineage emission (lineage is mandatory, even on failure where feasible)
#   - SBOM/SLSA checks (verify_supply_chain)
#   - Telemetry artifacts for downstream packaging/aggregation

name: ðŸ”„ kfm-auto-update

on:
  schedule:
    - cron: "0 3 * * *" # Daily auto-refresh at 03:00 UTC (runs on default branch)
  workflow_dispatch:
    inputs:
      reason:
        description: "Why are you running this manually? (optional)"
        required: false
        type: string

# Prevent overlapping auto-update runs per ref
concurrency:
  group: kfm-auto-update-${{ github.ref }}
  cancel-in-progress: false

# Default permissions: least privilege. Escalate per-job as needed.
permissions:
  contents: read
  actions: read

defaults:
  run:
    shell: bash

env:
  PYTHON_VERSION: "3.11"

  # Lifecycle envs (KFM convention)
  KFM_STAGE_ENV: "stage"
  KFM_PROD_ENV: "prod"

  # Validation roots (repo conventions)
  STAC_ROOT: "data/stac"
  STAC_SCHEMA_DIR: "schemas/stac"

  # Telemetry
  KFM_TELEMETRY_OUT: "github-infra-telemetry.json"

jobs:
  ###########################################################################
  # 1. INGEST + VALIDATE (Stage)
  ###########################################################################
  ingest:
    name: "ðŸ§ª Ingest & Validate (Stage)"
    runs-on: ubuntu-22.04
    environment: stage
    timeout-minutes: 150

    # If your ingest scripts commit or open PRs, elevate permissions here.
    # Keeping read-only by default is safer; scripts can still write to workspace/artifacts.
    permissions:
      contents: read
      actions: read

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }} with cache
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            scripts/requirements*.txt

      - name: ðŸ“¦ Install Dependencies (Locked)
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [[ -f requirements.txt ]]; then
            pip install --no-cache-dir -r requirements.txt
          else
            echo "::error title=Missing dependencies::requirements.txt not found."
            exit 1
          fi

      - name: ðŸ”„ Run Ingest Agent (Stage)
        run: |
          set -euo pipefail
          if [[ ! -f run_agent.py ]]; then
            echo "::error title=Missing ingest entrypoint::run_agent.py not found."
            exit 1
          fi
          python run_agent.py --mode ingest --stage "${KFM_STAGE_ENV}"

      # -------------------
      # Metadata validation
      # -------------------
      - name: ðŸ“š Validate Docs & Front-Matter (KFM-MDP v11.2.6)
        run: |
          set -euo pipefail
          if [[ -d ".github/actions/markdown-lint" ]]; then
            bash .github/actions/markdown-lint/entrypoint.sh
          else
            echo "::error title=Missing action::.github/actions/markdown-lint not found."
            exit 1
          fi

      - name: ðŸ›° Validate STAC 1.x (Local Catalog)
        run: |
          set -euo pipefail
          if [[ -d ".github/actions/stac-validate" ]]; then
            if [[ -d "${STAC_ROOT}" ]]; then
              bash .github/actions/stac-validate/entrypoint.sh "${STAC_ROOT}" "${STAC_SCHEMA_DIR}"
            else
              echo "::notice title=STAC validate::No ${STAC_ROOT} directory; skipping."
            fi
          else
            echo "::error title=Missing action::.github/actions/stac-validate not found."
            exit 1
          fi

      - name: ðŸ—‚ Validate DCAT 3.0
        run: |
          set -euo pipefail
          if [[ -d ".github/actions/dcat-validate" ]]; then
            bash .github/actions/dcat-validate/entrypoint.sh
          else
            echo "::error title=Missing action::.github/actions/dcat-validate not found."
            exit 1
          fi

      - name: ðŸ§¬ JSON-LD & Ontology Validation
        run: |
          set -euo pipefail
          if [[ -d ".github/actions/schema-validate" ]]; then
            if [[ -d "schemas/jsonld" ]]; then
              # Validate JSON-LD schema set against relevant repo roots (adjust target as needed)
              bash .github/actions/schema-validate/entrypoint.sh "schemas/jsonld" "data"
            else
              echo "::notice title=JSON-LD validate::No schemas/jsonld directory; skipping."
            fi
          else
            echo "::error title=Missing action::.github/actions/schema-validate not found."
            exit 1
          fi

      # -------------------
      # FAIR+CARE & Sovereignty gates
      # -------------------
      - name: âš– FAIR+CARE Governance Check (Stage)
        run: |
          set -euo pipefail
          if [[ -f scripts/run_faircare_checks.py ]]; then
            python scripts/run_faircare_checks.py --env "${KFM_STAGE_ENV}"
          else
            echo "::error title=Missing FAIR+CARE check::scripts/run_faircare_checks.py not found."
            exit 1
          fi

      - name: ðŸ§Š H3 Generalization / Sensitive Coordinate Enforcement (Stage)
        run: |
          set -euo pipefail
          if [[ -f scripts/h3_masking_check.py ]]; then
            python scripts/h3_masking_check.py --stage "${KFM_STAGE_ENV}"
          else
            echo "::error title=Missing H3 masking check::scripts/h3_masking_check.py not found."
            exit 1
          fi

      # -------------------
      # Data contracts & lineage
      # -------------------
      - name: ðŸ” Validate Data Pipelines (KFM-PDC v11)
        run: |
          set -euo pipefail
          if [[ -f scripts/validate_pipelines.py ]]; then
            python scripts/validate_pipelines.py
          else
            echo "::error title=Missing pipeline validator::scripts/validate_pipelines.py not found."
            exit 1
          fi

      - name: ðŸ“¡ Emit OpenLineage Events (Stage)
        run: |
          set -euo pipefail
          if [[ -f scripts/emit_lineage.py ]]; then
            python scripts/emit_lineage.py --env "${KFM_STAGE_ENV}" --mode ingest
          else
            echo "::error title=Missing lineage emitter::scripts/emit_lineage.py not found."
            exit 1
          fi

      # -------------------
      # Domain-specific validation hooks (optional)
      # -------------------
      - name: ðŸŒ¿ Climate/Hydro Model Checks (if present)
        continue-on-error: true
        run: |
          set -euo pipefail
          if [[ -f scripts/validate_climate.py ]]; then
            python scripts/validate_climate.py
          else
            echo "scripts/validate_climate.py not found; skipping."
          fi

      # -------------------
      # Telemetry snapshot (Stage)
      # -------------------
      - name: ðŸ“Š Export Stage Telemetry
        run: |
          set -euo pipefail
          if [[ -f scripts/telemetry_collect.py ]]; then
            python scripts/telemetry_collect.py --env "${KFM_STAGE_ENV}" --out "${KFM_TELEMETRY_OUT}"
          else
            echo "::error title=Missing telemetry collector::scripts/telemetry_collect.py not found."
            exit 1
          fi

      - name: ðŸ“¤ Upload Stage Telemetry Artifact
        uses: actions/upload-artifact@v4
        with:
          name: telemetry-stage
          path: ${{ env.KFM_TELEMETRY_OUT }}
          if-no-files-found: error

      - name: ðŸ§¾ Emit Stage Summary
        if: always()
        run: |
          set -euo pipefail
          {
            echo "## ðŸ”„ KFM Auto-Update â€” Stage Summary"
            echo ""
            echo "- Trigger: \`${{ github.event_name }}\`"
            echo "- Stage env: \`${KFM_STAGE_ENV}\`"
            echo "- STAC root: \`${STAC_ROOT}\`"
            echo "- Telemetry: \`${KFM_TELEMETRY_OUT}\`"
            echo ""
            echo "Stage ingest + validation completed (or failed) with governed checks."
          } >> "${GITHUB_STEP_SUMMARY}"

  ###########################################################################
  # 2. PROMOTE TO PRODUCTION (Governed)
  ###########################################################################
  promote:
    name: "ðŸš€ Promote to Production (Governed)"
    needs: ingest
    runs-on: ubuntu-22.04

    # Only allow promotion from main â†’ prod environment
    if: github.ref == 'refs/heads/main'

    # Gated environment: reviewers + waiting period configured in repo settings
    environment:
      name: prod
      url: https://kfm.example.org

    timeout-minutes: 90

    permissions:
      contents: write     # tagging requires write; do NOT broaden more than needed
      actions: read
      id-token: write     # for OIDC-based provenance/signing if your scripts use it

    steps:
      - name: ðŸ“¥ Checkout repository (for tagging)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }} with cache
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            scripts/requirements*.txt

      - name: ðŸ“¦ Install Dependencies (Locked)
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [[ -f requirements.txt ]]; then
            pip install --no-cache-dir -r requirements.txt
          else
            echo "::error title=Missing dependencies::requirements.txt not found."
            exit 1
          fi

      # -------------------
      # Final governance gates
      # -------------------
      - name: âš– Final FAIR+CARE Gate (Prod)
        run: |
          set -euo pipefail
          if [[ -f scripts/run_faircare_checks.py ]]; then
            python scripts/run_faircare_checks.py --env "${KFM_PROD_ENV}"
          else
            echo "::error title=Missing FAIR+CARE check::scripts/run_faircare_checks.py not found."
            exit 1
          fi

      - name: ðŸ§Š Final H3 Generalization Check (Prod)
        run: |
          set -euo pipefail
          if [[ -f scripts/h3_masking_check.py ]]; then
            python scripts/h3_masking_check.py --stage "${KFM_PROD_ENV}"
          else
            echo "::error title=Missing H3 masking check::scripts/h3_masking_check.py not found."
            exit 1
          fi

      - name: ðŸ›¡ Supply-Chain (SBOM + SLSA) Check
        run: |
          set -euo pipefail
          if [[ -f scripts/verify_supply_chain.py ]]; then
            python scripts/verify_supply_chain.py
          else
            echo "::error title=Missing supply-chain verifier::scripts/verify_supply_chain.py not found."
            exit 1
          fi

      # -------------------
      # Promotion
      # -------------------
      - name: ðŸ” Promote Artifacts Stage â†’ Prod
        run: |
          set -euo pipefail
          if [[ -f promote.py ]]; then
            python promote.py --from "${KFM_STAGE_ENV}" --to "${KFM_PROD_ENV}"
          else
            echo "::error title=Missing promotion entrypoint::promote.py not found."
            exit 1
          fi

      - name: ðŸ“¡ Emit OpenLineage Events (Prod)
        run: |
          set -euo pipefail
          if [[ -f scripts/emit_lineage.py ]]; then
            python scripts/emit_lineage.py --env "${KFM_PROD_ENV}" --mode promote
          else
            echo "::error title=Missing lineage emitter::scripts/emit_lineage.py not found."
            exit 1
          fi

      # -------------------
      # Version tagging (governed)
      # -------------------
      - name: ðŸ· Tag Release (single-tag push; no global --tags)
        if: success()
        run: |
          set -euo pipefail

          if [[ ! -f scripts/print_version.py ]]; then
            echo "::error title=Missing version script::scripts/print_version.py not found."
            exit 1
          fi

          ver="$(python scripts/print_version.py)"
          tag="kfm-${ver}"

          git config user.name "kfm-auto-update-bot"
          git config user.email "auto@kfm.example.org"

          if git rev-parse "${tag}" >/dev/null 2>&1; then
            echo "Tag ${tag} already exists; skipping."
            exit 0
          fi

          git tag -a "${tag}" -m "Automated promotion (${KFM_STAGE_ENV} â†’ ${KFM_PROD_ENV})"
          git push origin "${tag}"

      # -------------------
      # Telemetry for promotion run
      # -------------------
      - name: ðŸ“Š Export Prod Telemetry
        run: |
          set -euo pipefail
          if [[ -f scripts/telemetry_collect.py ]]; then
            python scripts/telemetry_collect.py --env "${KFM_PROD_ENV}" --out "${KFM_TELEMETRY_OUT}"
          else
            echo "::error title=Missing telemetry collector::scripts/telemetry_collect.py not found."
            exit 1
          fi

      - name: ðŸ“¤ Upload Prod Telemetry Artifact
        uses: actions/upload-artifact@v4
        with:
          name: telemetry-prod
          path: ${{ env.KFM_TELEMETRY_OUT }}
          if-no-files-found: error

      - name: ðŸ§¾ Emit Promotion Summary
        if: always()
        run: |
          set -euo pipefail
          {
            echo "## ðŸš€ KFM Auto-Update â€” Promotion Summary"
            echo ""
            echo "- Ref: \`${GITHUB_REF}\`"
            echo "- Prod env: \`${KFM_PROD_ENV}\`"
            echo "- Supply-chain verified: \`scripts/verify_supply_chain.py\`"
            echo "- Telemetry: \`${KFM_TELEMETRY_OUT}\`"
            echo ""
            echo "Promotion is governed via the \`prod\` environment (reviewers / wait rules in repo settings)."
          } >> "${GITHUB_STEP_SUMMARY}"
