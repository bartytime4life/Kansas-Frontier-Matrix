# .github/workflows/stac-validate.yml
name: STAC Validate

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - "**/catalog.json"
      - "**/collection.json"
      - "data/**"
      - "catalogs/**"
      - "stac/**"
      - "schemas/**"
      - "src/**"
      - "Makefile"
      - "pyproject.toml"
      - "requirements*.txt"
      - ".github/workflows/stac-validate.yml"
  push:
    branches: [main, master]
    paths:
      - "**/catalog.json"
      - "**/collection.json"
      - "data/**"
      - "catalogs/**"
      - "stac/**"
      - "schemas/**"
      - "src/**"
      - "Makefile"
      - "pyproject.toml"
      - "requirements*.txt"
      - ".github/workflows/stac-validate.yml"
  workflow_dispatch:
    inputs:
      strict:
        description: "Fail if no STAC roots are detected"
        required: false
        default: "true"
      python_version:
        description: "Python version for validation tooling"
        required: false
        default: "3.11"

concurrency:
  group: stac-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  validate:
    name: Validate STAC (schema + structure)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      KFM_STAC_STRICT: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.strict || 'true' }}
      KFM_PYTHON_VERSION: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.python_version || '3.11' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.KFM_PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: |
            requirements*.txt
            pyproject.toml

      - name: Show versions
        run: |
          python --version
          pip --version

      - name: STAC validation
        shell: bash
        run: |
          set -euo pipefail

          strict="${KFM_STAC_STRICT}"
          echo "KFM_STAC_STRICT=${strict}"

          python -m pip install --upgrade pip

          make_has_target () {
            [[ -f Makefile ]] || return 1
            make -n "$1" >/dev/null 2>&1
          }

          run_make () {
            local target="$1"
            echo "::group::make ${target}"
            make --no-print-directory "${target}"
            echo "::endgroup::"
          }

          # Prefer repo-governed targets when available
          if make_has_target "stac-validate"; then
            run_make "stac-validate"
            exit 0
          fi

          if make_has_target "schema-validate"; then
            echo "::warning title=Using schema-validate fallback::Makefile target stac-validate not found; running schema-validate."
            run_make "schema-validate"
            exit 0
          fi

          # Fallback validator: PySTAC
          python -m pip install "pystac[validation]"

          # Discover likely STAC roots (minimal set to avoid redundant deep re-validations)
          mapfile -t roots < <(python - <<'PY'
          from __future__ import annotations

          import pathlib

          CANDIDATE_DIRS = ("data", "catalogs", "stac", "docs", "mcp")
          candidates: list[pathlib.Path] = []

          for base in CANDIDATE_DIRS:
            p = pathlib.Path(base)
            if not p.exists():
              continue
            candidates.extend(p.rglob("catalog.json"))
            candidates.extend(p.rglob("collection.json"))

          # De-dup + keep only top-level roots (skip roots nested under already-selected roots)
          uniq = sorted(set(candidates), key=lambda x: len(x.parts))
          selected: list[pathlib.Path] = []
          for f in uniq:
            if any(f.is_relative_to(s.parent) for s in selected):
              continue
            selected.append(f)

          for f in selected:
            print(str(f))
          PY
          )

          if [[ "${#roots[@]}" -eq 0 ]]; then
            msg="No STAC roots detected (catalog.json / collection.json) under: data/, catalogs/, stac/, docs/, mcp/."
            if [[ "${strict}" == "true" ]]; then
              echo "::error::${msg}"
              exit 1
            else
              echo "::warning::${msg}"
              exit 0
            fi
          fi

          {
            echo "### STAC validation"
            echo ""
            echo "Detected STAC roots:"
            for r in "${roots[@]}"; do
              echo "- \`${r}\`"
            done
          } >> "${GITHUB_STEP_SUMMARY}"

          for r in "${roots[@]}"; do
            echo "::group::pystac validate ${r}"
            if [[ "$(basename "${r}")" == "catalog.json" ]]; then
              pystac validate "${r}" --recursive
            else
              pystac validate "${r}"
            fi
            echo "::endgroup::"
          done

