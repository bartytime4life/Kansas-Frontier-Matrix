# ðŸ”„ Kansas Frontier Matrix â€” STAC Validation Workflow
# File: .github/workflows/stac-validate.yml
# Purpose: Validate all STAC 1.0.0 catalogs/collections/items under data/stac/**
# Governance: Master Coder Protocol (MCP v6.3) Â· FAIR+CARE Â· Diamondâ¹ Î© / CrownâˆžÎ©
# Notes:
#  - Produces machine-readable validation reports under reports/self-validation/stac/
#  - Uploads artifacts for audit and telemetry pipelines

name: STAC Validate

on:
  workflow_dispatch:
  push:
    paths:
      - "data/stac/**"
      - ".github/workflows/stac-validate.yml"
  pull_request:
    paths:
      - "data/stac/**"
      - ".github/workflows/stac-validate.yml"

permissions:
  contents: read
  actions: read
  checks: write

concurrency:
  group: stac-validate-${{ github.ref }}
  cancel-in-progress: true

env:
  STAC_DIR: data/stac
  REPORT_DIR: reports/self-validation/stac
  PYTHON_VERSION: "3.11"

jobs:
  stac-validate:
    name: Validate STAC (pystac + stac-validator)
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4

      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: ðŸ“¦ Install STAC toolchain
        run: |
          python -m pip install --upgrade pip
          # pystac includes a validator; stac-validator adds additional checks
          pip install "pystac[validation]>=1.9.0" stac-validator jsonschema

      - name: ðŸ§­ Ensure directories exist
        run: |
          mkdir -p "${REPORT_DIR}"
          echo "STAC_DIR=${STAC_DIR}"
          echo "REPORT_DIR=${REPORT_DIR}"

      - name: ðŸ” Discover STAC JSON files
        id: discover
        shell: bash
        run: |
          shopt -s globstar nullglob
          files=(${STAC_DIR}/**/*.json)
          echo "found=${#files[@]}" >> $GITHUB_OUTPUT
          printf "%s\n" "${files[@]}" > "${REPORT_DIR}/filelist.txt"
          echo "Discovered ${#files[@]} STAC JSON files."

      - name: ðŸ§ª Validate with pystac (structure & links)
        if: steps.discover.outputs.found != '0'
        shell: bash
        run: |
          set -euo pipefail
          python - << 'PY'
import json, subprocess, sys, pathlib, os
stac_root = os.environ["STAC_DIR"]
report_dir = os.environ["REPORT_DIR"]
results = []
for p in pathlib.Path(stac_root).rglob("*.json"):
    # pystac validation
    cmd = ["python", "-c",
           "import pystac,sys,json; " \
           "p=sys.argv[1]; " \
           "c=pystac.read_file(p); " \
           "c.validate()"]
    ok = True
    err = ""
    try:
        subprocess.check_output(cmd+[str(p)], stderr=subprocess.STDOUT)
    except subprocess.CalledProcessError as e:
        ok = False
        err = e.output.decode("utf-8", "ignore")
    results.append({"path": str(p), "tool": "pystac", "ok": ok, "error": err})
with open(os.path.join(report_dir,"pystac_results.json"),"w") as f:
    json.dump(results,f,indent=2)
PY

      - name: ðŸ§ª Validate with stac-validator (spec conformance)
        if: steps.discover.outputs.found != '0'
        shell: bash
        run: |
          set -euo pipefail
          echo "Running stac-validator across ${STAC_DIR}"
          # Summary counters
          pass=0; fail=0
          : > "${REPORT_DIR}/stac_validator_results.ndjson"
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            # Run stac-validator; capture JSON output
            out="$(stac-validator --raw "$file" || true)"
            echo "$out" >> "${REPORT_DIR}/stac_validator_results.ndjson"
            # Determine status (stac-validator returns JSON; check "valid": true/false)
            valid=$(echo "$out" | jq -r '.valid // empty')
            if [ "$valid" = "true" ]; then pass=$((pass+1)); else fail=$((fail+1)); fi
          done < <(find "${STAC_DIR}" -type f -name "*.json" | sort)
          printf '{"summary":{"passed":%s,"failed":%s}}\n' "$pass" "$fail" \
            | tee "${REPORT_DIR}/stac_validator_summary.json"
          # Emit annotations if failures found
          if [ "$fail" -gt 0 ]; then
            echo "::warning title=STAC Validation::${fail} file(s) failed stac-validator checks"
          fi

      - name: ðŸ§¾ Create combined summary
        if: steps.discover.outputs.found != '0'
        shell: bash
        run: |
          python - << 'PY'
import json, os, glob
rd = os.environ["REPORT_DIR"]
summary = {"pystac": {}, "stac_validator": {}}
try:
    with open(os.path.join(rd,"pystac_results.json")) as f:
        res = json.load(f)
    summary["pystac"]["files"] = len(res)
    summary["pystac"]["failed"] = sum(1 for r in res if not r["ok"])
except FileNotFoundError:
    summary["pystac"]["files"]=0
    summary["pystac"]["failed"]=0
try:
    with open(os.path.join(rd,"stac_validator_summary.json")) as f:
        s = json.load(f)
    summary["stac_validator"] = s.get("summary",{})
except FileNotFoundError:
    summary["stac_validator"]={"passed":0,"failed":0}
with open(os.path.join(rd,"_summary.json"),"w") as f:
    json.dump(summary,f,indent=2)
print(json.dumps(summary, indent=2))
PY

      - name: âœ… Fail if any validation failed
        if: steps.discover.outputs.found != '0'
        shell: bash
        run: |
          py_fail=$(jq -r '.pystac.failed' "${REPORT_DIR}/_summary.json")
          sv_fail=$(jq -r '.stac_validator.failed' "${REPORT_DIR}/_summary.json")
          total_fail=$((py_fail + sv_fail))
          if [ "${total_fail}" -gt 0 ]; then
            echo "::error title=STAC Validation Failed::${total_fail} files failed validation. See artifacts for details."
            exit 1
          fi
          echo "All STAC files passed validation."

      - name: ðŸ“¤ Upload validation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: stac-validation-reports
          path: |
            ${{ env.REPORT_DIR }}/filelist.txt
            ${{ env.REPORT_DIR }}/pystac_results.json
            ${{ env.REPORT_DIR }}/stac_validator_results.ndjson
            ${{ env.REPORT_DIR }}/stac_validator_summary.json
            ${{ env.REPORT_DIR }}/_summary.json
          if-no-files-found: warn

      - name: ðŸ§¾ Job summary
        if: always()
        run: |
          echo "### STAC Validation Summary" >> $GITHUB_STEP_SUMMARY
          if [ -f "${REPORT_DIR}/_summary.json" ]; then
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat "${REPORT_DIR}/_summary.json" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "No STAC files found or summary missing." >> $GITHUB_STEP_SUMMARY
          fi
