# .github/ISSUE_TEMPLATE/api_contract_change.yml
name: "ğŸ”Œ API Contract Change"
description: "Propose/track changes to KFM REST(OpenAPI)/GraphQL contracts (contract-first, governed API boundary)."
title: "ğŸ”Œ API Contract: <short summary>"
labels:
  - "type: feature"
  - "stage: api"
  - "component: api"
  - "governance: contract"

body:
  - type: markdown
    attributes:
      value: |
        ## ğŸ”Œ API Contract Change (KFM)
        This form is for **REST/OpenAPI** and **GraphQL** contract changes (endpoints, schemas, behavior guarantees).

        ### ğŸ” Safety (no secrets)
        **Do not** include secrets, credentials, private endpoints, PII, or restricted/sensitive coordinates.

        ### ğŸ§­ KFM invariants to keep in mind
        - The API is a **contract boundary**: changes must be deliberate, versioned, and tested.
        - The UI must **not** query Neo4j directly â€” all access goes through the governed API layer.
        - Prefer **diffs + examples** over narratives; attach evidence whenever possible.

        ğŸ“ Helpful refs (paths may vary by repo):
        - `src/server/` (API implementation)
        - `src/server/contracts/` (OpenAPI / GraphQL contract artifacts)
        - `docs/templates/TEMPLATE__API_CONTRACT_EXTENSION.md` (endpoint/schema addition pattern)
        - `docs/standards/` (profiles, governance gates, redaction rules)

  - type: checkboxes
    id: safety_gate
    attributes:
      label: "âœ… Safety + boundary confirmations"
      options:
        - label: "I confirm this issue contains **no secrets/PII/restricted coordinates**."
          required: true
        - label: "I understand **UI â†’ Graph is forbidden** (UI must go through the governed API boundary)."
          required: true
        - label: "I will provide a **contract diff** (or a link to it) and at least **one request/response example**."
          required: true

  - type: dropdown
    id: api_surface
    attributes:
      label: "ğŸ§© API surface(s) affected"
      description: "Select all that apply."
      multiple: true
      options:
        - "REST (OpenAPI)"
        - "GraphQL"
        - "Webhooks / Events"
        - "Client SDK(s)"
        - "Other / Unsure"
    validations:
      required: true

  - type: dropdown
    id: change_kind
    attributes:
      label: "ğŸš¦ Change type (compatibility)"
      description: "Classify the change for versioning + rollout planning."
      multiple: false
      options:
        - "âœ… Non-breaking: additive (new field/endpoint/enum value)"
        - "âš ï¸ Non-breaking-ish: behavior clarification (docs/tests), no client break expected"
        - "ğŸŸ§ Potentially breaking: behavior change or tightening validation"
        - "ğŸŸ¥ Breaking: removals/renames/semantic changes that will break clients"
        - "ğŸ•°ï¸ Deprecation only (no break yet, but planned sunset)"
    validations:
      required: true

  - type: dropdown
    id: pipeline_stage_touchpoints
    attributes:
      label: "ğŸ§­ Upstream/downstream touchpoints"
      description: "Which KFM stages are impacted (directly or indirectly)?"
      multiple: true
      options:
        - "ğŸ§° ETL / Pipelines"
        - "ğŸ—‚ï¸ Catalogs (STAC/DCAT/PROV)"
        - "ğŸ•¸ï¸ Graph (Neo4j / ontology)"
        - "ğŸ”Œ API boundary (this change)"
        - "ğŸ–¥ï¸ UI"
        - "ğŸ¬ Story Nodes"
        - "ğŸ§  Focus Mode"
        - "ğŸ§ª CI / DevEx"
        - "â“ Unknown"
    validations:
      required: true

  - type: dropdown
    id: sensitivity_class
    attributes:
      label: "ğŸ”’ Sensitivity classification (for discussion + examples)"
      description: "Keep details minimal for anything non-public."
      multiple: false
      options:
        - "ğŸŒ Public (safe for full details)"
        - "ğŸ¢ Internal (limit details; avoid internal URLs)"
        - "ğŸ” Confidential (do not post sensitive internals here)"
        - "ğŸ§¨ Restricted (STOP â€” use security reporting path, not issues)"
    validations:
      required: true

  - type: input
    id: primary_owner
    attributes:
      label: "ğŸ‘¤ Primary owner / contact"
      description: "GitHub handle or team (e.g., @kfm-api, @maintainer-handle)."
      placeholder: "@your-handle or @kfm-api"
    validations:
      required: true

  - type: textarea
    id: summary
    attributes:
      label: "ğŸ§¾ Summary"
      description: "What is changing and why? Keep it crisp."
      placeholder: |
        - Problem: â€¦
        - Proposed change: â€¦
        - Why now: â€¦
        - Risks: â€¦
    validations:
      required: true

  - type: textarea
    id: contract_artifacts
    attributes:
      label: "ğŸ“„ Contract artifacts (paths / identifiers)"
      description: "List the contract file(s) to be modified, plus any related schemas."
      placeholder: |
        - OpenAPI: src/server/contracts/openapi.yaml
        - GraphQL: src/server/contracts/schema.graphql
        - JSON Schema(s): schemas/api/â€¦
        - Related docs: docs/â€¦
    validations:
      required: true

  - type: textarea
    id: current_behavior
    attributes:
      label: "ğŸ“Œ Current behavior (today)"
      description: "What does the API contract currently guarantee?"
      placeholder: |
        - Endpoint/field: â€¦
        - Current semantics: â€¦
        - Known quirks/bugs: â€¦
    validations:
      required: true

  - type: textarea
    id: proposed_behavior
    attributes:
      label: "ğŸ¯ Proposed behavior (after change)"
      description: "Describe the intended contract semantics and constraints."
      placeholder: |
        - Endpoint/field: â€¦
        - New semantics: â€¦
        - Validation rules: â€¦
        - Error codes: â€¦
        - Pagination/sorting/filtering: â€¦
    validations:
      required: true

  - type: textarea
    id: contract_diff
    attributes:
      label: "ğŸ§© Contract diff (required)"
      description: "Paste a unified diff, link to a branch/commit, or include tool output (e.g., openapi-diff)."
      placeholder: |
        Option A (preferred): link to PR/branch/commit with diff
        Option B: paste diff snippet
        Option C: paste openapi-diff / graphql-schema-diff output

        Include: what changed + why itâ€™s safe (or why itâ€™s breaking).
    validations:
      required: true

  - type: textarea
    id: examples
    attributes:
      label: "ğŸ§ª Example request/response (required)"
      description: "Provide at least one example. Redact tokens/PII. Use minimal datasets."
      placeholder: |
        ### Example 1
        Request:
        ```http
        GET /api/v1/â€¦
        ```
        Response (before):
        ```json
        { }
        ```
        Response (after):
        ```json
        { }
        ```

        ### Example 2 (optional)
        â€¦
    validations:
      required: true

  - type: textarea
    id: breaking_assessment
    attributes:
      label: "ğŸ’¥ Breaking change assessment"
      description: "If breaking or potentially breaking, explain exactly what breaks and who is affected."
      placeholder: |
        - What breaks: (fields removed/renamed, semantics changed, stricter validation, etc.)
        - Known clients impacted: (UI, scripts, external users, SDKs)
        - Backward compatibility strategy: (versioned route, negotiation, defaulting, etc.)
        - Proposed deprecation window + sunset date:
    validations:
      required: false

  - type: textarea
    id: versioning_rollout
    attributes:
      label: "ğŸ·ï¸ Versioning + rollout plan"
      description: "How will we ship this safely?"
      placeholder: |
        - Version impact: (patch/minor/major) + rationale
        - Strategy: (v2 route, header negotiation, feature flag, dual-write/dual-read)
        - Deprecation policy: (warnings, docs, timeline)
        - Rollback plan:
    validations:
      required: true

  - type: textarea
    id: authz_redaction
    attributes:
      label: "ğŸ” AuthZ / redaction / governance notes"
      description: "How does this interact with permissions, data sensitivity, and redaction?"
      placeholder: |
        - Auth context required: (public, authenticated, role-based)
        - Redaction behavior: (what fields/geometry get generalized or removed)
        - CARE/sovereignty concerns:
        - Any new policy gates needed:
    validations:
      required: true

  - type: textarea
    id: data_provenance_impacts
    attributes:
      label: "ğŸ§¾ Provenance / evidence impacts"
      description: "If the API exposes datasets, ensure theyâ€™re cataloged (STAC/DCAT) and traced (PROV)."
      placeholder: |
        - New/changed dataset IDs exposed:
        - STAC/DCAT links:
        - PROV run/activity links:
        - Any derived/AI evidence artifacts involved:
    validations:
      required: false

  - type: checkboxes
    id: test_plan
    attributes:
      label: "âœ… Test & validation plan"
      description: "Select what you have or will add."
      options:
        - label: "Contract tests updated/added (OpenAPI/GraphQL)."
          required: true
        - label: "API integration tests updated/added (DB + app + request assertions)."
          required: false
        - label: "UI / client compatibility checked (or planned)."
          required: false
        - label: "Docs updated (README, API docs, examples)."
          required: false
        - label: "Redaction/security checks reviewed (no leakage)."
          required: true

  - type: textarea
    id: acceptance_criteria
    attributes:
      label: "âœ… Acceptance criteria (Definition of Done)"
      description: "Make it testable."
      placeholder: |
        - [ ] OpenAPI/GraphQL contract updated and validated
        - [ ] Contract tests pass (CI)
        - [ ] Backward compatibility strategy implemented (or version bump + deprecation plan)
        - [ ] Example requests/responses documented
        - [ ] Redaction/authZ behavior verified
    validations:
      required: true

  - type: textarea
    id: links
    attributes:
      label: "ğŸ”— Links & related work"
      description: "Issues/PRs/docs/threads that matter."
      placeholder: |
        - Related issue(s):
        - Draft PR / branch:
        - Docs:
        - External references:
    validations:
      required: false

