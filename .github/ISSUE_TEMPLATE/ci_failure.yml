# ğŸ§ª Kansas Frontier Matrix â€” CI Failure Template
# File: .github/ISSUE_TEMPLATE/ci_failure.yml
# Purpose: Governance-aware issue form for CI / contract gate failures (GitHub Actions + related checks).
# Alignment: MCP-DL v6.3 Â· KFM-MDP v11.2.6 Â· KFM-PIPE v11 Â· FAIR+CARE Â· SLSA/SBOM (as applicable)
# SPDX-License-Identifier: CC-BY-4.0

name: "ğŸ§ª CI Failure"
description: "Report a failing GitHub Actions workflow, quality gate, or contract check in Kansas Frontier Matrix (KFM)."
title: "CI: <workflow> â€” <short summary>"
labels:
  - "ci"
  - "triage"
assignees:
  - "bartytime4life"

body:
  - type: markdown
    attributes:
      value: |
        ## ğŸ§ª CI Failure / Gate Breakage

        This form is for **GitHub Actions / CI gate failures** (tests, builds, schema validation, policy-as-code, security scans, release lanes, etc.).

        KFM is **evidence-first** ğŸ§¾ â†’ please include: **run URL, commit SHA, and the minimal failing log excerpt**.

        > [!IMPORTANT]
        > ğŸ” **Do not post secrets, tokens, private keys, PII, or restricted/sensitive coordinates** in a public issue.  
        > If this looks like a vulnerability or sensitive disclosure, use the repoâ€™s **Security Policy** instead.

        **Helpful pointers (if present in this repo):**
        - `.github/SECURITY.md`
        - `docs/specs/qa/README.md`
        - `docs/governance/ROOT_GOVERNANCE.md`
        - `docs/incidents/` (post-mortems)

        **Canonical mental model:** ETL â†’ Catalogs â†’ Graph â†’ API â†’ UI â†’ Story â†’ Focus  
        CI gates often enforce this ordering (schemas + provenance before narrative).

  - type: input
    id: run_url
    attributes:
      label: "Run URL"
      description: "Link to the failing CI run (GitHub Actions run page)."
      placeholder: "https://github.com/<owner>/<repo>/actions/runs/<id>"
    validations:
      required: true

  - type: input
    id: workflow_name
    attributes:
      label: "Workflow name"
      description: "Exact workflow name as shown in Actions."
      placeholder: "Example: kfm-ci / docs_validate / kfm-policy-gate / change-qc-promote"
    validations:
      required: true

  - type: input
    id: job_name
    attributes:
      label: "Job name"
      description: "The job that failed (if known)."
      placeholder: "Example: validate / build / policy-gate / deploy"
    validations:
      required: false

  - type: input
    id: failing_step
    attributes:
      label: "Failing step name"
      description: "The step that failed (copy the step title if possible)."
      placeholder: "Example: Validate (schema/policy/qa/repro)"
    validations:
      required: false

  - type: dropdown
    id: reproducibility_ci
    attributes:
      label: "Reproducibility"
      description: "Does this fail consistently?"
      options:
        - "Always (re-run fails too)"
        - "Intermittent / flaky (re-run sometimes passes)"
        - "First time observed"
        - "Unknown"
      default: 0
    validations:
      required: true

  - type: dropdown
    id: failure_class
    attributes:
      label: "Failure class"
      description: "Pick the closest category so we can route quickly."
      options:
        - "ğŸ§¾ Schema / contract validation (STAC/DCAT/PROV/OpenAPI/GraphQL)"
        - "âœ… Tests (unit/integration/e2e)"
        - "ğŸ§¹ Lint / formatting / markdown protocol"
        - "ğŸ§  Policy gate (Conftest/OPA/Rego, FAIR+CARE, governance rules)"
        - "ğŸ” Security scanning (deps, SAST, secrets)"
        - "ğŸ“¦ Build (frontend/backend), packaging, container"
        - "ğŸš€ Deploy / release lane"
        - "ğŸ›°ï¸ Data pipeline / ETL validation"
        - "ğŸ•¸ï¸ Graph integrity / migrations"
        - "âš™ï¸ Infrastructure / permissions / runners"
        - "â“ Other / unknown"
      default: 0
    validations:
      required: true

  - type: dropdown
    id: pipeline_stage
    attributes:
      label: "Primary subsystem impacted"
      description: "Even though CI failed, what subsystem is the failure *about*?"
      options:
        - "ğŸ§ª CI / DevEx"
        - "ğŸ§° ETL / Pipelines"
        - "ğŸ—‚ï¸ Catalogs (STAC/DCAT/PROV)"
        - "ğŸ•¸ï¸ Graph"
        - "ğŸ”Œ API boundary"
        - "ğŸ–¥ï¸ UI / Map viewer"
        - "ğŸ¬ Story Nodes"
        - "ğŸ§  Focus Mode"
        - "â“ Unknown"
      default: 0
    validations:
      required: true

  - type: input
    id: pr_or_branch
    attributes:
      label: "PR / branch"
      description: "PR link/number or branch name associated with the run."
      placeholder: "Example: #123 Â· branch: feature/catalog-validator"
    validations:
      required: false

  - type: input
    id: commit_sha
    attributes:
      label: "Commit SHA"
      description: "The commit that CI ran on."
      placeholder: "Example: abc1234"
    validations:
      required: true

  - type: input
    id: last_known_good
    attributes:
      label: "Last known good run/commit"
      description: "Optional but high-value: link a passing run or commit SHA."
      placeholder: "Example: last pass at commit def5678 or run URL"
    validations:
      required: false

  - type: textarea
    id: changed_paths
    attributes:
      label: "Changed paths (best guess)"
      description: "List files/dirs touched in the PR/commit that might be related."
      placeholder: |
        Example:
        - .github/workflows/**
        - tools/validation/**
        - docs/specs/api/schemas/**
        - docs/specs/data/**
        - src/pipelines/**
        - src/server/**
        - web/**
    validations:
      required: false

  - type: textarea
    id: error_output
    attributes:
      label: "Failure output (redacted)"
      description: "Paste the relevant error log / stack trace. Redact tokens, keys, PII, or restricted coordinates."
      placeholder: |
        Example:
        Step: Policy gate (conftest)
        FAIL - policy/rego/kfm.rego:42: input violates rule ...
      render: shell
    validations:
      required: true

  - type: textarea
    id: artifacts
    attributes:
      label: "Artifacts / evidence pointers"
      description: "If the workflow uploaded artifacts (reports, coverage, validation outputs), list or link them."
      placeholder: |
        Example:
        - artifact: schema-validation-report.json
        - artifact: junit.xml
        - artifact: coverage.xml
        - artifact: sbom.spdx.json
        - artifact: prov.bundle.jsonld
        - path: docs/reports/audit/github-workflows-ledger.json
        - path: telemetry/**/*
    validations:
      required: false

  - type: dropdown
    id: runner_type
    attributes:
      label: "Runner / environment"
      description: "Where did the failure happen?"
      options:
        - "ubuntu-latest (GitHub-hosted)"
        - "windows-latest (GitHub-hosted)"
        - "macos-latest (GitHub-hosted)"
        - "self-hosted runner"
        - "containerized job"
        - "unknown"
      default: 0
    validations:
      required: true

  - type: input
    id: kill_switch
    attributes:
      label: "Kill-switch status (if applicable)"
      description: "If the repo/env kill-switch exists, note whether it was set."
      placeholder: "Example: KFM_KILL_SWITCH=0 (normal) / KFM_KILL_SWITCH=1 (paused)"
    validations:
      required: false

  - type: textarea
    id: local_repro
    attributes:
      label: "Local reproduction (if known)"
      description: "Commands to reproduce locally (or state that it's CI-only)."
      placeholder: |
        Example:
        - make test
        - make validate-schemas
        - make policy-gate
        - python tools/validation/run.py --manifest manifests/qa.manifest.yml
    validations:
      required: false

  - type: dropdown
    id: sensitivity
    attributes:
      label: "Data sensitivity / governance classification"
      description: "Classify any data/logs referenced in this issue."
      options:
        - "ğŸŒ Public"
        - "ğŸ¢ Internal"
        - "ğŸ” Confidential"
        - "ğŸ§¨ Restricted (do not post details here)"
        - "â“ Not sure"
      default: 0
    validations:
      required: true

  - type: checkboxes
    id: governance_checks
    attributes:
      label: "Security & governance checks"
      description: "Required to keep CI triage safe and compliant."
      options:
        - label: "âœ… I did **not** include secrets, private keys, tokens, or credentials."
          required: true
        - label: "âœ… I did **not** include PII or restricted/sensitive coordinates."
          required: true
        - label: "âœ… Logs are **redacted** and limited to whatâ€™s needed to debug."
          required: true
        - label: "âœ… If this looks like a security vulnerability, I will use the security reporting path instead."
          required: true

  - type: checkboxes
    id: kfm_gates
    attributes:
      label: "Which gates appear involved?"
      description: "Select any that match the failure (optional)."
      options:
        - label: "ğŸ§¾ STAC/DCAT/PROV schema validation"
        - label: "ğŸ”Œ API contract tests (OpenAPI/GraphQL)"
        - label: "ğŸ•¸ï¸ Graph integrity checks / migrations"
        - label: "ğŸ§  Policy-as-code gate (Conftest/OPA/Rego)"
        - label: "ğŸ“„ Docs/Markdown protocol validation"
        - label: "ğŸ” Secret scanning / dependency audit / CodeQL"
        - label: "ğŸ“¦ SBOM generation"
        - label: "ğŸªª SLSA/OIDC attestation/signing"
        - label: "âš¡ Energy/Carbon telemetry step"
        - label: "ğŸ¤– Agent lane (Watcher/Planner/Executor)"

  - type: textarea
    id: suspected_root_cause
    attributes:
      label: "Suspected root cause / notes"
      description: "What do you think is going on? Include links to relevant code/specs if you have them."
      placeholder: |
        Example:
        - Failure started after updating schema version references.
        - Conftest policy rejects missing PROV fields.
        - Permissions failure after changing workflow permissions.
        - Flake: test depends on network/time; needs pinning or better mocking.
    validations:
      required: false

  - type: dropdown
    id: urgency
    attributes:
      label: "Urgency"
      description: "How urgent is this CI failure?"
      options:
        - "ğŸŸ¥ P0 â€” blocks main/release, prevents merges"
        - "ğŸŸ§ P1 â€” blocks important lane or data promotion"
        - "ğŸŸ¨ P2 â€” intermittent or partial impact"
        - "ğŸŸ© P3 â€” minor / cosmetic / low impact"
      default: 1
    validations:
      required: true

  - type: markdown
    attributes:
      value: |
        ## ğŸ§¯ If this is a production-impacting CI outage

        If the failure blocks releases or data promotion:
        - Consider pausing automation (repo/env **kill-switch**, if defined) ğŸ›‘
        - Open a post-mortem in `docs/incidents/INCIDENT-YYYYMMDD.md` (if the incident workflow exists)

        Thanks for keeping KFM reproducible, auditable, and safe. ğŸŒ¾âœ…

