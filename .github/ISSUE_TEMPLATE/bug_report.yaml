# ğŸ Kansas Frontier Matrix (KFM) â€” Bug Report (Issue Form)
# File: .github/ISSUE_TEMPLATE/bug_report.yml
# Purpose: Governance-aware intake for defects across the full KFM pipeline.
# Alignment: MCP-DL v6.3 Â· KFM-MDP v11.2.6 Â· KFM-PIPE v11 Â· KFM-ONT v11 Â· KFM-OP v11 Â· FAIR+CARE Â· Diamondâ¹ Î© / CrownâˆÎ©
# SPDX-License-Identifier: CC-BY-4.0

name: "ğŸ Bug Report"
description: "Report an error, malfunction, or unexpected behavior in KFM â€” with evidence, provenance, and sensitivity context."
title: "Bug: <short description>"
labels:
  - "bug"
  - "triage"
assignees:
  - "bartytime4life"

body:
  - type: markdown
    attributes:
      value: |
        ## ğŸ Bug Report (Governed Intake) ğŸ§­ğŸ§¾

        KFM is **contract-first**, **provenance-first**, and **evidence-first**.
        Please include enough context to reproduce or verify the defect without guesswork.

        **Canonical pipeline (nonâ€‘negotiable ordering):**
        **ETL â†’ Catalogs (STAC/DCAT/PROV) â†’ Graph â†’ API â†’ UI â†’ Story Nodes â†’ Focus Mode**

        > [!CAUTION]
        > **Do not post secrets, credentials, private keys, PII, private endpoints, or restricted/sensitive coordinates.**
        > If you suspect a vulnerability or sensitive disclosure, use the repoâ€™s security reporting path (see `SECURITY.md` / `.github/SECURITY.md`) instead of filing a public bug.

        **Helpful docs (if present in this repo):**
        - âš–ï¸ Governance: `docs/governance/ROOT_GOVERNANCE.md` Â· `docs/governance/ETHICS.md` Â· `docs/governance/SOVEREIGNTY.md`
        - ğŸ§¾ Standards: `docs/standards/` (STAC/DCAT/PROV profiles)
        - ğŸ”Œ API contracts: `src/server/contracts/` Â· `schemas/`
        - ğŸ¬ Story Nodes: `docs/reports/story_nodes/`
        - ğŸ¤ Collaboration rules: `.github/README.md` Â· `docs/glossary.md`

  - type: checkboxes
    id: safety_gate
    attributes:
      label: "ğŸ” Safety / confidentiality gate (required)"
      description: "If you canâ€™t affirm these, STOP and use the security/governance path instead."
      options:
        - label: "I confirm this report contains **no secrets**, **no PII**, **no private endpoints**, and **no restricted/sensitive coordinates**."
          required: true
        - label: "If this touches Indigenous/CARE-governed or culturally sensitive knowledge, I used **generalized locations** (county/region) and avoided precise site details."
          required: true

  - type: input
    id: summary
    attributes:
      label: "Summary"
      description: "One sentence describing the defect."
      placeholder: "Example: STAC items appear in the layer list, but the map tiles never load."
    validations:
      required: true

  - type: dropdown
    id: severity
    attributes:
      label: "Severity"
      description: "Impact to users, safety, or integrity."
      options:
        - "ğŸŸ¥ P0 Critical â€” safety/security risk, data loss, or system down"
        - "ğŸŸ§ P1 High â€” core workflow broken, widespread impact"
        - "ğŸŸ¨ P2 Medium â€” partial breakage, workaround exists"
        - "ğŸŸ© P3 Low â€” minor/cosmetic"
      default: 2
    validations:
      required: true

  - type: dropdown
    id: classification
    attributes:
      label: "Data classification (routing)"
      description: "How should this issue be handled publicly?"
      options:
        - "ğŸŒ Public â€” safe to discuss openly"
        - "ğŸ¢ Internal â€” limit details (avoid sensitive internals)"
        - "ğŸ” Confidential â€” do NOT include sensitive details; use a private channel"
        - "ğŸ§¨ Restricted â€” STOP: use security reporting path"
      default: 0
    validations:
      required: true

  - type: dropdown
    id: pipeline_stage
    attributes:
      label: "Affected pipeline stage"
      description: "Best guess â€” helps triage. (Pick â€œUnknownâ€ if unsure.)"
      options:
        - "ğŸ§° ETL / Pipelines (ingest, transforms, tiling, normalization)"
        - "ğŸ—‚ï¸ Catalogs (STAC/DCAT/PROV metadata, validators, links)"
        - "ğŸ•¸ï¸ Graph (Neo4j entities/relations/citations/timelines)"
        - "ğŸ”Œ API boundary (contracts, authZ, redaction, query behavior)"
        - "ğŸ–¥ï¸ UI / Map viewer (React/MapLibre/Cesium, UX, rendering)"
        - "ğŸ¬ Story Nodes (governed narrative markdown + citations)"
        - "ğŸ§  Focus Mode (evidence-backed summaries & context bundles)"
        - "ğŸ§ª CI / DevEx (tests, builds, validators, infra)"
        - "â“ Unknown / not sure"
      default: 8
    validations:
      required: true

  - type: dropdown
    id: component
    attributes:
      label: "Component (closest match)"
      description: "Pick the closest subsystem â€” maintainers can adjust."
      options:
        - "pipeline (src/pipelines/**)"
        - "catalogs/metadata (data/stac/** Â· data/catalog/dcat/** Â· data/prov/**)"
        - "graph (src/graph/** Â· ontology Â· migrations)"
        - "api/server (src/server/** Â· contracts)"
        - "web/ui (web/**)"
        - "docs/story (docs/**)"
        - "agents/automation (tools/agents/** Â· artifacts/**)"
        - "infra/ci (.github/workflows/** Â· builds Â· containers)"
        - "other"
      default: 8
    validations:
      required: true

  - type: dropdown
    id: frequency
    attributes:
      label: "Frequency"
      description: "How often does it happen?"
      options:
        - "âœ… Always (100%)"
        - "ğŸ” Often (50â€“99%)"
        - "ğŸ² Sometimes (1â€“49%)"
        - "ğŸ§Š Rare (hard to reproduce)"
        - "â“ Unknown"
      default: 4
    validations:
      required: true

  - type: textarea
    id: expected_behavior
    attributes:
      label: "Expected behavior"
      description: "What should have happened?"
      placeholder: "Example: The UI should request `GET /api/v1/layers/<id>` and render tiles at zoom 8â€“12."
    validations:
      required: true

  - type: textarea
    id: actual_behavior
    attributes:
      label: "Actual behavior"
      description: "What actually happened? Include any visible error messages (redacted)."
      placeholder: "Example: Tiles request returns 403 and the layer stays blank."
    validations:
      required: true

  - type: textarea
    id: steps_to_reproduce
    attributes:
      label: "Steps to reproduce"
      description: "Make this deterministic if possible. If not reproducible, describe conditions + timing."
      placeholder: |
        1. Start services: `docker compose up`
        2. Open http://localhost:3000
        3. Enable layer "Historical Treaties"
        4. Zoom to Kansas
        5. Observe: layer stays blank + console error
    validations:
      required: true

  - type: textarea
    id: logs
    attributes:
      label: "Logs / stack traces (redacted)"
      description: "Paste relevant logs. Remove secrets, tokens, sensitive coordinates, and PII."
      placeholder: |
        ERROR src/server/...:
        Traceback (most recent call last):
          ...
      render: shell
    validations:
      required: false

  - type: textarea
    id: screenshots
    attributes:
      label: "Screenshots / screen recordings (optional)"
      description: "Attach safe screenshots/recordings. Avoid showing tokens, internal URLs, or restricted coordinates."
      placeholder: |
        - Screenshot: (drag & drop)
        - Recording: (drag & drop)
    validations:
      required: false

  - type: input
    id: environment
    attributes:
      label: "Environment"
      description: "Runtime context (no secrets)."
      placeholder: "macOS 14 Â· Chrome 121 Â· Node 20 Â· Python 3.12 Â· Docker Desktop 4.x"
    validations:
      required: true

  - type: input
    id: build_info
    attributes:
      label: "KFM version / branch / commit"
      description: "Release tag, branch, or commit SHA."
      placeholder: "branch: main Â· commit: abc1234 Â· tag: v11.2.6"
    validations:
      required: true

  - type: textarea
    id: identifiers
    attributes:
      label: "IDs / routes / paths (anchors for triage) ğŸ”"
      description: |
        Provide any stable identifiers (best effort):
        - STAC: collection/item IDs (or paths)
        - DCAT: dataset IDs
        - PROV: activity/bundle IDs (or paths)
        - Graph: node IDs/labels
        - API: route + method
        - UI: route/page + layer key
      placeholder: |
        - STAC Collection: data/stac/collections/<domain>/collection.json
        - STAC Item: <collection>/<item-id>
        - DCAT Dataset: data/catalog/dcat/<id>.jsonld
        - PROV bundle: data/prov/<run-id>.jsonld
        - Graph node: :Place {kfm_id: "..."}
        - API: GET /api/v1/layers/<id>
        - UI: web/src/.../LayerRegistry.ts
    validations:
      required: false

  - type: textarea
    id: data_provenance
    attributes:
      label: "Provenance & licensing (if data is involved) ğŸ§¾"
      description: |
        Required when the defect concerns datasets, derived layers, OCR/AI artifacts, or analytics outputs.
        Include source authority, license/terms, retrieval date, and coverage (generalize if sensitive).
      placeholder: |
        - Source authority:
        - License/terms:
        - Retrieval date:
        - Spatial coverage (generalized):
        - Temporal coverage:
        - Processing context (toolchain/CRS/major transforms):
    validations:
      required: false

  - type: textarea
    id: determinism
    attributes:
      label: "Determinism / experiments (if applicable) ğŸ›ï¸"
      description: |
        If the defect relates to modeling, analytics, or anything stochastic:
        provide seeds/configs and how to rebuild the same artifact.
      placeholder: |
        - Random seed / deterministic flag:
        - Config file(s):
        - Inputs (hash/ID):
        - Output artifact path(s):
        - Metrics/diagnostics (optional):
    validations:
      required: false

  - type: textarea
    id: workaround
    attributes:
      label: "Workaround (if any)"
      description: "Any temporary mitigation you found."
      placeholder: "Example: Refreshing after toggling layer twice makes it load."
    validations:
      required: false

  - type: checkboxes
    id: governance_flags
    attributes:
      label: "Governance / routing flags (optional) âš–ï¸"
      description: "Helps triage faster."
      options:
        - label: "May be a security issue (authZ, secrets, injection, etc.)."
        - label: "May involve sensitive locations / Indigenous / CARE-governed data."
        - label: "Potential provenance break (missing/incorrect STAC/DCAT/PROV linkage)."
        - label: "Potential contract break (schema/endpoint mismatch)."
        - label: "Impacts Story Nodes / Focus Mode evidence or citations."

  - type: checkboxes
    id: checklist
    attributes:
      label: "Pre-submission checklist âœ…"
      description: "Confirm before submitting."
      options:
        - label: "I reproduced this at least once (or described why itâ€™s non-deterministic)."
          required: true
        - label: "I checked for duplicates among open issues."
          required: true
        - label: "I included enough context to locate the defect (IDs/routes/paths)."
          required: true
        - label: "I did **not** include secrets/PII/restricted coordinates."
          required: true

  - type: markdown
    attributes:
      value: |
        ## ğŸ§± What maintainers will look for

        - ğŸ§­ **Stage correctness:** routed to the right pipeline stage.
        - ğŸ§¾ **Evidence:** repro steps, logs, IDs, or a minimal fixture.
        - ğŸ“œ **Contracts:** schema/endpoint mismatches get handled as contract breaks.
        - ğŸ§¬ **Provenance:** data issues must preserve STAC/DCAT/PROV linkage.
        - ğŸª¶ **Sovereignty:** classifications propagate; no output can be less restricted than its inputs.

        If you canâ€™t safely share details publicly, stop and use the security/governance path instead.
