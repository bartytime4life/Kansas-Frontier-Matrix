# ğŸ§¬ PROV Mapping â€” `<dataset_slug>`

![Status](https://img.shields.io/badge/status-draft-orange)
![Domain](https://img.shields.io/badge/domain-external-blue)
![Standard](https://img.shields.io/badge/standard-W3C%20PROV-5B8)
![KFM](https://img.shields.io/badge/KFM-v13%20aligned-9cf)

> **Purpose:** Define how this external datasetâ€™s lineage is captured as a **PROV activity bundle** (W3C PROV-style), so the project can answer: **â€œHow was this data produced?â€** ğŸ§¾âœ…

**Quick links ğŸ”—**
- ğŸ“„ STAC mapping: `./stac_mapping.md`
- ğŸ“„ DCAT mapping: `./dcat_mapping.md`
- ğŸ§¬ Output PROV bundle: `../../../prov/<dataset_slug>.prov.json`
- ğŸ“¦ Processed outputs: `../../processed/<dataset_slug>/`

---

<details>
<summary><strong>ğŸ§­ Table of contents</strong></summary>

- [ğŸ¯ Goal](#-goal)
- [ğŸ“¦ Required outputs](#-required-outputs)
- [ğŸ—‚ï¸ Directory & file layout](#ï¸-directory--file-layout)
- [ğŸ§¬ PROV modeling rules](#-prov-modeling-rules)
- [ğŸ”‘ Namespaces & ID strategy](#-namespaces--id-strategy)
- [ğŸ§± Entity mapping](#-entity-mapping)
- [ğŸ§ª Activity mapping](#-activity-mapping)
- [ğŸ‘¥ Agent mapping](#-agent-mapping)
- [ğŸ”— Cross-links to STAC & DCAT](#-cross-links-to-stac--dcat)
- [ğŸ” Versioning rules](#-versioning-rules)
- [âš–ï¸ Governance & redaction](#ï¸-governance--redaction)
- [âœ… Validation checklist](#-validation-checklist)
- [ğŸ§¾ Example PROV-JSON snippet](#-example-prov-json-snippet)
- [ğŸ§° Implementation notes](#-implementation-notes)
- [ğŸ—“ï¸ Change log](#ï¸-change-log)

</details>

---

## ğŸ¯ Goal

This mapping defines the **minimum required provenance** for `<dataset_slug>` so that:

- Lineage is **transparent** (inputs â†’ steps â†’ outputs) ğŸ§µ  
- Work is **reproducible** (run id / git commit / parameters are recorded) ğŸ”  
- Metadata stays **in sync** across STAC, DCAT, and PROV ğŸ”—  
- CI can validate provenance completeness âœ…

> **Nonâ€‘negotiable for KFM:** PROV must link the full chain **raw inputs â†’ intermediate work â†’ processed outputs**, and identify the **pipeline run/config** (e.g., run id + commit hash). ğŸ§¬ğŸ§¾

---

## ğŸ“¦ Required outputs

### âœ… Primary artifact
- **PROV bundle (PROVâ€‘JSON)**  
  - Path: `data/prov/<dataset_slug>.prov.json` *(or per-run under a dataset folder; see below)*  
  - Role: authoritative lineage for the dataset publication event(s)

### âœ… Minimum referenced artifacts
- **Processed data assets** referenced by STAC/DCAT:
  - Path: `data/external/processed/<dataset_slug>/...`
- **STAC Collection + Items** that point to the processed assets:
  - Path: `data/stac/collections/...` and `data/stac/items/...`
- **DCAT dataset entry**:
  - Path: `data/catalog/dcat/<dataset_slug>.jsonld` *(or equivalent per repo conventions)*

### Optional but recommended
- `data/prov/<dataset_slug>/<run_id>.prov.json` for multi-run histories  
- Validation report entities (e.g., `.../work/.../validation_report.json`)  
- Provenance graph render (SVG/PNG) generated from the PROV bundle

---

## ğŸ—‚ï¸ Directory & file layout

> This mapping doc lives inside the **external domain** dataset mapping folder.

```text
ğŸ“ data/
â”œâ”€â”€ ğŸ“ prov/                                 # ğŸ§¬ PROV bundles (per run / per dataset)
â”‚   â”œâ”€â”€ ğŸ“„ <dataset_slug>.prov.json
â”‚   â””â”€â”€ ğŸ“ <dataset_slug>/                   # (optional) per-run bundles
â”‚       â””â”€â”€ ğŸ“„ <run_id>.prov.json
â””â”€â”€ ğŸ“ external/
    â”œâ”€â”€ ğŸ“ raw/                              # ğŸ“¥ raw inputs (read-only)
    â”‚   â””â”€â”€ ğŸ“ <dataset_slug>/
    â”œâ”€â”€ ğŸ“ work/                             # ğŸ§ª intermediate artifacts
    â”‚   â””â”€â”€ ğŸ“ <dataset_slug>/
    â”œâ”€â”€ ğŸ“ processed/                        # ğŸ“¦ final published outputs
    â”‚   â””â”€â”€ ğŸ“ <dataset_slug>/
    â””â”€â”€ ğŸ“ mappings/                         # ğŸ§­ mapping docs (STAC/DCAT/PROV)
        â””â”€â”€ ğŸ“ <dataset_slug>/
            â”œâ”€â”€ ğŸ“„ prov_mapping.md           # ğŸ‘ˆ this file
            â”œâ”€â”€ ğŸ“„ stac_mapping.md           # (optional) sibling doc
            â””â”€â”€ ğŸ“„ dcat_mapping.md           # (optional) sibling doc
```

---

## ğŸ§¬ PROV modeling rules

### ğŸ§± Core PROV objects
- **Entity**: a thing (file, dataset version, validation report, config)  
- **Activity**: a process step (download, transform, validate, package, publish)  
- **Agent**: who/what acted (org, person, software pipeline)

### ğŸ”— Core relations we use
At minimum, model:

- `prov:used` â€” Activity used an Entity (inputs)  
- `prov:wasGeneratedBy` â€” Entity generated by Activity (outputs)  
- `prov:wasAssociatedWith` â€” Activity associated with Agent (who/what ran it)  
- `prov:wasDerivedFrom` â€” Entity derived from another Entity (lineage, versioning)  

Recommended:
- `prov:wasAttributedTo` â€” crediting/ownership for Entities  
- `prov:actedOnBehalfOf` â€” automation acting for a maintainer/org  
- `prov:wasRevisionOf` *(or `prov:wasDerivedFrom`)* â€” dataset version lineage

### ğŸ§¾ Required attributes (KFM minimum)
Each PROV bundle **must** include:

- **Run identity**
  - `kfm:run_id` (stable per execution)
  - `kfm:git_commit` (or equivalent source revision)
- **Time**
  - `prov:startTime`, `prov:endTime` for key activities
- **Inputs/Outputs**
  - checksums for at least raw and processed entities (e.g., `kfm:sha256`)
  - stable locations (repo-relative paths or stable URLs)

### ğŸ§  Notes / citations / parameters
PROV may also include:
- `kfm:parameters` (projection, filters, thresholds, join keys)
- `kfm:notes` (manual decisions, exclusions)
- `kfm:methods_citation` (algorithms/models referenced)
- `kfm:confidence_metrics` (if AI/model-derived artifact)

---

## ğŸ”‘ Namespaces & ID strategy

### Prefixes (recommended)
Use predictable namespaces so IDs are human-auditable:

- `prov:` â€” PROV vocab
- `kfm:` â€” project namespace
- `ext:` â€” external provider namespace
- `file:` â€” file locations (repo paths)

Example `prefix` map (PROVâ€‘JSON):
```json
{
  "prov": "http://www.w3.org/ns/prov#",
  "kfm": "https://kansasfrontier.org/ns/kfm#",
  "ext": "https://example.org/ext/<provider_slug>#",
  "file": "file://"
}
```

### ID patterns (recommended)
Keep IDs **deterministic** and **stable** across runs.

**Entities**
- `file:data/external/raw/<dataset_slug>/<filename>`
- `file:data/external/work/<dataset_slug>/<step>/<artifact>`
- `file:data/external/processed/<dataset_slug>/<artifact>`
- `kfm:entity:dataset/<dataset_slug>#v=<dataset_version>`

**Activities**
- `kfm:activity:ingest/<dataset_slug>/<run_id>`
- `kfm:activity:transform/<dataset_slug>/<run_id>`
- `kfm:activity:validate/<dataset_slug>/<run_id>`
- `kfm:activity:publish/<dataset_slug>/<run_id>`

**Agents**
- `kfm:agent:org/<provider_slug>`
- `kfm:agent:person/<github_or_handle>`
- `kfm:agent:software/<pipeline_name>`

> âœ… Tip: If you embed a checksum in the entity ID (`...#sha256=<hash>`), keep it **also** as an attribute for easy validation.

---

## ğŸ§± Entity mapping

Fill out the table below for this dataset. Keep it boring and complete. ğŸ§¾ğŸ§±

### Entity catalog

| Entity class | Entity ID (pattern) | `prov:type` | Required attributes | Notes |
|---|---|---:|---|---|
| External distribution / landing page | `ext:distribution/<dataset_slug>` | `prov:Entity` | `prov:location`, `prov:label`, `dcterms:license` | Source â€œthingâ€ even if itâ€™s not a file |
| Raw source file(s) | `file:data/external/raw/<dataset_slug>/<filename>` | `prov:Entity` | `prov:location`, `kfm:sha256`, `kfm:retrieved_at`, `kfm:source_url` | One row per raw file |
| Intermediate artifact(s) | `file:data/external/work/<dataset_slug>/<step>/<artifact>` | `prov:Entity` | `prov:location`, `kfm:sha256` *(if material)* | Include only meaningful checkpoints |
| Processed output(s) | `file:data/external/processed/<dataset_slug>/<artifact>` | `prov:Entity` | `prov:location`, `kfm:sha256`, `kfm:dataset_version` | Must match STAC/DCAT distributions |
| Validation report(s) | `file:data/external/work/<dataset_slug>/validation/<report>` | `prov:Entity` | `prov:location`, `kfm:summary` | Optional but recommended |
| Config used | `file:src/pipelines/<...>/config/<...>.yml` | `prov:Entity` | `prov:location`, `kfm:sha256` | If config impacts outputs, model it |
| Published dataset â€œconceptâ€ | `kfm:entity:dataset/<dataset_slug>#v=<dataset_version>` | `prov:Entity` | `prov:label`, `kfm:dataset_version`, `dcterms:license` | Useful for version lineage |

> ğŸ§  Large/remote assets: If the data lives outside git (S3, etc.), the Entity should still exist and carry a **stable URL + hash**.

---

## ğŸ§ª Activity mapping

### Activity catalog

| Pipeline stage | Activity ID (pattern) | Inputs (`prov:used`) | Outputs (`prov:wasGeneratedBy`) | Required attributes | Notes |
|---|---|---|---|---|---|
| Acquire / download | `kfm:activity:ingest/<dataset_slug>/<run_id>` | external distribution entity | raw files | `prov:startTime`, `prov:endTime`, `kfm:run_id`, `kfm:git_commit` | Record retrieval timestamp + URLs |
| Transform / normalize | `kfm:activity:transform/<dataset_slug>/<run_id>` | raw files (+ config) | intermediate + processed outputs | `kfm:parameters`, `kfm:environment` | Include projection, filters, joins |
| Validate / QC | `kfm:activity:validate/<dataset_slug>/<run_id>` | processed outputs | validation report(s) | `kfm:checks` | Capture pass/fail summary |
| Package / publish | `kfm:activity:publish/<dataset_slug>/<run_id>` | processed outputs + STAC/DCAT entities | PROV bundle entity + any release artifacts | `kfm:release_tag` *(if used)* | Publication = â€œboundary momentâ€ |

### Required relations
For each stage above:
- record at least one `prov:used`
- record at least one `prov:wasGeneratedBy`
- attach at least one `prov:wasAssociatedWith` (software agent, and human if applicable)

---

## ğŸ‘¥ Agent mapping

### Agent catalog

| Agent | Agent ID (pattern) | `prov:type` | Required attributes | Notes |
|---|---|---:|---|---|
| External provider org | `kfm:agent:org/<provider_slug>` | `prov:Organization` | `prov:label`, `kfm:source_homepage` | Attribution + licensing trace |
| Pipeline software | `kfm:agent:software/<pipeline_name>` | `prov:SoftwareAgent` | `prov:label`, `kfm:version`, `kfm:repo_path` | Ex: `src/pipelines/<...>` |
| Maintainer/operator (if manual) | `kfm:agent:person/<handle>` | `prov:Person` | `prov:label`, `kfm:role` | Only if a human triggered/edited |

> âœ… If the pipeline is fully automated, you can omit the person Agent **unless** a human made a decision or intervened (then model it explicitly).

---

## ğŸ”— Cross-links to STAC & DCAT

KFM expects **cross-references** so catalogs, graph, and narrative layers stay aligned. ğŸ”—ğŸ§­

### STAC â†” Data â†” PROV
- STAC Items **must link to the actual processed assets** in `data/.../processed/...`
- STAC should carry **source attribution + license**
- STAC should include a **provenance reference** pointing to this datasetâ€™s PROV bundle (field name per `KFM_STAC_PROFILE.md`)

âœ… Minimum recommendation:
- STAC Item includes a link or property: `kfm:prov_ref = "data/prov/<dataset_slug>.prov.json"`
- PROV output entities include `kfm:stac_item_id` *(or a `prov:location` link to the STAC JSON)*

### DCAT â†” Distributions â†” PROV
- DCAT should include distribution links to:
  - the STAC catalog entry **or** direct data download path(s)
- DCAT should include a provenance/prov linkage (field name per `KFM_DCAT_PROFILE.md`)

âœ… Minimum recommendation:
- DCAT dataset includes `dcterms:provenance` pointing to the PROV bundle
- PROV output entity includes `kfm:dcat_id` *(or a `prov:location` link to the DCAT JSON-LD)*

---

## ğŸ” Versioning rules

When `<dataset_slug>` is updated or reprocessed, ensure lineage between versions is explicit. ğŸ”ğŸ§¬

### Dataset-level versioning
For each new published version:
- Assign `kfm:dataset_version` (e.g., `v1`, `v2`, `2026.1`, etc.)
- Link the new version to the prior version:
  - DCAT: `prov:wasRevisionOf` (new â†’ old)
  - PROV: output entity `prov:wasDerivedFrom` prior output entity *(or model an activity that derives v2 from v1)*

### Run identity
Each version must identify:
- `kfm:run_id`
- `kfm:git_commit`
- major parameters/config that affect outputs (`kfm:parameters`)

> ğŸ·ï¸ If the repo uses release tags for data bundles, include `kfm:release_tag` in the publish activity and/or output entities.

---

## âš–ï¸ Governance & redaction

External datasets often carry licensing and sensitivity constraints. This mapping must ensure:

- **License traceability**: include license on source and output entities
- **Attribution**: provider org agent + `prov:wasAttributedTo` where appropriate
- **Sensitivity**: if any inputs contain PII/sensitive attributes, do **not** embed sensitive values in PROV; record **classification labels** and use redacted summaries

Recommended attributes:
- `kfm:classification`: `public | restricted | sensitive`
- `kfm:redaction_applied`: `true/false`
- `kfm:access_policy_ref`: link to governance policy doc if applicable

---

## âœ… Validation checklist

**PROV bundle checks (must pass CI) âœ…**
- [ ] `data/prov/<dataset_slug>.prov.json` exists
- [ ] Contains at least: Entities + Activities + Agents
- [ ] Captures chain: **raw â†’ work â†’ processed**
- [ ] Includes `kfm:run_id` and `kfm:git_commit`
- [ ] Raw and processed entities include checksums (`kfm:sha256`)
- [ ] All referenced IDs exist (no dangling `prov:used` / `prov:wasGeneratedBy`)
- [ ] STAC/DCAT cross-links exist (STAC/DCAT â†’ data, and provenance references)
- [ ] Version updates include revision/derivation links (v2 â†’ v1)

---

## ğŸ§¾ Example PROV-JSON snippet

<details>
<summary><strong>ğŸ“„ Minimal skeleton (copy + customize)</strong></summary>

```json
{
  "prefix": {
    "prov": "http://www.w3.org/ns/prov#",
    "kfm": "https://kansasfrontier.org/ns/kfm#",
    "ext": "https://example.org/ext/<provider_slug>#",
    "file": "file://",
    "dcterms": "http://purl.org/dc/terms/"
  },

  "entity": {
    "ext:distribution/<dataset_slug>": {
      "prov:label": "External distribution for <dataset_slug>",
      "prov:location": "<source_landing_or_distribution_url>",
      "dcterms:license": "<license_url_or_spdx>",
      "kfm:source_version": "<upstream_version_if_any>"
    },

    "file:data/external/raw/<dataset_slug>/<raw_file>": {
      "prov:label": "Raw source file <raw_file>",
      "prov:location": "data/external/raw/<dataset_slug>/<raw_file>",
      "kfm:sha256": "<sha256>",
      "kfm:retrieved_at": "2026-01-29T00:00:00Z",
      "kfm:source_url": "<direct_download_url_if_any>"
    },

    "file:data/external/processed/<dataset_slug>/<output_file>": {
      "prov:label": "Processed output <output_file>",
      "prov:location": "data/external/processed/<dataset_slug>/<output_file>",
      "kfm:sha256": "<sha256>",
      "kfm:dataset_version": "v1"
    }
  },

  "activity": {
    "kfm:activity:publish/<dataset_slug>/<run_id>": {
      "prov:label": "Publish <dataset_slug>",
      "prov:startTime": "2026-01-29T00:00:00Z",
      "prov:endTime": "2026-01-29T00:10:00Z",
      "kfm:run_id": "<run_id>",
      "kfm:git_commit": "<commit_hash>",
      "kfm:parameters": {
        "projection": "EPSG:4326",
        "filters": "<describe>"
      }
    }
  },

  "agent": {
    "kfm:agent:org/<provider_slug>": {
      "prov:label": "<Provider Name>",
      "prov:type": { "$": "prov:Organization", "type": "prov:QUALIFIED_NAME" }
    },
    "kfm:agent:software/<pipeline_name>": {
      "prov:label": "<pipeline_name>",
      "prov:type": { "$": "prov:SoftwareAgent", "type": "prov:QUALIFIED_NAME" },
      "kfm:repo_path": "src/pipelines/<...>",
      "kfm:version": "<pipeline_version_or_commit>"
    }
  },

  "used": {
    "_:use_raw": {
      "prov:activity": "kfm:activity:publish/<dataset_slug>/<run_id>",
      "prov:entity": "file:data/external/raw/<dataset_slug>/<raw_file>"
    }
  },

  "wasGeneratedBy": {
    "_:gen_out": {
      "prov:entity": "file:data/external/processed/<dataset_slug>/<output_file>",
      "prov:activity": "kfm:activity:publish/<dataset_slug>/<run_id>"
    }
  },

  "wasAssociatedWith": {
    "_:assoc_sw": {
      "prov:activity": "kfm:activity:publish/<dataset_slug>/<run_id>",
      "prov:agent": "kfm:agent:software/<pipeline_name>"
    }
  },

  "wasDerivedFrom": {
    "_:der1": {
      "prov:generatedEntity": "file:data/external/processed/<dataset_slug>/<output_file>",
      "prov:usedEntity": "file:data/external/raw/<dataset_slug>/<raw_file>"
    }
  }
}
```

</details>

---

## ğŸ§° Implementation notes

### Recommended generation workflow ğŸ› ï¸
1. Pipeline produces/updates:
   - raw â†’ work â†’ processed assets
2. Pipeline emits metadata:
   - STAC Items/Collections
   - DCAT dataset entry
3. Pipeline emits PROV bundle:
   - includes run id + commit
   - includes checksums and locations
4. CI validates:
   - schema + link integrity + provenance completeness

### â€œRed flagâ€ rule ğŸš©
If something is â€œpublishedâ€ but lacks a PROV bundle, treat it as **incomplete** until provenance is added.

---

## ğŸ—“ï¸ Change log

| Version | Date | Change | Author |
|---:|---|---|---|
| 0.1.0 | 2026-01-29 | Initial PROV mapping scaffold for `<dataset_slug>` | `<author>` |

