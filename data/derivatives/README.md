üß≠ Kansas-Frontier-Matrix ‚Äî Derived Geospatial Products

Purpose: hold analysis-ready derivatives computed from canonical COGs in data/cogs/ and curated inputs in data/sources/.
All outputs are reproducible, checksummed, and preferably registered as STAC Items.

flowchart LR
  A["COGs and sources\n(data/cogs and data/sources)"] --> B["Derive\n(terrain hydro change)"]
  B --> C["Derivatives\n(data/derivatives/**)"]
  C --> D["Checksums\n(.sha256)"]
  C --> E["STAC items\n(stac/items)"]
  C --> F["Tiles\n(PMTiles or MBTiles)"]
  F --> G["Web viewer\n(MapLibre)"]
  E --> H["Validate\n(stac validate)"]

<!-- END OF MERMAID -->



‚∏ª

What belongs here (and what doesn‚Äôt)
	‚Ä¢	‚úÖ Belongs: computed artifacts (rasters, vectors, tiles) that can be re-generated by scripts.
	‚Ä¢	üö´ Doesn‚Äôt: raw acquisitions and mission-final COGs ‚Üí keep those under data/cogs/**.
Derivatives may reference COGs but must not modify them in place.

‚∏ª

üìÇ Directory layout

data/
‚îî‚îÄ derivatives/
   ‚îú‚îÄ terrain/     # slope, aspect, TRI, TPI, roughness, shaded blends
   ‚îú‚îÄ hydrology/   # filled DEM, flowdir, flowacc, streams, basins
   ‚îú‚îÄ contours/    # vector contours (GPKG), index contours, labels
   ‚îú‚îÄ change/      # DEMs of Difference (DoD), erosion-deposition
   ‚îú‚îÄ vectors/     # extracted ridges/valleys, geomorph features (GPKG)
   ‚îú‚îÄ tiles/       # PMTiles / MBTiles (raster or vector)
   ‚îî‚îÄ _meta/       # schemas, templates, shared LUTs/palettes

Each artifact should include:
	‚Ä¢	Checksum sidecar ‚Üí *.{ext}.sha256 (GNU format)
	‚Ä¢	STAC Item in stac/items/** (preferred)
	‚Ä¢	Optional .meta.json (small pipeline notes)
	‚Ä¢	Optional preview ‚Üí *_preview.png (~1‚Äì2 MP)

‚∏ª

üè∑Ô∏è Naming conventions

<theme>/<region>*<product>[*<params>]_<year-or-range>[_v<semver>].<ext>

Examples
	‚Ä¢	terrain/ks_slope_2018_2020.tif
	‚Ä¢	terrain/ks_aspect_2018_2020.tif
	‚Ä¢	contours/ks_contours_10m_2018_2020.gpkg
	‚Ä¢	hydrology/ks_flowdir_d8_2018_2020.tif
	‚Ä¢	change/ks_dem_DoD_1894_2020.tif
	‚Ä¢	tiles/ks_hillshade_2018_2020.pmtiles

‚∏ª

üîê Sidecars

1) Checksum

cd data/derivatives/<subdir> && \
  sha256sum <name>.<ext> > <name>.<ext>.sha256

Verify later:

sha256sum -c data/derivatives/<subdir>/<name>.<ext>.sha256

2) Optional .meta.json (use STAC when possible)

{
  "id": "ks_slope_2018_2020",
  "version": "1.0.0",
  "type": "raster-derivative",
  "product": "slope",
  "title": "Kansas Slope (degrees, from 1 m DEM 2018‚Äì2020)",
  "derived_from": [
    {
      "id": "ks_1m_dem_2018_2020",
      "path": "data/cogs/dem/ks_1m_dem_2018_2020.tif",
      "sha256": "data/cogs/dem/ks_1m_dem_2018_2020.tif.sha256"
    }
  ],
  "files": {
    "primary": {
      "path": "data/derivatives/terrain/ks_slope_2018_2020.tif",
      "sha256": "data/derivatives/terrain/ks_slope_2018_2020.tif.sha256"
    }
  },
  "processing": {
    "software": { "gdal": "3.6+" },
    "commands": [
      "gdaldem slope -s 1.0 -of GTiff data/cogs/dem/ks_1m_dem_2018_2020.tif /tmp/ks_slope.tif",
      "gdal_translate -of COG -co COMPRESS=DEFLATE -co PREDICTOR=2 /tmp/ks_slope.tif data/derivatives/terrain/ks_slope_2018_2020.tif"
    ],
    "params": { "units": "degree", "scale_z": 1.0 }
  }
}

Source of truth: Prefer STAC Items with projection/raster/file/checksum extensions.

‚∏ª

üß™ Standard derivatives & recipes

Replace EPSG with your DEM CRS (Kansas commonly EPSG:26914 UTM 14N; sometimes EPSG:6344). Keep outputs COG when practical.

Slope (degrees) and Aspect (0‚Äì360)

# Slope (degrees)
gdaldem slope -s 1.0 data/cogs/dem/ks_1m_dem_2018_2020.tif /tmp/ks_slope.tif
gdal_translate -of COG -co COMPRESS=DEFLATE -co PREDICTOR=2 \
  /tmp/ks_slope.tif data/derivatives/terrain/ks_slope_2018_2020.tif

# Aspect (0‚Äì360, 0=N)
gdaldem aspect data/cogs/dem/ks_1m_dem_2018_2020.tif /tmp/ks_aspect.tif
gdal_translate -of COG -co COMPRESS=DEFLATE -co PREDICTOR=2 \
  /tmp/ks_aspect.tif data/derivatives/terrain/ks_aspect_2018_2020.tif

TRI / TPI / Roughness

gdaldem TRI       data/cogs/dem/ks_1m_dem_2018_2020.tif /tmp/ks_tri.tif
gdaldem TPI       data/cogs/dem/ks_1m_dem_2018_2020.tif /tmp/ks_tpi.tif
gdaldem roughness data/cogs/dem/ks_1m_dem_2018_2020.tif /tmp/ks_rough.tif

for f in ks_tri ks_tpi ks_rough; do
  gdal_translate -of COG -co COMPRESS=DEFLATE -co PREDICTOR=2 \
    /tmp/${f}.tif data/derivatives/terrain/${f}_2018_2020.tif
done

Hydrology (fill depressions ‚Üí flowdir ‚Üí flowacc)

gdaldem fillnodata fills NoData, not true depressions. Use WhiteboxTools, TauDEM, or RichDEM.

WhiteboxTools example:

whitebox_tools -r FillDepressions    -i data/cogs/dem/ks_1m_dem_2018_2020.tif -o /tmp/ks_dem_filled.tif
whitebox_tools -r D8Pointer          -i /tmp/ks_dem_filled.tif -o /tmp/ks_flowdir.tif
whitebox_tools -r D8FlowAccumulation -i /tmp/ks_dem_filled.tif -o /tmp/ks_flowacc.tif

gdal_translate -of COG -co COMPRESS=DEFLATE -co PREDICTOR=2 \
  /tmp/ks_flowdir.tif data/derivatives/hydrology/ks_flowdir_d8_2018_2020.tif
gdal_translate -of COG -co COMPRESS=DEFLATE -co PREDICTOR=2 \
  /tmp/ks_flowacc.tif data/derivatives/hydrology/ks_flowacc_d8_2018_2020.tif

Contours (vector, GPKG)

gdal_contour -a elev -i 10.0 \
  data/cogs/dem/ks_1m_dem_2018_2020.tif \
  data/derivatives/contours/ks_contours_10m_2018_2020.gpkg

DEM of Difference (DoD)

Align to a common grid (CRS, resolution, extent, alignment) before differencing:

# Align newer to older (example; adjust EPSG and extent)
gdalwarp -t_srs EPSG:26914 -r bilinear -tap -tr 1 1 -te_srs EPSG:26914 \
  -te <minx> <miny> <maxx> <maxy> \
  data/cogs/dem/newer_dem.tif /tmp/newer_aligned.tif

gdal_calc.py -A data/cogs/dem/older_dem.tif -B /tmp/newer_aligned.tif \
  --calc="B-A" --NoDataValue=-9999 --outfile=/tmp/ks_DoD.tif

gdal_translate -of COG -co COMPRESS=DEFLATE -co PREDICTOR=2 \
  /tmp/ks_DoD.tif data/derivatives/change/ks_dem_DoD_older_newer.tif

Web tiles (PMTiles / MBTiles)
	‚Ä¢	PMTiles (raster): tile from COG (e.g., rio-tiler pipeline) then pmtiles convert.
	‚Ä¢	MBTiles: gdal2tiles.py ‚Üí mb-util, or rio mbtiles.

Record tool versions and commands in metadata.

‚∏ª

üß∞ Makefile snippets (drop into project Makefile)

DERIV := data/derivatives

# Ensure subdirs exist
$(DERIV)/%/:
	@mkdir -p $@

# Slope / Aspect from DEM
$(DERIV)/terrain/ks_slope_2018_2020.tif: data/cogs/dem/ks_1m_dem_2018_2020.tif | $(DERIV)/terrain/
	gdaldem slope -s 1.0 $< /tmp/ks_slope.tif
	gdal_translate -of COG -co COMPRESS=DEFLATE -co PREDICTOR=2 /tmp/ks_slope.tif $@

$(DERIV)/terrain/ks_aspect_2018_2020.tif: data/cogs/dem/ks_1m_dem_2018_2020.tif | $(DERIV)/terrain/
	gdaldem aspect $< /tmp/ks_aspect.tif
	gdal_translate -of COG -co COMPRESS=DEFLATE -co PREDICTOR=2 /tmp/ks_aspect.tif $@

# Contours
$(DERIV)/contours/ks_contours_10m_2018_2020.gpkg: data/cogs/dem/ks_1m_dem_2018_2020.tif | $(DERIV)/contours/
	gdal_contour -a elev -i 10.0 $< $@

.PHONY: derivatives-all
derivatives-all: \
  $(DERIV)/terrain/ks_slope_2018_2020.tif \
  $(DERIV)/terrain/ks_aspect_2018_2020.tif \
  $(DERIV)/contours/ks_contours_10m_2018_2020.gpkg


‚∏ª

‚úÖ Validation

# STAC validation for derivative items (if present)
make stac-validate-items || true

# JSON sanity for .meta.json (if used)
find data/derivatives -name "*.meta.json" -print0 | xargs -0 -I{} jq -e 'type=="object"' {}

# Checksum verification
find data/derivatives -name "*.sha256" -print0 | xargs -0 -I{} sha256sum -c {}

# Quick inspection
gdalinfo data/derivatives/terrain/ks_slope_2018_2020.tif | head -n 40 || true


‚∏ª

üîó Web viewer wiring

Add or generate a layer entry:

{
  "id": "ks_slope_2018_2020",
  "title": "Slope (degrees, 2018‚Äì2020)",
  "type": "raster",
  "data": "data/derivatives/terrain/ks_slope_2018_2020.tif",
  "category": "terrain",
  "opacity": 0.7,
  "visible": false,
  "attribution": "Derived from USGS 3DEP DEM (Public Domain)"
}

If tiled, use the tile URL or pmtiles://‚Ä¶ instead of the raw COG.

‚∏ª

üß≠ Tips
	‚Ä¢	Prefer tile size 512 for large rasters (better range reads).
	‚Ä¢	Continuous rasters ‚Üí DEFLATE + PREDICTOR=2; scanned photos ‚Üí JPEG/WebP.
	‚Ä¢	Hydrology and differencing demand exact grid alignment.
	‚Ä¢	Track big artifacts with LFS or DVC; commit checksums + STAC to git.

Owner: Data Engineering / MCP
PR label: data:derivative

‚∏ª
