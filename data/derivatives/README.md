# Derived Geospatial Products

This folder contains **analysis-ready derivatives** generated from canonical sources in `data/cogs/` and curated inputs in `data/sources/`.  
All outputs here are **reproducible**, **documented**, and tied back to their origins via **provenance sidecars** and (preferably) **STAC Items**.

> Examples: slope/aspect, TRI/TPI/roughness, filled DEMs, shaded-relief blends, contours, DoD (change), hydrology stacks (flowdir/flowacc), vector extractions, and web tiles (PMTiles/MBTiles).

---

## What belongs here (and what doesnâ€™t)

- âœ… **Belongs**: artifacts computed from sources (rasters/vectors/tiles) that can be re-generated by scripts.
- ðŸš« **Doesnâ€™t**: raw acquisitions and *mission-final* COGs â€” those live in `data/cogs/**`.  
  Derivatives may **reference** them but **must not** mutate them in place.

---

## Directory layout

```

data/
â””â”€ derivatives/
â”œâ”€ terrain/        # slope, aspect, TRI, TPI, roughness, shaded blends
â”œâ”€ hydrology/      # filled DEM, flowdir, flowacc, streams, basins
â”œâ”€ contours/       # vector contours (GPKG), index contours, labels
â”œâ”€ change/         # DEMs of Difference (DoD), erosion/deposition maps
â”œâ”€ vectors/        # extracted ridges/valleys, geomorph features (GPKG)
â”œâ”€ tiles/          # PMTiles/MBTiles (raster or vector)
â””â”€ _meta/          # schemas, templates, shared LUTs/palettes

```

Each artifact should be accompanied by:
- A **checksum** sidecar: `*.{ext}.sha256` (GNU format: `<digest><two spaces><filename>`)
- (Preferred) a **STAC Item** in `stac/items/**`
- (Optional) `*.meta.json` â€” small, pipeline-friendly metadata if you need non-STAC notes
- (Optional) preview: `*_preview.png` (~1â€“2 MP)

---

## Naming conventions

```

<theme>/<region>*<product>[*<params>]_<year-or-range>[_v<semver>].<ext>

````

**Examples**
- `terrain/ks_slope_2018_2020.tif`
- `terrain/ks_aspect_2018_2020.tif`
- `contours/ks_contours_10m_2018_2020.gpkg`
- `hydrology/ks_flowdir_d8_2018_2020.tif`
- `change/ks_dem_DoD_1894_2020.tif`
- `tiles/ks_hillshade_2018_2020.pmtiles`

---

## Sidecars

### 1) Checksum

**Recommended (ensures the filename in the sidecar, not the full path):**
```bash
cd data/derivatives/<subdir> && \
  sha256sum <name>.<ext> > <name>.<ext>.sha256
````

Verify later with:

```bash
sha256sum -c data/derivatives/<subdir>/<name>.<ext>.sha256
```

### 2) Metadata (`.meta.json`) â€” optional if you have STAC

Minimal keys (extend as needed):

```json
{
  "id": "ks_slope_2018_2020",
  "version": "1.0.0",
  "type": "raster-derivative",
  "product": "slope",
  "title": "Kansas Slope (degrees, from 1 m DEM 2018â€“2020)",
  "description": "Slope (degrees) derived from ks_1m_dem_2018_2020.",
  "spatial": {
    "bbox": [-102.05, 36.99, -94.60, 40.00],
    "resolution_m": 1.0,
    "proj": { "epsg": 26914 }
  },
  "temporal": { "start": "2018-01-01", "end": "2020-12-31" },
  "derived_from": [
    {
      "id": "ks_1m_dem_2018_2020",
      "path": "data/cogs/dem/ks_1m_dem_2018_2020.tif",
      "sha256": "data/cogs/dem/ks_1m_dem_2018_2020.tif.sha256"
    }
  ],
  "files": {
    "primary": {
      "path": "data/derivatives/terrain/ks_slope_2018_2020.tif",
      "media_type": "image/tiff; application=geotiff; profile=cloud-optimized",
      "sha256": "data/derivatives/terrain/ks_slope_2018_2020.tif.sha256"
    },
    "preview": { "path": "data/derivatives/terrain/ks_slope_2018_2020_preview.png" }
  },
  "processing": {
    "software": { "gdal": "3.6+" },
    "commands": [
      "gdaldem slope -s 1.0 -of GTiff data/cogs/dem/ks_1m_dem_2018_2020.tif /tmp/ks_slope.tif",
      "gdal_translate -of COG -co COMPRESS=DEFLATE -co PREDICTOR=2 /tmp/ks_slope.tif data/derivatives/terrain/ks_slope_2018_2020.tif"
    ],
    "params": { "units": "degree", "scale_z": 1.0, "pixels_are_square": true }
  },
  "license": "Public Domain (USGS)",
  "providers": [{ "name": "USGS 3DEP", "roles": ["producer"] }]
}
```

> **Source of truth:** Prefer STAC Items under `stac/items/**` (projection/raster/file/checksum extensions). Keep `.meta.json` only if needed.

---

## Standard derivatives & recipes

> Replace EPSG with your DEM CRS (Kansas commonly **EPSG:26914** UTM 14N; sometimes **EPSG:6344**). Keep outputs **COG** when practical.

### Slope (degrees) & Aspect (0â€“360)

```bash
# Slope (degrees)
gdaldem slope -s 1.0 data/cogs/dem/ks_1m_dem_2018_2020.tif /tmp/ks_slope.tif
gdal_translate -of COG -co COMPRESS=DEFLATE -co PREDICTOR=2 \
  /tmp/ks_slope.tif data/derivatives/terrain/ks_slope_2018_2020.tif

# Aspect (0â€“360, 0=N)
gdaldem aspect data/cogs/dem/ks_1m_dem_2018_2020.tif /tmp/ks_aspect.tif
gdal_translate -of COG -co COMPRESS=DEFLATE -co PREDICTOR=2 \
  /tmp/ks_aspect.tif data/derivatives/terrain/ks_aspect_2018_2020.tif
```

### TRI / TPI / Roughness

```bash
gdaldem TRI       data/cogs/dem/ks_1m_dem_2018_2020.tif /tmp/ks_tri.tif
gdaldem TPI       data/cogs/dem/ks_1m_dem_2018_2020.tif /tmp/ks_tpi.tif
gdaldem roughness data/cogs/dem/ks_1m_dem_2018_2020.tif /tmp/ks_rough.tif

for f in ks_tri ks_tpi ks_rough; do
  gdal_translate -of COG -co COMPRESS=DEFLATE -co PREDICTOR=2 \
    /tmp/${f}.tif data/derivatives/terrain/${f}_2018_2020.tif
done
```

### Hydrology (depression filling â†’ flowdir â†’ flowacc)

> **Note:** `gdaldem fillnodata` fills *NoData holes*, not geomorphic depressions.
> For hydrology, use **RichDEM**, **TauDEM**, or **WhiteboxTools**.

WhiteboxTools (CLI) example:

```bash
whitebox_tools -r FillDepressions    -i data/cogs/dem/ks_1m_dem_2018_2020.tif -o /tmp/ks_dem_filled.tif
whitebox_tools -r D8Pointer          -i /tmp/ks_dem_filled.tif -o /tmp/ks_flowdir.tif
whitebox_tools -r D8FlowAccumulation -i /tmp/ks_dem_filled.tif -o /tmp/ks_flowacc.tif

gdal_translate -of COG -co COMPRESS=DEFLATE -co PREDICTOR=2 \
  /tmp/ks_flowdir.tif data/derivatives/hydrology/ks_flowdir_d8_2018_2020.tif
gdal_translate -of COG -co COMPRESS=DEFLATE -co PREDICTOR=2 \
  /tmp/ks_flowacc.tif data/derivatives/hydrology/ks_flowacc_d8_2018_2020.tif
```

### Contours (vector, GPKG)

```bash
gdal_contour -a elev -i 10.0 \
  data/cogs/dem/ks_1m_dem_2018_2020.tif \
  data/derivatives/contours/ks_contours_10m_2018_2020.gpkg
```

### DEM of Difference (DoD)

**Always** align to a common grid (CRS, resolution, extent, pixel alignment) before differencing:

```bash
# Align newer to older (example; adjust EPSG/res as needed)
gdalwarp -t_srs EPSG:26914 -r bilinear -tap -tr 1 1 -te_srs EPSG:26914 \
  -te <minx> <miny> <maxx> <maxy> \
  data/cogs/dem/newer_dem.tif /tmp/newer_aligned.tif

gdal_calc.py -A data/cogs/dem/older_dem.tif -B /tmp/newer_aligned.tif \
  --calc="B-A" --NoDataValue=-9999 --outfile=/tmp/ks_DoD.tif

gdal_translate -of COG -co COMPRESS=DEFLATE -co PREDICTOR=2 \
  /tmp/ks_DoD.tif data/derivatives/change/ks_dem_DoD_older_newer.tif
```

### Web tiles (PMTiles / MBTiles)

* **PMTiles** (raster): tile from COG (e.g., `rio-tiler`/`cogeo-tiler`) then `pmtiles convert`.
* **MBTiles**: `gdal2tiles.py` â†’ `mb-util`, or `rio mbtiles`.

Record the build recipe and tool versions in your metadata.

---

## Makefile snippets (drop into project `Makefile`)

```make
DERIV := data/derivatives

# Ensure directories exist
$(DERIV)/%/:
	@mkdir -p $@

# Slope / Aspect from DEM
$(DERIV)/terrain/ks_slope_2018_2020.tif: data/cogs/dem/ks_1m_dem_2018_2020.tif | $(DERIV)/terrain/
	gdaldem slope -s 1.0 $< /tmp/ks_slope.tif
	gdal_translate -of COG -co COMPRESS=DEFLATE -co PREDICTOR=2 /tmp/ks_slope.tif $@

$(DERIV)/terrain/ks_aspect_2018_2020.tif: data/cogs/dem/ks_1m_dem_2018_2020.tif | $(DERIV)/terrain/
	gdaldem aspect $< /tmp/ks_aspect.tif
	gdal_translate -of COG -co COMPRESS=DEFLATE -co PREDICTOR=2 /tmp/ks_aspect.tif $@

# Contours
$(DERIV)/contours/ks_contours_10m_2018_2020.gpkg: data/cogs/dem/ks_1m_dem_2018_2020.tif | $(DERIV)/contours/
	gdal_contour -a elev -i 10.0 $< $@

.PHONY: derivatives-all
derivatives-all: \
  $(DERIV)/terrain/ks_slope_2018_2020.tif \
  $(DERIV)/terrain/ks_aspect_2018_2020.tif \
  $(DERIV)/contours/ks_contours_10m_2018_2020.gpkg
```

---

## Validation

```bash
# STAC: validate items (if present)
make stac-validate-items || true

# JSON sidecars (if you use .meta.json)
find data/derivatives -name "*.meta.json" -print0 | xargs -0 -I{} jq -e 'type=="object"' {}

# Checksums
find data/derivatives -name "*.sha256" -print0 | xargs -0 -I{} sha256sum -c {}

# Quick gdalinfo spot checks
gdalinfo data/derivatives/terrain/ks_slope_2018_2020.tif | head -n 40 || true
```

---

## Provenance & MCP hooks

* Every derivative must declare **`derived_from`** entries (paths + checksums).
* Include exact **processing.commands** and **params** (window sizes, resampling, z-scale, kernel, etc.).
* For MCP traces, populate `experiment_id`, `documentation`, `sop_reference`, and a `traceability.git_commit`.

---

## Web viewer wiring

Add/confirm a layer entry (or generate from STAC):

```json
{
  "id": "ks_slope_2018_2020",
  "title": "Slope (degrees, 2018â€“2020)",
  "type": "raster",
  "data": "data/derivatives/terrain/ks_slope_2018_2020.tif",
  "category": "terrain",
  "opacity": 0.7,
  "visible": false,
  "attribution": "Derived from USGS 3DEP DEM (Public Domain)"
}
```

> If tiling to PMTiles/MBTiles, point to the tile URL or `pmtiles://â€¦` source instead of the raw COG.

---

## Tips

* Prefer **tile size 512** for large rasters (better range-reads).
* Use **DEFLATE + PREDICTOR=2** for continuous rasters; **JPEG/WebP** only for scanned RGB imagery.
* Keep DEM/hydrology outputs **lossless**.
* For differencing/stacking, ensure **exact grid alignment** (CRS, `-tr`, `-tap`, `-te`, `-r`).
* Store big artifacts with **LFS/DVC**; commit just checksums + STAC (and optional `.meta.json`) to git.

**Owner**: Data Engineering / MCP
**PR label**: `data:derivative`

---

```
```
