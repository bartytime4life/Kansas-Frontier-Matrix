# Derived Geospatial Products

This folder contains **analysis-ready derivatives** generated from canonical sources in `data/cogs/` and other curated inputs in `data/sources/`.  
All outputs here are reproducible, documented, and tied back to their origins via **provenance sidecars**.

> Think: slope/aspect, contours, flow direction/accumulation, depressionless DEMs, shaded-relief composites, change rasters (DoD), vector extractions, and web tiles (PMTiles/MBTiles).

---

## What belongs here (and what doesnâ€™t)

- âœ… **Belongs**: artifacts computed from sources (rasters/vectors/tiles) that may be re-generated by scripts.
- ðŸš« **Doesnâ€™t**: raw acquisitions and mission-final COGs â€” those live in `data/cogs/`.  
  Derivatives can point to them and should never silently mutate them.

---

## Directory layout

```

data/
â””â”€ derivatives/
â”œâ”€ terrain/           # slope, aspect, TRI, TPI, roughness, shaded blends
â”œâ”€ hydrology/         # filled DEM, flowdir, flowacc, streams, basins
â”œâ”€ contours/          # vector contours (GPKG), index contours, labels
â”œâ”€ change/            # DEMs of Difference (DoD), erosion/deposition maps
â”œâ”€ vectors/           # geomorph. features, extracted ridges/valleys (GPKG)
â”œâ”€ tiles/             # PMTiles/MBTiles built from any of the above
â””â”€ \_meta/             # schemas, templates, shared LUTs/palettes

```

Each artifact should be accompanied by:
- `*.meta.json` â€” pipeline-friendly metadata (provenance + parameters)
- `*.sha256`  â€” checksum of the primary file
- Optional preview: `*_preview.png` (small, 1â€“2 MP)

---

## Naming conventions

```

<theme>/<region>*<product>*\<temporal|version>.<ext>

````

**Examples**
- `terrain/ks_slope_2018_2020.tif`
- `terrain/ks_aspect_2018_2020.tif`
- `contours/ks_contours_10m_2018_2020.gpkg`
- `hydrology/ks_flowdir_d8_2018_2020.tif`
- `change/ks_dem_DoD_1894_2020.tif`
- `tiles/ks_hillshade_2018_2020.pmtiles`

---

## Sidecars

### 1) Checksum
```bash
sha256sum data/derivatives/<subdir>/<name>.<ext> \
  | awk '{print $1"  "$2}' \
  > data/derivatives/<subdir>/<name>.sha256
````

### 2) Metadata (`.meta.json`)

Minimal keys (extend as needed):

```json
{
  "id": "ks_slope_2018_2020",
  "version": "1.0.0",
  "type": "raster-derivative",
  "product": "slope",
  "title": "Kansas Slope (degrees, from 1m DEM 2018â€“2020)",
  "description": "Slope (degrees) derived from ks_1m_dem_2018_2020.",
  "spatial": { "bbox": [-102.05,36.99,-94.60,40.00], "resolution_m": 1.0, "proj": { "epsg": 26914 } },
  "temporal": { "start": "2018-01-01", "end": "2020-12-31" },
  "derived_from": [
    { "id": "ks_1m_dem_2018_2020", "path": "data/cogs/dem/ks_1m_dem_2018_2020.tif",
      "meta": "data/cogs/dem/ks_1m_dem_2018_2020.meta.json",
      "sha256": "data/cogs/dem/ks_1m_dem_2018_2020.sha256" }
  ],
  "files": {
    "primary": {
      "path": "data/derivatives/terrain/ks_slope_2018_2020.tif",
      "media_type": "image/tiff; application=geotiff; profile=cloud-optimized",
      "size_bytes": null,
      "sha256": "data/derivatives/terrain/ks_slope_2018_2020.sha256"
    },
    "preview": {
      "path": "data/derivatives/terrain/ks_slope_2018_2020_preview.png",
      "media_type": "image/png",
      "size_bytes": null
    }
  },
  "processing": {
    "software": { "gdal": "3.6+" },
    "commands": [
      "gdaldem slope -s 1.0 -of GTiff data/cogs/dem/ks_1m_dem_2018_2020.tif /tmp/ks_slope.tif",
      "gdal_translate -of COG -co COMPRESS=DEFLATE -co PREDICTOR=2 /tmp/ks_slope.tif data/derivatives/terrain/ks_slope_2018_2020.tif"
    ],
    "params": { "units": "degree", "scale_z": 1.0, "pixels_are_square": true }
  },
  "validation": {
    "checks": [
      "jq -e 'type==\"object\"' data/derivatives/terrain/ks_slope_2018_2020.meta.json",
      "sha256sum -c data/derivatives/terrain/ks_slope_2018_2020.sha256"
    ]
  },
  "license": "Public Domain (USGS)",
  "providers": [{ "name": "USGS 3DEP", "roles": ["producer"] }],
  "mcp": {
    "experiment_id": "EXP-SLOPE-KS-2018-2020",
    "documentation": "mcp/experiments/terrain_slope_ks_2018_2020.md",
    "sop_reference": "mcp/sops/derive_slope_aspect.md",
    "traceability": { "git_commit": "<commit-hash>" }
  }
}
```

---

## Standard derivatives & recipes

> Replace EPSG with your actual DEM CRS (KS often uses **EPSG:26914** or **EPSG:6344**). Keep outputs as **COG** when practical.

### Slope (degrees) & Aspect (0â€“360)

```bash
# Slope
gdaldem slope -s 1.0 data/cogs/dem/ks_1m_dem_2018_2020.tif /tmp/ks_slope.tif
gdal_translate -of COG -co COMPRESS=DEFLATE -co PREDICTOR=2 /tmp/ks_slope.tif data/derivatives/terrain/ks_slope_2018_2020.tif

# Aspect
gdaldem aspect data/cogs/dem/ks_1m_dem_2018_2020.tif /tmp/ks_aspect.tif
gdal_translate -of COG -co COMPRESS=DEFLATE -co PREDICTOR=2 /tmp/ks_aspect.tif data/derivatives/terrain/ks_aspect_2018_2020.tif
```

### Terrain Ruggedness/Position (TRI/TPI) & Roughness

```bash
gdaldem TRI data/cogs/dem/ks_1m_dem_2018_2020.tif /tmp/ks_tri.tif
gdaldem TPI data/cogs/dem/ks_1m_dem_2018_2020.tif /tmp/ks_tpi.tif
gdaldem roughness data/cogs/dem/ks_1m_dem_2018_2020.tif /tmp/ks_rough.tif
for f in ks_tri ks_tpi ks_rough; do
  gdal_translate -of COG -co COMPRESS=DEFLATE -co PREDICTOR=2 /tmp/$f.tif data/derivatives/terrain/${f}_2018_2020.tif
done
```

### Hydrology (fill â†’ flow direction â†’ flow accumulation)

> For large domains consider TauDEM/RichDEM/Whitebox for speed, but hereâ€™s a GDAL-first baseline:

```bash
# Fill depressions
gdaldem fillnodata -md 5 data/cogs/dem/ks_1m_dem_2018_2020.tif /tmp/ks_dem_filled.tif

# Flow direction (D8 proxy with gdaldem) â€“ or swap in RichDEM/TauDEM
# (gdaldem has no direct D8; use external tools for production)
# Example with RichDEM (python): rd.FillSinks, rd.FlowDirD8, rd.FlowAccumD8

# Flow accumulation (example using WhiteboxTools CLI if available)
# whitebox_tools -r "D8Pointer" -i /tmp/ks_dem_filled.tif -o /tmp/ks_flowdir.tif
# whitebox_tools -r "D8FlowAccumulation" -i /tmp/ks_dem_filled.tif -o /tmp/ks_flowacc.tif

# Convert to COG if generated
# gdal_translate -of COG -co COMPRESS=DEFLATE -co PREDICTOR=2 /tmp/ks_flowdir.tif data/derivatives/hydrology/ks_flowdir_d8_2018_2020.tif
# gdal_translate -of COG -co COMPRESS=DEFLATE -co PREDICTOR=2 /tmp/ks_flowacc.tif data/derivatives/hydrology/ks_flowacc_d8_2018_2020.tif
```

### Contours (vector, GPKG)

```bash
gdal_contour -a elev -i 10.0 \
  data/cogs/dem/ks_1m_dem_2018_2020.tif \
  data/derivatives/contours/ks_contours_10m_2018_2020.gpkg
```

### DEM of Difference (DoD)

```bash
# Reproject & align both DEMs to a common grid before differencing
gdal_calc.py -A data/cogs/dem/older_dem.tif -B data/cogs/dem/newer_dem.tif \
  --calc="B-A" --outfile=/tmp/ks_DoD.tif --NoDataValue=-9999
gdal_translate -of COG -co COMPRESS=DEFLATE -co PREDICTOR=2 /tmp/ks_DoD.tif data/derivatives/change/ks_dem_DoD_older_newer.tif
```

### Web tiles (PMTiles/MBTiles)

* PMTiles (tippecanoe for vector, `pmtiles convert` or `cogâ†’tiles` pipelines for raster)
* MBTiles (e.g., `gdal2tiles.py` then `mb-util`, or `rio mbtiles`)

Record the tile build in `*.meta.json` and link back to the source derivative.

---

## Validation

Run before committing:

```bash
# JSON sidecars
find data/derivatives -name "*.meta.json" -print0 | xargs -0 -I{} jq -e 'type=="object"' {}

# Checksums
find data/derivatives -name "*.sha256" -print0 | xargs -0 -I{} sha256sum -c {}

# Quick gdalinfo (spot-check a few)
gdalinfo data/derivatives/terrain/ks_slope_2018_2020.tif | head -n 40 || true
```

---

## Provenance & MCP hooks

* Every derivative must declare **`derived_from`** entries pointing to its inputs (paths + meta + sha256).
* Include **processing.commands** and key parameters (window sizes, resampling, z-scale, etc.).
* Use `mcp.experiment_id`, `mcp.documentation`, `mcp.sop_reference`, and capture `traceability.git_commit`.

---

## Tips

* Prefer **tile size 512** for large rasters (better HTTP range-read behavior).
* Use **DEFLATE+PREDICTOR=2** for continuous rasters; **JPEG (QUALITY 85, YCBCR)** for scanned RGB map imagery.
* Keep DEM/hydrology outputs **lossless**.
* Align grids for any differencing (exact res, extent, pixel alignment).

---

**Owner**: Data Engineering / MCP
**PR label**: `data:derivative`

```
```

