# Inputs / outputs
DEM="data/cogs/dem/ks_1m_dem_2018_2020.tif"
OUT="data/cogs/hillshade/ks_hillshade_2018_2020.tif"
PREVIEW="data/cogs/hillshade/ks_hillshade_2018_2020_preview.png"

mkdir -p "$(dirname "$OUT")"

# 1) Hillshade (single-direction; robust defaults)
gdaldem hillshade \
  -alt 45 -az 315 \
  -compute_edges \
  -of GTiff \
  "$DEM" /tmp/ks_hillshade_2018_2020.tif

# (Optional) multidirectional variant (uncomment to use instead of the block above)
# gdaldem hillshade -multidirectional -compute_edges -of GTiff "$DEM" /tmp/ks_hillshade_2018_2020.tif

# 2) Convert to Cloud-Optimized GeoTIFF (lossless)
gdal_translate -of COG \
  -co COMPRESS=DEFLATE -co PREDICTOR=2 \
  -co BLOCKSIZE=512 \
  -co NUM_THREADS=ALL_CPUS \
  -co BIGTIFF=IF_SAFER \
  -co OVERVIEW_RESAMPLING=AVERAGE \
  /tmp/ks_hillshade_2018_2020.tif "$OUT"

# 3) Preview + checksum (best effort)
gdal_translate -of PNG -outsize 25% 25% "$OUT" "$PREVIEW" 2>/dev/null || true
if command -v sha256sum >/dev/null 2>&1; then
  ( cd "$(dirname "$OUT")" && sha256sum "$(basename "$OUT")" > "$(basename "$OUT").sha256" )
else
  ( cd "$(dirname "$OUT")" && shasum -a 256 "$(basename "$OUT")" > "$(basename "$OUT").sha256" )
fi

echo "âœ… Built $OUT"
gdalinfo "$OUT" | sed -n '1,20p'

