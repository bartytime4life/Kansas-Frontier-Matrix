<!-- [KFM_META_BLOCK_V2]
doc_id: kfm://doc/93120427-ae74-471a-ac97-dedb507879b1
title: scripts/release ‚Äî Governed release runbook
type: standard
version: v1
status: draft
owners: TBD (assign a release maintainer)
created: 2026-02-22
updated: 2026-02-22
policy_label: public
related:
  - kfm://doc/definitive-design-governance-guide-vnext (reference; path/ID may differ)
  - docs/MASTER_GUIDE_v13.md (if present)
  - releases/ (packaged release artifacts)
tags: [kfm, release, scripts, provenance, promotion, gates, sbom]
notes:
  - This file documents the *release tooling boundary* (package + verify + attest + publish).
  - If your repo uses different script names, keep the behaviors/gates but update the entrypoints here.
[/KFM_META_BLOCK_V2] -->

# Release scripts
Pack, verify, and (optionally) sign/attest KFM releases **without punching holes in the trust membrane**.

**Status:** draft ‚Ä¢ **Owners:** TBD ‚Ä¢ **Last updated:** 2026-02-22

![status](https://img.shields.io/badge/status-draft-yellow)
![scope](https://img.shields.io/badge/scope-release%20scripts-blue)
![policy](https://img.shields.io/badge/gates-fail--closed-critical)
![metadata](https://img.shields.io/badge/catalog-STAC%20%2B%20DCAT%20%2B%20PROV-informational)
![supply-chain](https://img.shields.io/badge/supply%20chain-SBOM%20%2B%20attestations-9cf)

**Legend:** ‚úÖ Confirmed ‚Ä¢ üß™ Proposed ‚Ä¢ ‚ùì Unknown (verify in repo)

---

## Quick navigation
- [What this directory is](#what-this-directory-is)
- [Non-negotiables](#non-negotiables)
- [Release Definition of Done](#release-definition-of-done)
- [Release flow](#release-flow)
- [Promotion gates mapped to release steps](#promotion-gates-mapped-to-release-steps)
- [Release bundle layout](#release-bundle-layout)
- [How to run locally](#how-to-run-locally)
- [CI integration expectations](#ci-integration-expectations)
- [Rollback and revocation](#rollback-and-revocation)
- [Troubleshooting](#troubleshooting)
- [Appendix: Proposed CLI contract](#appendix-proposed-cli-contract)

---

## What this directory is

This folder **contains (or is reserved for)** scripts that turn already-produced artifacts into a **governed release**:

- ‚úÖ **Package**: deterministic, versioned bundles (data + catalogs + receipts).
- ‚úÖ **Verify**: strict, *fail-closed* gates for identity, licensing, policy, and provenance.
- ‚úÖ **Optionally attest/sign**: SBOM + supply-chain provenance for promoted artifacts.
- ‚úÖ **Publish**: move a release into a runtime surface (e.g., `releases/`, OCI registry, static hosting).

### What this directory is not

Release scripts **must not** be the place where we ‚Äúdo the real work‚Äù of ingestion/transforms.

- Data transforms belong in pipeline code (`src/pipelines/...`) and must emit receipts, checksums, and catalogs *before* release.
- UI and API code do not live here.

> **NOTE (repo reality check):**
> This README is intentionally written as a **contract + runbook**.
> If you don‚Äôt yet have a single entrypoint script in this folder, start by adding one and implementing the **gates** section below.

### Repo-specific assumptions (UNKNOWN until verified)

The following are intentionally treated as **unknown** until you confirm them in the repo:

- **Entrypoint name(s):** which script is the canonical interface (`kfm-release`, `release.sh`, `release.py`, etc.).
- **Publish target:** filesystem `releases/`, OCI registry, static hosting, or a mix.
- **Policy engine:** OPA/Conftest vs another evaluator.
- **Signing/attestation tooling:** Cosign/Sigstore vs another mechanism (or none yet).
- **Schema locations:** where STAC/DCAT/PROV profiles and receipt schemas live.
- **Catalog authority:** whether catalogs are generated by pipelines, by release tooling, or both.

**Minimum verification steps (fast):**
1. `ls -la scripts/release/` (discover actual entrypoints).
2. Search CI workflows for references to `scripts/release` and ‚Äúpublish/promote/release‚Äù.
3. Locate schema folders (look for `schemas/`, `catalog/`, `policy/`).
4. Run `./scripts/release/<entrypoint> --help` and confirm it supports **verify/build/publish** (or equivalent).

[‚¨Ü Back to top](#release-scripts)

---

## Non-negotiables

These are the invariants the release scripts must enforce (or delegate to enforced tooling):

1) **Fail-closed promotion**
   - If evidence, signatures, catalogs, or policies fail ‚Üí **nothing ships**.

2) **Determinism**
   - The same inputs + same spec must produce the same `dataset_version_id` and artifact digests.
   - Configs/params must be canonicalized before hashing.

3) **Receipts as first-class artifacts**
   - Every release run produces a machine-readable receipt (run manifest + run receipt).

4) **Catalog triplet is the publish gate**
   - DCAT + STAC + PROV must exist, validate, and cross-link before promotion.

5) **Policy-aware by default**
   - Policy labels and redaction obligations are inputs to packaging, tiling, and publishing.
   - Never ‚Äúleak by behavior‚Äù (e.g., distinguish 403 vs 404 in a way that reveals restricted existence).

6) **No long-lived secrets**
   - Prefer ephemeral identity (CI OIDC) and keyless signing where possible.
   - Scrub logs; never print tokens, cookies, or sensitive URLs.

[‚¨Ü Back to top](#release-scripts)

---

## Release Definition of Done

A release run is **DONE** only when all of the following are true:

- [ ] **Gate A** passes: `dataset_version_id` and `spec_hash` are deterministic and recorded.
- [ ] **Gate B** passes: license + rights + attribution are present and consistent across catalogs.
- [ ] **Gate C** passes: `policy_label` is assigned; redaction/generalization obligations are satisfied (or the run is blocked).
- [ ] **Gate D** passes: DCAT/STAC/PROV validate and cross-link.
- [ ] **Gate E** passes: run receipt(s) exist; every output has a sha256 digest; environment is captured.
- [ ] **Gate F** passes: policy tests + contract tests pass; evidence resolution works in CI.
- [ ] **Publish step is explicit:** publish requires an explicit command/flag (never ‚Äúby accident‚Äù).
- [ ] **Artifacts are reversible:** you can roll back the publication without rewriting history (audit remains).

> **WARNING:** If you can‚Äôt check all of these boxes, treat the output as **preview-only** and do **not** publish.

[‚¨Ü Back to top](#release-scripts)

---

## Release flow

```mermaid
flowchart LR
  A[Inputs: processed artifacts + catalogs + receipts] --> B[Verify gates A-G]
  B -->|pass| C[Package release bundle]
  B -->|fail| Q[Fail closed: stop / quarantine]
  C --> D[Write checksums + manifest]
  D --> E[Optional: SBOM + attestations + signatures]
  E --> F[Publish (artifact store / OCI / static hosting)]
  F --> G[Tag + record audit reference]
```

**Key point:** release scripts should be **boring**: predictable IO, explicit inputs, and strict validation.

[‚¨Ü Back to top](#release-scripts)

---

## Promotion gates mapped to release steps

KFM‚Äôs minimum credible promotion contract can be implemented as release-time gates.

### Gate summary table (minimum credible set)

| Gate | What it protects | Fail-closed examples | Typical release-stage implementation |
|---|---|---|---|
| A. Identity & versioning | Reproducible identity and traceability | Missing/unstable `dataset_version_id`, spec hash differs across runs | Compute/verify `spec_hash`, assert deterministic `dataset_version_id`, require promotion manifest |
| B. Licensing & rights | Legal/ethical publishability | Missing license, ambiguous rights, inconsistent STAC/DCAT license fields | Require SPDX/approved license values + rights holder + attribution; block unknown ‚Üí quarantine |
| C. Sensitivity & redaction plan | Harm prevention + policy compliance | Missing `policy_label`, no redaction/generalization plan for restricted layers | Require policy label; require redaction plan recorded in PROV; verify generalized assets when needed |
| D. Catalog triplet validation | Evidence resolution + interoperability | STAC invalid, DCAT invalid JSON-LD, PROV missing, broken cross-links | Validate schemas + JSON-LD shapes; run link-check across DCAT‚áÑSTAC‚áÑPROV + receipt pointers |
| E. Run receipt & checksums | Auditability + integrity | Missing receipt; missing digests; environment not recorded | Require `run_receipt` + validation report; require sha256 digests for every output; record env (container digest, params hash) |
| F. Policy + contract tests | Trust membrane at API/UI boundary | OPA tests fail; evidence resolver can‚Äôt resolve refs; API schema drift | Run policy tests (fixtures); resolve at least one EvidenceRef in CI; validate API contracts/schemas |
| G. Optional but recommended | Supply chain + operational posture | No SBOM; no build provenance; perf/a11y regressions | Generate SBOM (CycloneDX/SPDX); sign/attest; run perf smoke checks; UI a11y smoke checks |

### What ‚Äúfail closed‚Äù looks like in practice

- Exit non-zero.
- Write **actionable** errors (which gate, which file, how to fix).
- Never partially publish. If a publish step is started, it must be **transactional** (or explicitly reversible).

[‚¨Ü Back to top](#release-scripts)

---

## Release bundle layout

You can implement release publishing to the filesystem (`releases/`) and/or to an OCI registry.
A consistent on-disk layout makes audits and evidence resolution cheap.

### Current directory (minimum)

```text
scripts/release/
‚îî‚îÄ README.md  # this file
```

### Recommended directory (PROPOSED)

```text
scripts/release/
‚îú‚îÄ README.md
‚îú‚îÄ kfm-release            # entrypoint (sh/py/node) ‚Äî supports subcommands; prints --help
‚îú‚îÄ lib/                   # shared helpers (canonicalize, hashing, logging)
‚îú‚îÄ gates/                 # gate implementations (validate catalogs, license checks, policy tests)
‚îî‚îÄ templates/             # manifest + receipt templates (JSON/YAML)
```

### Recommended release output (PROPOSED)

```text
releases/
‚îî‚îÄ <dataset_version_id>/
   ‚îú‚îÄ manifests/
   ‚îÇ  ‚îú‚îÄ promotion_manifest.json
   ‚îÇ  ‚îî‚îÄ release_manifest.json
   ‚îú‚îÄ checksums/
   ‚îÇ  ‚îú‚îÄ sha256sums.txt
   ‚îÇ  ‚îî‚îÄ sha256sums.sig               # optional
   ‚îú‚îÄ receipts/
   ‚îÇ  ‚îú‚îÄ run_receipt.json
   ‚îÇ  ‚îî‚îÄ validation_report.json
   ‚îú‚îÄ catalog/
   ‚îÇ  ‚îú‚îÄ dcat.dataset.jsonld
   ‚îÇ  ‚îú‚îÄ stac/                        # collections + items
   ‚îÇ  ‚îî‚îÄ prov.bundle.jsonld
   ‚îú‚îÄ sbom/                           # optional but recommended
   ‚îÇ  ‚îú‚îÄ sbom.spdx.json
   ‚îÇ  ‚îî‚îÄ sbom.cdx.json
   ‚îú‚îÄ attestations/                   # optional
   ‚îÇ  ‚îî‚îÄ *.jsonl
   ‚îî‚îÄ artifacts/                      # pointers or copies (repo-specific)
      ‚îú‚îÄ *.parquet
      ‚îú‚îÄ *.pmtiles
      ‚îú‚îÄ *.tif
      ‚îî‚îÄ ...
```

> **TIP:** if you publish to OCI, keep the same logical structure but map files into
> well-known artifact types + OCI referrers (SBOMs and attestations ‚Äútravel with‚Äù the release).

[‚¨Ü Back to top](#release-scripts)

---

## How to run locally

Because this repo‚Äôs exact entrypoint may differ, start by discovering what exists:

```bash
# List available tools in this folder
ls -1 scripts/release

# Look for a single entrypoint and read its help output
# (Replace with the actual script name you find.)
./scripts/release/kfm-release --help
```

### Minimal release run (PROPOSED interface)

```bash
# Verify gates first (fast fail)
./scripts/release/kfm-release verify \
  --dataset-version "<dataset_version_id>" \
  --strict

# Build a release bundle (no publish)
./scripts/release/kfm-release build \
  --dataset-version "<dataset_version_id>" \
  --out "releases/<dataset_version_id>" \
  --mode "preview"
```

### Publish (PROPOSED interface)

```bash
# Publish must be its own explicit action.
./scripts/release/kfm-release publish \
  --release-dir "releases/<dataset_version_id>" \
  --destination "filesystem:releases"      # or oci:<registry>/<repo>
```

[‚¨Ü Back to top](#release-scripts)

---

## CI integration expectations

A sane baseline is:

- PRs run **verify-only** (never publish):
  - Gate A‚ÄìF must pass for touched datasets/components.
- Main branch merge can build a **candidate** release bundle:
  - Still no publish unless explicitly triggered.
- Tags/releases (or an approved workflow dispatch) can publish:
  - Gate A‚ÄìG enforced; require approval if policy label is restricted.

### CI permissions posture (recommended)

- Default CI permissions: `contents:read`
- Only jobs that sign/attest should have `id-token:write`
- No long-lived secrets in CI; prefer OIDC + short-lived credentials

[‚¨Ü Back to top](#release-scripts)

---

## Rollback and revocation

Release scripts must treat rollback as a first-class path.

### Rollback (filesystem publishing)

- Remove or revert the published bundle directory.
- Restore prior ‚Äúlatest‚Äù pointer (if you maintain one).
- Record a rollback audit record with:
  - who / when / why
  - what was rolled back (dataset_version_id + digests)
  - what is now current

### Revocation (signatures / policy)

If a release is found to have:
- licensing defects,
- policy label defects,
- tampering (digest mismatch),
- or provenance gaps,

then the correct response is **revocation**, not silent replacement.

**Minimum revocation behaviors:**
- mark the version as revoked in the catalog
- keep the original artifacts for audit (do not rewrite history)
- prevent API/UI from serving it (policy deny)

[‚¨Ü Back to top](#release-scripts)

---

## Troubleshooting

### ‚ÄúGate A failed: dataset_version_id changed‚Äù
- Ensure configs/params are canonicalized before hashing.
- Verify that input file ordering is stable (sort before hashing).
- Check that timestamps are not being embedded in the spec hash.

### ‚ÄúGate B failed: license missing/unknown‚Äù
- Add license in *all* relevant surfaces:
  - DCAT dataset license/rights
  - STAC collection/item license
  - Any repository-level license metadata required by policy
- If rights remain unclear, this version must stay in quarantine.

### ‚ÄúGate D failed: cross-link not resolvable‚Äù
- Ensure DCAT links to PROV (e.g., `prov:wasGeneratedBy`).
- Ensure STAC collection links to DCAT (`rel="describedby"`).
- Ensure STAC items link to run receipts / PROV activities.

### ‚ÄúGate E failed: digests missing‚Äù
- Every output artifact needs a sha256 digest recorded in:
  - checksums file
  - run receipt outputs[]
  - catalog assets (where applicable)

### ‚ÄúGate F failed: policy tests‚Äù
- Re-run the policy tests locally (Conftest/OPA) with verbose output.
- Confirm the dataset‚Äôs `policy_label` and obligations match the intended publish surface.

[‚¨Ü Back to top](#release-scripts)

---

## Appendix: Proposed CLI contract

The following is a **recommended** stable interface so CI and developers can rely on the release tools.
If you adopt it, keep it backward compatible.

### Commands

- `kfm-release verify` ‚Äî run gates A‚ÄìF (and optionally G) for a dataset version
- `kfm-release build` ‚Äî package a release bundle (no publish)
- `kfm-release publish` ‚Äî publish a previously-built bundle to a destination
- `kfm-release attest` ‚Äî generate SBOM/attestations/signatures (optional, but recommended)
- `kfm-release doctor` ‚Äî environment check (tooling versions, required binaries)

### Common flags

- `--dataset-version <id>` (required for verify/build)
- `--out <dir>` (build output)
- `--strict` (treat warnings as failures)
- `--dry-run` (print planned actions; write nothing)
- `--json` (structured logs for CI)
- `--policy-context <file>` (optional: explicit policy inputs)

<details>
<summary>Minimal JSON shape for a release manifest (PROPOSED)</summary>

```json
{
  "release_manifest_version": "v1",
  "dataset_version_id": "kfm://dataset/@2026-02.abcd1234",
  "spec_hash": "sha256:...",
  "git_commit": "deadbeef",
  "policy_label": "public",
  "artifacts": [
    {"uri": "artifacts/events.parquet", "digest": "sha256:..."}
  ],
  "catalog": {
    "dcat": {"uri": "catalog/dcat.dataset.jsonld", "digest": "sha256:..."},
    "stac": {"uri": "catalog/stac/collection.json", "digest": "sha256:..."},
    "prov": {"uri": "catalog/prov.bundle.jsonld", "digest": "sha256:..."}
  },
  "receipts": [
    {"uri": "receipts/run_receipt.json", "digest": "sha256:..."}
  ],
  "sbom": [
    {"type": "spdx", "uri": "sbom/sbom.spdx.json", "digest": "sha256:..."}
  ],
  "created_at": "2026-02-22T00:00:00Z"
}
```

</details>

[‚¨Ü Back to top](#release-scripts)
