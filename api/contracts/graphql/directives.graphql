# üß© KFM GraphQL Directives Contract (`directives.graphql`)

![Contract-First](https://img.shields.io/badge/contract--first-‚úÖ-blue)
![Evidence-First](https://img.shields.io/badge/evidence--first-üßæ-success)
![Provenance](https://img.shields.io/badge/provenance--first-üîé-informational)
![GraphQL SDL](https://img.shields.io/badge/GraphQL-SDL-E10098)

---

## üìÅ File Location

```text
api/
‚îî‚îÄ‚îÄ contracts/
    ‚îî‚îÄ‚îÄ graphql/
        ‚îî‚îÄ‚îÄ directives.graphql
```

---

## üßæ `api/contracts/graphql/directives.graphql`

```graphql
# =============================================================================
# üß© Kansas Frontier Matrix (KFM) ‚Äî GraphQL Directives (Contract)
# =============================================================================
# This file is a *contract artifact* (GraphQL SDL).
# It defines cross-cutting schema directives used across the KFM GraphQL schema:
#   - üîê auth & RBAC
#   - üßæ provenance & evidence guardrails
#   - üïµÔ∏è audit & logging annotations
#   - üßØ redaction & data classification
#   - ‚ö° pagination, cost/complexity, rate limiting, cache hints
#   - üó∫Ô∏è spatial/time query guardrails
#
# Treat this file as stable API contract surface.
# Breaking changes require a version bump + compatibility plan.
# =============================================================================

"""
KFM role-based access control (RBAC) roles.

These are intentionally coarse-grained and align to KFM product needs:
- PUBLIC: anonymous/public viewer access to public data
- CONTRIBUTOR: can create draft content / submit contributions
- ADMIN: full administrative access
- SERVICE: non-human identities (workers, scheduled jobs, integrations)
"""
enum KfmRole {
  """Public/anonymous access (public datasets only)."""
  PUBLIC

  """Contributor access (drafts, submissions, moderated writes)."""
  CONTRIBUTOR

  """Administrative access (full control)."""
  ADMIN

  """Service identity (background workers, integrations)."""
  SERVICE
}

"""
How the `requires` list in @auth is interpreted.
"""
enum KfmAuthMode {
  """User must have *at least one* of the roles listed in `requires`."""
  ANY

  """User must have *all* roles listed in `requires` (rare)."""
  ALL
}

"""
Sensitivity classification for data and fields.

Used to label contract surfaces and enforce redaction/leakage constraints.
"""
enum KfmDataClassification {
  """Safe for public release."""
  PUBLIC

  """Visible to authenticated users (e.g., contributors) but not public."""
  INTERNAL

  """Sensitive information; restricted to elevated roles."""
  CONFIDENTIAL

  """Highly restricted; only admins/services or explicitly approved contexts."""
  RESTRICTED
}

"""
How a classified field should be redacted when viewer access is insufficient.
"""
enum KfmRedactionStrategy {
  """Remove the field entirely (typically return null)."""
  REMOVE

  """Replace the field with a mask string (e.g., ‚ñà‚ñà‚ñà‚ñà)."""
  MASK

  """Return a hash of the value (useful for deduping without exposing)."""
  HASH

  """Generalize value (e.g., reduce precision, bucketize)."""
  GENERALIZE

  """Truncate to keep only a suffix/prefix (e.g., keepLast=4)."""
  TRUNCATE
}

"""
Supported provenance systems used by KFM catalogs.
"""
enum KfmProvenanceSystem {
  """STAC (SpatioTemporal Asset Catalog) metadata references."""
  STAC

  """DCAT discovery metadata references."""
  DCAT

  """PROV lineage metadata references."""
  PROV
}

"""
Where a field/type is primarily resolved from (implementation hint).
"""
enum KfmDataSource {
  POSTGIS
  NEO4J
  STAC
  DCAT
  PROV
  OBJECT_STORAGE
  FILE
  EXTERNAL_API
  COMPUTED
}

"""
How responses should be cached (hint to clients / gateways).
"""
enum KfmCacheScope {
  PUBLIC
  PRIVATE
}

"""
Rate-limit identity scope.
"""
enum KfmRateLimitScope {
  """Per IP address."""
  IP

  """Per authenticated user."""
  USER

  """Per API key / client credential."""
  API_KEY
}

"""
Pagination strategy expected for list-like fields.
"""
enum KfmPaginationStrategy {
  """Cursor-based pagination (preferred)."""
  CURSOR

  """Offset/limit pagination (allowed for certain datasets)."""
  OFFSET
}

"""
Feature lifecycle stages for schema elements.
"""
enum KfmFeatureStage {
  EXPERIMENTAL
  BETA
  GA
  DEPRECATED
}

"""
PII kinds for labeling and downstream policy enforcement.
"""
enum KfmPiiKind {
  GENERIC
  NAME
  EMAIL
  PHONE
  ADDRESS
  DOB
  GOVERNMENT_ID
  BIOMETRIC
  LOCATION_PRECISE
}

"""
Reference to an evidence/provenance record.
Intended to point at STAC/DCAT/PROV identifiers or resolvable URIs.
"""
input KfmEvidenceRef {
  """Which provenance system this reference belongs to."""
  system: KfmProvenanceSystem!

  """Opaque identifier in that system (e.g., STAC item id, PROV entity id)."""
  id: String!

  """Optional resolvable URI (if available)."""
  uri: String

  """Optional content hash for immutability checks (e.g., sha256:...)."""
  hash: String

  """Optional human-readable label."""
  label: String
}

# -----------------------------------------------------------------------------
# üîê AUTH / RBAC
# -----------------------------------------------------------------------------

"""
RBAC / scope gate for schema objects & fields.

Usage:
- On a type:
  type DraftStory @auth(requires: [CONTRIBUTOR]) { ... }
- On a field:
  notes: String @auth(requires: [ADMIN])

Semantics are enforced by the server at runtime.
"""
directive @auth(
  """Roles permitted to access this element."""
  requires: [KfmRole!] = [PUBLIC]

  """How `requires` is evaluated (ANY vs ALL)."""
  mode: KfmAuthMode = ANY

  """
  Optional OAuth2 scopes/permissions (stringly-typed to keep the contract flexible).
  Example: ["story:write", "dataset:publish"]
  """
  scopes: [String!]

  """Why this restriction exists (helps governance/audits)."""
  reason: String
) on OBJECT | INTERFACE | FIELD_DEFINITION | INPUT_FIELD_DEFINITION

"""
Marks a schema element as internal-only.

Server implementations MAY omit internal elements from the published schema or
deny them for non-internal callers.
"""
directive @internal(
  reason: String
) on FIELD_DEFINITION
 | OBJECT
 | INTERFACE
 | UNION
 | ENUM
 | ENUM_VALUE
 | INPUT_OBJECT
 | INPUT_FIELD_DEFINITION

# -----------------------------------------------------------------------------
# üßØ CLASSIFICATION / REDACTION / PRIVACY
# -----------------------------------------------------------------------------

"""
Classify a type/field by sensitivity.

This is used to drive policy, redaction, and UI "no leakage" guarantees.
"""
directive @classify(
  level: KfmDataClassification!
  reason: String
) on OBJECT | INTERFACE | FIELD_DEFINITION | INPUT_FIELD_DEFINITION

"""
Redaction policy for a field when viewer access is insufficient.

Notes:
- Combine with @classify for explicit classification labels.
- `toRoles` indicates who can see the unredacted value.
"""
directive @redact(
  strategy: KfmRedactionStrategy = REMOVE

  """Mask character/string if strategy=MASK (default uses ‚ñà)."""
  maskWith: String = "‚ñà"

  """If strategy=TRUNCATE, keep only the last N characters."""
  keepLast: Int

  """Roles allowed to see the unredacted value."""
  toRoles: [KfmRole!] = [ADMIN]

  reason: String
) on FIELD_DEFINITION

"""
Labels a field as containing personally identifiable information (PII).
Used for audits and stricter redaction defaults.
"""
directive @pii(
  kind: KfmPiiKind = GENERIC
  reason: String
) on FIELD_DEFINITION | INPUT_FIELD_DEFINITION

# -----------------------------------------------------------------------------
# üßæ PROVENANCE / EVIDENCE / AI-GOVERNANCE
# -----------------------------------------------------------------------------

"""
Marks a type/field as provenance-backed.

When `required=true`, the server SHOULD ensure a resolvable provenance trail
exists (STAC/DCAT/PROV) for returned values.
"""
directive @provenance(
  required: Boolean = true
  systems: [KfmProvenanceSystem!] = [STAC, DCAT, PROV]

  """Minimum provenance/evidence references expected (implementation-enforced)."""
  minRefs: Int = 1

  """Implementation hint (e.g., which field carries the refs)."""
  hint: String
) on OBJECT | INTERFACE | FIELD_DEFINITION

"""
Requires evidence references for a given field (evidence-first guardrail).

This is useful for narrative/claim-like fields where provenance must exist,
and for AI-assisted surfaces that must be evidence-constrained.
"""
directive @requiresEvidence(
  """Minimum evidence references expected (implementation-enforced)."""
  min: Int = 1

  """Restrict to specific provenance systems if desired."""
  systems: [KfmProvenanceSystem!]

  reason: String
) on FIELD_DEFINITION

"""
Marks a field/type as AI-generated or AI-assisted output.

Clients SHOULD display a disclosure and SHOULD surface linked evidence when
`requiresEvidence=true`.
"""
directive @aiGenerated(
  """Optional model identifier (e.g., 'gpt-5', 'local-llm:v3')."""
  model: String

  """If true, this field MUST be constrained by evidence links."""
  requiresEvidence: Boolean = true

  """Optional UI disclosure text override."""
  disclaimer: String
) on OBJECT | FIELD_DEFINITION

"""
Attach static evidence/provenance references directly to schema elements.
Useful for documenting methodology/algorithms used to compute a field.
"""
directive @evidence(
  refs: [KfmEvidenceRef!]!
  note: String
) repeatable on FIELD_DEFINITION | OBJECT | INTERFACE

"""
Attach scholarly or external citations to schema elements (repeatable).
"""
enum KfmCitationSystem {
  DOI
  URL
  BIBTEX
  WIKIDATA
  OTHER
}

directive @cite(
  system: KfmCitationSystem = URL
  value: String!
  label: String
) repeatable on FIELD_DEFINITION
 | OBJECT
 | INTERFACE
 | ENUM
 | ENUM_VALUE

# -----------------------------------------------------------------------------
# ‚ö° PERFORMANCE / SAFETY (PAGINATION, COST, RATE LIMIT, CACHE)
# -----------------------------------------------------------------------------

"""
Indicates a list-like field must be paginated and provides contract defaults.

Server SHOULD enforce maxLimit; clients SHOULD use pagination args accordingly.
"""
directive @paginate(
  strategy: KfmPaginationStrategy = CURSOR
  defaultLimit: Int = 50
  maxLimit: Int = 500
  reason: String
) on FIELD_DEFINITION

"""
Query cost annotation for complexity analysis.

- `value` is the base cost of resolving this field.
- `multipliers` are argument names that multiply the cost (e.g., ["limit"]).
"""
directive @cost(
  value: Int!
  multipliers: [String!]
  rationale: String
) on FIELD_DEFINITION

"""
Rate limiting for potentially expensive fields/resolvers.
"""
directive @rateLimit(
  max: Int!
  windowSeconds: Int = 60
  scope: KfmRateLimitScope = IP
  reason: String
) on FIELD_DEFINITION

"""
Cache hint for responses (client/gateway hint; server may also honor).

- `maxAge` is in seconds.
- `staleWhileRevalidate` is in seconds (optional).
"""
directive @cacheControl(
  maxAge: Int
  scope: KfmCacheScope = PUBLIC
  staleWhileRevalidate: Int
  reason: String
) on FIELD_DEFINITION | OBJECT | INTERFACE | UNION

"""
Sets a maximum depth for incoming queries (schema-level guardrail).
"""
directive @depthLimit(
  max: Int!
) on SCHEMA

# -----------------------------------------------------------------------------
# üïµÔ∏è AUDIT / OBSERVABILITY
# -----------------------------------------------------------------------------

"""
Marks a schema element for audit logging.

Typical usage:
- Mutations: @audit(event: "story.create")
- Sensitive reads: @audit(event: "dataset.download", pii: true)
"""
directive @audit(
  event: String
  pii: Boolean = false
  classification: KfmDataClassification = PUBLIC
) on FIELD_DEFINITION | OBJECT | INTERFACE | SCHEMA

# -----------------------------------------------------------------------------
# üö© FEATURE FLAGS / LIFECYCLE / VERSIONING
# -----------------------------------------------------------------------------

"""
Feature flag gate for schema elements.
Server may deny access unless feature is enabled for the caller/environment.
"""
directive @featureFlag(
  name: String!
  stage: KfmFeatureStage = BETA
  reason: String
) on FIELD_DEFINITION | OBJECT | INTERFACE | INPUT_OBJECT | INPUT_FIELD_DEFINITION

"""
Introduced-in version marker for schema elements (contract documentation).
"""
directive @since(
  version: String!
  note: String
) on FIELD_DEFINITION
 | OBJECT
 | INTERFACE
 | UNION
 | ENUM
 | ENUM_VALUE
 | INPUT_OBJECT
 | INPUT_FIELD_DEFINITION

# -----------------------------------------------------------------------------
# ‚úÖ INPUT VALIDATION / GEO + TIME GUARDRAILS
# -----------------------------------------------------------------------------

"""
General-purpose input validation constraints (schema-driven validation).

This directive mirrors common constraint patterns used by GraphQL servers.
"""
directive @constraint(
  min: Float
  max: Float
  exclusiveMin: Float
  exclusiveMax: Float
  multipleOf: Float
  minLength: Int
  maxLength: Int
  pattern: String
  format: String
) on ARGUMENT_DEFINITION | INPUT_FIELD_DEFINITION

"""
Bounding-box guardrail for geo queries (implementation-enforced).

Useful when a query accepts bbox-like inputs and needs hard limits.
"""
directive @bboxLimit(
  """Maximum bbox area in square kilometers (approx)."""
  maxAreaSqKm: Float

  """Maximum span in degrees (approx) for either axis."""
  maxSpanDegrees: Float

  reason: String
) on ARGUMENT_DEFINITION | INPUT_FIELD_DEFINITION

"""
Time-range guardrail for time-windowed queries (implementation-enforced).
"""
directive @timeRangeLimit(
  """Maximum allowed duration in days."""
  maxDays: Int

  """Maximum allowed duration in years (alternative to maxDays)."""
  maxYears: Int

  reason: String
) on ARGUMENT_DEFINITION | INPUT_FIELD_DEFINITION

"""
Marks a field as geometry-bearing and documents expected encoding.
"""
enum KfmGeometryFormat {
  GEOJSON
  WKT
  WKB
}

directive @geometry(
  format: KfmGeometryFormat = GEOJSON
  srid: Int = 4326
  reason: String
) on FIELD_DEFINITION | INPUT_FIELD_DEFINITION

# -----------------------------------------------------------------------------
# üîå IMPLEMENTATION HINTS (RESOLVER SOURCES, LICENSING, TAGS)
# -----------------------------------------------------------------------------

"""
Indicates where this element is resolved from (internal contract hint).
"""
directive @source(
  system: KfmDataSource!
  reference: String
  notes: String
) on FIELD_DEFINITION | OBJECT | INTERFACE

"""
Attach licensing/attribution hints to schema elements.
(Actual license truth should come from STAC/DCAT metadata; this is a contract hint.)
"""
directive @license(
  """SPDX identifier if available (e.g., 'CC-BY-4.0')."""
  spdx: String

  """Optional license URL (string only; do not assume resolvable)."""
  url: String

  """Attribution requirements summary."""
  attribution: String
) on OBJECT | FIELD_DEFINITION

"""
Tag schema elements for documentation, grouping, or governance routing.
"""
directive @tag(
  name: String!
) repeatable on FIELD_DEFINITION
 | OBJECT
 | INTERFACE
 | UNION
 | ENUM
 | ENUM_VALUE
 | INPUT_OBJECT
 | INPUT_FIELD_DEFINITION
```

---

## ‚úÖ Quick Usage Examples (Optional)

```graphql
type StoryNode
  @auth(requires: [PUBLIC])
  @provenance(required: true, systems: [STAC, DCAT, PROV], minRefs: 1)
{
  id: ID!

  title: String!

  bodyMarkdown: String
    @requiresEvidence(min: 1, reason: "Story Nodes must be provenance-linked.")

  aiSummary: String
    @aiGenerated(model: "gpt-5", requiresEvidence: true)
    @requiresEvidence(min: 1)

  internalNotes: String
    @auth(requires: [CONTRIBUTOR])
    @classify(level: INTERNAL)
    @redact(strategy: REMOVE, toRoles: [CONTRIBUTOR, ADMIN])
}
```

---
