# ğŸ§¬ PROV Catalog Adapter (Outbound)  
_ğŸ“ Path: `api/src/adapters/outbound/catalogs/prov/`_

![Adapter](https://img.shields.io/badge/adapter-outbound-blue)
![Catalog](https://img.shields.io/badge/catalog-PROV%20(JSON--LD)-informational)
![Standard](https://img.shields.io/badge/standard-W3C%20PROV--O%20%2F%20PROV--JSON--LD-orange)
![KFM](https://img.shields.io/badge/KFM-evidence--first-6f42c1)

> âœ… **Purpose:** Generate, validate, and publish **W3C PROV** **JSON-LD** bundles that explain _exactly_ how KFM datasets & evidence artifacts were produced (inputs â†’ processing steps â†’ outputs + agents).  
> ğŸ§  **Why it matters:** PROV is a **hard gate** for publishing, graph ingestion, UI provenance panels, and Focus Mode citations.

---

## ğŸ§­ Quick Navigation
- [What this adapter does](#-what-this-adapter-does)
- [Where PROV lives](#-where-prov-lives)
- [Data model](#-data-model)
- [Cross-catalog linking](#-cross-catalog-linking)
- [Validation & policy gates](#-validation--policy-gates)
- [Integration points](#-integration-points)
- [Testing](#-testing)
- [Roadmap](#-roadmap)
- [Project docs this adapter aligns with](#-project-docs-this-adapter-aligns-with)

---

## ğŸ§© What this adapter does

### âœ… Responsibilities
This adapter is the **outbound** implementation for KFMâ€™s **provenance catalog** boundary:

- ğŸ§¾ **Build a PROV bundle** (JSON-LD) from:
  - ğŸ§± **Entities**: raw inputs, intermediate artifacts, processed outputs
  - âš™ï¸ **Activities**: pipeline runs, transformations, validations, model runs
  - ğŸ§‘â€ğŸ¤â€ğŸ§‘ **Agents**: humans, CI, software pipelines, AI systems (where applicable)
- ğŸ—‚ï¸ **Write bundles** to the canonical PROV output location (see below)
- ğŸ§ª **Validate** output against the **KFM-PROV profile** and schema checks
- ğŸ”— **Enable cross-references** from STAC/DCAT â†’ PROV and PROV â†’ artifacts

### ğŸš« Non-goals
- âŒ Does **not** run ETL itself (thatâ€™s `src/pipelines/`)
- âŒ Does **not** load into Neo4j directly (thatâ€™s `src/graph/`)
- âŒ Does **not** â€œfixâ€ data (PROV must *describe* changes, not silently correct them)
- âŒ Does **not** bypass API governance for restricted artifacts

---

## ğŸ§¬ Where PROV lives

KFM treats STAC/DCAT/PROV as **boundary artifacts** (publishable interfaces to downstream stages).

### ğŸ“¦ Canonical output directory
- ğŸ“ `data/prov/` â€” PROV bundles (per dataset and/or per run)

> Tip: If you see `data/provenance/` referenced in older notes, treat `data/prov/` as canonical unless repo policy says otherwise.

### ğŸ·ï¸ Recommended naming conventions (adapter contract)
Pick **one** strategy and keep it consistent across domains:

#### Option A â€” dataset-stable (simple)
- `data/prov/{dataset_id}.jsonld`

Pros: clean, Git history provides evolution  
Cons: harder to represent multiple parallel runs

#### Option B â€” dataset + run (preferred for auditability)
- `data/prov/{dataset_id}/{run_id}.jsonld`

Pros: append-only friendly, supports multiple runs  
Cons: more files

âœ… **This adapter should support both** via configuration (see [Configuration](#-configuration)).

---

## ğŸ—ºï¸ Pipeline placement (why this sits in outbound)

```mermaid
flowchart LR
  Raw["ğŸ“¥ data/raw/** (immutable evidence)"] --> ETL["âš™ï¸ src/pipelines/**"]
  ETL --> Processed["ğŸ“¦ data/processed/**"]
  Processed --> Catalogs["ğŸ—‚ï¸ Catalog outputs<br/>data/stac + data/catalog/dcat + data/prov"]
  Catalogs --> Graph["ğŸ•¸ï¸ src/graph/** (Neo4j ingest/build)"]
  Graph --> API["ğŸ§© src/server/** (FastAPI + GraphQL boundary)"]
  API --> UI["ğŸ—ºï¸ web/** (React + MapLibre/Cesium)"]
  UI --> Story["ğŸ“– Story Nodes + ğŸ¯ Focus Mode"]
```

---

## ğŸ§¾ Data model

KFM uses PROV to answer: **â€œHow did we get here?â€**

### ğŸ§± Entities (`prov:Entity`)
Represent â€œthingsâ€:
- ğŸ“„ Raw files (e.g., source CSVs, imagery, scanned documents)
- ğŸ§ª Intermediate products (work outputs)
- ğŸ“¦ Processed artifacts (final outputs users download/use)
- ğŸ”§ Code/config snapshots (recommended)
- ğŸ§  Model artifacts (if AI produced output)

### âš™ï¸ Activities (`prov:Activity`)
Represent â€œwork performedâ€:
- ğŸ§° Ingest job runs
- ğŸ—ºï¸ Geospatial transforms (reproject, clip, dissolve, rasterize, etc.)
- ğŸ“Š Analytic workflows (aggregation, classification, inference)
- ğŸ¤– AI model runs (prompt â†’ output, or training â†’ model)

### ğŸ§‘â€ğŸ¤â€ğŸ§‘ Agents (`prov:Agent`)
Represent â€œwho/what did itâ€:
- ğŸ‘©â€ğŸ’» Human contributor(s)
- ğŸ¤– CI bot / automation actor
- ğŸ§© Pipeline software agent (versioned)
- ğŸ§  AI system agent (model/version identified)

### ğŸ”— Core relations you should expect
- `prov:used` â€” activity consumed entity
- `prov:wasGeneratedBy` â€” entity generated by activity
- `prov:wasDerivedFrom` â€” entity derived from another entity
- `prov:wasAssociatedWith` â€” activity associated with agent

---

## ğŸ§ª Minimal PROV JSON-LD example

> This is intentionally small; real KFM bundles should include IDs/URIs, checksums, config + commit hash, and cross-links.

```json
{
  "@context": [
    "https://www.w3.org/ns/prov.jsonld",
    { "kfm": "https://kansas-frontier-matrix.org/ns#" }
  ],
  "@type": "prov:Bundle",

  "entity": {
    "kfm:raw/usgs_nlcd_2020.tif": {
      "prov:type": "prov:Entity",
      "prov:label": "USGS NLCD 2020 (raw)",
      "kfm:sha256": "â€¦"
    },
    "kfm:processed/landcover/ks_landcover_2020.tif": {
      "prov:type": "prov:Entity",
      "prov:label": "Kansas Landcover 2020 (processed)",
      "kfm:dataset_id": "kfm.ks.landcover.2020",
      "kfm:sha256": "â€¦"
    }
  },

  "activity": {
    "kfm:run/4b7b0d6d-2f5e-4c05-9b9a-2b0e5b9b5b2a": {
      "prov:type": "prov:Activity",
      "prov:label": "Landcover pipeline run",
      "prov:startedAtTime": "2025-01-01T10:00:00Z",
      "prov:endedAtTime": "2025-01-01T10:05:00Z",
      "kfm:pipeline": "src/pipelines/landcover",
      "kfm:commit": "â€¦"
    }
  },

  "agent": {
    "kfm:agent/ci": {
      "prov:type": "prov:SoftwareAgent",
      "prov:label": "KFM CI"
    }
  },

  "used": {
    "_:u1": {
      "prov:activity": "kfm:run/4b7b0d6d-2f5e-4c05-9b9a-2b0e5b9b5b2a",
      "prov:entity": "kfm:raw/usgs_nlcd_2020.tif",
      "prov:role": "input"
    }
  },

  "wasGeneratedBy": {
    "_:g1": {
      "prov:entity": "kfm:processed/landcover/ks_landcover_2020.tif",
      "prov:activity": "kfm:run/4b7b0d6d-2f5e-4c05-9b9a-2b0e5b9b5b2a"
    }
  },

  "wasAssociatedWith": {
    "_:a1": {
      "prov:activity": "kfm:run/4b7b0d6d-2f5e-4c05-9b9a-2b0e5b9b5b2a",
      "prov:agent": "kfm:agent/ci"
    }
  }
}
```

---

## ğŸ”— Cross-catalog linking

KFM does **not** treat STAC, DCAT, and PROV as separate worlds. They must reference each other.

### STAC â†’ PROV
Recommended patterns:
- Add a property that identifies:
  - the **PROV Activity ID** that produced an asset, **or**
  - the **run_id / bundle_id** used to locate the PROV bundle

### DCAT â†’ STAC + PROV
Recommended patterns:
- Include `dcat:distribution` (or equivalent) links that point to:
  - STAC Collection URL (discovery/geo asset detail)
  - PROV bundle URL (lineage/audit trail)

### PROV â†’ data/processed/**
PROV should include:
- Stable references to output artifacts (paths and/or URLs)
- Checksums for **raw inputs** and **processed outputs** (at minimum)

---

## ğŸ›¡ï¸ Validation & policy gates

KFM treats metadata like code: it is validated and enforced.

### âœ… Schema validation
- PROV bundles must conform to:
  - `docs/standards/KFM_PROV_PROFILE.md` (profile expectations)
  - `schemas/` validation rules (JSON Schema and/or SHACL depending on implementation)

### âœ… Policy Pack (OPA/Conftest) expectations
Typical rules enforced by CI include:
- ğŸ§¬ **Provenance-first publishing:** new/changed processed artifacts must have PROV
- ğŸ§¾ **No orphan data:** processed files must also have STAC + DCAT + PROV
- ğŸ§± **Pipeline ordering:** catalogs must exist before graph ingestion + UI exposure

#### Common failure mode to document in PR reviews
- `KFM-PROV-001` â€” processed artifact changed without corresponding provenance update

---

## ğŸ”Œ Integration points

### ğŸ•¸ï¸ Graph ingestion (Neo4j)
PROV is ingested to create:
- activity/run nodes
- lineage edges between datasets/assets
- queryable â€œhow producedâ€ paths

This is what makes questions like â€œwhat stories used this dataset?â€ or â€œwhich pipeline run created this map layer?â€ actually answerable.

### ğŸ—ºï¸ UI (Provenance panels)
The UI expects that layers/nodes can surface:
- source attribution
- license + usage constraints
- lineage chain (where it came from + how it was transformed)

### ğŸ¯ Focus Mode (citations + traceability)
Focus Mode outputs are expected to be **evidence-backed**:
- every claim should map to a dataset/document/entity
- provenance can drive â€œView Evidenceâ€ experiences and machine-checkable audit trails

---

## âš™ï¸ Configuration

> These are **recommended adapter configuration keys**. If your repo already has a config system, map these to it.

| Key | Example | Notes |
|---|---:|---|
| `KFM_DATA_ROOT` | `./data` | Root for data tree |
| `KFM_PROV_DIR` | `data/prov` | Default PROV output |
| `KFM_BASE_URI` | `https://kansas-frontier-matrix.org/id/` | Used to mint stable IDs |
| `KFM_PROV_NAMING` | `dataset` \| `dataset_run` | Select naming strategy |
| `KFM_PROFILE_PROV_VERSION` | `11.0.0` | Profile version used for validation |

---

## ğŸ§ª Testing

### Unit tests (recommended)
- âœ… bundle is valid JSON-LD
- âœ… required relationships exist (`used`, `wasGeneratedBy`, `wasAssociatedWith`)
- âœ… stable IDs are deterministic for the same inputs (no random ordering)
- âœ… checksums are present for raw + processed entities

### Suggested commands
```bash
pytest -k prov
```

---

## ğŸ§¯ Troubleshooting

### â€œPolicy Pack failed: missing PROV for processed outputâ€
Checklist:
- [ ] A PROV bundle exists for the dataset/run
- [ ] PROV bundle references the processed artifact path/URI
- [ ] Checksums updated (if file bytes changed)
- [ ] STAC/DCAT cross-links updated (if you renamed IDs or paths)

### â€œGraph ingest missing activity nodesâ€
Checklist:
- [ ] PROV uses expected keys (`entity`, `activity`, relations)
- [ ] IDs are resolvable/stable (avoid ephemeral local-only IDs)
- [ ] Bundle path matches what graph importer expects

---

## ğŸ§  Roadmap (near + future)

> These are **aligned extensions** from KFMâ€™s broader directionâ€”capture more provenance, not more complexity.

- ğŸ” **PR â†’ PROV graph integration:** model PRs/commits/reviewers as PROV Activities/Entities/Agents  
- ğŸ§¾ **Rollback + provenance repair runbooks:** record retractions/repairs without erasing lineage  
- ğŸ” **Supply-chain signing:** sign artifacts + attach PROV as attestations/referrers (OCI + cosign/oras patterns)  
- ğŸ§© **Story Node evidence manifests:** store structured citations and connect them to PROV edges  
- ğŸ§  **AI evidence artifacts:** treat AI outputs as first-class datasets with PROV (model/version/params + confidence)  
- ğŸ—ºï¸ **Geospatial transform tracing:** include CRS changes, projection steps, and spatial QC as explicit activities  
- ğŸ§‘â€âš–ï¸ **CARE + sovereignty controls:** encode restrictions/ethics signals so downstream UI/API can enforce them

---

## ğŸ“š Project docs this adapter aligns with

> ğŸ§· Keep these as the â€œnorth starâ€ when adjusting fields, validation rules, or output layout.

### Core KFM docs
- ğŸ“š **Data Intake â€“ Technical & Design Guide** (STAC/DCAT/PROV triplet, evidence-first intake)
- ğŸ§­ **AI System Overview** (provenance-backed AI + citations)
- ğŸ—ºï¸ **UI System Overview** (provenance surfaced in UI layers/panels)
- ğŸ›ï¸ **Comprehensive Architecture / Technical Docs** (contract-first, policy gates, governance)
- ğŸ’¡ **Innovative Concepts / Future Proposals** (PRâ†’PROV, policy pack, rollback + provenance repair)
- ğŸ§ª **Additional Project Ideas** (story evidence manifests, OCI artifacts + provenance attachments)

### ğŸ“¦ Reference libraries (PDF portfolios in this project)
- ğŸ¤– **AI Concepts & more** (ML foundations + model practices)
- ğŸŒ **Maps / WebGL / GIS** (3D/4D geospatial rendering + projection literacy)
- ğŸ§° **Programming resources** (implementation patterns across stacks)
- ğŸ—ƒï¸ **Data management portfolio** (data architecture, lineage, reproducibility)

---

## âœ… Definition of Done (PR checklist)
- [ ] PROV bundle added/updated in `data/prov/`
- [ ] STAC + DCAT updated to reference PROV (and vice versa if required)
- [ ] Checksums updated for inputs/outputs
- [ ] Schema/profile validation passes
- [ ] Policy Pack passes (no orphan processed artifacts)
- [ ] (If applicable) graph ingest validates lineage paths
- [ ] (If applicable) UI provenance panel renders expected lineage

---

### ğŸ”— External standards (for implementers)
- W3C PROV-O: `https://www.w3.org/TR/prov-o/`
- PROV-JSON / PROV-JSON-LD context: `https://www.w3.org/ns/prov.jsonld`

