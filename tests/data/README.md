# ğŸ§ªğŸ“¦ Test Data Fixtures (`tests/data/`)

![fixtures](https://img.shields.io/badge/fixtures-deterministic-brightgreen)
![gates](https://img.shields.io/badge/gates-fail--closed-red)
![metadata](https://img.shields.io/badge/metadata-STAC%20%2B%20DCAT%20%2B%20PROV-6f42c1)

Deterministic, license-safe, provenance-aware fixtures used by **unit**, **contract**, **pipeline**, and **governance** tests.  
This directory is intentionally small and boring â€” it exists to keep CI fast and results reproducible âœ…

---

## ğŸ¯ What belongs here

- âœ… **Tiny â€œgoldenâ€ inputs** that exercise edge cases (nulls, invalid geometry, duplicates, encoding issues, time ranges, etc.)
- âœ… **Expected outputs** for pipeline regression tests (a.k.a. â€œgoldensâ€)
- âœ… **Minimal metadata artifacts** (STAC / DCAT / PROV) to prove the **Truth Path** contract works end-to-end
- âœ… **Policy fixtures** (e.g., sensitivity tags, missing license cases) to ensure governance gates **fail closed**
- âœ… **Snapshot payloads** for API contract tests (small JSON responses only)

---

## ğŸš« What does *not* belong here

- âŒ **PII / personal data**, even if â€œpublicâ€
- âŒ **Secrets**, API keys, tokens, `.env` content
- âŒ **Unlicensed or unclear-license data** (tests should reject it, not normalize it)
- âŒ Large binaries (rasters, point clouds, MBTiles, etc.) unless theyâ€™re *tiny* and essential  
  *(If itâ€™s big, treat it as external integration data â€” not a repo fixture.)*

> [!IMPORTANT]
> If you canâ€™t answer: **â€œWhere did this file come from, under what license, and what is its sensitivity?â€**  
> it doesnâ€™t belong in `tests/data/`.

---

## ğŸ§­ Mini â€œTruth Pathâ€ (how fixtures should think)

Even in tests, we mirror the projectâ€™s canonical flow:

```text
Raw âœ Processed âœ Catalog/PROV âœ (DB) âœ API âœ UI/AI
```

### ğŸ§© Why this matters
Tests are governance infrastructure. Fixtures should make it easy to verify:
- provenance exists,
- licensing exists,
- sensitivity exists,
- policy gates run,
- and outputs stay deterministic.

---

## ğŸ—‚ï¸ Recommended layout

This folder may evolve, but keep changes predictable and documented. A suggested structure:

```text
tests/data/
â”œâ”€ README.md                          # you are here ğŸ™‚
â”œâ”€ manifests/
â”‚  â”œâ”€ fixtures.manifest.yaml          # âœ… checksums + provenance pointers
â”‚  â””â”€ fixtures.manifest.schema.json   # optional: schema for the manifest
â”œâ”€ raw/                               # ğŸ“¥ miniature â€œingestâ€ inputs
â”‚  â””â”€ <domain>/
â”œâ”€ processed/                          # ğŸ§¼ expected standardized outputs
â”‚  â””â”€ <domain>/
â”œâ”€ catalog/                             # ğŸ—ºï¸ STAC/DCAT test artifacts
â”‚  â”œâ”€ stac/
â”‚  â””â”€ dcat/
â”œâ”€ provenance/                          # ğŸ§¾ W3C PROV fixtures (lineage)
â”‚  â””â”€ runs/
â”œâ”€ policies/                            # ğŸ›¡ï¸ policy test fixtures (roles/tags)
â”‚  â””â”€ <scenario>/
â””â”€ api/                                 # ğŸ”Œ contract test snapshots (small JSON)
   â””â”€ v1/
```

> [!NOTE]
> If your tests donâ€™t need a subfolder, donâ€™t invent one. If you *add* one, update this README and the manifest.

---

## ğŸ·ï¸ Naming conventions (boring on purpose)

Use stable, greppable names:

```text
<domain>__<scenario>__v<major>.<minor>.<patch>.<ext>

Examples:
hydrology__missing_license__v1.0.0.json
railroads__invalid_geometry__v1.1.0.geojson
counties__time_window_edge__v2.0.0.parquet
```

**Rules**
- âœ… lowercase
- âœ… `__` between â€œmeaningful segmentsâ€
- âœ… version bumps when meaning changes (not when regenerated byte-for-byte)

---

## ğŸ“‘ Fixture manifest (required for anything non-trivial)

For any fixture that matters (pipeline tests, governance tests, contract snapshots), add an entry to:

ğŸ“„ `tests/data/manifests/fixtures.manifest.yaml`

### âœ… Manifest goals
- **provenance pointers**
- **license & source clarity**
- **sensitivity tags**
- **checksums** for deterministic regression

### âœï¸ Suggested manifest entry (template)

```yaml
- id: hydrology__missing_license__v1.0.0
  purpose: "Ensure ingestion gate fails when license is absent."
  classification: public
  license: "UNKNOWN"           # tests should expect failure
  source:
    kind: "synthetic"
    citation: "generated in-repo for policy test"
  inputs:
    - path: raw/hydrology/hydrology__missing_license__v1.0.0.json
      sha256: "<fill-me>"
  expected:
    outcome: "deny"            # allow | deny | redact | warn
    policy: "data_policies"
```

> [!TIP]
> A manifest is a test helper *and* a governance artifact. It should be easy to diff in PRs.

---

## ğŸ§± Formats: keep diffs readable

Prefer **diff-friendly** formats:

âœ… Good:
- `.json`, `.geojson`, `.yaml`, `.csv`
- `.parquet` *(only if tests truly need it)*

âš ï¸ Use sparingly:
- `.gpkg`, `.tif`, `.mbtiles`, `.pbf` *(only if minimal + essential)*

âŒ Avoid in fixtures:
- shapefiles (multi-file, fragile diffs)
- vendor exports with unstable ordering

---

## ğŸ”’ Sensitivity & governance test scenarios

This folder should include *some* fixtures designed to test enforcement:

- `classification: public | internal | confidential | restricted` (or your projectâ€™s equivalent)
- missing `license`
- missing `source`
- missing `provenance`
- restricted dataset that should be denied/redacted for non-privileged roles

> [!IMPORTANT]
> If you add a restricted/sensitive fixture, it must be **synthetic** unless explicitly approved, and it should never contain real sensitive coordinates or identities.

---

## ğŸ§ª How to add a new fixture (checklist)

When adding data under `tests/data/`:

- [ ] Keep it **tiny** (optimize for CI speed)
- [ ] Make it **deterministic** (stable ordering, stable rounding)
- [ ] Add/update `fixtures.manifest.yaml` with:
  - [ ] `license`
  - [ ] `classification`
  - [ ] `source.citation`
  - [ ] `sha256`
- [ ] Add/adjust tests to reference the manifest **instead of hardcoding paths**
- [ ] If changing a golden output:
  - [ ] bump version in filename
  - [ ] explain â€œwhyâ€ in PR description
- [ ] Run the full test suite locally before pushing âœ…

---

## ğŸ” Regenerating â€œgoldensâ€ safely

If a fixture output is generated (not hand-authored):
1. regenerate using the pipeline/tooling
2. update checksum(s) in the manifest
3. confirm the change is intended (review the diff!)
4. bump the fixture version if semantics changed

> [!CAUTION]
> Never â€œregenerate until tests pass.â€  
> If tests fail: either the code regressed (fix code) **or** the expected output legitimately changed (bump fixture version + explain).

---

## ğŸ§­ Quick links (repo-relative)

- ğŸ  Project overview: `../../README.md`
- ğŸ¤ Contribution rules: `../../CONTRIBUTING.md`
- ğŸ“¦ Primary data truth-path: `../../data/`
- ğŸ§° Validators & helpers: `../../tools/`
- ğŸ§ª Tests: `../`

---

## ğŸ™‹ FAQ

### â€œWhy do we need metadata in *tests*?â€
Because governance is part of correctness. If â€œmissing metadata blocks the operationâ€ is a contract, tests should assert it.

### â€œWhere do big integration datasets go?â€
Not here. Use a dedicated integration-data mechanism (artifact store, LFS, or CI download step) and keep this folder repo-native and small.

### â€œCan I add real-world data if itâ€™s public?â€
Only if the license is explicit, sensitivity is appropriate, and the fixture is minimized to the smallest usable subset. Prefer synthetic whenever possible.

---