%%---
%% title: "ETL Pipeline — Ingest, Normalize, Validate, Enrich, Publish, Archive"
%% version: "v2.1.1"
%% author: "@kfm-architecture"
%% description: "Standard KFM ETL pipeline with FAIR+CARE validation, STAC and DCAT registration, and provenance governance."
%% license: "CC-BY 4.0"
%% source: "docs/architecture/diagrams/templates/etl_pipeline.mmd"
%%---

flowchart TD

  %% Subgraphs for clarity
  subgraph SRC["Data Sources"]
    S1["NOAA · USGS · FEMA · KGS"]
    S2["Archives · Documents · Maps"]
    S3["APIs · Files · Web Services"]
  end

  subgraph ING["Ingestion"]
    I1["Fetch Data"]
    I2["Record Metadata"]
    I3["Generate Checksums"]
  end

  subgraph NORM["Standardization"]
    N1["Reproject to EPSG 4326"]
    N2["Normalize Schemas"]
    N3["Clean and De duplicate"]
  end

  subgraph VAL["Validation"]
    V1["Schema Validation"]
    V2["STAC Conformance"]
    V3["FAIR and CARE Review"]
  end

  subgraph ENR["Enrichment"]
    E1["Geocoding and NER"]
    E2["Joins and Indices"]
    E3["Derivatives and Summaries"]
  end

  subgraph PUB["Publication"]
    P1["Create STAC Item and Collection"]
    P2["Export DCAT JSON LD"]
    P3["Update Catalog Index"]
  end

  subgraph ARC["Archival and Governance"]
    A1["Write to Archive"]
    A2["Update Provenance Ledger"]
    A3["Release Manifest and SBOM"]
  end

  %% Main flow
  S1 --> I1
  S2 --> I1
  S3 --> I1
  I1 --> I2 --> I3 --> N1
  N1 --> N2 --> N3 --> V1
  V1 --> V2 --> V3 --> E1
  E1 --> E2 --> E3 --> P1
  P1 --> P2 --> P3 --> A1
  A1 --> A2 --> A3

  %% Cross links to artifacts
  I2 -. "metadata.json" .-> V1
  I3 -. "sha256" .-> A3
  V2 -. "stac_validation_report.json" .-> A2
  V3 -. "data_fair_summary.json" .-> A2
  P2 -. "dcat.jsonld" .-> A2

  %% Styling
  classDef stage fill:#eef7ff,stroke:#2a7fff,stroke-width:1px,color:#0b2e6b;
  class SRC,ING,NORM,VAL,ENR,PUB,ARC stage;

<!-- END OF MERMAID -->