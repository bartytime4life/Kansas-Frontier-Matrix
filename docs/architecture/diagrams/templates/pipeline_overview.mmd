%%----------------------------------------------------------
%% Kansas Frontier Matrix â€” Pipeline Overview (Enhanced)
%% File: docs/architecture/diagrams/templates/pipeline_overview.mmd
%% Purpose: Visualize complete ETL + AI/ML + Graph + API + Web pipeline lifecycle
%% Author: KFM Documentation Team
%% Version: 2.0.0
%% Date: 2025-11-16
%% License: CC-BY 4.0
%% Commit: <auto-filled-on-export>
%%----------------------------------------------------------
%% Usage Guidelines:
%% - Use quotes for all labels.
%% - Use \n for new lines; keep text short and descriptive.
%% - IDs (A-Z,0-9,_) only; avoid spaces.
%% - End block with <!-- END OF MERMAID --> (required for GitHub/CI render).
%%----------------------------------------------------------

flowchart TD

  %% 0ï¸âƒ£ External Inputs
  subgraph SRC["ðŸŒ Data Sources\n(scans Â· rasters Â· vectors Â· documents Â· APIs)"]
    S1["Source A\n(e.g., USGS DEM Â· LiDAR)"]
    S2["Source B\n(e.g., NOAA Climate Â· Daymet)"]
    S3["Source C\n(e.g., Kansas GIS Archive Â· REST)"]
    S4["Source D\n(e.g., Historical Documents Â· OCR PDFs)"]
  end

  %% 1ï¸âƒ£ ETL / Processing
  subgraph ETL["âš™ï¸ ETL Pipeline\n(Makefile Â· Python Â· Checksums)"]
    FET["Fetch\nscripts/fetch_data.py"]
    TRF["Transform\nreproject Â· convert Â· normalize"]
    QA["Validate\nschema Â· STAC Â· checksums"]
    OUT["Processed Outputs\nCOG Â· GeoJSON Â· CSV/Parquet"]
  end

  %% 2ï¸âƒ£ Catalog / Metadata
  subgraph CAT["ðŸ§© Catalog & Metadata\n(STAC Â· DCAT Â· JSON-LD)"]
    COLL["STAC Collection\nfamily-level metadata"]
    ITEM["STAC Item\nspatial Â· temporal Â· asset hrefs"]
    SHA["SHA-256 Checksums\nintegrity sidecars (*.sha256)"]
  end

  %% 3ï¸âƒ£ AI/ML Enrichment
  subgraph AIML["ðŸ§  AI/ML Enrichment\n(NER Â· Geocoding Â· Linking Â· Summarization)"]
    NER["Entity Extraction\npeople Â· places Â· dates Â· events"]
    GEO["Geoparsing / Geocoding\nGNIS Â· Gazetteers"]
    LINK["Entity Linking\nfuzzy + context score"]
    SUM["Summarization\nBART/T5 Â· Optional Inference"]
  end

  %% 4ï¸âƒ£ Knowledge Graph
  subgraph KG["ðŸ•¸ Knowledge Graph\n(Neo4j Â· CIDOC CRM Â· OWL-Time)"]
    NODE["Nodes\n(Person Â· Place Â· Event Â· Document)"]
    REL["Relationships\n(OCCURRED_AT Â· MENTIONS Â· SOURCE_OF)"]
    CONF["Evidence / Confidence\ncross-source corroboration"]
  end

  %% 5ï¸âƒ£ API Layer
  subgraph API["ðŸ”Œ API Layer\n(FastAPI Â· GraphQL Â· JSON-LD)"]
    REST["REST Endpoints\n/events Â· /entity Â· /search Â· /layers-config"]
    GQL["GraphQL\nentity dossiers Â· graph traversals"]
    AUTH["Auth\nJWT/cookies Â· roles (optional)"]
  end

  %% 6ï¸âƒ£ Publication / UI
  subgraph UI["ðŸŒŽ Publication & Visualization\n(Web UI Â· Exports)"]
    WEB["Web UI\nReact Â· MapLibre Â· Timeline/Map"]
    EXP["Exports\nKML Â· KMZ Â· Downloads (Optional)"]
  end

  %% 7ï¸âƒ£ Storage / Static Assets
  subgraph FILES["ðŸ—„ï¸ Static Assets / Tiles\n(CDN Â· Tile Server Â· Object Storage)"]
    COGS["Raster Tiles / COG\nhillshade Â· DEM Â· scans"]
    VECT["Vector Data\nGeoJSON Â· MVT vector tiles"]
  end

  %% 8ï¸âƒ£ Observability
  subgraph OBS["ðŸ“Š Observability & Governance\n(CI/CD Â· Logs Â· Metrics Â· Traces)"]
    CI["CI/CD\nlint Â· tests Â· STAC validate Â· security scans"]
    O11Y["Telemetry\nOpenTelemetry Â· dashboards"]
    POL["Policy-as-Code\nOPA/Conftest Â· branch protection"]
  end

  %% --- Data Flow Connections ---
  S1 --> FET
  S2 --> FET
  S3 --> FET
  S4 --> FET

  FET --> TRF --> QA --> OUT
  OUT --> COLL
  OUT --> ITEM
  ITEM --> SHA

  %% --- AI/ML & Graph Integration ---
  OUT --> NER
  NER --> GEO --> LINK
  NER --> SUM
  LINK --> NODE
  LINK --> REL
  SUM --> NODE
  NODE --> CONF
  REL --> CONF
  SHA -. "provenance link" .- NODE
  ITEM -. "asset href" .- NODE

  %% --- Metadata â†’ API â†’ UI ---
  COLL --> REST
  ITEM --> REST
  NODE --> REST
  REL --> REST
  CONF --> REST
  REST --> GQL
  AUTH --> REST

  REST -- "JSON / GeoJSON" --> WEB
  REST -- "downloads" --> EXP
  WEB <-- "tiles Â· COG Â· GeoJSON" --> FILES
  COGS -. "raster href" .- ITEM
  VECT -. "vector href" .- ITEM

  %% --- Observability & CI/CD ---
  CI --> O11Y
  REST --> O11Y
  WEB --> O11Y
  O11Y --> POL
  CI --> POL

  %% --- Styling (WCAG 2.1 AA Accessible) ---
  classDef layer fill:#f7f7f7,stroke:#333,stroke-width:1px,color:#111;
  classDef src fill:#fafafa,stroke:#444,stroke-width:1px,color:#111;
  classDef etl fill:#e6f2ff,stroke:#31708f,stroke-width:1.2px,color:#111;
  classDef cat fill:#fff8e1,stroke:#8a6d3b,stroke-width:1.2px,color:#111;
  classDef ai fill:#f3e5f5,stroke:#6a1b9a,stroke-width:1.2px,color:#111;
  classDef kg fill:#f9e6ff,stroke:#6b3c76,stroke-width:1.2px,color:#111;
  classDef api fill:#e3f2fd,stroke:#1565c0,stroke-width:1.2px,color:#111;
  classDef ui fill:#e8f5e9,stroke:#2e7d32,stroke-width:1.2px,color:#111;
  classDef files fill:#eceff1,stroke:#546e7a,stroke-width:1px,color:#111;
  classDef obs fill:#ede7f6,stroke:#4527a0,stroke-width:1.2px,color:#111;

  %% Apply Classes
  class SRC src;
  class ETL etl;
  class CAT cat;
  class AIML ai;
  class KG kg;
  class API api;
  class UI ui;
  class FILES files;
  class OBS obs;
  class OUT,COLL,ITEM,SHA data;
  class NODE,REL,CONF kg;

  %% --- Legend (Optional) ---
  %% subgraph LEGEND["Legend (Remove in Production)"]
  %%   L1["â¬œ Source / ETL"]:::etl
  %%   L2["ðŸŸ¨ Catalog / Metadata"]:::cat
  %%   L3["ðŸŸª Knowledge Graph"]:::kg
  %%   L4["ðŸŸ¦ API Layer"]:::api
  %%   L5["ðŸŸ© Web UI"]:::ui
  %% end

  %% --- Accessibility & Design Tips ---
  %% âœ… Keep label contrast â‰¥ 4.5:1.
  %% âœ… Use dashed edges for inferred or optional data flows.
  %% âœ… Include provenance notes where relevant.
  %% âœ… Limit line crossings by grouping flows horizontally.
  %% âœ… Use TD (topâ†’down) for long pipelines, LR (leftâ†’right) for compact layouts.

<!-- END OF MERMAID -->