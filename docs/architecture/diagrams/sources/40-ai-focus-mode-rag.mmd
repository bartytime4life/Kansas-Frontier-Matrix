%%{init: {"theme": "neutral", "flowchart": {"curve": "linear"}}}%%
%% ğŸ§  KFM Diagram #40 â€” AI Focus Mode RAG (Retrieval-Augmented Generation)
%% Source: "Kansas Frontier Matrix â€“ Comprehensive System Documentation" (Focus Mode / Ollama integration)
%% Key ideas:
%% - UI never calls Ollama directly; all traffic flows through FastAPI.
%% - Hybrid retrieval: Neo4j + PostGIS + Full-text + Vector search (embeddings).
%% - Evidence-first: "No Source, No Answer" + citations [1..n].
%% - Guardrails: Prompt Gate (input) + OPA (output) + immutable provenance logging.

flowchart TB

  %% ----------------------------
  %% Styling ğŸ¨
  %% ----------------------------
  classDef ui fill:#E3F2FD,stroke:#1E88E5,stroke-width:1px,color:#0D47A1;
  classDef svc fill:#E8F5E9,stroke:#43A047,stroke-width:1px,color:#1B5E20;
  classDef data fill:#F3E5F5,stroke:#8E24AA,stroke-width:1px,color:#4A148C;
  classDef llm fill:#FFEBEE,stroke:#E53935,stroke-width:1px,color:#B71C1C;
  classDef gov fill:#FFF3E0,stroke:#FB8C00,stroke-width:1px,color:#E65100;

  %% ----------------------------
  %% UI Layer ğŸ—ºï¸
  %% ----------------------------
  subgraph UI["ğŸ—ºï¸ UI"]
    u((ğŸ‘¤ User)):::ui
    web["ğŸŒ Web App (React/TypeScript)\nMap â€¢ Timeline â€¢ Focus Mode panel"]:::ui
    ans["ğŸ“ Focus Mode Answer\n+ clickable citations [1..n]"]:::ui
    audit["ğŸ” Audit Panel\nretrieved snippets + provenance"]:::ui

    u -->|"ask"| web
    web -->|"render"| ans
    web -->|"render"| audit
  end

  %% ----------------------------
  %% Backend Orchestration ğŸ§ 
  %% ----------------------------
  subgraph API["ğŸ§  Backend API (FastAPI)"]
    endpoint["POST /focus-mode/query\n(question + map context)"]:::svc
    pg["ğŸ§¼ Prompt Gate\nsanitize â€¢ anti-injection â€¢ profanity"]:::gov
    rag["ğŸ” RAG Orchestrator\nhybrid retrieval + context assembly"]:::svc
    ctx["ğŸ“¦ Context Pack\nSOURCES [1..n]\n(snippets + source_ids)"]:::svc
    tpl["ğŸ§¾ Prompt Template\n\"No Source, No Answer\"\nCite every claim [n]"]:::svc
    asm["ğŸ“¬ Response Assembly\nanswer + citation map + audit payload"]:::svc
    cache["âš¡ Context Cache\nhot queries + session memory"]:::data
  end

  web -->|"HTTP"| endpoint
  endpoint -->|"1) sanitize"| pg
  pg -->|"2) retrieve"| rag
  rag <-->|lookup / store| cache

  %% ----------------------------
  %% Governed Data Stores ğŸ—ƒï¸
  %% ----------------------------
  subgraph DATA["ğŸ—ƒï¸ Governed Data Stores"]
    neo["ğŸ•¸ï¸ Neo4j\nKnowledge Graph"]:::data
    gis["ğŸ—ƒï¸ PostGIS\nSpatial + stats queries"]:::data
    search["ğŸ”¤ Full-text Search Index\n(e.g., Elasticsearch)"]:::data
    vec["ğŸ§² Vector Store\n(e.g., Chroma / Qdrant / pgvector)"]:::data
    obj["ğŸ—„ï¸ Object Storage\n(PDFs â€¢ COGs â€¢ tiles)"]:::data
    cat["ğŸ·ï¸ Catalog\n(STAC/DCAT + Source IDs)"]:::data
  end

  rag -->|"graph"| neo
  rag -->|"geo/stats"| gis
  rag -->|"full-text"| search

  %% ----------------------------
  %% Ollama Runtime ğŸ¤–
  %% ----------------------------
  subgraph OLLAMA["ğŸ¤– Ollama (Local LLM Runtime)"]
    embed["ğŸ§¬ Embeddings Model\n/api/embeddings\n(e.g., mxbai-embed-large)"]:::llm
    gen["ğŸ’¬ Generation Model\n/api/generate\n(e.g., kfmllama2:latest)"]:::llm
    sandbox["ğŸ”’ AI Sandbox\nno internet â€¢ no DB â€¢ no tools"]:::llm

    sandbox -. "least privilege" .-> gen
  end

  rag -->|"vector route\ncompute query embedding"| embed
  embed -->|"query embedding â†’ top-k"| vec

  neo --> ctx
  gis --> ctx
  search --> ctx
  vec --> ctx

  ctx -->|"resolve titles/links/provenance"| cat
  ctx --> tpl
  tpl -->|"3) grounded prompt\nSOURCES [1..n]"| gen

  %% ----------------------------
  %% Governance + Provenance ğŸ›¡ï¸
  %% ----------------------------
  subgraph GOV["ğŸ›¡ï¸ Governance & Audit"]
    opa["âœ… OPA Policy Check (Rego)\n- citations required\n- sensitivity labels\n- RBAC/roles"]:::gov
    block["â›” Block / Redact / Clarify\nsafe fallback"]:::gov
    ledger["â›“ï¸ Provenance Ledger\nappend-only log (PROV-O)\nQ + sources + model + prompt + decision"]:::gov
  end

  gen -->|"draft answer + [1..n]"| opa
  opa -->|"allow"| asm
  opa -->|"deny"| block --> asm

  asm --> ledger
  asm -->|"5) response\n(answer + citations + audit data)"| web

  %% Guardrail: UI never calls Ollama directly ğŸš«
  web -. "ğŸš« UI never calls Ollama directly" .-> gen

  %% ----------------------------
  %% Offline Indexing & Embeddings (ETL) ğŸ“š
  %% ----------------------------
  subgraph ETL["ğŸ“š Offline Indexing & Embeddings (ETL)"]
    sources["ğŸ“„ Sources\n(newspapers â€¢ archives â€¢ reports â€¢ PDFs)"]:::data
    etl["ğŸ“¥ Ingestion/ETL Workers\n(Airflow/Jobs)"]:::svc
    ocr["ğŸ” OCR + NLP\nchunk + entity extract"]:::svc
    index["ğŸ“š Index Builder\n(full-text + vector)"]:::svc

    sources --> etl --> ocr --> index
    ocr -->|"store binaries"| obj
    ocr -->|"entities/relations"| neo
    index -->|"update"| search
    index -->|"upsert vectors"| vec
    index -->|"register sources + lineage"| cat
    index -->|"batch embeddings"| embed
  end

  %% Truth path reminder ğŸ”
  %% Raw âœ Processed âœ Catalog âœ Databases âœ API âœ UI/AI
