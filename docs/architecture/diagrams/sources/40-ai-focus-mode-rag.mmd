%% ğŸ§  KFM Diagram #40 â€” AI Focus Mode RAG (Retrieval-Augmented Generation)
%% KFM-MDP: v11.2.6
%% Path: docs/architecture/diagrams/sources/40-ai-focus-mode-rag.mmd
%% Truth Path (must not be bypassed): Raw âœ Processed âœ Catalog âœ Databases âœ API âœ UI/AI
%% Notes:
%% - UI never calls Ollama directly; all traffic goes through FastAPI.
%% - Evidence-first: answers must cite sources (1..n); â€œno source, no answerâ€.
%% - Fail-closed: OPA gate can deny/redact/require-clarification.
%% - Immutable audit: prompts, sources, decisions logged as provenance.

flowchart TB

  %% ----------------------------
  %% Styling ğŸ¨
  %% ----------------------------
  classDef ui fill:#E3F2FD,stroke:#1E88E5,stroke-width:1px,color:#0D47A1;
  classDef svc fill:#E8F5E9,stroke:#43A047,stroke-width:1px,color:#1B5E20;
  classDef data fill:#F3E5F5,stroke:#8E24AA,stroke-width:1px,color:#4A148C;
  classDef llm fill:#FFEBEE,stroke:#E53935,stroke-width:1px,color:#B71C1C;
  classDef gov fill:#FFF3E0,stroke:#FB8C00,stroke-width:1px,color:#E65100;

  %% ----------------------------
  %% UI Layer ğŸ—ºï¸
  %% ----------------------------
  subgraph UI["ğŸ—ºï¸ UI"]
    u((ğŸ‘¤ User)):::ui
    web["ğŸŒ Web App (React/TS)<br/>Map â€¢ Timeline â€¢ Focus Mode panel"]:::ui
    ans["ğŸ“ Answer View<br/>Citations (1..n)"]:::ui
    audit["ğŸ” Audit View<br/>Snippets + provenance"]:::ui

    u -->|ask| web
    web -->|render| ans
    web -->|render| audit
  end

  %% ----------------------------
  %% Backend Orchestration ğŸ§ 
  %% ----------------------------
  subgraph API["ğŸ§  Backend API (FastAPI)"]
    endpoint["POST /focus-mode/query<br/>Question + map context"]:::svc
    pg["ğŸ§¼ Prompt Gate<br/>sanitize â€¢ anti-injection â€¢ policy hints"]:::gov
    rag["ğŸ” RAG Orchestrator<br/>hybrid retrieval + context assembly"]:::svc
    cache["âš¡ Context Cache<br/>hot queries + session memory"]:::data
    ctx["ğŸ“¦ Context Pack<br/>SOURCES (1..n)<br/>snippets + source_ids"]:::svc
    tpl["ğŸ§¾ Prompt Template<br/>No Source, No Answer<br/>Cite each claim (1..n)"]:::svc
    asm["ğŸ“¬ Response Assembly<br/>answer + citation map + audit payload"]:::svc
  end

  web -->|HTTP| endpoint
  endpoint -->|1) sanitize| pg
  pg -->|2) retrieve| rag
  rag <-->|lookup/store| cache
  rag -->|assemble| ctx
  ctx -->|grounded prompt| tpl

  %% ----------------------------
  %% Governed Data Stores ğŸ—ƒï¸
  %% ----------------------------
  subgraph DATA["ğŸ—ƒï¸ Governed Data Stores"]
    neo["ğŸ•¸ï¸ Neo4j<br/>Knowledge Graph"]:::data
    gis["ğŸ—ºï¸ PostGIS<br/>Spatial + stats queries"]:::data
    search["ğŸ”¤ Full-text Index<br/>search + filters"]:::data
    vec["ğŸ§² Vector Store<br/>embeddings + top-k"]:::data
    obj["ğŸ—„ï¸ Object Storage<br/>PDFs â€¢ COGs â€¢ tiles"]:::data
    cat["ğŸ·ï¸ Catalog Layer<br/>STAC/DCAT + Source IDs"]:::data
  end

  rag -->|graph| neo
  rag -->|geo/stats| gis
  rag -->|full-text| search
  rag -->|vector retrieve| vec
  rag -->|resolve metadata| cat
  rag -->|fetch assets| obj

  neo --> ctx
  gis --> ctx
  search --> ctx
  vec --> ctx
  cat --> ctx

  %% ----------------------------
  %% Ollama Runtime ğŸ¤–
  %% ----------------------------
  subgraph OLLAMA["ğŸ¤– Ollama (Local LLM Runtime)"]
    embed["ğŸ§¬ Embeddings Model<br/>/api/embeddings"]:::llm
    gen["ğŸ’¬ Generation Model<br/>/api/generate"]:::llm
    sandbox["ğŸ”’ Sandbox<br/>no internet â€¢ no DB â€¢ no tools"]:::llm
  end

  rag -->|embed query| embed
  embed -->|top-k| vec
  tpl -->|3) generate grounded answer| gen
  sandbox -. least privilege .-> gen

  %% ----------------------------
  %% Governance + Provenance ğŸ›¡ï¸
  %% ----------------------------
  subgraph GOV["ğŸ›¡ï¸ Governance & Audit"]
    opa["âœ… OPA Policy Check (Rego)<br/>citations required â€¢ sensitivity labels â€¢ RBAC"]:::gov
    block["â›” Block/Redact/Clarify<br/>safe fallback"]:::gov
    ledger["â›“ï¸ Provenance Ledger<br/>append-only PROV-O log"]:::gov
  end

  gen -->|draft + citations| opa
  opa -->|allow| asm
  opa -->|deny| block --> asm

  asm -->|write audit| ledger
  asm -->|5) response payload| web

  %% Guardrail: UI never calls Ollama directly ğŸš«
  web -. "ğŸš« UI never calls Ollama directly" .-> gen

  %% ----------------------------
  %% Offline Indexing & Embeddings (ETL) ğŸ“š
  %% ----------------------------
  subgraph ETL["ğŸ“š Offline Indexing & Embeddings (ETL)"]
    sources["ğŸ“„ Sources<br/>archives â€¢ reports â€¢ PDFs â€¢ datasets"]:::data
    etl["ğŸ“¥ Ingestion Workers<br/>Airflow/Jobs"]:::svc
    chunk["âœ‚ï¸ Chunk + NLP<br/>entities â€¢ dedupe â€¢ normalize"]:::svc
    index["ğŸ“š Index Builder<br/>full-text + vectors"]:::svc

    sources --> etl --> chunk --> index
    chunk -->|store binaries| obj
    chunk -->|entities/relations| neo
    index -->|update| search
    index -->|upsert vectors| vec
    index -->|register IDs + lineage| cat
    index -->|batch embeddings| embed
  end
