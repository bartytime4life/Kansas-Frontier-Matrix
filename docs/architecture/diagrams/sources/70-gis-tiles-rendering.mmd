flowchart TB
  %% ------------------------------------------------------------------------------------
  %% ğŸ§© KFM | GIS Tiles Rendering (Vector + Raster)
  %% ğŸ“„ docs/architecture/diagrams/sources/70-gis-tiles-rendering.mmd
  %%
  %% NOTE (Mermaid compatibility):
  %% - Keep "flowchart TB" as the FIRST non-empty line (some renderers require this).
  %% - Avoid Mermaid init blocks here; prefer repo-wide Mermaid config if needed.
  %% ------------------------------------------------------------------------------------

  %% =========================
  %% ğŸ‘¤ CLIENTS
  %% =========================
  subgraph Clients["ğŸ‘¤ Clients (consume tiles)"]
    direction LR
    web["ğŸŒ Web UI<br/>MapLibre GL JS"]
    openlayers["ğŸ—ºï¸ External clients<br/>OpenLayers / QGIS / custom apps"]
    globe["ğŸ§­ 3D / Globe<br/>Cesium"]
    mobile["ğŸ“± Mobile / AR"]
    earth["ğŸŒ Google Earth"]
  end

  %% =========================
  %% ğŸšª EDGE / DELIVERY
  %% =========================
  subgraph Edge["ğŸšª Edge / Delivery"]
    direction LR
    cdn["ğŸ§Š CDN / Edge cache"]
    waf["ğŸ›¡ï¸ WAF + TLS termination"]
  end

  %% =========================
  %% ğŸ§  API + GOVERNANCE
  %% =========================
  subgraph API["ğŸ§  API + Governance"]
    direction TB
    auth["ğŸ” AuthN<br/>(JWT / session)"]
    policy["ğŸ›¡ï¸ Policy gate<br/>(OPA/Rego)"]
    tiles["ğŸ§© Tiles endpoint<br/>GET /tiles/:layer/:z/:x/:y.pbf (MVT)<br/>GET /tiles/:layer/:z/:x/:y.png|webp"]
    cache["âš¡ Read-through tile cache<br/>(Redis / disk)"]
    audit["ğŸ§¾ Audit + metrics<br/>(trace id, rate limits, access logs)"]
    deny["â›” Deny / sanitize<br/>(403 or masked tile)"]
  end

  %% =========================
  %% ğŸ¨ RENDERERS
  %% =========================
  subgraph Render["ğŸ¨ Renderers"]
    direction LR
    kind{"ğŸ§­ Tile kind?"}
    vtr["ğŸ§± Vector tile renderer<br/>MVT (.pbf)"]
    rtr["ğŸ–¼ï¸ Raster tile renderer<br/>PNG / WEBP"]
    proxy["ğŸ” Proxy / re-tile<br/>WMS/WMTS passthrough"]
  end

  %% =========================
  %% ğŸ—„ï¸ STORES
  %% =========================
  subgraph Stores["ğŸ—„ï¸ Stores"]
    direction LR
    postgis["ğŸ—ºï¸ PostGIS<br/>(vector features + spatial indexes)"]
    pmtiles["ğŸ“¦ PMTiles / MBTiles<br/>(prebuilt tilesets)"]
    cog["ğŸ›°ï¸ Cloud-Optimized GeoTIFFs (COG)<br/>(+ overviews / pyramids)"]
    lake["â˜ï¸ Data lake / object store<br/>(large rasters, artifacts)"]
    extsvc["ğŸ”— External GIS services<br/>(ArcGIS, WMS/WMTS)"]
    catalog["ğŸ“š Catalog + Layer Registry<br/>(STAC/DCAT metadata + routing)"]
  end

  %% =========================
  %% ğŸ—ï¸ OFFLINE PIPELINE (OPTIONAL)
  %% =========================
  subgraph Offline["ğŸ—ï¸ Offline ingest + prep (optional)"]
    direction TB
    ingest["ğŸ“¥ Ingest<br/>(federated harvest / uploads / STAC feeds)"]
    prep["ğŸ§ª Preprocess<br/>(clip/mosaic/reproject â†’ indexes + COGs)"]
    build["ğŸ§± Build tilesets<br/>(tile pyramid / PMTiles / MBTiles / XYZ)"]
    publish["ğŸš€ Publish + version<br/>(cache-bust + catalog update)"]
  end

  %% =========================
  %% RUNTIME FLOW
  %% =========================
  web --> cdn
  openlayers --> cdn
  globe --> cdn
  mobile --> cdn
  earth --> cdn

  cdn --> waf --> auth --> policy
  policy -->|deny| deny --> cdn
  policy -->|allow| tiles

  tiles -->|layer config| catalog
  tiles --> audit
  policy --> audit

  tiles --> cache
  cache -->|HIT| cdn
  cache -->|MISS| kind

  kind -->|vector| vtr
  kind -->|raster| rtr
  kind -->|proxy| proxy

  vtr -->|query| postgis
  vtr -->|read| pmtiles

  rtr -->|read| pmtiles
  rtr -->|read| cog
  rtr -->|read| lake

  proxy -->|fetch| extsvc

  vtr -->|write| cache
  rtr -->|write| cache
  proxy -->|write| cache

  %% =========================
  %% OFFLINE FLOW
  %% =========================
  ingest --> prep --> build --> publish
  prep --> postgis
  prep --> cog
  prep --> lake
  build --> pmtiles
  publish --> catalog
  publish -->|invalidate| cache

  %% =========================
  %% STYLES
  %% =========================
  classDef client fill:#E3F2FD,stroke:#1E88E5,stroke-width:1px,color:#0D47A1;
  classDef edge fill:#F3E5F5,stroke:#8E24AA,stroke-width:1px,color:#4A148C;
  classDef api fill:#E8F5E9,stroke:#43A047,stroke-width:1px,color:#1B5E20;
  classDef render fill:#FFF3E0,stroke:#FB8C00,stroke-width:1px,color:#E65100;
  classDef store fill:#ECEFF1,stroke:#546E7A,stroke-width:1px,color:#263238;
  classDef warn fill:#FFEBEE,stroke:#E53935,stroke-width:1px,color:#B71C1C;
  classDef offline fill:#F1F8E9,stroke:#7CB342,stroke-width:1px,color:#33691E;

  class web,openlayers,globe,mobile,earth client;
  class cdn,waf edge;
  class auth,policy,tiles,cache,audit api;
  class kind,vtr,rtr,proxy render;
  class postgis,pmtiles,cog,lake,extsvc,catalog store;
  class deny warn;
  class ingest,prep,build,publish offline;
