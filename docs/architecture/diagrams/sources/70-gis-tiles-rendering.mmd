%% ------------------------------------------------------------------------------------
%% ðŸ§© KFM | GIS Tiles Rendering (Vector + Raster)
%% ðŸ“„ docs/architecture/diagrams/sources/70-gis-tiles-rendering.mmd
%%
%% Runtime (public consumption):
%%   - Vector tiles: GET /tiles/:layer/:z/:x/:y.pbf  (MVT)
%%   - Raster tiles: GET /tiles/:layer/:z/:x/:y.png  (or .webp)
%%
%% Offline (optional but recommended for scale):
%%   - Vector + raster prep (PostGIS, COGs), optionally build PMTiles/MBTiles/XYZ pyramids
%%   - Publish versions to support cache-busting and reproducible map states
%% ------------------------------------------------------------------------------------

%%{init: {'flowchart': {'curve': 'basis'}}}%%
flowchart TB

  %% =========================
  %% ðŸ‘¤ CLIENTS
  %% =========================
  subgraph Clients["ðŸ‘¤ Clients (consume tiles)"]
    direction LR
    web["ðŸŒ Web UI\nMapLibre GL JS"]
    openlayers["ðŸ—ºï¸ External clients\nOpenLayers / QGIS / custom apps"]
    globe["ðŸ§­ 3D / Globe\nCesium"]
    mobile["ðŸ“± Mobile / AR"]
    earth["ðŸŒŽ Google Earth"]
  end

  %% =========================
  %% ðŸšª EDGE / DELIVERY
  %% =========================
  subgraph Edge["ðŸšª Edge / Delivery"]
    direction LR
    cdn["ðŸ§Š CDN / Edge cache"]
    waf["ðŸ›¡ï¸ WAF + TLS termination"]
  end

  %% =========================
  %% ðŸ§  API + GOVERNANCE
  %% =========================
  subgraph API["ðŸ§  API + Governance"]
    direction TB
    auth["ðŸ” AuthN\n(JWT / session)"]
    policy["ðŸ›¡ï¸ Policy gate\n(OPA/Rego)"]
    tiles["ðŸ§© Tiles endpoint\nGET /tiles/:layer/:z/:x/:y.pbf (MVT)\nGET /tiles/:layer/:z/:x/:y.png|webp"]
    cache["âš¡ Read-through tile cache\n(Redis / disk)"]
    audit["ðŸ§¾ Audit + metrics\n(trace id, rate limits, access logs)"]
    deny["â›” Deny / sanitize\n(403 or masked tile)"]
  end

  %% =========================
  %% ðŸŽ¨ RENDERERS
  %% =========================
  subgraph Render["ðŸŽ¨ Renderers"]
    direction LR
    kind{"ðŸ§­ Tile kind?"}
    vtr["ðŸ§± Vector tile renderer\nMVT (.pbf)"]
    rtr["ðŸ–¼ï¸ Raster tile renderer\nPNG / WEBP"]
    proxy["ðŸ” Proxy / re-tile\nWMS/WMTS passthrough"]
  end

  %% =========================
  %% ðŸ—„ï¸ STORES
  %% =========================
  subgraph Stores["ðŸ—„ï¸ Stores"]
    direction LR
    postgis["ðŸ—ºï¸ PostGIS\n(vector features + spatial indexes)"]
    pmtiles["ðŸ“¦ PMTiles / MBTiles\n(prebuilt tilesets)"]
    cog["ðŸ›°ï¸ Cloud-Optimized GeoTIFFs (COG)\n(+ overviews / pyramids)"]
    lake["â˜ï¸ Data lake / object store\n(large rasters, artifacts)"]
    extsvc["ðŸ”— External GIS services\n(ArcGIS, WMS/WMTS)"]
    catalog["ðŸ“š Catalog + Layer Registry\n(STAC/DCAT metadata + routing)"]
  end

  %% =========================
  %% ðŸ—ï¸ OFFLINE PIPELINE (OPTIONAL)
  %% =========================
  subgraph Offline["ðŸ—ï¸ Offline ingest + prep (optional)"]
    direction TB
    ingest["ðŸ“¥ Ingest\n(federated harvest / uploads / STAC feeds)"]
    prep["ðŸ§ª Preprocess\n(clip/mosaic/reproject â†’ indexes + COGs)"]
    build["ðŸ§± Build tilesets\n(tile pyramid / PMTiles / MBTiles / XYZ)"]
    publish["ðŸš€ Publish + version\n(cache-bust + catalog update)"]
  end

  %% =========================
  %% RUNTIME FLOW
  %% =========================
  web --> cdn
  openlayers --> cdn
  globe --> cdn
  mobile --> cdn
  earth --> cdn

  cdn --> waf --> auth --> policy
  policy -->|deny| deny --> cdn
  policy -->|allow| tiles

  tiles -->|layer config| catalog
  tiles --> audit
  policy --> audit

  tiles --> cache
  cache -->|HIT| cdn
  cache -->|MISS| kind

  kind -->|vector| vtr
  kind -->|raster| rtr
  kind -->|proxy| proxy

  vtr -->|query| postgis
  vtr -->|read| pmtiles

  rtr -->|read| pmtiles
  rtr -->|read| cog
  rtr -->|read| lake

  proxy -->|fetch| extsvc

  vtr -->|write| cache
  rtr -->|write| cache
  proxy -->|write| cache

  %% =========================
  %% OFFLINE FLOW
  %% =========================
  ingest --> prep --> build --> publish
  prep --> postgis
  prep --> cog
  prep --> lake
  build --> pmtiles
  publish --> catalog
  publish -->|invalidate| cache

  %% =========================
  %% STYLES
  %% =========================
  classDef client fill:#E3F2FD,stroke:#1E88E5,stroke-width:1px,color:#0D47A1;
  classDef edge fill:#F3E5F5,stroke:#8E24AA,stroke-width:1px,color:#4A148C;
  classDef api fill:#E8F5E9,stroke:#43A047,stroke-width:1px,color:#1B5E20;
  classDef render fill:#FFF3E0,stroke:#FB8C00,stroke-width:1px,color:#E65100;
  classDef store fill:#ECEFF1,stroke:#546E7A,stroke-width:1px,color:#263238;
  classDef warn fill:#FFEBEE,stroke:#E53935,stroke-width:1px,color:#B71C1C;
  classDef offline fill:#F1F8E9,stroke:#7CB342,stroke-width:1px,color:#33691E;

  class web,openlayers,globe,mobile,earth client;
  class cdn,waf edge;
  class auth,policy,tiles,cache,audit api;
  class kind,vtr,rtr,proxy render;
  class postgis,pmtiles,cog,lake,extsvc,catalog store;
  class deny warn;
  class ingest,prep,build,publish offline;

