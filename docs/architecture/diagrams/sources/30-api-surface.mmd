%% Kansas Frontier Matrix (KFM) â€” API Surface
%% Source: "API Schemas and Developer Interfaces" section in Kansas Frontier Matrix Comprehensive System Documentation.pdf
%%{init: {"theme":"base","flowchart":{"curve":"linear"}}}%%
flowchart LR

    %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    %% Clients
    %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph C[ğŸ§‘â€ğŸ’» Clients]
        web[ğŸŒ Web Frontend]
        mobile[ğŸ“± Mobile / AR]
        gis[ğŸ—ºï¸ GIS Tools]
        ext[ğŸ§ª Scripts / Integrations]
    end

    api[ğŸšª Unified API Layer<br/>FastAPI<br/>REST + GraphQL]

    web --> api
    mobile --> api
    gis --> api
    ext --> api

    %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    %% Governance (applies to every request)
    %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph GOV[ğŸ›¡ï¸ Governance & Safety Rails]
        auth[ğŸ”‘ AuthN/AuthZ<br/>API key or OAuth token]
        rbac[ğŸ‘® RBAC + data sensitivity filters]
        audit[ğŸ§¾ Audit logging]
        limits[â±ï¸ Pagination + timeouts<br/>GraphQL depth/cost limits]
    end

    api -.enforces.-> auth
    api -.enforces.-> rbac
    api -.records.-> audit
    api -.protects.-> limits

    %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    %% Public API surface
    %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph PUB[ğŸ”Œ Public API Surface]
        meta["â„¹ï¸ Health & Docs<br/>GET /healthz<br/>GET /readyz<br/>GET /version<br/>GET /openapi.json<br/>GET /docs"]
        catalog["ğŸ“š Data Catalog & Datasets<br/>GET /api/v1/datasets/{id}<br/>GET /api/v1/catalog/search<br/>GET /api/v1/datasets/{id}/data<br/>â†³ params: format=geojson, bbox=â€¦"]
        query["ğŸ§® Ad-hoc Spatial Query<br/>GET /api/v1/query<br/>â†³ params: table, bbox, where, select, format"]
        tiles["ğŸ—ºï¸ Map Tiles<br/>GET /tiles/{layer}/{z}/{x}/{y}.pbf (MVT)<br/>GET /tiles/{layer}/{z}/{x}/{y}.png (.webp)"]
        gql["ğŸ§¬ Knowledge Graph & Search<br/>POST /graphql"]
        story["ğŸ§µ Story Nodes<br/>POST /api/v1/story (contributors)<br/>GET story by id + search (bbox/time/tags)"]
        ai["âœ¨ Focus Mode AI<br/>POST /api/v1/ai/query<br/>POST /api/v1/ai/stream (experimental)<br/>GET /api/v1/ai/suggestions"]
    end

    %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    %% Admin / Maintainer surface (restricted roles)
    %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph ADM[ğŸ” Admin / Maintainer Surface]
        ingest["ğŸšš Ingestion & Pipeline Control<br/>POST /api/v1/ingest/runPipeline<br/>+ run status + provenance logs"]
    end

    api --> meta
    api --> catalog
    api --> query
    api --> tiles
    api --> gql
    api --> story
    api --> ai
    api --> ingest

    %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    %% Core backends
    %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph CORE[ğŸ§± Core Backends]
        postgis[(ğŸ—„ï¸ PostGIS)]
        neo4j[(ğŸ•¸ï¸ Neo4j)]
        obj[(ğŸª£ Object Storage<br/>STAC assets / exports)]
        tileSvc[(ğŸ§Š Tile Service)]
        retrieval[(ğŸ§· Retrieval + Citations)]
        ollama[(ğŸ§  Ollama)]
        pipelines[(âš™ï¸ ETL / Pipeline Runner)]
    end

    %% Data / query paths
    catalog --> postgis
    catalog --> obj
    query --> postgis

    tiles --> tileSvc
    tileSvc --> postgis

    gql --> neo4j
    gql --> postgis

    story --> postgis

    %% AI paths (grounded answers)
    ai --> retrieval
    retrieval --> postgis
    retrieval --> neo4j
    retrieval --> obj
    retrieval --> ollama

    %% Ingestion paths
    ingest --> pipelines
    pipelines --> obj
    pipelines --> postgis
    pipelines --> neo4j

    %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    %% Roadmap / planned interop
    %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph ROADMAP[ğŸ§­ Interop Roadmap]
        ogc["ğŸ›°ï¸ OGC APIs (WMS/WFS/OGC Features)"]
        gqlSub["ğŸ”” GraphQL subscriptions / streaming (WebSocket)"]
    end

    api -.planned.-> ogc
    api -.planned.-> gqlSub

    %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    %% Styling
    %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    classDef apiNode fill:#0b5fff,color:#ffffff,stroke:#0847b8,stroke-width:2px;
    classDef surface fill:#f4f6ff,stroke:#8a93c2,stroke-width:1px;
    classDef admin fill:#fff5f5,stroke:#d48a8a,stroke-width:1px;
    classDef backend fill:#f3fff6,stroke:#7ac28a,stroke-width:1px;
    classDef govern fill:#fffaf0,stroke:#c2a36b,stroke-width:1px;
    classDef roadmap fill:#f8f8f8,stroke:#bdbdbd,stroke-dasharray: 5 5;

    class api apiNode;
    class meta,catalog,query,tiles,gql,story,ai surface;
    class ingest admin;
    class postgis,neo4j,obj,tileSvc,retrieval,ollama,pipelines backend;
    class auth,rbac,audit,limits govern;
    class ogc,gqlSub roadmap;

