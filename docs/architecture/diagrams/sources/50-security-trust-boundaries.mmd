%% =============================================================================
%% ğŸ“„ docs/architecture/diagrams/sources/50-security-trust-boundaries.mmd
%% ğŸ” Kansas Frontier Matrix (KFM) â€” Security Trust Boundaries
%% =============================================================================
%% Project sources used:
%% - Kansas Frontier Matrix Comprehensive System Documentation (PDF)
%%   - Multi-layer â€œtruth pathâ€ & â€œUI cannot query DB directlyâ€ (pp. 1â€“2)
%%   - Security + governance: RBAC, OPA, provenance, audit ledger, policy gates (pp. 10â€“11)
%%   - Deployment: Docker Compose services, Nginx reverse proxy, HTTPS/HSTS/CSP, CI/CD (pp. 15â€“17)
%%   - Focus Mode RAG + Prompt Gate + Ollama sandbox + OPA output filtering (pp. 6, 166â€“167)
%% =============================================================================

%%{init: {"theme":"neutral","flowchart":{"curve":"linear"}}}%%
flowchart LR

  %% ---------- Styles ----------
  classDef actor fill:#ffffff,stroke:#333333,stroke-width:1px;
  classDef service fill:#e8f4ff,stroke:#1e88e5,stroke-width:1px;
  classDef control fill:#ffe8e8,stroke:#d9534f,stroke-width:1px;
  classDef datastore fill:#fff2cc,stroke:#f1c232,stroke-width:1px;
  classDef note fill:#f7f7f7,stroke:#aaaaaa,stroke-dasharray: 3 3;

  %% ---------- TB0: External / Untrusted ----------
  subgraph TB0["TB0 ğŸŒ External / Untrusted Zone"]
    user["ğŸ‘¤ Users\nPublic â€¢ Contributor â€¢ Maintainer â€¢ Admin"]:::actor
    ext_data["ğŸŒ External Data Sources\nCSV uploads â€¢ APIs â€¢ ArcGIS â€¢ STAC feeds"]:::actor
    dev["ğŸ‘©â€ğŸ’» Developers"]:::actor
    github["ğŸ™ GitHub Repo"]:::service
  end
  style TB0 fill:#fafafa,stroke:#999999,stroke-width:2px,stroke-dasharray: 6 3

  %% ---------- TB1: Edge / DMZ ----------
  subgraph TB1["TB1 ğŸ›¡ Edge / DMZ (Internet-Facing)"]
    nginx["ğŸŒ Reverse Proxy\nNginx/Apache\nTLS âœ… â€¢ HSTS âœ… â€¢ CSP âœ…"]:::service
    edge_ctrl["ğŸ§¯ Edge Controls\nrate limiting â€¢ basic WAF rules"]:::control
    open_ports["ğŸ”“ Exposed Ports\n80/443 only (recommended)"]:::note
  end
  style TB1 fill:#f5fbff,stroke:#999999,stroke-width:2px,stroke-dasharray: 6 3

  %% ---------- TB2: Runtime Compute ----------
  subgraph TB2["TB2 ğŸ— Runtime Compute (Trusted Services)"]
    web["ğŸ—ºï¸ Web UI (SPA)\nReact + MapLibre/Cesium"]:::service
    api["âš™ï¸ API Layer\nFastAPI + REST/GraphQL"]:::service
    focus["ğŸ¯ Focus Mode Orchestrator\nRAG â€¢ citation enforcement"]:::service
    opa_rt["ğŸ§± OPA (Runtime Policy)\nRBAC â€¢ sensitivity gates â€¢ fail-closed"]:::control
    secrets["ğŸ”‘ Secrets\nJWT secret â€¢ DB creds\n(env vars / Docker secrets / vault)"]:::datastore
  end
  style TB2 fill:#f0fff4,stroke:#999999,stroke-width:2px,stroke-dasharray: 6 3

  %% ---------- TB2b: Data Pipeline Compute ----------
  subgraph TB2b["TB2b ğŸ“¥ Data Pipeline Compute"]
    etl["ğŸ­ ETL / Pipeline Workers\ningest âœ transform âœ validate âœ publish"]:::service
    gates["ğŸš¦ Policy Gates\nlicense â€¢ classification â€¢ metadata completeness"]:::control
  end
  style TB2b fill:#f0fff4,stroke:#999999,stroke-width:2px,stroke-dasharray: 6 3

  %% ---------- TB3: Restricted Data Tier ----------
  subgraph TB3["TB3 ğŸ”’ Restricted Data Tier (Datastores)"]
    raw["ğŸª£ Raw Storage (immutable)"]:::datastore
    processed["ğŸ—ƒï¸ Processed Data Store"]:::datastore
    catalog["ğŸ“š Catalog & Metadata\nSTAC â€¢ DCAT â€¢ PROV"]:::datastore
    postgis["ğŸ—„ï¸ PostGIS (spatial DB)"]:::datastore
    neo4j["ğŸ•¸ï¸ Neo4j (knowledge graph)"]:::datastore
    search["ğŸ” Search + Vector Index\nDocs â€¢ embeddings"]:::datastore
    prov["ğŸ§¾ Provenance + Audit Ledger\nappend-only â€¢ signed/timestamped (planned)"]:::datastore
  end
  style TB3 fill:#fffdf0,stroke:#999999,stroke-width:2px,stroke-dasharray: 6 3

  %% ---------- TB4: AI Containment Zone ----------
  subgraph TB4["TB4 ğŸ¤– AI Containment (Sandboxed LLM)"]
    promptgate["ğŸ§¼ Prompt Gate\nsanitize inputs â€¢ block injection/profanity"]:::control
    ollama["ğŸ§  Ollama LLM\n/api/generate\nğŸš« no internet â€¢ ğŸš« no tools"]:::service
    opa_ai["ğŸ›¡ OPA Output Filter\nallow/redact/block per policy"]:::control
  end
  style TB4 fill:#fdf7ff,stroke:#999999,stroke-width:2px,stroke-dasharray: 6 3

  %% ---------- TB5: CI/CD + Supply Chain ----------
  subgraph TB5["TB5 ğŸ§ª CI/CD & Supply Chain"]
    policy_pack["ğŸ“œ Policy Pack (OPA)\npolicies-as-code"]:::control
    ci["ğŸ¤– CI Workflows\nunit/integration tests â€¢ policy tests"]:::control
    scans["ğŸ§¯ Security Checks\nSBOM â€¢ SLSA â€¢ dependency scan â€¢ OWASP ZAP"]:::control
    sign["âœï¸ Image Signing\nCosign â€¢ transparency logs"]:::control
    registry["ğŸ“¦ Container Registry\n(GHCR/Docker Hub)"]:::service
    deploy["ğŸš€ Deploy\nDocker Compose / Kubernetes"]:::service
  end
  style TB5 fill:#fff7f0,stroke:#999999,stroke-width:2px,stroke-dasharray: 6 3

  %% ---------- Primary Flows (User â†” Runtime) ----------
  user -- "HTTPS 443" --> nginx
  nginx --> edge_ctrl
  edge_ctrl --> nginx
  nginx --> open_ports

  nginx -- "static assets" --> web
  nginx -- "/api â€¢ /graphql â€¢ /focus-mode/*" --> api

  web -- "authenticated requests\n(token/session)" --> api
  api -- "policy decision" --> opa_rt
  opa_rt -- "allow/deny + masking" --> api

  secrets --> api
  secrets --> etl
  secrets -. "âŒ not mounted" .-> ollama

  %% ---------- Runtime â†” Datastores ----------
  api -- "queries (least privilege)" --> postgis
  api -- "graph queries" --> neo4j
  api -- "search" --> search
  api -- "read large assets" --> raw
  api -- "metadata" --> catalog
  api -- "audit/provenance writes" --> prov

  %% ---------- Focus Mode (RAG) Flow ----------
  api -- "POST /focus-mode/query" --> focus
  focus --> promptgate
  promptgate -- "sanitized query" --> focus

  focus -- "retrieve evidence" --> neo4j
  focus -- "retrieve evidence" --> postgis
  focus -- "retrieve evidence" --> search
  focus -- "retrieve metadata" --> catalog

  focus -- "prompt + SOURCES[n]" --> ollama
  ollama -- "draft answer" --> opa_ai
  opa_ai -- "allow/redact/block" --> focus

  focus -- "answer + citations\n(+ policy decision)" --> api
  focus -- "append-only audit" --> prov

  %% ---------- Data Pipeline (External Sources â†’ Truth Path) ----------
  ext_data --> etl
  etl --> gates
  gates -- "pass" --> raw
  raw --> processed
  processed --> catalog
  catalog --> postgis
  catalog --> neo4j
  catalog --> search
  etl --> prov

  %% ---------- CI/CD (Dev â†’ Prod) ----------
  dev --> github
  github --> ci
  github --> policy_pack
  policy_pack --> ci
  policy_pack --> opa_rt
  policy_pack --> opa_ai
  policy_pack --> gates

  ci --> scans
  scans --> sign
  sign --> registry
  registry --> deploy
  deploy --> api
  deploy --> web
  deploy --> opa_rt
  deploy --> ollama
  deploy --> etl

  %% ---------- Explicitly Blocked Paths (Trust Boundary Enforcement) ----------
  user -. "âŒ internal-only (no direct service ports)" .-> postgis
  user -. "âŒ internal-only (no direct service ports)" .-> neo4j
  user -. "âŒ internal-only (no direct service ports)" .-> ollama
  web  -. "âŒ UI never queries DB directly (API only)" .-> postgis
  ollama -. "âŒ no DB creds / no DB access" .-> postgis

  %% ---------- Legend ----------
  subgraph LEG["ğŸ“Œ Legend"]
    l1["ğŸ”’ Trust Boundaries = dashed containers (TB0..TB5)"]:::note
    l2["ğŸ§± OPA enforces RBAC + sensitivity + output filtering (fail-closed)"]:::note
    l3["ğŸ§¾ Provenance/audit is append-only; datasets & AI answers are traceable"]:::note
    l4["ğŸ§  LLM is sandboxed; only sees curated prompt + retrieved sources"]:::note
  end
  style LEG fill:#ffffff,stroke:#dddddd,stroke-width:1px

