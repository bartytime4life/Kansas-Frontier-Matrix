%%---------------------------------------------------------------------------
%% ğŸ“ docs/architecture/diagrams/sources/60-ci-cd-devsecops.mmd
%% ğŸ§­ Kansas Frontier Matrix â€” CI/CD + DevSecOps (high-level pipeline)
%% Source: "Deployment Instructions" (CI/CD + deployment) in:
%%         Kansas Frontier Matrix Comprehensive System Documentation.pdf
%%---------------------------------------------------------------------------

%%{init: {"flowchart": {"curve": "basis"}} }%%
flowchart TB

  %% ===== Styles (kept subtle for GitHub light/dark) =====
  classDef actor stroke-width:2px;
  classDef ci stroke-width:1px;
  classDef sec stroke-width:1px,stroke-dasharray: 3 3;
  classDef artifact stroke-width:1px;
  classDef gate stroke-width:2px,stroke-dasharray: 5 5;
  classDef runtime stroke-width:1px;
  classDef obs stroke-width:1px;

  %%--------------------------------------------------------------------------
  %% ğŸ§‘â€ğŸ’» SOURCE CONTROL & COLLABORATION
  %%--------------------------------------------------------------------------
  subgraph SOURCE["ğŸ§‘â€ğŸ’» Source Control & Collaboration"]
    direction TB
    DEV["ğŸ§‘â€ğŸ’» Developer"]
    REPO["ğŸ™ GitHub Repo<br/>Kansas-Frontier-Matrix"]
    PR["ğŸ”€ Pull Request<br/>review + merge"]
    DEV -->|git push| REPO
    REPO -->|open PR| PR
    PR -->|merge to main| REPO
  end
  class DEV,REPO,PR actor

  %%--------------------------------------------------------------------------
  %% âš™ï¸ CI â€” GITHUB ACTIONS
  %%--------------------------------------------------------------------------
  subgraph CI["âš™ï¸ CI â€” GitHub Actions"]
    direction TB
    CI_TRIGGER["â±ï¸ Workflows<br/>on: pull_request / push / schedule"]
    LINT["ğŸ” Lint + Format"]
    TESTS["âœ… Automated Tests<br/>unit + integration"]
    SAST["ğŸ§¯ SAST<br/>static code analysis"]
    SECRETSCAN["ğŸ•µï¸ Secrets Scan<br/>prevent credential leaks"]
    SCA["ğŸ“¦ Dependency / SCA Scan<br/>vulns + licenses"]
    IAC_SCAN["ğŸ—ï¸ IaC Scan<br/>compose / k8s / terraform"]
    BUILD["ğŸ³ Build Docker Images<br/>api + web"]
    IMAGE_SCAN["ğŸ§« Container/Image Scan<br/>vulns + misconfig"]
    SBOM["ğŸ§¾ SBOM + Provenance<br/>SPDX/CycloneDX"]
    SIGN["ğŸ” Sign / Attest Artifacts<br/>(optional)"]
    PUSH["ğŸ“¤ Publish Images<br/>GHCR / Docker Hub"]
    GHA_SECRETS["ğŸ” GitHub Actions Secrets<br/>(SSH key, registry creds)"]

    CI_TRIGGER --> LINT --> TESTS --> SAST --> SECRETSCAN --> SCA --> IAC_SCAN --> BUILD --> IMAGE_SCAN --> SBOM --> SIGN --> PUSH
  end
  class CI_TRIGGER,LINT,TESTS,BUILD,SBOM,SIGN,PUSH ci
  class SAST,SECRETSCAN,SCA,IAC_SCAN,IMAGE_SCAN sec

  REPO -->|push / PR| CI_TRIGGER
  GHA_SECRETS -.->|auth to registry| PUSH

  %%--------------------------------------------------------------------------
  %% ğŸ“¦ ARTIFACTS & SUPPLY-CHAIN
  %%--------------------------------------------------------------------------
  subgraph ARTIFACTS["ğŸ“¦ Artifacts & Supply-Chain"]
    direction TB
    REGISTRY["ğŸ“¦ Container Registry<br/>GHCR / Docker Hub"]
    SBOM_STORE["ğŸ§¾ SBOM Store<br/>workflow artifact / release asset"]
    RELEASE["ğŸ·ï¸ Versioned Release<br/>tag + changelog"]
    PUSH --> REGISTRY
    SBOM --> SBOM_STORE
    PUSH --> RELEASE
  end
  class REGISTRY,SBOM_STORE,RELEASE artifact

  %%--------------------------------------------------------------------------
  %% ğŸš€ CD â€” DEPLOYMENT AUTOMATION
  %%--------------------------------------------------------------------------
  subgraph CD["ğŸš€ CD â€” Deployment Automation"]
    direction TB
    IAC_APPLY["ğŸ—ï¸ Provision / Configure Infra<br/>Terraform / CloudFormation / Ansible"]
    DEPLOY_STG["ğŸš€ Deploy â†’ Staging<br/>SSH pull + docker-compose up -d<br/>or apply K8s manifests"]
    SMOKE["ğŸ§ª Staging Verification<br/>â€¢ Web UI + map layers<br/>â€¢ /api + /graphql<br/>â€¢ Focus Mode (citations)<br/>â€¢ DB migrations/seeds"]
    DAST["ğŸ•·ï¸ DAST (staging)<br/>API + UI attack-surface checks"]
    APPROVAL{"ğŸ›‘ Approval Gate<br/>manual + policy checks"}
    DEPLOY_PROD["ğŸš€ Deploy â†’ Production<br/>compose restart / rolling update"]
    POSTCHECK["âœ… Post-Deploy Checks<br/>port scan (80/443)<br/>basic vuln scan + health checks"]

    IAC_APPLY --> DEPLOY_STG --> SMOKE --> DAST --> APPROVAL --> DEPLOY_PROD --> POSTCHECK
  end
  class DAST,POSTCHECK sec
  class APPROVAL gate

  REGISTRY -->|pull images| DEPLOY_STG
  RELEASE -->|tag/version| DEPLOY_STG
  GHA_SECRETS -.->|SSH deploy key| DEPLOY_STG

  %%--------------------------------------------------------------------------
  %% ğŸ›°ï¸ RUNTIME â€” KFM STACK
  %%--------------------------------------------------------------------------
  subgraph RUNTIME["ğŸ›°ï¸ Runtime â€” KFM Stack (Docker Compose / â˜¸ï¸ K8s)"]
    direction TB
    HOST["ğŸ–¥ï¸ Ubuntu Server / Cloud VM<br/>public: 80/443"]
    PROXY["ğŸŒ Nginx / Apache Reverse Proxy<br/>TLS (Let's Encrypt)<br/>security headers + caching"]
    ORCH["ğŸ³ docker-compose.yml<br/>or â˜¸ï¸ Kubernetes/ECS"]

    WEB["ğŸ–¥ï¸ web (React)<br/>static assets"]
    API["ğŸ§  api (FastAPI + Uvicorn)<br/>REST / GraphQL / Focus Mode"]
    POSTGIS["ğŸ—ºï¸ db-postgis<br/>PostgreSQL + PostGIS"]
    NEO4J["ğŸ•¸ï¸ db-neo4j<br/>Graph DB"]
    OLLAMA["ğŸ¤– ollama<br/>LLM service"]
    OPA["ğŸ›¡ï¸ opa (OPA)<br/>Policy-as-Code sidecar"]
    SECRETS_RT["ğŸ”‘ Secrets + Env<br/>.env.example â†’ prod .env<br/>Docker secrets"]

    HOST --> PROXY
    HOST --> ORCH

    PROXY --> WEB
    PROXY --> API

    ORCH --> WEB
    ORCH --> API
    ORCH --> POSTGIS
    ORCH --> NEO4J
    ORCH --> OLLAMA
    ORCH --> OPA

    API --> POSTGIS
    API --> NEO4J
    API --> OLLAMA
    API --> OPA

    SECRETS_RT --> API
    SECRETS_RT --> POSTGIS
    SECRETS_RT --> NEO4J
    SECRETS_RT --> OLLAMA
  end
  class HOST,PROXY,ORCH,WEB,API,POSTGIS,NEO4J,OLLAMA,OPA,SECRETS_RT runtime

  DEPLOY_PROD -->|restart/update| ORCH
  DEPLOY_PROD -->|config/proxy reload| PROXY

  %%--------------------------------------------------------------------------
  %% ğŸ“ˆ OBSERVABILITY + OPS + FEEDBACK LOOP
  %%--------------------------------------------------------------------------
  subgraph OBS["ğŸ“ˆ Observability, Ops, and Feedback"]
    direction TB
    LOGS["ğŸªµ Centralized Logs<br/>proxy + api + DB"]
    METRICS["ğŸ“ˆ Metrics<br/>Prometheus"]
    DASH["ğŸ“Š Dashboards<br/>Grafana"]
    ALERTS["ğŸš¨ Alerts<br/>on-call / email / chat"]
    BACKUPS["ğŸ’¾ Backups<br/>Postgres + Neo4j"]
    AUDIT["ğŸ§¾ Audit Trails<br/>auth + data access"]

    LOGS --> DASH
    METRICS --> DASH --> ALERTS

    POSTGIS --> BACKUPS
    NEO4J --> BACKUPS
    API --> AUDIT
  end
  class LOGS,METRICS,DASH,ALERTS,BACKUPS,AUDIT obs

  API --> LOGS
  PROXY --> LOGS
  API --> METRICS

  %% ğŸ” Continuous feedback into engineering
  ALERTS -->|incident / bug report| REPO

  %% ğŸ§¯ Recovery path (conceptual)
  POSTCHECK -->|rollback â†’ redeploy previous tag| DEPLOY_PROD

