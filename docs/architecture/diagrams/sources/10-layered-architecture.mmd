%% ğŸ“ docs/architecture/diagrams/sources/
%% â””â”€â”€ 10-layered-architecture.mmd
%%
%% ğŸ§­ Kansas Frontier Matrix (KFM) â€” 10-Layered Architecture
%% Evidence-first â€œTruth Pathâ€: Raw âœ Processed âœ Catalog âœ Databases âœ API âœ UI/AI
%% Source: "Kansas Frontier Matrix (KFM) â€“ Comprehensive System Documentation" (project PDF)

%%{init: {"theme":"base","flowchart":{"curve":"linear"},"themeVariables":{"fontFamily":"ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial","fontSize":"14px"}}}%%
flowchart TB

  %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  %% 10 Layers (top-to-bottom data pipeline + governed request path)
  %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  L01["01ï¸âƒ£ External Data Sources ğŸ“¦<br/>â€¢ State & federal open data (CSV, APIs, ArcGIS services)<br/>â€¢ Community archives (PDFs, photos, oral history)<br/>â€¢ Remote sensing & LiDAR (STAC feeds)"]:::layer

  L02["02ï¸âƒ£ Ingestion & Orchestration ğŸ“¥<br/>â€¢ Connectors, harvesters, stream subscribers<br/>â€¢ Schedulers: Airflow / Step Functions<br/>â€¢ Streams: Kafka / Kinesis"]:::layer

  L03["03ï¸âƒ£ Immutable Raw Storage ğŸ§Š<br/>â€¢ Append-only landing zone (object storage)<br/>â€¢ Raw retained for audit + reprocessing"]:::layer

  L04["04ï¸âƒ£ Processing & Normalization ğŸ­<br/>â€¢ Cleaning, schema harmonization, reprojection<br/>â€¢ Raster prep: COG + pyramids/tiles<br/>â€¢ Extract time/entity hints where possible"]:::layer

  L05["05ï¸âƒ£ Curated Data Products ğŸ§°<br/>â€¢ Processed datasets + derived layers + tiles<br/>â€¢ Standardized, versioned, reproducible outputs"]:::layer

  L06["06ï¸âƒ£ Catalog & Metadata ğŸ—‚ï¸<br/>â€¢ STAC / DCAT (discoverability + interoperability)<br/>â€¢ JSON-LD / dataset contracts"]:::layer

  L07["07ï¸âƒ£ Provenance & Governance Ledger ğŸ”<br/>â€¢ W3C PROV lineage links (\"map behind the map\")<br/>â€¢ License/sensitivity gates + signed audit trails"]:::layer

  L08["08ï¸âƒ£ Runtime Knowledge Stores ğŸ—ƒï¸<br/>â€¢ PostGIS (spatial) + Neo4j (knowledge graph)<br/>â€¢ Search index + vector store (semantic retrieval)<br/>â€¢ Object storage for large assets (COGs, PDFs, tiles)"]:::layer

  L09["09ï¸âƒ£ Service & Policy Gateway ğŸŒ<br/>â€¢ FastAPI: REST + GraphQL + OpenAPI<br/>â€¢ Adapter modules for PostGIS/Neo4j/indexes<br/>â€¢ OPA middleware enforces authz + rules"]:::layer

  L10["ğŸ”Ÿ User Experiences ğŸ—ºï¸ğŸ¤–<br/>â€¢ React/TypeScript web app (MapLibre + Cesium 3D)<br/>â€¢ Timelines, narratives, external clients (mobile/AR)<br/>â€¢ Focus Mode: RAG retrieval + Ollama LLM + citations"]:::layer

  %% Data â€œtruth pathâ€ (publication pipeline)
  L01 -->|collect| L02
  L02 -->|land raw| L03
  L03 -->|transform| L04
  L04 -->|produce curated| L05
  L05 -->|describe| L06
  L06 -->|prove & gate| L07
  L07 -->|load| L08
  L08 -->|serve| L09
  L09 -->|deliver| L10

  %% Governed request path (runtime queries)
  L10 -.->|queries| L09
  L09 -.->|retrieves| L08

  %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  %% Focus Mode loop (API-orchestrated, citation-first, policy-checked)
  %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  subgraph FM["ğŸ§  Focus Mode Loop (API-orchestrated, citation-first)"]
    Q["User question"]:::focus
    R["Retrieve context<br/>â€¢ Neo4j + PostGIS + search/vector"]:::focus
    G["Generate draft<br/>â€¢ Ollama LLM service"]:::focus
    P["Policy check<br/>â€¢ OPA (citations, sensitivity, role)"]:::focus
    A["Answer + citation map<br/>â€¢ UI shows audit panel"]:::focus
    Q --> R --> G --> P --> A
  end

  %% Hook Focus Mode into layered architecture
  L10 -.-> Q
  A -.-> L10
  L09 -.-> R
  R -.-> L08
  G -.-> L09
  P -.-> L07

  %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  %% Optional platform foundation (cross-cutting, not a numbered layer)
  %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  subgraph PF["âš™ï¸ Platform Foundation (cross-cutting)"]
    DEP["Containers & orchestration<br/>â€¢ Docker + Kubernetes / ECS"]:::platform
    SEC["Security posture<br/>â€¢ least-privilege services<br/>â€¢ centralized policy gates (OPA)"]:::platform
    OBS["Observability<br/>â€¢ logs + metrics + auditability"]:::platform
  end

  DEP -.-> L02
  DEP -.-> L09
  SEC -.-> L09
  SEC -.-> L10
  OBS -.-> L07
  OBS -.-> L09
  OBS -.-> L10

  %% Styling
  classDef layer fill:#f8fafc,stroke:#334155,color:#0f172a,stroke-width:1px;
  classDef focus fill:#ecfdf5,stroke:#16a34a,color:#052e16,stroke-width:1px;
  classDef platform fill:#fff7ed,stroke:#c2410c,color:#431407,stroke-width:1px;

