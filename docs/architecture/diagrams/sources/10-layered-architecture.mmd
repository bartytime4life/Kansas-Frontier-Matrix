flowchart TB
  %% ðŸ§­ KFM â€” 10-layered architecture (source diagram)
  %% Truth Path: Raw -> Processed -> Catalog -> Databases -> API -> UI/AI

  L01["01 External Data Sources ðŸ“¦\n- state/federal open data\n- community archives\n- remote sensing & LiDAR"]:::layer
  L02["02 Ingestion & Orchestration ðŸ“¥\n- connectors/harvesters\n- schedulers (Airflow/Step Functions)\n- streams (Kafka/Kinesis)"]:::layer
  L03["03 Immutable Raw Storage ðŸ§Š\n- append-only landing zone\n- raw retained for audit/reprocessing"]:::layer
  L04["04 Processing & Normalization ðŸ­\n- clean/harmonize/reproject\n- raster prep (COG/tiles)\n- extract hints (time/entities)"]:::layer
  L05["05 Curated Data Products ðŸ§°\n- processed datasets + derived layers\n- versioned, reproducible outputs"]:::layer
  L06["06 Catalog & Metadata ðŸ—‚ï¸\n- STAC / DCAT\n- dataset contracts (JSON-LD)"]:::layer
  L07["07 Provenance & Governance Ledger ðŸ”Ž\n- W3C PROV lineage\n- license/sensitivity gates + audit trails"]:::layer
  L08["08 Runtime Knowledge Stores ðŸ—ƒï¸\n- PostGIS + Neo4j\n- search index + vector store\n- object storage (COGs/PDFs/tiles)"]:::layer
  L09["09 Service & Policy Gateway ðŸŒ\n- FastAPI (REST/GraphQL)\n- adapters for stores\n- OPA policy enforcement"]:::layer
  L10["10 User Experiences ðŸ—ºï¸ðŸ¤–\n- React UI (MapLibre/Cesium)\n- timelines + stories\n- Focus Mode (RAG + citations)"]:::layer

  %% Truth Path (publish pipeline)
  L01 -->|collect| L02 -->|land raw| L03 -->|transform| L04 -->|produce curated| L05 -->|describe| L06 -->|prove & gate| L07 -->|load| L08 -->|serve| L09 -->|deliver| L10

  %% Governed request path (runtime)
  L10 -.->|queries| L09
  L09 -.->|retrieves| L08

  %% Focus Mode loop (API-orchestrated)
  subgraph FM["Focus Mode Loop ðŸ§  (citation-first, policy-checked)"]
    Q["User question"]:::focus
    R["Retrieve context\n- PostGIS / Neo4j / search+vector"]:::focus
    G["Generate draft\n- LLM (Ollama)"]:::focus
    P["Policy check\n- OPA + sensitivity rules"]:::focus
    A["Answer + citation map\n- UI audit panel"]:::focus
    Q --> R --> G --> P --> A
  end

  L10 -.-> Q
  A -.-> L10
  L09 -.-> R
  R -.-> L08
  P -.-> L07

  %% Cross-cutting platform foundation (not a numbered layer)
  subgraph PF["Platform Foundation âš™ï¸ (cross-cutting)"]
    DEP["Containers & orchestration\n- Docker + K8s/ECS"]:::platform
    SEC["Security posture\n- least privilege + centralized policy"]:::platform
    OBS["Observability\n- logs/metrics/auditability"]:::platform
  end

  DEP -.-> L02
  DEP -.-> L09
  SEC -.-> L09
  SEC -.-> L10
  OBS -.-> L07
  OBS -.-> L09
  OBS -.-> L10

  classDef layer fill:#f8fafc,stroke:#334155,color:#0f172a,stroke-width:1px;
  classDef focus fill:#ecfdf5,stroke:#16a34a,color:#052e16,stroke-width:1px;
  classDef platform fill:#fff7ed,stroke:#c2410c,color:#431407,stroke-width:1px;
