%%-------------------------------------------------------------
%% Kansas Frontier Matrix â€” UI Component Flow (React â†” FastAPI)
%% File: docs/design/diagrams/ui_component_flow.mmd
%% Author: Kansas Frontier Matrix Â· Systems & UI Architecture Team
%% License: CC-BY-4.0
%% Last Updated: {{ ISO8601_DATE }}
%%-------------------------------------------------------------

flowchart LR
  %% ===== FRONTEND (React SPA) =====
  subgraph FE["Frontend (React + MapLibreGL + D3.js)"]
    SB["ðŸ”Ž SearchBar.tsx\nâ€¢ query input\nâ€¢ autosuggest\nâ€¢ keyboard nav"]
    TL["ðŸ•°ï¸ TimelineCanvas.tsx\nâ€¢ D3/canvas render\nâ€¢ range select\nâ€¢ play controls"]
    MV["ðŸ—ºï¸ MapView.tsx\nâ€¢ MapLibreGL layers\nâ€¢ popups/markers\nâ€¢ hover/select"]
    DP["ðŸ“‹ DetailPanel.tsx\nâ€¢ entity dossier\nâ€¢ sources & links\nâ€¢ AI summary"]
    LC["ðŸ§­ LayerControls.tsx\nâ€¢ toggle STAC layers\nâ€¢ legends\nâ€¢ opacity"]
    AP["ðŸ¤– AssistantPanel.tsx\nâ€¢ /ask Q&A\nâ€¢ context injection\nâ€¢ citations"]

    ST["ðŸ§  UI State (Context/Store)\nâ€¢ selectedEntity\nâ€¢ timeRange\nâ€¢ activeLayers\nâ€¢ searchQuery"]
    SB -->|setQuery| ST
    TL -->|setTimeRange| ST
    LC -->|setActiveLayers| ST
    MV -->|setSelectedEntity| ST
    ST --> MV
    ST --> TL
    ST --> DP
    ST --> LC
  end

  %% ===== BACKEND (FastAPI + Graph DB + Files) =====
  subgraph BE["Backend (FastAPI Â· GraphQL Â· Neo4j Â· COG/GeoJSON Store)"]
    API_SEARCH["/search\nâ€¢ people/places/events\nâ€¢ suggestions"]
    API_EVENTS["/events\nâ€¢ time-filtered list\nâ€¢ bbox filter"]
    API_ENTITY["/entity/{id}\nâ€¢ node + relations\nâ€¢ provenance"]
    API_LAYERS["/layers-config\nâ€¢ STAC-driven list\nâ€¢ styles/legends"]
    API_ASK["/ask\nâ€¢ NL Q&A\nâ€¢ citations"]

    NEO["Neo4j\n(knowledge graph)"]
    STAC["STAC Catalog\n(data/stac/*)"]
    FILES["Static Files / Tiles\nâ€¢ COG rasters\nâ€¢ GeoJSON vectors"]
    API_SEARCH --> NEO
    API_EVENTS --> NEO
    API_ENTITY --> NEO
    API_LAYERS --> STAC
    MV <-->|tiles / data| FILES
  end

  %% ===== DATA FLOWS =====
  SB -- "GET /search?q=â€¦" --> API_SEARCH
  API_SEARCH -- "results" --> SB

  TL -- "GET /events?start={t0}&end={t1}&bbox=â€¦" --> API_EVENTS
  API_EVENTS -- "events[]" --> TL
  TL -- "select event" --> DP

  MV -- "GET /layers-config" --> API_LAYERS
  API_LAYERS -- "layer list" --> MV
  LC -- "toggle layer" --> MV
  MV -- "click marker â†’ load entity" --> API_ENTITY
  API_ENTITY -- "entity + relations" --> DP

  AP -- "POST /ask {question, context}" --> API_ASK
  API_ASK -- "answer + citations" --> AP
  AP --> DP

  %% ===== STATE SYNC =====
  ST -. "selectedEntity change" .-> DP
  ST -. "timeRange change" .-> MV
  ST -. "activeLayers change" .-> MV

  %% ===== ERROR & RETRY PATHS =====
  classDef warn fill:#FFF6E5,stroke:#FF851B,stroke-width:1px,color:#5A3E00
  ERR1["âš ï¸ Network/Error Handler\nâ€¢ backoff retry\nâ€¢ toast/inline message\nâ€¢ accessibility alerts"]
  FE --> ERR1
  BE --> ERR1

  %% ===== STYLES =====
  style FE fill:#F8FAFF,stroke:#6A8BD1,stroke-width:2px
  style BE fill:#F6FFFB,stroke:#2ECC71,stroke-width:2px
  style ST fill:#FFF0F5,stroke:#FF69B4,stroke-width:1.5px

%% END OF MERMAID