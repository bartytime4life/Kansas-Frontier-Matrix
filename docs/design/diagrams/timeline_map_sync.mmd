%%-------------------------------------------------------------
%% Kansas Frontier Matrix â€” Timeline â‡„ Map Synchronization Flow
%% File: docs/design/diagrams/timeline_map_sync.mmd
%% License: CC-BY-4.0
%% Last Updated: {{ ISO8601_DATE }}
%%-------------------------------------------------------------

flowchart LR
  %% ===== FRONTEND CONTEXT =====
  subgraph FE["Frontend (React + MapLibreGL + D3.js)"]
    TL["ðŸ•°ï¸ TimelineCanvas\nâ€¢ zoom/scroll\nâ€¢ range handles\nâ€¢ play/step"]
    MV["ðŸ—ºï¸ MapView\nâ€¢ STAC layers\nâ€¢ markers/popups\nâ€¢ hover/select"]
    LC["ðŸ§­ LayerControls\nâ€¢ toggle layers\nâ€¢ opacity/legend"]
    ST["ðŸ§  UI Store (Context)\nâ€¢ timeRange\nâ€¢ activeLayers\nâ€¢ selectedEntity\nâ€¢ bbox"]
    ACC["â™¿ Accessibility Hooks\nâ€¢ focus order\nâ€¢ ARIA\nâ€¢ keyboard nav"]
    TL -->|set timeRange| ST
    LC -->|set activeLayers| ST
    MV -->|set selectedEntity| ST
    ACC --- TL
    ACC --- MV
  end

  %% ===== API & DATA =====
  subgraph BE["Backend (FastAPI Â· GraphQL Â· Neo4j Â· STAC)"]
    API_EVENTS["/events?start={t0}&end={t1}&bbox=â€¦\nâ€¢ time-filtered entities"]
    API_LAYERS["/layers-config\nâ€¢ STAC-driven list\nâ€¢ style/legend"]
    API_ENTITY["/entity/{id}\nâ€¢ node + relations\nâ€¢ provenance"]
    NEO["Neo4j Knowledge Graph\n(Person Â· Place Â· Event Â· Document)"]
    STAC["STAC Catalog\n(data/stac/*)\nâ€¢ temporal/spatial extents"]
    API_EVENTS --> NEO
    API_ENTITY --> NEO
    API_LAYERS --> STAC
  end

  %% ===== TILE/ASSET =====
  subgraph FS["Static Data / Tiles"]
    TILES["COG tiles (rasters)"]
    GEOJSON["GeoJSON vectors (events, trails)"]
  end

  %% ===== INTERACTIONS =====
  ST -- "timeRange change" --> TL
  ST -- "timeRange change" --> MV
  ST -- "activeLayers change" --> MV
  ST -- "selectedEntity change" --> MV

  TL -- "GET /events (t0,t1,bbox)" --> API_EVENTS
  API_EVENTS -- "events[]" --> TL
  TL -- "hover/click event" --> MV

  MV -- "GET /layers-config" --> API_LAYERS
  API_LAYERS -- "layers[]" --> MV
  MV <-->|tiles/data| TILES
  MV <-->|features| GEOJSON

  MV -- "click marker â†’ /entity/{id}" --> API_ENTITY
  API_ENTITY -- "entity + relations" --> MV

  %% ===== PLAYBACK LOOP =====
  subgraph PLAY["Story/Playback"]
    BTN["â–¶ï¸Ž Play / â¸ Pause / â® â­ Step"]
    TICK["Frame Ticker\nâ€¢ Î”t per step\nâ€¢ easing"]
  end
  BTN --> TICK --> TL
  TICK -->|update timeRange| ST

  %% ===== ERROR/RETRY =====
  classDef warn fill:#FFF6E5,stroke:#FF851B,stroke-width:1px,color:#5A3E00
  ERR["âš ï¸ Network/Error Handler\nâ€¢ backoff retry\nâ€¢ offline hint\nâ€¢ a11y announcements"]
  FE --> ERR
  BE --> ERR

  %% ===== LAYERS OF CONCERN =====
  classDef fe fill:#F8FAFF,stroke:#6A8BD1,stroke-width:2px
  classDef be fill:#F6FFFB,stroke:#2ECC71,stroke-width:2px
  classDef fs fill:#F0FFFF,stroke:#39CCCC,stroke-width:2px
  classDef play fill:#FFF0F5,stroke:#FF69B4,stroke-width:2px
  class FE fe
  class BE be
  class FS fs
  class PLAY play
  class ERR warn