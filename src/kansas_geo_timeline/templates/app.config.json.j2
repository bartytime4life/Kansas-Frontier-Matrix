{# -----------------------------------------------------------------------------
  Kansas Geo Timeline — app.config.json template
  - JSON-safe: all strings/bools routed through |tojson
  - Clamp defaultYear to [time.min, time.max]
  - Layer URL resolution precedence: url > tiles[0] > path
  - Image overlays: accept either 'coordinates' or 'bbox' ([w,s,e,n])
  - Optional OSM basemap (include_osm=true by default)
----------------------------------------------------------------------------- #}

{# ---------- derived scalars (clamp defaultYear) --------------------------- #}
{% set _min_year = (start_year | default(1850)) | int %}
{% set _max_year = (end_year   | default(2025)) | int %}
{% set _want_def = default_year if default_year is defined else _min_year %}
{% set _def_year = [_min_year, (_want_def | int), _max_year] | sort | nth(1) %}

{
  "title": {{ (title | default("Kansas-Frontier-Matrix", true)) | tojson }},
  "subtitle": {{ (subtitle | default("Time-aware historical GIS for Kansas", true)) | tojson }},
  "style": {{ (style | default("https://demotiles.maplibre.org/style.json", true)) | tojson }},

  "center": [{{ (center_lon | default(-98.3)) | float }}, {{ (center_lat | default(38.5)) | float }}],
  "zoom": {{ (zoom | default(6)) | float }},

  "time": { "min": {{ _min_year }}, "max": {{ _max_year }} },
  "defaultYear": {{ _def_year }},

  "defaults": {
    "minzoom": {{ (minzoom | default(0)) | int }},
    "maxzoom": {{ (maxzoom | default(15)) | int }},
    "tileSize": {{ (tilesize | default(256)) | int }},
    "visible": {{ (visible | default(true)) | tojson }},
    "opacity": {{ (opacity | default(1.0)) | float }},
    "bounds": {{ (bounds | default([-102.05, 36.99, -94.59, 40.00])) | tojson }}
  },

  "layers": [
    {# ---------- Optional OSM basemap -------------------------------------- #}
    {% set include_osm = include_osm if include_osm is defined else true %}
    {% if include_osm %}
    {
      "id": "basemap_osm",
      "title": "Basemap — OpenStreetMap",
      "group": {{ (basemap_group | default("Basemaps & Terrain")) | tojson }},
      "type": "raster",
      "url": "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
      "opacity": 1.0,
      "minzoom": 0,
      "maxzoom": 19,
      "visible": true,
      "attribution": "© OpenStreetMap contributors"
    }{% if layers is defined and layers %},{% endif %}
    {% endif %}

    {# ---------- Hand-authored (or STAC-rendered) layers ------------------- #}
    {% if layers is defined and layers %}
      {%- for ly in layers -%}
      {# Resolve a URL: prefer explicit URL, then tiles[0], then path #}
      {%- set _url = (
            ly.url
            if ly.url is defined else
            (ly.tiles[0] if ly.tiles is defined and ly.tiles and ly.tiles[0] is defined else
             (ly.path if ly.path is defined else none))
          )
      -%}

      {# If it's an image overlay and only bbox is given, build coordinates:
         bbox = [w,s,e,n] -> [[w,n],[e,n],[e,s],[w,s]] #}
      {%- set _coords = none -%}
      {%- if ly.type is defined and ly.type == "image" -%}
        {%- if ly.coordinates is defined -%}
          {%- set _coords = ly.coordinates -%}
        {%- elif ly.bbox is defined and (ly.bbox | length) >= 4 -%}
          {%- set _w = ly.bbox[0] -%}
          {%- set _s = ly.bbox[1] -%}
          {%- set _e = ly.bbox[2] -%}
          {%- set _n = ly.bbox[3] -%}
          {%- set _coords = [[_w,_n],[_e,_n],[_e,_s],[_w,_s]] -%}
        {%- endif -%}
      {%- endif -%}

      {
        "id": {{ ly.id | tojson }},
        "title": {{ (ly.title | default(ly.id)) | tojson }},
        "group": {{ (ly.group | default("Layers")) | tojson }},
        "type": {{ (ly.type | default("raster")) | tojson }},
        "url": {{ (_url | default("", true)) | tojson }},
        {% if _coords is not none %}"coordinates": {{ _coords | tojson }},{% endif %}
        "opacity": {{ (ly.opacity | default(1.0)) | float }},
        "minzoom": {{ (ly.minzoom | default(minzoom | default(0))) | int }},
        "maxzoom": {{ (ly.maxzoom | default(maxzoom | default(15))) | int }},
        "visible": {{ (ly.visible is not defined or ly.visible | bool) | tojson }},
        {% if ly.start is defined %}"start": {{ (ly.start | int) }},{% endif %}
        {% if ly.end   is defined %}"end":   {{ (ly.end   | int) }},{% endif %}
        {% if ly.paint is defined %}"paint": {{ ly.paint | tojson }},{% endif %}
        {% if ly.attribution is defined %}"attribution": {{ ly.attribution | tojson }},{% endif %}
        {% if ly.extra is defined %}"extra": {{ ly.extra | tojson }},{% endif %}
        "_generated": true
      }{{ "," if not loop.last }}
      {%- endfor -%}
    {% endif %}
  ]
}
