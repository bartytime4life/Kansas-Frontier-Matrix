%% Kansas Frontier Matrix (KFM) — Lineage Flow (v11)
%% File: src/pipelines/architecture/architecture_diagrams/lineage_flow.mmd
%% Purpose:
%% - End-to-end provenance lineage from source intake → processing → catalogs → graph → API → web UI
%% - PROV-O concepts: prov:Entity, prov:Activity, prov:Agent
%% - Governance-first: CARE/sovereignty constraints are evaluated before publish/release

flowchart TB

  %% ------------------------------------------------------------
  %% Sources + intake (entities)
  %% ------------------------------------------------------------
  subgraph SOURCES["Sources + intake (prov:Entity)"]
    S_EXT["External source\n(archive/GIS portal/agency API/scans)"]
    S_MAN["Source manifest\n(data/sources/*.yml: uri, license, retrieval_date, checksums, restrictions, steward)"]
    S_RAW["Raw artifacts\n(data/raw/{source_id}/**)"]
    S_CHK["Checksum records\n(sha256 parity for raw + derived assets)"]
  end

  %% ------------------------------------------------------------
  %% Activities (prov:Activity)
  %% ------------------------------------------------------------
  subgraph ACTIVITIES["Pipeline activities (prov:Activity)"]
    A_EXTRACT["Extract\n(fetch + verify + normalize filenames)"]
    A_TRANSFORM["Transform\n(parse/clean/georef/normalize; deterministic)"]
    A_CATALOG["Catalog registration\n(STAC/DCAT + asset linking)"]
    A_VALIDATE["Validate\n(schema + geo-safety + FAIR+CARE checks)"]
    A_GOV["Governance decision\n(certify/provisional/block; append-only ledger)"]
    D_CERT{"Certified to publish?"}
    A_GRAPH["Graph ingest\n(Neo4j upsert/merge; version-aware)"]
    A_PUBLISH["Publish\n(API deploy + web build)"]
  end

  %% ------------------------------------------------------------
  %% Derived artifacts (entities)
  %% ------------------------------------------------------------
  subgraph ARTIFACTS["Derived artifacts (prov:Entity)"]
    E_PROC["Processed outputs\n(data/processed/{dataset_id}/{version}/**)"]
    E_STAC["STAC records\n(data/stac/**: Collections + Items + assets)"]
    E_DCAT["DCAT view\n(datasets + distributions; license/publisher/coverage)"]
    E_PROV["PROV traces\n(mcp/runs/{run_id}/** + data/reports/audit/**)"]
    E_REPORTS["Validation reports\n(data/reports/**: self-validation, fair, audit)"]
    E_LEDGER["Governance ledger entries\n(data/reports/audit/**; append-only)"]
    E_TELEM["Telemetry events\n(releases/**/focus-telemetry.json; non-PII)"]
    E_RELEASE["Release artifacts\n(releases/{version}/: manifest.zip + sbom.spdx.json + signatures/attestations)"]
  end

  %% ------------------------------------------------------------
  %% Graph → API → UI (entities)
  %% ------------------------------------------------------------
  subgraph DELIVERY["Graph + API + UI (prov:Entity)"]
    E_GRAPH["Graph state\n(Neo4j entities + relationships; stable URNs)"]
    E_API["API payloads\n(OpenAPI/GraphQL; governed shapes)"]
    E_UI["Web UI views\n(Story Nodes + Focus Mode consume API only)"]
  end

  %% ------------------------------------------------------------
  %% Agents (prov:Agent)
  %% ------------------------------------------------------------
  subgraph AGENTS["Agents (prov:Agent)"]
    AG_USER["Maintainer / operator"]
    AG_CI["CI runner"]
    AG_BOT["Governance bot / service account"]
    AG_API["API service"]
    AG_WEB["Web client"]
  end

  %% ------------------------------------------------------------
  %% Legend (relationship hints)
  %% ------------------------------------------------------------
  subgraph LEGEND["Legend (PROV relationship intent)"]
    L_USED["used = prov:used"]
    L_GEN["generated = prov:wasGeneratedBy"]
    L_DERIVE["derived = prov:wasDerivedFrom"]
    L_ASSOC["associated = prov:wasAssociatedWith"]
  end

  %% ----------------------------
  %% Associations (agents)
  %% ----------------------------
  AG_USER -->|associated| A_EXTRACT
  AG_CI -->|associated| A_VALIDATE
  AG_BOT -->|associated| A_GOV
  AG_API -->|associated| A_PUBLISH
  AG_WEB -->|associated| E_UI

  %% ----------------------------
  %% Intake → extract
  %% ----------------------------
  S_EXT -->|used| A_EXTRACT
  S_MAN -->|used| A_EXTRACT
  A_EXTRACT -->|generated| S_RAW
  S_RAW -->|generated| S_CHK

  %% ----------------------------
  %% Transform
  %% ----------------------------
  S_RAW -->|used| A_TRANSFORM
  S_CHK -->|used| A_TRANSFORM
  A_TRANSFORM -->|generated| E_PROC
  E_PROC -->|derived| S_RAW

  %% ----------------------------
  %% Catalog registration
  %% ----------------------------
  E_PROC -->|used| A_CATALOG
  A_CATALOG -->|generated| E_STAC
  A_CATALOG -->|generated| E_DCAT
  E_STAC -->|derived| E_PROC
  E_DCAT -->|derived| E_PROC

  %% ----------------------------
  %% Validation (gates)
  %% ----------------------------
  E_PROC -->|used| A_VALIDATE
  E_STAC -->|used| A_VALIDATE
  E_DCAT -->|used| A_VALIDATE
  S_MAN -->|used| A_VALIDATE
  A_VALIDATE -->|generated| E_REPORTS
  A_VALIDATE -->|generated| E_PROV

  %% ----------------------------
  %% Governance decision
  %% ----------------------------
  E_REPORTS -->|used| A_GOV
  E_PROV -->|used| A_GOV
  A_GOV -->|generated| E_LEDGER
  A_GOV --> D_CERT

  %% ----------------------------
  %% Certified → graph ingest → publish
  %% ----------------------------
  D_CERT -- "yes" --> A_GRAPH
  D_CERT -- "no" --> E_LEDGER

  E_STAC -->|used| A_GRAPH
  E_DCAT -->|used| A_GRAPH
  E_PROC -->|used| A_GRAPH
  A_GRAPH -->|generated| E_GRAPH

  E_GRAPH -->|used| A_PUBLISH
  A_PUBLISH -->|generated| E_API
  E_API -->|used| E_UI

  %% ----------------------------
  %% Telemetry + release artifacts (statement of record)
  %% ----------------------------
  E_UI -->|generated| E_TELEM
  E_LEDGER -->|used| E_RELEASE
  E_TELEM -->|used| E_RELEASE
  E_STAC -->|used| E_RELEASE
  E_DCAT -->|used| E_RELEASE
  E_PROV -->|used| E_RELEASE
