flowchart TD
  subgraph OFFLINE["Offline AI build and governance"]
    DATA["Validated datasets and docs"] --> TRAIN["Model training and tuning (src/ai)"]
    TRAIN --> ART["Model artifacts (weights, prompts)"]
    TRAIN --> CARDS["Model card and provenance (mcp/model_cards)"]
    CARDS --> AUDIT["AI audits (tools/ai)"]
    AUDIT --> APPROVED["Approved model release"]
  end
  subgraph ONLINE["Online Focus Mode request"]
    USER["User selects a story, place, or region"] --> UI["Web UI (React, MapLibre, Cesium)"]
    UI --> API["API layer (REST and GraphQL)"]
    API --> QUERY["Focus context query (resolver or Cypher)"]
    QUERY --> GRAPH["Knowledge graph (Neo4j)"]
    QUERY --> CATALOG["Catalogs (STAC, DCAT, PROV)"]
    QUERY --> DOCS["Story nodes and docs (structured, governed)"]
    GRAPH --> RAWCTX["Context draft (subgraph and entities)"]
    CATALOG --> RAWCTX
    DOCS --> RAWCTX
    RAWCTX --> POLICY["Policy gate (FAIR+CARE, sovereignty, auth)"]
    POLICY --> CTX["Context bundle (facts, citations, allowed transforms)"]
    APPROVED --> GEN["Focus Mode generator (summary, timeline, highlight)"]
    ART --> GEN
    CTX --> GEN
    GEN --> OUT["Output package (narrative, citations, explanation, audit notice)"]
    OUT --> API
    API --> UI
    CATALOG --> EVID["Evidence assets (STAC item assets)"]
    EVID --> UI
  end
  subgraph OBS["Telemetry and governance evidence"]
    API --> TEL["Telemetry collector (tools/telemetry)"]
    GEN --> TEL
    POLICY --> TEL
    TEL --> BUNDLE["Telemetry bundle (focus-telemetry.json)"]
    TEL --> LEDGER["Governance ledger entry"]
  end
