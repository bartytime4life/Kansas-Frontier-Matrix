%% KFM Telemetry Flow (v11.x)
%% Scope: end-to-end telemetry (pipeline + governance + API + web) with non-PII constraints.

flowchart TB

subgraph EMIT["Emitters (where telemetry originates)"]
  E_ETL["ETL + processing runs<br/>(src/pipelines/**)"]
  E_VALID["Validation + QA tools<br/>(tools/validation/**)"]
  E_GOV["Governance tools<br/>(tools/governance/**)"]
  E_CI["CI/CD workflows<br/>(.github/workflows/**)"]
  E_API["API service runtime<br/>(src/api/**)"]
  E_WEB["Web client runtime<br/>(web/**)"]
  E_AI["AI/ML jobs (when used)<br/>(mcp/experiments/** + mcp/model_cards/**)"]
end

subgraph EVENTS["Event families (non-PII by design)"]
  F_PIPE["Pipeline events<br/>(run start/end, step timings, row/feature counts)"]
  F_DATA["Data quality events<br/>(schema validation, completeness, drift flags)"]
  F_GOV["Governance events<br/>(CARE labels, sovereignty flags, certification state)"]
  F_SEC["Security events<br/>(SAST/CodeQL, dep scan, secret/PII scan counts)"]
  F_A11Y["Accessibility events<br/>(a11y checks, Lighthouse/axe summaries)"]
  F_SUS["Sustainability events<br/>(energy Wh + carbon gCO2e estimates)"]
  F_WEB["UX interaction events<br/>(map/timeline/focus/story actions; no PII)"]
  F_API["API performance events<br/>(latency, status, error taxonomy; no request bodies)"]
end

subgraph SDK["Collection + normalization (deterministic)"]
  S_POLICY["Telemetry policy gate<br/>(strip PII, redact sensitive fields, enforce allowlist)"]
  S_CTX["Attach context<br/>(run_id, tool_version, contract_version, dataset_id, care_label)"]
  S_NORM["Normalize to canonical event shape<br/>(stable keys, stable enums, deterministic timestamps)"]
  S_ENRICH["Enrich (safe)<br/>(job/environment metadata, commit hash, artifact refs)"]
end

subgraph VALIDATE["Schema validation (CI-blocking where applicable)"]
  V_SCHEMA["Validate vs telemetry schema<br/>(schemas/telemetry/**)"]
  V_ENERGY["Validate energy schema<br/>(schemas/telemetry/energy-v2.json)"]
  V_CARBON["Validate carbon schema<br/>(schemas/telemetry/carbon-v2.json)"]
  V_OK{"Schema valid?"}
  V_FAIL["Fail + report<br/>(data/reports/** + mcp/runs/** context preserved)"]
end

subgraph STORE["Stores (statement-of-record + working logs)"]
  ST_RUN["Per-run telemetry<br/>(mcp/runs/{run_id}/telemetry*.jsonl)"]
  ST_REPORTS["Ops telemetry reports<br/>(docs/reports/telemetry/**)"]
  ST_RELEASE["Release telemetry bundle<br/>(releases/{version}/focus-telemetry.json)"]
  ST_TOOLS["Tools telemetry bundle<br/>(releases/{version}/tools-telemetry.json)"]
end

subgraph GOVERN["Governance linkage (append-only)"]
  G_LINK["Link telemetry â†” provenance<br/>(PROV used/generated; dataset + run refs)"]
  G_LEDGER["Append governance ledger entry<br/>(data/reports/audit/**)"]
  G_CERT["Certification state updated<br/>(certified / provisional / blocked)"]
end

subgraph CONSUME["Consumers (read-only)"]
  C_DASH["Dashboards / reports<br/>(governance + sustainability + reliability)"]
  C_ALERT["Alerting / anomaly checks<br/>(thresholds, regressions, policy violations)"]
  C_REVIEW["FAIR+CARE Council + auditors<br/>(evidence-led review)"]
  C_OPT["Optimization loop<br/>(performance + cost + energy tuning)"]
end

%% Emitters -> Event families
E_ETL --> F_PIPE
E_ETL --> F_DATA
E_VALID --> F_DATA
E_GOV --> F_GOV
E_CI --> F_SEC
E_CI --> F_A11Y
E_CI --> F_PIPE
E_API --> F_API
E_WEB --> F_WEB
E_AI --> F_DATA
E_AI --> F_SUS
E_ETL --> F_SUS
E_CI --> F_SUS

%% Event families -> Collection
F_PIPE --> S_POLICY
F_DATA --> S_POLICY
F_GOV --> S_POLICY
F_SEC --> S_POLICY
F_A11Y --> S_POLICY
F_SUS --> S_POLICY
F_WEB --> S_POLICY
F_API --> S_POLICY

%% Collection -> Normalize -> Validate
S_POLICY --> S_CTX --> S_NORM --> S_ENRICH --> V_SCHEMA
S_ENRICH --> V_ENERGY
S_ENRICH --> V_CARBON

V_SCHEMA --> V_OK
V_ENERGY --> V_OK
V_CARBON --> V_OK

V_OK -- "no" --> V_FAIL
V_OK -- "yes" --> ST_RUN

%% Store -> Governance linkage
ST_RUN --> ST_REPORTS
ST_RUN --> ST_RELEASE
ST_RUN --> ST_TOOLS

ST_RELEASE --> G_LINK
ST_TOOLS --> G_LINK
G_LINK --> G_LEDGER --> G_CERT

%% Governance -> Consumers
G_CERT --> C_DASH
G_LEDGER --> C_REVIEW
ST_REPORTS --> C_DASH
C_DASH --> C_ALERT
C_ALERT --> C_OPT
C_REVIEW --> C_OPT
