import os, textwrap

base_path = "/mnt/data/src/pipelines/architecture/architecture_diagrams"
os.makedirs(base_path, exist_ok=True)

content = """%% Kansas Frontier Matrix (KFM) â€” Governance Flow (v11)
%% File: src/pipelines/architecture/architecture_diagrams/governance_flow.mmd
%% Notes:
%% - Governance is a first-class pipeline gate for datasets, models, narratives, and releases
%% - Inputs are validation reports + contracts + provenance + telemetry + rights metadata
%% - Outputs are append-only ledgers + certification states + signed release governance manifests

flowchart TB

  %% ------------------------------------------------------------------
  %% Triggers
  %% ------------------------------------------------------------------
  subgraph TRIGGERS["Triggers"]
    T_PR["PR / merge to protected branches"]
    T_SCHED["Scheduled governance/validation runs"]
    T_RELEASE["Release cut (tag/version)"]
    T_LOCAL["Local operator run (CLI)"]
  end

  %% ------------------------------------------------------------------
  %% Evidence inputs (what governance evaluates)
  %% ------------------------------------------------------------------
  subgraph EVIDENCE["Evidence inputs"]
    E_CONTRACTS["Contracts + schemas\\n(docs/contracts/** + schemas/**)"]
    E_REPORTS["Validation reports\\n(data/reports/**: self-validation, fair, audit)"]
    E_PROV["Provenance traces\\n(PROV entities/activities/agents; run logs in mcp/runs/**)"]
    E_CATALOG["Catalog records\\n(STAC/DCAT: data/stac/** + DCAT view)"]
    E_INTEGRITY["Integrity signals\\n(sha256 checksums, SBOM, manifests)"]
    E_TELEM["Telemetry signals\\n(latency/errors/bytes + energy/carbon)"]
    E_RIGHTS["Rights + governance metadata\\n(license, rights-holder, CARE label, sovereignty flags)"]
  end

  %% ------------------------------------------------------------------
  %% Automated validation gates (CI-blocking)
  %% ------------------------------------------------------------------
  subgraph VALIDATION["Automated validation gates (CI-blocking)"]
    V_SCHEMA["Schema validation\\n(STAC/DCAT/JSON/YAML/SHACL where used)"]
    V_SEC["Security + secret/PII scanning\\n(blocks on findings)"]
    V_GEO["Geo safety checks\\n(no precision leaks; masking/generalization enforced)"]
    V_A11Y["A11y checks\\n(WCAG-aligned audits for governed UI content)"]
    V_OK{"All checks pass?"}
    V_FAIL["Fail fast\\nPublish reports; block merge/release"]
  end

  %% ------------------------------------------------------------------
  %% Governance tooling (append-only ledger + certification)
  %% ------------------------------------------------------------------
  subgraph GOVTOOLS["Governance tools"]
    G_SYNC["governance_sync\\nAggregate signals into staging bundle"]
    G_AUDIT["certification_audit\\nFAIR+CARE + ethics + sovereignty + license"]
    G_DECIDE{"Certification state?"}
    G_LEDGER["ledger_update\\nAppend-only signed ledger entry"]
    G_MANIFEST["governance_manifest_generator\\nBundle ledgers + slices + telemetry + contracts"]
  end

  %% ------------------------------------------------------------------
  %% Human oversight (when required)
  %% ------------------------------------------------------------------
  subgraph OVERSIGHT["Human oversight (policy-required)"]
    H_FLAG["Flag for review\\n(indigenous_rights_flag, redaction_required, high-risk changes)"]
    H_COUNCIL["FAIR+CARE Council review\\nDecision + notes + conditions"]
    H_APPROVE{"Approved?"}
    H_BLOCK["Blocked\\nRecord rationale; remediation required"]
  end

  %% ------------------------------------------------------------------
  %% Release outputs (statement of record)
  %% ------------------------------------------------------------------
  subgraph OUTPUTS["Governance outputs (statement of record)"]
    O_LEDGERS["Ledgers\\n(data/reports/audit/**: provenance + integrity logs)"]
    O_CERT["Certification record\\n(certified / provisional / blocked)"]
    O_RELEASE["Release bundle\\n(releases/{version}/: manifest.zip, sbom.spdx.json, signatures, attestations"]
    O_PUBLISH["Publication\\n(API + web UI consumes governed artifacts)"]
  end

  %% ------------------------------------------------------------------
  %% Feedback loop
  %% ------------------------------------------------------------------
  subgraph FEEDBACK["Feedback + continuous improvement"]
    F_ISSUES["Open remediation work\\n(fix sources, transforms, metadata, tests)"]
    F_RERUN["Re-run pipeline\\n(idempotent; deterministic)"]
    F_MON["Ongoing monitoring\\n(telemetry trends + drift/bias signals where applicable)"]
  end

  %% ---------------- Wiring ----------------
  T_PR --> V_SCHEMA
  T_SCHED --> V_SCHEMA
  T_RELEASE --> V_SCHEMA
  T_LOCAL --> V_SCHEMA

  %% validation gating
  E_CONTRACTS --> V_SCHEMA
  E_CATALOG --> V_SCHEMA
  E_REPORTS --> V_SCHEMA
  E_PROV --> V_SCHEMA
  E_RIGHTS --> V_SCHEMA

  E_INTEGRITY --> V_SEC
  E_INTEGRITY --> V_SCHEMA
  E_TELEM --> V_SCHEMA
  E_TELEM --> V_A11Y
  E_RIGHTS --> V_GEO

  V_SCHEMA --> V_OK
  V_SEC --> V_OK
  V_GEO --> V_OK
  V_A11Y --> V_OK

  V_OK -- "no" --> V_FAIL --> F_ISSUES --> F_RERUN --> V_SCHEMA
  V_OK -- "yes" --> G_SYNC

  %% governance tools
  E_REPORTS --> G_SYNC
  E_TELEM --> G_SYNC
  E_INTEGRITY --> G_SYNC
  E_RIGHTS --> G_SYNC
  G_SYNC --> G_AUDIT --> G_DECIDE

  %% certification decisions
  G_DECIDE -- "blocked" --> H_FLAG
  G_DECIDE -- "provisional" --> H_FLAG
  G_DECIDE -- "certified" --> G_LEDGER

  %% human review path
  H_FLAG --> H_COUNCIL --> H_APPROVE
  H_APPROVE -- "no" --> H_BLOCK --> G_LEDGER
  H_APPROVE -- "yes" --> G_LEDGER

  %% ledger + manifest outputs
  G_LEDGER --> O_LEDGERS
  G_LEDGER --> O_CERT
  O_LEDGERS --> G_MANIFEST
  O_CERT --> G_MANIFEST
  G_MANIFEST --> O_RELEASE --> O_PUBLISH

  %% monitoring loop
  O_PUBLISH --> F_MON
  F_MON --> F_ISSUES
"""

file_path = os.path.join(base_path, "governance_flow.mmd")
with open(file_path, "w", encoding="utf-8") as f:
    f.write(content)

file_path
