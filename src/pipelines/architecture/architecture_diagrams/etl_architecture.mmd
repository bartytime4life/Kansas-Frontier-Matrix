%% Kansas Frontier Matrix (KFM) â€” ETL Architecture (v11)
%% File: src/pipelines/architecture/architecture_diagrams/etl_architecture.mmd
%% Notes:
%% - Deterministic, config-driven, replayable ETL
%% - Produces STAC/DCAT/PROV outputs and loads Neo4j for API + Web consumption
%% - Governance, validation, and telemetry are first-class pipeline gates

flowchart TB

  %% ------------------------------------------------------------
  %% Triggers / Execution
  %% ------------------------------------------------------------
  subgraph TRIGGERS["Triggers"]
    T_LOCAL["Local run: make all / pipeline CLI"]
    T_CI["CI/CD: .github/workflows (PR + scheduled)"]
    T_UPDATES["Update events: data/updates/** (incremental backfills)"]
  end

  %% ------------------------------------------------------------
  %% Source Intake + Governance
  %% ------------------------------------------------------------
  subgraph INTAKE["Source intake + governance"]
    S_EXT["External sources: archives, GIS portals, APIs, scans"]
    S_MANIFEST["Source manifest: data/sources/{source_id}.yml; uri, license, retrieval_date, checksums, restrictions, steward"]
    S_REVIEW["FAIR+CARE + sovereignty review gate (human oversight when required)"]
  end

  %% ------------------------------------------------------------
  %% Orchestration (determinism + reproducibility)
  %% ------------------------------------------------------------
  subgraph ORCH["Pipeline orchestration"]
    O_RUNNER["src/pipelines/** runner; config-driven, replayable, idempotent"]
    O_CONFIG["Run config + seeds snapshot: mcp/runs/{run_id}/**"]
    O_ENV["Pinned runtime: containers / lockfiles / versions"]
  end

  %% ------------------------------------------------------------
  %% Extract
  %% ------------------------------------------------------------
  subgraph EXTRACT["Extract"]
    E_FETCH["Extract: fetch/download/scan; normalize filenames"]
    E_RAW["Raw artifacts: data/raw/{source_id}/**"]
    E_CHECKSUMS["Integrity: data/checksums/** (sha256)"]
    E_TRACKING["Large-file tracking: DVC/LFS (when used)"]
  end

  %% ------------------------------------------------------------
  %% Transform
  %% ------------------------------------------------------------
  subgraph TRANSFORM["Transform"]
    X_STAGE["Staging workspace: data/work/{run_id}/**"]
    X_JOBS["Transform: parse/clean/georef/standardize; join; de-duplicate; version"]
    X_PROCESSED["Processed datasets: data/processed/{dataset_id}/{version}/**"]
  end

  %% ------------------------------------------------------------
  %% Catalog + Provenance Outputs
  %% ------------------------------------------------------------
  subgraph CATALOG["Catalog + provenance outputs"]
    C_STAC["STAC: data/stac/** (Collections + Items + assets)"]
    C_DCAT["DCAT view: docs/data/** or data/catalog/** (dataset/distribution records)"]
    C_PROV["PROV trace: mcp/runs/{run_id}/** + data/reports/audit/** (Entities, Activities, Agents)"]
  end

  %% ------------------------------------------------------------
  %% Validation + Certification Gates
  %% ------------------------------------------------------------
  subgraph VALIDATE["Validate + certify"]
    V_CONTRACTS["Contracts + schemas: docs/contracts/** + schemas/** (JSON + SHACL)"]
    V_VALIDATE["tools/validation/**: STAC/DCAT/schema lint; checksum verify; contract tests"]
    V_REPORTS["Reports: data/reports/** (self-validation, fair, audit)"]
    V_OK{"Valid + compliant?"}
    V_FAIL["Stop: publish failure reports; no load/release"]
  end

  %% ------------------------------------------------------------
  %% Governance + Release Artifacts
  %% ------------------------------------------------------------
  subgraph GOVERN["Governance + release artifacts"]
    G_TOOLS["tools/governance/**: append-only ledgers; certification status"]
    G_LEDGERS["Ledgers: data/reports/audit/** (data provenance + integrity logs)"]
    G_TELEM["tools/telemetry/**: metrics (bytes, latency, energy, carbon); no PII"]
    G_RELEASE["Release bundle: releases/{version}/** (manifest.zip, sbom.spdx.json, signatures, attestations)"]
  end

  %% ------------------------------------------------------------
  %% Load + Serve
  %% ------------------------------------------------------------
  subgraph LOAD["Load + serve"]
    L_NEO4J["Neo4j ingest: incremental + idempotent; constraints + dedupe"]
    L_API["API layer: versioned contracts; pagination; safe errors"]
    L_WEB["Web app: Map + Timeline + Story Nodes + Focus Mode (UI consumes APIs only)"]
  end

  %% ------------------------------------------------------------
  %% Wiring
  %% ------------------------------------------------------------

  %% Triggers -> Orchestration
  T_LOCAL --> O_RUNNER
  T_CI --> O_RUNNER
  T_UPDATES --> O_RUNNER

  %% Intake -> Orchestration
  S_EXT --> S_MANIFEST --> S_REVIEW --> O_RUNNER

  %% Orchestration -> Determinism artifacts
  O_RUNNER --> O_CONFIG
  O_RUNNER --> O_ENV

  %% Orchestration -> Extract
  O_RUNNER --> E_FETCH --> E_RAW --> X_STAGE
  E_FETCH --> E_CHECKSUMS
  E_RAW -. "tracked" .-> E_TRACKING

  %% Transform
  X_STAGE --> X_JOBS --> X_PROCESSED

  %% Catalog + provenance
  X_PROCESSED --> C_STAC
  X_PROCESSED --> C_DCAT
  X_PROCESSED --> C_PROV

  %% Validation
  V_CONTRACTS --> V_VALIDATE
  C_STAC --> V_VALIDATE
  C_DCAT --> V_VALIDATE
  C_PROV --> V_VALIDATE
  E_CHECKSUMS --> V_VALIDATE
  V_VALIDATE --> V_REPORTS --> V_OK
  V_OK -- "no" --> V_FAIL
  V_OK -- "yes" --> G_TOOLS

  %% Governance + release
  V_REPORTS --> G_TOOLS
  G_TOOLS --> G_LEDGERS --> G_RELEASE
  G_TOOLS --> G_TELEM --> G_RELEASE

  %% Load + serve
  G_RELEASE --> L_NEO4J --> L_API --> L_WEB
