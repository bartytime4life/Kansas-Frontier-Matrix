# docker-compose.yml — Kansas Frontier Matrix (KFM) local stack
# Components: Neo4j (graph), FastAPI (API), React/MapLibre (UI)
# Optional "ops" profile: ETL runner + graph sync jobs
#
# Canonical code homes (v13): src/pipelines/, src/graph/, src/server/, web/
# Canonical data roots: data/<domain>/{raw,work,processed}, data/stac/, data/catalog/dcat/, data/prov/, data/graph/
#
# Tip: Copy .env.example -> .env (if your repo has one) and override vars as needed.

services:
  neo4j:
    image: "neo4j:${NEO4J_IMAGE_TAG:-5}"
    container_name: kfm-neo4j
    restart: unless-stopped
    ports:
      - "127.0.0.1:${NEO4J_HTTP_PORT:-7474}:7474"
      - "127.0.0.1:${NEO4J_BOLT_PORT:-7687}:7687"
    environment:
      NEO4J_AUTH: "neo4j/${NEO4J_PASSWORD:-kfm_dev_password}"
      # Expose password for healthcheck / helper tools (do not use in production).
      NEO4J_PASSWORD: "${NEO4J_PASSWORD:-kfm_dev_password}"
      # Optional plugins (comment out if you don't need them):
      NEO4J_PLUGINS: '["apoc"]'
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_plugins:/plugins
      # Make graph exports available for LOAD CSV and seeding workflows:
      - ./data/graph/csv:/import:ro
      - ./data/graph/cypher:/kfm-graph-cypher:ro
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u neo4j -p $NEO4J_PASSWORD 'RETURN 1' >/dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 30
    networks:
      - kfm_backend

  api:
    build:
      context: .
      dockerfile: ./src/server/Dockerfile
    image: kfm-api:dev
    container_name: kfm-api
    restart: unless-stopped
    environment:
      FASTAPI_ENV: "${FASTAPI_ENV:-development}"
      NEO4J_URI: "${NEO4J_URI:-bolt://neo4j:7687}"
      NEO4J_USER: "${NEO4J_USER:-neo4j}"
      NEO4J_PASSWORD: "${NEO4J_PASSWORD:-kfm_dev_password}"
      KFM_REPO_ROOT: "/workspace"
      KFM_DATA_ROOT: "/workspace/data"
      KFM_DOCS_ROOT: "/workspace/docs"
      KFM_SCHEMAS_ROOT: "/workspace/schemas"
    volumes:
      - ./:/workspace
    working_dir: /workspace
    ports:
      - "127.0.0.1:${API_PORT:-8000}:${API_CONTAINER_PORT:-8000}"
    depends_on:
      neo4j:
        condition: service_healthy
    networks:
      - kfm_backend
      - kfm_app

  ui:
    build:
      context: .
      dockerfile: ./web/Dockerfile
    image: kfm-ui:dev
    container_name: kfm-ui
    restart: unless-stopped
    environment:
      # For Vite:
      VITE_API_BASE_URL: "http://api:${API_CONTAINER_PORT:-8000}"
      # For Create React App:
      REACT_APP_API_BASE_URL: "http://api:${API_CONTAINER_PORT:-8000}"
    ports:
      - "127.0.0.1:${UI_PORT:-3000}:${UI_CONTAINER_PORT:-3000}"
    depends_on:
      - api
    networks:
      - kfm_app

  # ----- Optional ops containers (run with: docker compose --profile ops up ...) -----

  etl:
    image: kfm-api:dev
    container_name: kfm-etl
    profiles: ["ops"]
    environment:
      NEO4J_URI: "${NEO4J_URI:-bolt://neo4j:7687}"
      NEO4J_USER: "${NEO4J_USER:-neo4j}"
      NEO4J_PASSWORD: "${NEO4J_PASSWORD:-kfm_dev_password}"
      KFM_REPO_ROOT: "/workspace"
      KFM_DATA_ROOT: "/workspace/data"
    volumes:
      - ./:/workspace
    working_dir: /workspace
    # NOTE: run_agent.py path/args not confirmed in provided docs — adjust to match your repo.
    command: ["bash", "-lc", "python src/pipelines/etl/run_agent.py"]
    depends_on:
      neo4j:
        condition: service_healthy
    networks:
      - kfm_backend

  graph_sync:
    image: kfm-api:dev
    container_name: kfm-graph-sync
    profiles: ["ops"]
    environment:
      NEO4J_URI: "${NEO4J_URI:-bolt://neo4j:7687}"
      NEO4J_USER: "${NEO4J_USER:-neo4j}"
      NEO4J_PASSWORD: "${NEO4J_PASSWORD:-kfm_dev_password}"
      KFM_REPO_ROOT: "/workspace"
      KFM_DATA_ROOT: "/workspace/data"
    volumes:
      - ./:/workspace
    working_dir: /workspace
    # NOTE: entrypoint not confirmed — replace with your graph build/sync command under src/graph/.
    command: ["bash", "-lc", "python src/graph/sync.py"]
    depends_on:
      neo4j:
        condition: service_healthy
    networks:
      - kfm_backend

volumes:
  neo4j_data:
  neo4j_logs:
  neo4j_plugins:

networks:
  # Internal graph/data network (UI is intentionally NOT attached here)
  kfm_backend:
  # App-facing network (UI <-> API)
  kfm_app:
