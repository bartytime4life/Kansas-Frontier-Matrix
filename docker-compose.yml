version: "3.9"

# ──────────────────────────────────────────────────────────────────────────────
# Reusable anchors
# ──────────────────────────────────────────────────────────────────────────────
x-env-defaults: &env_defaults
  PYTHONDONTWRITEBYTECODE: "1"
  PYTHONUNBUFFERED: "1"
  # GDAL/PROJ sensible defaults for networked datasets & VSI performance
  GDAL_DISABLE_READDIR_ON_OPEN: "YES"
  VSI_CACHE: "TRUE"
  VSI_CACHE_SIZE: "1000000"
  PROJ_NETWORK: "ON"
  # Makefile / STAC paths honored inside container
  KFM_DATA_DIR: "/app/data"
  KFM_STAC_DIR: "/app/stac"

x-volume-mounts: &vol_mounts
  - ./:/app:rw
  - pip-cache:/home/dev/.cache/pip:rw
  - ${HOME:-/root}/.aws:/home/dev/.aws:ro
  - ${HOME:-/root}/.netrc:/home/dev/.netrc:ro
  - ${HOME:-/root}/.config/gcloud:/home/dev/.config/gcloud:ro

x-tmpfs: &tmpfs_mounts
  - /tmp:size=512m,mode=1777
  - /var/tmp:size=256m,mode=1777

x-logging: &logging_defaults
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

x-security: &security_defaults
  init: true
  security_opt:
    - no-new-privileges:true
  cap_drop:
    - ALL

x-ulimits: &ulimits_defaults
  nofile:
    soft: 4096
    hard: 8192

# ──────────────────────────────────────────────────────────────────────────────
# Services
# ──────────────────────────────────────────────────────────────────────────────
services:
  # Main toolbox container (GDAL + Python + your repo bind-mounted)
  kfm:
    build:
      context: .
      dockerfile: docker/Dockerfile
      args:
        GDAL_IMAGE: ${GDAL_IMAGE:-ghcr.io/osgeo/gdal:ubuntu-small-latest}
        USER_ID: ${UID:-1000}
        GROUP_ID: ${GID:-1000}
    image: ${IMAGE_NAME:-kfm:local}
    container_name: kfm
    platform: ${PLATFORM:-linux/amd64}
    working_dir: /app
    user: "${UID:-1000}:${GID:-1000}"
    volumes: *vol_mounts
    env_file:
      - .env
    environment:
      <<: *env_defaults
      GITHUB_TOKEN: ${GITHUB_TOKEN:-}
      AWS_PROFILE: ${AWS_PROFILE:-default}
    tmpfs: *tmpfs_mounts
    tty: true
    stdin_open: true
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "command -v gdalinfo >/dev/null 2>&1 && gdalinfo --version >/dev/null 2>&1 || exit 1"]
      interval: 60s
      timeout: 5s
      retries: 3
      start_period: 20s
    logging: *logging_defaults
    <<: [*security_defaults]
    ulimits: *ulimits_defaults

  # Tiny HTTP server to preview ./web (dev-only)
  site:
    profiles: ["dev"]               # docker compose --profile dev up site
    image: ${IMAGE_NAME:-kfm:local}
    platform: ${PLATFORM:-linux/amd64}
    working_dir: /app/web
    depends_on:
      kfm:
        condition: service_healthy
    command: >
      bash -lc 'python - <<PY
      from http.server import SimpleHTTPRequestHandler, ThreadingHTTPServer
      class H(SimpleHTTPRequestHandler):
          def end_headers(self):
              self.send_header("Access-Control-Allow-Origin","*")
              self.send_header("Cache-Control","no-cache, no-store, must-revalidate")
              super().end_headers()
      ThreadingHTTPServer(("0.0.0.0",8080), H).serve_forever()
      PY'
    ports:
      - "127.0.0.1:8080:8080"
    volumes: *vol_mounts
    user: "${UID:-1000}:${GID:-1000}"
    environment:
      <<: *env_defaults
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "command -v curl >/dev/null 2>&1 && curl -fsS --max-time 2 http://127.0.0.1:8080 >/dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s
    logging: *logging_defaults
    <<: [*security_defaults]
    ulimits: *ulimits_defaults

  # CI-style one-shot runner: validates STAC & writes preview manifest then exits
  prebuild:
    profiles: ["ci"]                # docker compose --profile ci up --abort-on-container-exit
    image: ${IMAGE_NAME:-kfm:local}
    platform: ${PLATFORM:-linux/amd64}
    working_dir: /app
    depends_on:
      kfm:
        condition: service_healthy
    entrypoint: [ "bash", "-lc" ]
    command: |
      set -euo pipefail
      if make -qn prebuild >/dev/null 2>&1; then
        make prebuild
      else
        echo "[info] No 'prebuild' target; running quick schema checks"
        python -m pip install -q jsonschema || true
        if [ -f web/app.config.json ] && [ -f web/config/app.config.schema.json ]; then
          python - <<'PY'
import json, sys
from jsonschema import Draft202012Validator as V
cfg=json.load(open("web/app.config.json"))
sch=json.load(open("web/config/app.config.schema.json"))
errs=list(V(sch).iter_errors(cfg))
for e in errs[:20]:
    print("-", "/".join(map(str,e.path)) or "(root)", ":", e.message)
sys.exit(1 if errs else 0)
PY
        fi
      fi
    volumes: *vol_mounts
    user: "${UID:-1000}:${GID:-1000}"
    environment:
      <<: *env_defaults
    logging: *logging_defaults
    <<: [*security_defaults]
    ulimits: *ulimits_defaults

  # Optional: live docs preview (MkDocs) on http://127.0.0.1:8001
  docs:
    profiles: ["docs"]             # docker compose --profile docs up docs
    image: ${IMAGE_NAME:-kfm:local}
    platform: ${PLATFORM:-linux/amd64}
    working_dir: /app
    depends_on:
      kfm:
        condition: service_healthy
    command: >
      bash -lc 'python -m pip install -q mkdocs mkdocs-material mkdocs-redirects mkdocs-include-markdown-plugin mkdocs-minify-plugin mkdocs-git-revision-date-localized-plugin || true; mkdocs serve -a 0.0.0.0:8001'
    ports:
      - "127.0.0.1:8001:8001"
    volumes: *vol_mounts
    user: "${UID:-1000}:${GID:-1000}"
    environment:
      <<: *env_defaults
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "command -v curl >/dev/null 2>&1 && curl -fsS --max-time 2 http://127.0.0.1:8001 >/dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s
    logging: *logging_defaults
    <<: [*security_defaults]
    ulimits: *ulimits_defaults

# ──────────────────────────────────────────────────────────────────────────────
# Volumes (local caches)
# ──────────────────────────────────────────────────────────────────────────────
volumes:
  pip-cache:
