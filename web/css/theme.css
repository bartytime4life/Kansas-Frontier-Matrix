Here’s an upgraded, debugged, and **connected** `web/css/theme.css` that cleanly bridges your `--kfm-*` theme tokens to the core UI tokens used by `app.css` / `map.css` (`--bg`, `--panel`, `--text`, etc.). It supports:

* System **light/dark** (via `prefers-color-scheme`)
* **Forced theme classes** (`.kfm-theme-dark` / `.kfm-theme-light`) on `<html>` or `<body>`
* **Forced-colors**, **reduced-motion**, **high-contrast**, and **RTL** safety
* Safe **color-mix** fallbacks where unsupported

Drop this in as a full replacement.

```css
/* ------------------------------------------------------------------
   Kansas-Frontier-Matrix — Theme Styles (connected to app.css/map.css)
   File: web/css/theme.css
   Purpose: Color palettes, typography, elevation, and theming utilities.
   Notes:
     - Defines `--kfm-*` tokens (native theme set).
     - Maps those tokens to app.css/map.css core vars (`--bg`, `--panel`, `--text`, …)
       so both systems stay in sync without duplication.
     - Supports system light/dark AND class-forced themes.
   ------------------------------------------------------------------ */

/* ===== Root Theme Tokens (Dark default) ===== */
:root {
  /* Color System */
  --kfm-bg: #0e1117;
  --kfm-surface: #171a21;
  --kfm-surface-alt: #1d222d;
  --kfm-border: #2c3240;

  --kfm-ink: #e8eefc;
  --kfm-ink-dim: #b4bfd6;
  --kfm-muted: #7b84a5;

  --kfm-accent: #7cc4ff;
  --kfm-accent-2: #63ffa0;
  --kfm-accent-3: #ffb45e;
  --kfm-danger: #ff6b6b;
  --kfm-warning: #ffd166;
  --kfm-success: #06d6a0;

  /* Typography */
  --kfm-font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans";
  --kfm-mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;

  /* Elevation / Radii */
  --kfm-shadow-1: 0 2px 8px rgba(0,0,0,0.25);
  --kfm-shadow-2: 0 6px 20px rgba(0,0,0,0.35);
  --kfm-shadow-3: 0 12px 32px rgba(0,0,0,0.4);

  --kfm-radius-sm: 6px;
  --kfm-radius: 12px;
  --kfm-radius-lg: 18px;

  /* Spacing */
  --kfm-space-1: 6px;
  --kfm-space-2: 10px;
  --kfm-space-3: 16px;
  --kfm-space-4: 24px;
  --kfm-space-5: 32px;

  /* Transitions */
  --kfm-transition-fast: 120ms ease;
  --kfm-transition: 200ms ease;
  --kfm-transition-slow: 400ms ease;

  /* Safe areas */
  --kfm-safe-top: env(safe-area-inset-top, 0px);
  --kfm-safe-right: env(safe-area-inset-right, 0px);
  --kfm-safe-bottom: env(safe-area-inset-bottom, 0px);
  --kfm-safe-left: env(safe-area-inset-left, 0px);
}

/* ===== Map KFM tokens to core UI variables (compat bridge) ===== */
:root {
  /* Colors & surfaces */
  --bg: var(--kfm-bg);
  --bg-soft: #12151d; /* fallback if color-mix unsupported */
  --panel: var(--kfm-surface);
  --border: var(--kfm-border);
  --text: var(--kfm-ink);
  --muted: var(--kfm-ink-dim);

  /* computed bg-soft with color-mix (when available) */
}
@supports (background: color-mix(in oklab, white 10%, black)) {
  :root {
    --bg-soft: color-mix(in oklab, var(--kfm-surface) 65%, var(--kfm-bg));
  }
}

/* Accents */
:root {
  --accent: var(--kfm-accent);
  --accent-2: var(--kfm-accent-2);
  --danger: var(--kfm-danger);
}

/* Shadows & radii */
:root {
  --shadow-1: var(--kfm-shadow-1);
  --shadow-2: var(--kfm-shadow-2);
  --shadow: var(--k
```
