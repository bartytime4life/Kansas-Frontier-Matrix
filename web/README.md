# Kansas Geo Timeline — Web App

**Time · Terrain · History** — a tiny, dependency-light MapLibre viewer with a time slider.  
It can read layers from a **STAC-derived config** (preferred) or from a simple
`layers.json` (fallback). Designed to publish on **GitHub Pages**.

---

## Folder contents

```text
web/
├─ index.html          # minimal MapLibre bootstrap + UI
├─ app.js              # time slider + layer loader
├─ app.css             # CSS tokens, layout, accessibility
├─ app.config.json     # (preferred) generated from STAC via `make site-config`
├─ layers.json         # (fallback) written by `make site` for quick preview
├─ assets/
│  ├─ logo.png
│  └─ favicon.svg
└─ docs/               # contributor docs (ARCHITECTURE, STYLE_GUIDE, etc.)
````

> If both `app.config.json` and `layers.json` exist, **`app.config.json` wins**.

---

## Quick start

### Option A — Python one-liner

```bash
cd web
python -m http.server 8080
# → open http://localhost:8080
```

### Option B — Docker (compose profile)

```bash
# from repo root (reuses the kfm image)
docker compose --profile dev up -d site
# → open http://localhost:8080
```

---

## Build the data + configs

From the repo root:

```bash
# Show detected tools
make env

# Produce terrain COGs (hillshade/slope/aspect)
make terrain

# Minimal site manifest (fallback) at web/layers.json
make site

# Preferred: render STAC → web/app.config.json (requires kgt)
make stac stac-validate site-config
```

* **DEM override** (optional):

  ```bash
  make terrain DEM=/path/to/dem.tif
  ```

---

## Configs the web app understands

### 1) STAC-driven (preferred) — `web/app.config.json`

Generated by:

```bash
make site-config
```

Simplified structure:

```json
{
  "title": "Kansas Geo Timeline",
  "center": [-98.0, 39.0],
  "zoom": 6,
  "time": { "min": "1850-01-01", "max": "2025-12-31" },
  "layers": [
    {
      "id": "hillshade",
      "title": "Hillshade",
      "type": "raster",
      "url": "../data/derivatives/hillshade.tif",
      "opacity": 1.0,
      "visible": true,
      "time": { "start": "1850-01-01", "end": "2025-12-31" }
    },
    {
      "id": "usgs_larned_1894",
      "title": "USGS Larned (1894)",
      "type": "raster",
      "url": "../data/cogs/overlays/usgs_topo_larned_1894.tif",
      "opacity": 0.7,
      "visible": false,
      "time": { "start": "1894-01-01", "end": "1899-12-31" }
    }
  ]
}
```

### 2) Fallback — `web/layers.json`

Written by `make site` for quick preview:

```json
{
  "layers": [
    { "id": "hillshade", "title": "Hillshade", "type": "raster", "path": "../data/derivatives/hillshade.tif" },
    { "id": "slope",     "title": "Slope (deg)", "type": "raster", "path": "../data/derivatives/slope.tif" },
    { "id": "aspect",    "title": "Aspect (deg)", "type": "raster", "path": "../data/derivatives/aspect.tif" }
  ]
}
```

> The fallback format uses `path` and lacks time windows. For time filtering, generate `app.config.json` via `make site-config`.

---

## How layers load (`app.js`)

* **Raster COGs**: added as MapLibre `raster` sources/layers. Must be web-readable.
* **Static images** (optional): supported if georeferenced, but prefer COGs.
* **GeoJSON overlays**: loaded via `path`, styled by `paint` keys (`line`, `fill`, `circle`).
* **Visibility**: controlled by the time slider. Layers show/hide based on `time.start` / `time.end`.

---

## Publishing to GitHub Pages

1. Ensure **`web/`** contains a valid `app.config.json` or `layers.json`.
   Our CI step `make prebuild` (`stac-validate + site`) prepares artifacts.

2. Configure Pages to serve `web/` or a built `site/`:

   * GitHub Actions (recommended)
   * `/docs` branch path (if mirroring)

3. If using **Lychee** link-check, keep `.lychee.toml` at repo root:

```toml
base_url = "https://<user>.github.io/<repo>/"
include = ["site/**", "README.md", "web/**"]
fail_if_empty = false
```

---

## Troubleshooting

* **White map / nothing loads**

  * Check console for CORS or 404s.
  * Verify `data/derivatives/*.tif` exist (`make terrain`) and config paths are relative to `web/`.

* **COGs won’t render**

  * Ensure they are valid COGs with overviews (`rio cogeo info <file>`).
  * Rebuild via `make terrain`.

* **Slider does nothing**

  * Likely using `layers.json`. Generate `app.config.json` with `make site-config`.

* **Local file URLs blocked**

  * Always serve via HTTP (`python -m http.server` or Docker). Browsers restrict `file://`.

---

## Adding historical overlays

* **USGS topo maps (as COGs):**

  ```
  data/cogs/overlays/usgs_topo_<place>_<year>.tif
  ```

  Add to STAC, regenerate `app.config.json`, and it appears with the right year window.

* **Vectorization helpers:**

  ```bash
  make slope_classes
  make aspect_sectors
  ```

  Outputs to `data/processed/vectors/*.geojson`.

---

## Conventions

* **CRS**: default `EPSG:4326` (configurable in `pyproject.toml` under `[tool.kansas_geo_timeline]`).
* **Tile size**: default `512`.
* **Data roots**:

  * `data/derivatives/` — viewer-ready COGs (`make terrain`)
  * `stac/` — catalog used to render configs (`make site-config`)

---

## Roadmap (web)

* Add a **layer panel** (checkbox + opacity slider).
* Support **vector tiles** (PMTiles / TiTiler).
* Add **permalinks** (center/zoom/year/layers in query string).

---

**License:** MIT (see repo root)
**Questions / ideas?** Open an issue in the repo.

```
