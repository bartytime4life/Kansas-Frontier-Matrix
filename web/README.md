# Kansas Geo Timeline — Web App

**Time · Terrain · History** — a tiny, dependency-light MapLibre viewer with a time slider.
It can read layers from a **STAC-derived config** (preferred) or from a simple
`layers.json` (fallback). Designed to publish on **GitHub Pages**.

---

## Folder contents

```

web/
├─ index.html          # minimal MapLibre bootstrap + UI
├─ app.js              # time slider + layer loader
├─ app.css             # small styles
├─ app.config.json     # (preferred) generated from STAC via `make site-config`
├─ layers.json         # (fallback) written by `make site` for quick preview
└─ assets/
├─ logo.png
└─ favicon.svg

````

> If both `app.config.json` and `layers.json` exist, **`app.config.json` wins**.

---

## Quick start

### Option A — one-liner (Python)
```bash
cd web
python -m http.server 8080
# → open http://localhost:8080
````

### Option B — Docker (compose profile)

```bash
# from repo root (reuses the kfm image)
docker compose --profile dev up -d site
# → open http://localhost:8080
```

---

## Build the data + configs

From the repo root:

```bash
# Show what tools are detected
make env

# Produce terrain COGs (hillshade/slope/aspect) and mirror them into data/derivatives/
make terrain

# Minimal site manifest (fallback) at web/layers.json
make site

# Preferred: render STAC → web/app.config.json (requires kgt)
make stac stac-validate site-config
```

* **DEM override** (optional):

  ```bash
  make terrain DEM=/path/to/dem.tif
  ```

---

## Configs the web app understands

### 1) STAC-driven (preferred) — `web/app.config.json`

This file is generated by:

```bash
make site-config
```

Typical shape (simplified):

```json
{
  "title": "Kansas Geo Timeline",
  "center": [-98.0, 39.0],
  "zoom": 6,
  "years": { "min": 1850, "max": 2025 },
  "layers": [
    {
      "id": "hillshade",
      "title": "Hillshade",
      "type": "raster",
      "url": "../data/derivatives/hillshade.tif",
      "opacity": 1.0,
      "visible": true,
      "years": [1850, 2025]
    },
    {
      "id": "usgs_larned_1894",
      "title": "USGS Larned (1894)",
      "type": "raster",
      "url": "../data/cogs/overlays/usgs_topo_larned_1894.tif",
      "opacity": 0.7,
      "visible": false,
      "years": [1894, 1899]
    }
  ]
}
```

### 2) Fallback — `web/layers.json`

Written by `make site` for fast previews:

```json
{
  "layers": [
    { "id": "hillshade", "title": "Hillshade", "type": "raster", "path": "../data/derivatives/hillshade.tif" },
    { "id": "slope",     "title": "Slope (deg)", "type": "raster", "path": "../data/derivatives/slope.tif" },
    { "id": "aspect",    "title": "Aspect (deg)", "type": "raster", "path": "../data/derivatives/aspect.tif" }
  ]
}
```

> The app will convert `path` into a raster source. For time filtering, use the STAC-driven `app.config.json`.

---

## How layers load (app.js)

* **Raster COGs**: added as MapLibre `raster` sources/layers. COGs should be web-readable.
* **Static images** (optional): the app has a code path for georeferenced images if a source is provided; prefer COGs.
* **Visibility**: the time slider toggles `.visible` based on the selected year and each layer’s `years` window.

---

## Publishing to GitHub Pages

1. Ensure **`web/`** is copied to a site folder or published as-is:

   * Our CI step `make prebuild` (`stac-validate + site`) prepares artifacts.
2. Serve `web/` (or a built `site/`) via Pages:

   * Pages → Source: `GitHub Actions` (recommended) or `/docs` branch path if you mirror `web/` there.
3. If you use **Lychee** link-check, keep `.lychee.toml` at repo root to set:

   * `base_url = "https://<user>.github.io/<repo>/"`,
   * `include = ["site/**", "README.md", "web/**"]`,
   * `fail_if_empty = false` (scaffolding-friendly).

---

## Troubleshooting

* **White map / nothing loads**

  * Open devtools → Console. Look for CORS or 404s.
  * Check that `data/derivatives/*.tif` exist (`make terrain`), and that paths in the config are **relative** from `web/`.
* **COGs won’t render**

  * Ensure they are true **COGs** with overviews (`rio cogeo info <file>`), or rebuild via `make terrain`.
* **Slider does nothing**

  * You’re probably on the fallback `layers.json`. Generate an `app.config.json` with `years` windows (`make site-config`).
* **Local file URLs blocked**

  * Always serve via HTTP (Python server or Docker) — browsers restrict `file://` reads.

---

## Adding historical overlays (examples)

* USGS historical topo as COG:

  ```
  data/cogs/overlays/usgs_topo_<place>_<year>.tif
  ```

  Add an item in **STAC**, regenerate `app.config.json`, and it will appear with the correct **year** window.

* Vectorization quick wins:

  ```
  make slope_classes
  make aspect_sectors
  ```

  Exported to `data/processed/vectors/*.geojson` (you can later add MVT tiles if desired).

---

## Conventions

* **CRS**: default `EPSG:4326` (configurable in `pyproject.toml` under `[tool.kansas_geo_timeline]`).
* **Tile size**: 512 by default (same place).
* **Data roots**:

  * `data/derivatives/` – viewer-ready COGs from `make terrain`
  * `stac/` – catalog used to render `app.config.json` via `make site-config`

---

## Roadmap (web)

* Add a small **layer panel** (checkbox + opacity).
* Optional **vector tile** support (rio-tiler / TiTiler / PMTiles).
* Bookmarkable **permalink** (center/zoom/year/layers in query string).

---

**License:** MIT (see repo root).
**Questions / ideas?** Open an issue in the main repo.

```

This README matches the Makefile targets you’re using (`site`, `site-config`, `prebuild`) and makes the STAC → `app.config.json` path the primary workflow, with `layers.json` as a safe preview fallback.
```
