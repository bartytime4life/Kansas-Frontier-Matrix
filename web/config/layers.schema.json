{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "web/config/layers.schema.json",
  "title": "Kansas-Frontier-Matrix â€” Layers Config",
  "type": "object",
  "additionalProperties": false,

  "required": ["defaults", "layers"],

  "properties": {
    "version":   { "type": "string" },
    "generated": { "type": ["string", "null"], "format": "date-time" },

    "defaults": {
      "type": "object",
      "additionalProperties": false,
      "required": ["minzoom", "maxzoom", "visible", "opacity", "time"],
      "properties": {
        "minzoom": { "type": "integer", "minimum": 0, "maximum": 24 },
        "maxzoom": { "type": "integer", "minimum": 0, "maximum": 24 },
        "visible": { "type": "boolean" },
        "opacity": { "type": "number", "minimum": 0, "maximum": 1 },
        "tileSize": { "type": ["integer", "null"], "enum": [256, 512, null] },
        "bounds": {
          "type": "array",
          "minItems": 4,
          "maxItems": 4,
          "items": { "type": "number" }
        },
        "time": { "$ref": "#/$defs/timeRange" }
      }
    },

    "time": {
      "description": "Global timeline domain for this simple layers config (optional).",
      "type": "object",
      "additionalProperties": false,
      "required": ["min", "max"],
      "properties": {
        "min":         { "type": "string", "format": "date" },
        "max":         { "type": "string", "format": "date" },
        "defaultYear": { "type": ["integer", "null"] },
        "step":        { "type": ["integer", "null"], "minimum": 1 },
        "fps":         { "type": ["integer", "null"], "minimum": 1, "maximum": 60 },
        "loop":        { "type": ["boolean", "null"] },
        "autoplay":    { "type": ["boolean", "null"] }
      }
    },

    "layers": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/layer" }
    }
  },

  "$defs": {
    "timeRange": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "start": { "type": ["string", "null"], "format": "date" },
        "end":   { "type": ["string", "null"], "format": "date" }
      }
    },

    "legendItem": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "label": { "type": ["string", "null"] },
        "color": { "type": ["string", "null"] },
        "lineColor": { "type": ["string", "null"] },
        "lineWidth": { "type": ["number", "null"] },
        "pointColor": { "type": ["string", "null"] },
        "pointRadius": { "type": ["number", "null"] },
        "gradient": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },

    "legend": {
      "type": "array",
      "items": { "$ref": "#/$defs/legendItem" }
    },

    "commonLayerProps": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "id":         { "type": "string" },
        "title":      { "type": "string" },
        "group":      { "type": ["string", "null"] },
        "category": {
          "type": ["string", "null"],
          "enum": ["reference","terrain","historical","infrastructure","documents","environment","culture",null]
        },

        /* Data endpoints (one of these will be required per-type) */
        "url":   { "type": ["string", "null"] },
        "tiles": {
          "type": ["array", "null"],
          "items": { "type": "string" }
        },
        "data":  { "type": ["string", "null"] },

        "opacity":    { "type": "number", "minimum": 0, "maximum": 1 },
        "minzoom":    { "type": ["integer", "null"], "minimum": 0, "maximum": 24 },
        "maxzoom":    { "type": ["integer", "null"], "minimum": 0, "maximum": 24 },
        "tileSize":   { "type": ["integer", "null"], "enum": [256, 512, null] },
        "crossOrigin":{ "type": ["string", "null"] },
        "visible":    { "type": "boolean" },

        "bounds": {
          "type": "array",
          "minItems": 4,
          "maxItems": 4,
          "items": { "type": "number" }
        },
        "time":        { "$ref": "#/$defs/timeRange" },
        "attribution": { "type": ["string", "null"] },

        /* Presentation: flat MapLibre paint or compound geometry blocks */
        "paint": { "$ref": "#/$defs/paint" },
        "style": { "$ref": "#/$defs/style" },

        /* Vector tiling keys (optional in simple config) */
        "source":       { "type": ["string", "null"] },
        "source-layer": { "type": ["string", "null"] },
        "sourceLayer":  { "type": ["string", "null"] },

        /* UI helpers */
        "popup": { "type": "array", "items": { "type": "string" } },

        /* Per-feature time (GeoJSON/vector) */
        "timeProperty":       { "type": ["string", "null"] },
        "timeStartProperty":  { "type": ["string", "null"] },
        "timeEndProperty":    { "type": ["string", "null"] },

        /* Legend entries (optional) */
        "legend": { "$ref": "#/$defs/legend" }
      },
      "required": ["id", "title", "visible"]
    },

    "paintFlat": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "line-color": { "type": "string" },
        "line-width": { "type": "number" },
        "line-opacity": { "type": "number", "minimum": 0, "maximum": 1 },

        "fill-color": { "type": "string" },
        "fill-opacity": { "type": "number", "minimum": 0, "maximum": 1 },
        "fill-outline-color": { "type": "string" },

        "circle-color": { "type": "string" },
        "circle-radius": { "type": "number" },
        "circle-opacity": { "type": "number", "minimum": 0, "maximum": 1 },

        "raster-opacity": { "type": "number", "minimum": 0, "maximum": 1 },
        "hillshade-exaggeration": { "type": "number", "minimum": 0 }
      }
    },

    "paintCompound": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "line":  { "$ref": "#/$defs/paintFlat" },
        "fill":  { "$ref": "#/$defs/paintFlat" },
        "circle":{ "$ref": "#/$defs/paintFlat" }
      }
    },

    "paint": {
      "description": "Either flat MapLibre paint keys or compound per-geometry blocks.",
      "oneOf": [
        { "$ref": "#/$defs/paintFlat" },
        { "$ref": "#/$defs/paintCompound" }
      ]
    },

    "style": {
      "type": "object",
      "description": "App-level vector styling (camelCase).",
      "additionalProperties": false,
      "properties": {
        "lineColor": { "type": "string" },
        "lineWidth": { "type": "number" },
        "lineOpacity": { "type": "number", "minimum": 0, "maximum": 1 },

        "fillColor": { "type": "string" },
        "fillOpacity": { "type": "number", "minimum": 0, "maximum": 1 },
        "fillOutlineColor": { "type": "string" },

        "circleColor": { "type": "string" },
        "circleRadius": { "type": "number" },
        "circleOpacity": { "type": "number", "minimum": 0, "maximum": 1 },

        "lineDasharray": { "type": "array", "items": { "type": "number" } }
      }
    },

    "rasterLayer": {
      "allOf": [
        { "$ref": "#/$defs/commonLayerProps" },
        {
          "type": "object",
          "additionalProperties": false,
          "properties": { "type": { "const": "raster" } },
          "required": ["type"]
        },
        {
          "type": "object",
          "oneOf": [
            { "required": ["tiles"] },
            { "required": ["url"] }
          ]
        }
      ]
    },

    "rasterDemLayer": {
      "allOf": [
        { "$ref": "#/$defs/commonLayerProps" },
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "type": { "const": "raster-dem" },
            "terrain":             { "type": ["boolean", "null"] },
            "terrainExaggeration": { "type": ["number", "null"] }
          },
          "required": ["type"]
        },
        {
          "type": "object",
          "oneOf": [
            { "required": ["tiles"] },
            { "required": ["url"] }
          ]
        }
      ]
    },

    "geojsonLayer": {
      "allOf": [
        { "$ref": "#/$defs/commonLayerProps" },
        {
          "type": "object",
          "additionalProperties": false,
          "properties": { "type": { "const": "geojson" } },
          "required": ["type"]
        },
        {
          "type": "object",
          "oneOf": [
            { "required": ["url"] },
            { "required": ["data"] }
          ]
        }
      ]
    },

    "vectorLayer": {
      "allOf": [
        { "$ref": "#/$defs/commonLayerProps" },
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "type": { "const": "vector" },
            "source-layer": { "type": ["string", "null"] },
            "sourceLayer":  { "type": ["string", "null"] }
          },
          "required": ["type"]
        },
        {
          "type": "object",
          "oneOf": [
            { "required": ["url"] },
            { "required": ["tiles"] }
          ]
        }
      ]
    },

    "imageLayer": {
      "allOf": [
        { "$ref": "#/$defs/commonLayerProps" },
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "type": { "const": "image" },
            "coordinates": {
              "description": "NW, NE, SE, SW lon/lat pairs",
              "type": "array",
              "minItems": 4,
              "maxItems": 4,
              "items": {
                "type": "array",
                "minItems": 2,
                "maxItems": 2,
                "items": { "type": "number" }
              }
            }
          },
          "required": ["type"],
          "oneOf": [
            { "required": ["url", "coordinates"] }
          ]
        }
      ]
    },

    "layer": {
      "oneOf": [
        { "$ref": "#/$defs/rasterLayer" },
        { "$ref": "#/$defs/rasterDemLayer" },
        { "$ref": "#/$defs/geojsonLayer" },
        { "$ref": "#/$defs/vectorLayer" },
        { "$ref": "#/$defs/imageLayer" }
      ]
    }
  }
}
