<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Kansas Geo Timeline — Viewer</title>
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.7.0/dist/maplibre-gl.css"/>
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .panel {
      position: absolute; top: 10px; left: 10px; z-index: 2;
      background: #fff; padding: 10px 12px; border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,.18); font: 14px/1.3 system-ui, sans-serif;
      max-width: 320px;
    }
    .row { display: flex; align-items: center; gap: 8px; margin: 6px 0; }
    .row label { white-space: nowrap; }
    .muted { color: #666; font-size: 12px; }
    .legend { margin-top: 6px; }
  </style>
</head>
<body>
<div id="map" aria-label="Map viewer"></div>

<div class="panel" role="region" aria-label="Map controls">
  <strong>Kansas Geo Timeline</strong><br/>
  <div class="row">
    <input type="checkbox" id="toggle-hillshade" checked/>
    <label for="toggle-hillshade">Hillshade</label>
  </div>
  <div class="row" title="Filter layers by year">
    <label for="year">Year</label>
    <input id="year" type="range" min="1850" max="2025" step="1" value="1930" style="flex:1"/>
    <span id="year-label" aria-live="polite">1930</span>
  </div>
  <div class="muted">Tip: layers are filtered by their <em>start–end</em> years.</div>
  <div id="status" class="muted legend"></div>
</div>

<script src="https://unpkg.com/maplibre-gl@3.7.0/dist/maplibre-gl.js"></script>
<script>
/**
 * Viewer expects a small manifest:
 *  - Prefer ./app.config.json {layers:[{id,type,url|tiles,opacity,start,end,coordinates}]}
 *  - Fallback to ./layers.json {layers:[{id,type,path,opacity,start,end,coordinates}]}
 * For 'image' layers you can provide coordinates: [[west,south],[east,south],[east,north],[west,north]]
 */
(async function () {
  const statusEl = document.getElementById('status');
  const setStatus = (msg) => statusEl.textContent = msg || '';

  // Base map
  const map = new maplibregl.Map({
    container: 'map',
    style: 'https://demotiles.maplibre.org/style.json',
    center: [-98.0, 38.5],
    zoom: 5.5,
    attributionControl: true
  });
  map.addControl(new maplibregl.NavigationControl({ visualizePitch: true }));
  map.addControl(new maplibregl.ScaleControl({ unit: 'imperial' }));

  // Load config
  let cfg;
  try {
    // prefer app.config.json, fallback to layers.json
    cfg = await fetch('./app.config.json').then(r => r.ok ? r.json() : Promise.reject())
      .catch(() => fetch('./layers.json').then(r => r.json()));
  } catch (e) {
    setStatus('Failed to load layer configuration (app.config.json / layers.json).');
    console.error(e);
    return;
  }

  const layers = (cfg && cfg.layers) ? cfg.layers : [];
  const yearEl = document.getElementById('year');
  const yearLabelEl = document.getElementById('year-label');
  const toggleHillshadeEl = document.getElementById('toggle-hillshade');

  function addRasterLayer(L) {
    const id = L.id;
    const opacity = (typeof L.opacity === 'number') ? L.opacity : 1.0;
    // Support either tile URL (tiles) or single tile path (url / path)
    const tiles = L.tiles || (L.url ? [L.url] : (L.path ? [L.path] : null));
    if (!tiles) return console.warn('Layer missing tiles/url/path:', L);

    if (!map.getSource(id)) {
      map.addSource(id, { type: 'raster', tiles, tileSize: 256, crossOrigin: 'anonymous' });
    }
    if (!map.getLayer(id)) {
      map.addLayer({ id, type: 'raster', source: id, paint: { 'raster-opacity': opacity } });
    }
  }

  function addImageLayer(L) {
    // Static image overlay (if you precomputed bounds to coordinates array)
    // coordinates: [[west, north], [east, north], [east, south], [west, south]]
    // Or MapLibre convention: [[minX, maxY], [maxX, maxY], [maxX, minY], [minX, minY]]
    if (!Array.isArray(L.coordinates) || !L.url) {
      console.warn('Image layer missing coordinates/url:', L);
      return;
    }
    const id = L.id;
    const opacity = (typeof L.opacity === 'number') ? L.opacity : 0.8;

    if (!map.getSource(id)) {
      map.addSource(id, { type: 'image', url: L.url, coordinates: L.coordinates });
    }
    if (!map.getLayer(id)) {
      map.addLayer({ id, type: 'raster', source: id, paint: { 'raster-opacity': opacity } });
    }
  }

  function ensureLayer(L) {
    if (!L || !L.id || !L.type) return;
    if (L.type === 'raster') addRasterLayer(L);
    else if (L.type === 'image') addImageLayer(L);
    // vector/mvt could be added later
  }

  function visibleForYear(L, y) {
    const start = (typeof L.start === 'number') ? L.start : -Infinity;
    const end = (typeof L.end === 'number') ? L.end : Infinity;
    return start <= y && y <= end;
  }

  function updateVisibility(y) {
    yearLabelEl.textContent = String(y);
    let shown = 0, total = 0;

    layers.forEach(L => {
      total++;
      ensureLayer(L);
      const id = L.id;
      const show = visibleForYear(L, y);
      if (map.getLayer(id)) {
        map.setLayoutProperty(id, 'visibility', show ? 'visible' : 'none');
        if (show) shown++;
      }
    });

    setStatus(`${shown}/${total} layers visible for ${y}`);
  }

  function initHillshadeToggle() {
    // The config should include a layer with id 'hillshade' (or adapt the id here)
    const HILLSHADE_ID = 'hillshade';
    toggleHillshadeEl.addEventListener('change', (e) => {
      const vis = e.target.checked ? 'visible' : 'none';
      if (map.getLayer(HILLSHADE_ID)) map.setLayoutProperty(HILLSHADE_ID, 'visibility', vis);
    });
  }

  map.on('load', () => {
    // Pre-register sources/layers so toggles act immediately
    layers.forEach(ensureLayer);
    initHillshadeToggle();
    updateVisibility(parseInt(yearEl.value, 10));
  });

  yearEl.addEventListener('input', () => {
    updateVisibility(parseInt(yearEl.value, 10));
  });
})();
</script>
</body>
</html>
