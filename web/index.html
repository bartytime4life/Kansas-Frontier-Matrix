<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Kansas-Frontier-Matrix — Geo Timeline Viewer</title>

  <!-- MapLibre GL -->
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.7.0/dist/maplibre-gl.css"/>
  <script defer src="https://unpkg.com/maplibre-gl@3.7.0/dist/maplibre-gl.js"></script>

  <!-- App styles -->
  <link rel="icon" href="./assets/favicon.svg" type="image/svg+xml"/>
  <link rel="stylesheet" href="./style.css"/>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header" role="banner">
      <div class="header__inner">
        <div class="brand">
          <img src="./assets/logo.png" alt="" aria-hidden="true"/>
          <span>Kansas-Frontier-Matrix</span>
        </div>
        <div class="header__spacer"></div>
        <div class="header__actions">
          <a class="btn" href="https://github.com/bartytime4life/Kansas-Frontier-Matrix" target="_blank" rel="noopener">GitHub</a>
          <button id="btn-reset" class="btn" type="button" title="Reset view">Reset</button>
        </div>
      </div>
    </header>

    <!-- Map -->
    <main class="map-wrapper" role="main">
      <div id="map" aria-label="Time-aware map of Kansas"></div>

      <!-- Controls -->
      <section class="controls fade-in" role="region" aria-label="Map controls">
        <div class="controls__section">
          <div class="label">Timeline</div>
          <div class="year-row">
            <input id="year" type="range" min="1850" max="2025" step="1" value="1930" aria-label="Filter layers by year"/>
            <output id="year-label" for="year">1930</output>
          </div>
          <div id="status" class="muted" aria-live="polite"></div>
        </div>

        <div class="controls__section">
          <div class="label">Layers</div>
          <div class="layers" id="layer-list">
            <!-- Hillshade toggle -->
            <div class="layer" data-layer-id="hillshade">
              <div class="layer__name">Hillshade</div>
              <div class="layer__controls">
                <div id="switch-hillshade" class="switch" role="switch" tabindex="0" aria-checked="true" aria-label="Toggle hillshade">
                  <div class="switch__dot"></div>
                </div>
              </div>
            </div>
            <!-- Basemap toggle (if present in config) -->
            <div class="layer" data-layer-id="basemap_osm">
              <div class="layer__name">Basemap — OSM</div>
              <div class="layer__controls">
                <div id="switch-basemap" class="switch" role="switch" tabindex="0" aria-checked="true" aria-label="Toggle basemap">
                  <div class="switch__dot"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="controls__section">
          <div class="label">Legend</div>
          <div class="legend">
            <div class="legend__row">
              <span class="legend__swatch" style="background:#7d7d7d"></span>
              <span class="legend__name">Hillshade</span>
              <span class="legend__meta">2018–2020</span>
            </div>
            <div class="legend__row">
              <span class="legend__swatch" style="background:#3a6ea8"></span>
              <span class="legend__name">USGS Historic Topo — Larned</span>
              <span class="legend__meta">1894</span>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
  // -----------------------------------------------------------------------------
  // Kansas-Frontier-Matrix — Minimal viewer logic
  // - Prefers ./app.config.json, falls back to ./layers.json
  // - Layer objects should have: { id, type: "raster"|"image", url, opacity, start, end, coordinates? }
  // - Our upgraded layers.json normalizes to `url` (not `tiles`)
  // -----------------------------------------------------------------------------
  (async function () {
    const $ = (sel) => document.querySelector(sel);

    const statusEl = $('#status');
    const yearEl = $('#year');
    const yearLabelEl = $('#year-label');
    const switchHillshade = $('#switch-hillshade');
    const switchBasemap = $('#switch-basemap');
    const btnReset = $('#btn-reset');

    const setStatus = (msg) => statusEl.textContent = msg || '';

    // MapLibre base
    const map = new maplibregl.Map({
      container: 'map',
      style: 'https://demotiles.maplibre.org/style.json',
      center: [-98.0, 38.5],
      zoom: 5.5,
      attributionControl: true
    });
    map.addControl(new maplibregl.NavigationControl({ visualizePitch: true }));
    map.addControl(new maplibregl.ScaleControl({ unit: 'imperial' }));

    // Load config (prefer app.config.json)
    let cfg;
    try {
      cfg = await fetch('./app.config.json').then(r => r.ok ? r.json() : Promise.reject())
            .catch(() => fetch('./layers.json').then(r => r.json()));
    } catch (e) {
      setStatus('Failed to load layer configuration (app.config.json / layers.json).');
      console.error(e);
      return;
    }

    const defaults = cfg.defaults || {};
    const layers = Array.isArray(cfg.layers) ? cfg.layers : [];

    function tilesFrom(L) {
      // We accept explicit tile templates in `url` (recommended) or `tiles` (array).
      if (Array.isArray(L.tiles) && L.tiles.length) return L.tiles;
      if (typeof L.url === 'string') return [L.url];
      if (typeof L.path === 'string') return [L.path]; // legacy
      return null;
    }

    function addRaster(L) {
      const id = L.id;
      const tiles = tilesFrom(L);
      if (!tiles) { console.warn('Raster layer missing url/tiles:', L); return; }

      if (!map.getSource(id)) {
        map.addSource(id, {
          type: 'raster',
          tiles,
          tileSize: L.tileSize || defaults.tileSize || 256,
          crossOrigin: 'anonymous'
        });
      }
      if (!map.getLayer(id)) {
        map.addLayer({
          id, type: 'raster', source: id,
          paint: { 'raster-opacity': (typeof L.opacity === 'number') ? L.opacity : (defaults.opacity ?? 1.0) },
          layout: { visibility: (L.visible ?? defaults.visible ?? true) ? 'visible' : 'none' }
        });
      }
    }

    function addImage(L) {
      // coordinates: [[minX, maxY], [maxX, maxY], [maxX, minY], [minX, minY]]
      if (!Array.isArray(L.coordinates) || !L.url) {
        console.warn('Image layer missing coordinates/url:', L);
        return;
      }
      const id = L.id;
      if (!map.getSource(id)) {
        map.addSource(id, { type: 'image', url: L.url, coordinates: L.coordinates });
      }
      if (!map.getLayer(id)) {
        map.addLayer({
          id, type: 'raster', source: id,
          paint: { 'raster-opacity': (typeof L.opacity === 'number') ? L.opacity : 0.8 },
          layout: { visibility: (L.visible ?? defaults.visible ?? true) ? 'visible' : 'none' }
        });
      }
    }

    function ensure(L) {
      if (!L || !L.id || !L.type) return;
      if (L.type === 'raster') addRaster(L);
      else if (L.type === 'image') addImage(L);
      // vector/MVT can be added later
    }

    function visibleForYear(L, y) {
      const start = (typeof L.start === 'number') ? L.start : -Infinity;
      const end = (typeof L.end === 'number') ? L.end : Infinity;
      return start <= y && y <= end;
    }

    function updateVisibility(y) {
      yearLabelEl.textContent = String(y);
      let shown = 0, total = 0;

      layers.forEach(L => {
        total++;
        ensure(L);
        const id = L.id;
        const show = visibleForYear(L, y);
        if (map.getLayer(id)) {
          map.setLayoutProperty(id, 'visibility', show ? 'visible' : 'none');
          if (show) shown++;
        }
      });

      setStatus(`${shown}/${total} layers visible for ${y}`);
    }

    function bindSwitch(el, layerId) {
      if (!el) return;
      const setChecked = (checked) => el.setAttribute('aria-checked', checked ? 'true' : 'false');
      const toggle = () => {
        const vis = el.getAttribute('aria-checked') !== 'true';
        setChecked(vis);
        if (map.getLayer(layerId)) map.setLayoutProperty(layerId, 'visibility', vis ? 'visible' : 'none');
      };
      el.addEventListener('click', toggle);
      el.addEventListener('keydown', (e) => {
        if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); toggle(); }
      });
    }

    map.on('load', () => {
      // Pre-register all layers so toggles work immediately
      layers.forEach(ensure);

      // Wire toggles
      bindSwitch(switchHillshade, 'hillshade');
      bindSwitch(switchBasemap, 'basemap_osm');

      // Year filter
      updateVisibility(parseInt(yearEl.value, 10));
    });

    yearEl.addEventListener('input', () => {
      updateVisibility(parseInt(yearEl.value, 10));
    });

    btnReset?.addEventListener('click', () => {
      map.easeTo({ center: [-98.0, 38.5], zoom: 5.5, pitch: 0, bearing: 0, duration: 600 });
    });
  })();
  </script>
</body>
</html>
